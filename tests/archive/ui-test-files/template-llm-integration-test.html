<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>üéØ Template & LLM Integration Test Suite</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      line-height: 1.6;
      background: #f8fafc;
      color: #1a202c;
      padding: 20px;
      margin: 0;
    }

    .test-container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .test-header {
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    .test-section {
      padding: 24px;
      border-bottom: 1px solid #e2e8f0;
    }

    .test-section:last-child {
      border-bottom: none;
    }

    .test-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .test-card {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .test-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .test-card-header {
      background: #f8fafc;
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 500;
      color: #374151;
    }

    .test-card-body {
      padding: 16px;
    }

    .test-button {
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      margin-bottom: 12px;
    }

    .test-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    .test-button.primary {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    .test-button.secondary {
      background: #6b7280;
    }

    .test-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }

    .test-result.success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
      display: block;
    }

    .test-result.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
      display: block;
    }

    .test-result.info {
      background: #eff6ff;
      color: #1e40af;
      border: 1px solid #bfdbfe;
      display: block;
    }

    .template-preview {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      background: #f8fafc;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .console-output {
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      overflow-x: auto;
      max-height: 250px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .json-viewer {
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre;
      line-height: 1.4;
    }

    .test-scenario {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
    }

    .scenario-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .scenario-details {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .generated-content {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      font-size: 12px;
      line-height: 1.5;
      max-height: 300px;
      overflow-y: auto;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin: 12px 0;
    }

    .metric-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .metric-label {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>üéØ Template & LLM Integration Test Suite</h1>
      <p>Comprehensive testing of template system, smart template selection, and LLM integration with real context data</p>
    </div>

    <!-- Template System Core Tests -->
    <div class="test-section">
      <div class="test-title">üèóÔ∏è Template System Core Tests</div>
      <div class="test-grid">
        <div class="test-card">
          <div class="test-card-header">Template Engine Health</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testTemplateEngineHealth()">üîç Test Template Engine</button>
            <div id="template-engine-health-result" class="test-result"></div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">Template Availability</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testTemplateAvailability()">üìã Check All Templates</button>
            <div id="template-availability-result" class="test-result"></div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">Smart Template Selection</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testSmartTemplateSelection()">üß† Test Smart Selection</button>
            <div id="smart-selection-result" class="test-result"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LLM Integration Tests -->
    <div class="test-section">
      <div class="test-title">ü§ñ LLM Integration Tests</div>
      <div class="test-grid">
        <div class="test-card">
          <div class="test-card-header">Basic Template Generation</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testBasicTemplateGeneration()">üìù Generate Basic Template</button>
            <div id="basic-generation-result" class="test-result"></div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">AEM Template Generation</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testAEMTemplateGeneration()">üèóÔ∏è Generate AEM Template</button>
            <div id="aem-generation-result" class="test-result"></div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">Complex Context Generation</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testComplexContextGeneration()">üîç Generate with Full Context</button>
            <div id="complex-generation-result" class="test-result"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Template Quality Tests -->
    <div class="test-section">
      <div class="test-title">‚úÖ Template Quality Tests</div>
      <div class="test-grid">
        <div class="test-card">
          <div class="test-card-header">Content Structure Validation</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testContentStructure()">üìê Validate Structure</button>
            <div id="content-structure-result" class="test-result"></div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">Context Variable Substitution</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testVariableSubstitution()">üîÑ Test Variable Substitution</button>
            <div id="variable-substitution-result" class="test-result"></div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">Template Performance</div>
          <div class="test-card-body">
            <button class="test-button" onclick="testTemplatePerformance()">‚ö° Measure Performance</button>
            <div id="template-performance-result" class="test-result"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Scenarios -->
    <div class="test-section">
      <div class="test-title">üé≠ Real-World Test Scenarios</div>
      
      <div class="test-scenario">
        <div class="scenario-title">Scenario 1: React Component with Complex Props</div>
        <div class="scenario-details">
          Tech Stack: React 18 + TypeScript + Material-UI<br>
          Component: User Profile Card with avatar, actions, and responsive design
        </div>
        <button class="test-button secondary" onclick="runScenario1()">üß™ Run Scenario 1</button>
        <div id="scenario1-result" class="test-result"></div>
      </div>

      <div class="test-scenario">
        <div class="scenario-title">Scenario 2: AEM Component with HTL Template</div>
        <div class="scenario-details">
          Tech Stack: AEM 6.5 + HTL + Sling Model + OSGi<br>
          Component: Navigation component with dynamic menu items
        </div>
        <button class="test-button secondary" onclick="runScenario2()">üß™ Run Scenario 2</button>
        <div id="scenario2-result" class="test-result"></div>
      </div>

      <div class="test-scenario">
        <div class="scenario-title">Scenario 3: Vue 3 Composition API Component</div>
        <div class="scenario-details">
          Tech Stack: Vue 3 + Composition API + Pinia + Vite<br>
          Component: Shopping cart with reactive state management
        </div>
        <button class="test-button secondary" onclick="runScenario3()">üß™ Run Scenario 3</button>
        <div id="scenario3-result" class="test-result"></div>
      </div>
    </div>

    <!-- Comprehensive Test Runner -->
    <div class="test-section">
      <div class="test-title">üöÄ Comprehensive Test Runner</div>
      <div class="test-grid">
        <div class="test-card">
          <div class="test-card-header">üéØ Run All Template Tests</div>
          <div class="test-card-body">
            <button class="test-button primary" onclick="runAllTemplateTests()">üöÄ Run Complete Template Test Suite</button>
            <div id="all-tests-result" class="test-result"></div>
            <div class="metrics-grid" id="test-metrics" style="display: none;">
              <div class="metric-card">
                <div class="metric-value" id="total-tests">0</div>
                <div class="metric-label">Total Tests</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="passed-tests">0</div>
                <div class="metric-label">Passed</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="success-rate">0%</div>
                <div class="metric-label">Success Rate</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="avg-time">0ms</div>
                <div class="metric-label">Avg Time</div>
              </div>
            </div>
          </div>
        </div>
        <div class="test-card">
          <div class="test-card-header">Generated Content Preview</div>
          <div class="test-card-body">
            <div id="generated-preview" class="generated-content">
              Click "Run Complete Template Test Suite" to see generated template content here...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Console Output -->
    <div class="test-section">
      <div class="test-title">üìã Test Console Output</div>
      <div class="console-output" id="console-output">
Ready to run template tests...<br>
Click any test button to see real-time output here.
      </div>
    </div>
  </div>

  <script>
    const consoleOutput = document.getElementById('console-output');
    let testResults = [];
    let testTimes = [];
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      consoleOutput.innerHTML += `${emoji} [${timestamp}] ${message}<br>`;
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      console.log(`${emoji} ${message}`);
    }

    function showResult(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `test-result ${type}`;
    }

    function showGeneratedContent(content) {
      const preview = document.getElementById('generated-preview');
      preview.innerHTML = `<pre>${content.substring(0, 1500)}${content.length > 1500 ? '\n\n... (truncated)' : ''}</pre>`;
    }

    function updateTestMetrics() {
      const total = testResults.length;
      const passed = testResults.filter(r => r.passed).length;
      const successRate = total > 0 ? Math.round((passed / total) * 100) : 0;
      const avgTime = testTimes.length > 0 ? Math.round(testTimes.reduce((a, b) => a + b, 0) / testTimes.length) : 0;

      document.getElementById('total-tests').textContent = total;
      document.getElementById('passed-tests').textContent = passed;
      document.getElementById('success-rate').textContent = `${successRate}%`;
      document.getElementById('avg-time').textContent = `${avgTime}ms`;
      document.getElementById('test-metrics').style.display = 'grid';
    }

    // Template Engine Health Test
    async function testTemplateEngineHealth() {
      const startTime = Date.now();
      log('Testing template engine health...');
      try {
        // Test server connectivity
        const response = await fetch('http://localhost:3000/', {
          method: 'GET'
        });

        if (!response.ok) {
          throw new Error(`Server not responding: ${response.status}`);
        }

        const serverInfo = await response.json();
        const hasTemplateTools = serverInfo.tools && serverInfo.tools.includes('generate_template_tickets');

        if (hasTemplateTools) {
          log('‚úÖ Template engine healthy: generate_template_tickets tool available', 'success');
          showResult('template-engine-health-result', '‚úÖ Template engine healthy and ready', 'success');
          testResults.push({ name: 'Template Engine Health', passed: true });
        } else {
          throw new Error('generate_template_tickets tool not found');
        }

        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Template engine health check failed: ${error.message}`, 'error');
        showResult('template-engine-health-result', `‚ùå Template engine error: ${error.message}`, 'error');
        testResults.push({ name: 'Template Engine Health', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Template Availability Test
    async function testTemplateAvailability() {
      const startTime = Date.now();
      log('Checking template availability...');
      try {
        const platforms = ['jira', 'github', 'confluence'];
        const documentTypes = ['component', 'code-simple', 'feature', 'service', 'page'];
        const aemTemplates = ['component-aem', 'code-simple-aem', 'page-aem', 'service-aem'];

        let totalTemplates = 0;
        let availableTemplates = 0;

        // Standard templates
        for (const platform of platforms) {
          for (const docType of documentTypes) {
            totalTemplates++;
            // Simulate template availability check
            availableTemplates++;
            log(`‚úì ${platform}/${docType}.yml available`, 'info');
          }
        }

        // AEM-specific templates
        for (const aemTemplate of aemTemplates) {
          totalTemplates++;
          availableTemplates++;
          log(`‚úì jira/${aemTemplate}.yml available`, 'info');
        }

        const availabilityRate = Math.round((availableTemplates / totalTemplates) * 100);
        log(`Template availability: ${availableTemplates}/${totalTemplates} (${availabilityRate}%)`, 'success');
        
        showResult('template-availability-result', 
          `‚úÖ Templates: ${availableTemplates}/${totalTemplates} available (${availabilityRate}%)`, 
          'success'
        );
        
        testResults.push({ name: 'Template Availability', passed: availabilityRate === 100 });
        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Template availability check failed: ${error.message}`, 'error');
        showResult('template-availability-result', `‚ùå Availability error: ${error.message}`, 'error');
        testResults.push({ name: 'Template Availability', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Smart Template Selection Test
    async function testSmartTemplateSelection() {
      const startTime = Date.now();
      log('Testing smart template selection logic...');
      try {
        const testCases = [
          {
            techStack: 'AEM 6.5 with HTL (HTML Template Language), Apache Sling framework',
            documentType: 'component',
            expected: 'component-aem.yml',
            name: 'AEM Component'
          },
          {
            techStack: 'AEM 6.5, OSGi bundles, JCR repository, Touch UI components',
            documentType: 'code-simple',
            expected: 'code-simple-aem.yml',
            name: 'AEM Code Simple'
          },
          {
            techStack: 'React 18 with TypeScript, Material-UI v5',
            documentType: 'component',
            expected: 'component.yml',
            name: 'React Component'
          },
          {
            techStack: 'Vue 3 with Composition API, Pinia for state',
            documentType: 'service',
            expected: 'service.yml',
            name: 'Vue Service'
          }
        ];

        let passedTests = 0;
        for (const testCase of testCases) {
          log(`Testing: ${testCase.name}`, 'info');
          
          // Mock smart template selection logic
          const isAEM = testCase.techStack.toLowerCase().includes('aem') || 
                       testCase.techStack.toLowerCase().includes('htl') ||
                       testCase.techStack.toLowerCase().includes('sling') ||
                       testCase.techStack.toLowerCase().includes('osgi');
          
          const selectedTemplate = isAEM ? 
            `${testCase.documentType}-aem.yml` : 
            `${testCase.documentType}.yml`;
          
          if (selectedTemplate === testCase.expected) {
            passedTests++;
            log(`‚úÖ PASS: ${testCase.name} ‚Üí ${selectedTemplate}`, 'success');
          } else {
            log(`‚ùå FAIL: ${testCase.name} expected ${testCase.expected}, got ${selectedTemplate}`, 'error');
          }
        }

        const successRate = Math.round((passedTests / testCases.length) * 100);
        showResult('smart-selection-result', 
          `‚úÖ Smart Selection: ${passedTests}/${testCases.length} tests passed (${successRate}%)`, 
          passedTests === testCases.length ? 'success' : 'error'
        );
        
        testResults.push({ name: 'Smart Template Selection', passed: passedTests === testCases.length });
        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Smart template selection test failed: ${error.message}`, 'error');
        showResult('smart-selection-result', `‚ùå Smart selection error: ${error.message}`, 'error');
        testResults.push({ name: 'Smart Template Selection', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Basic Template Generation Test
    async function testBasicTemplateGeneration() {
      const startTime = Date.now();
      log('Testing basic template generation...');
      try {
        const templateRequest = {
          method: 'generate_template_tickets',
          params: {
            frameData: [{
              id: '11536:17598',
              name: 'Button Component',
              type: 'COMPONENT',
              dimensions: { width: 120, height: 40 }
            }],
            figmaContext: {
              figmaUrl: 'https://www.figma.com/file/test-file/Test',
              fileName: 'Component Library'
            },
            platform: 'jira',
            documentType: 'component',
            teamStandards: {
              tech_stack: 'React 18 with TypeScript'
            }
          }
        };

        log('Sending basic template generation request...', 'info');
        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(templateRequest)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.content && result.content[0] && result.content[0].text) {
          const generatedContent = result.content[0].text;
          const wordCount = generatedContent.split(/\s+/).length;
          const hasRequiredSections = [
            'Button Component',
            'Acceptance Criteria',
            'Technical Requirements',
            'React'
          ].every(section => generatedContent.includes(section));
          
          log(`‚úÖ Generated ${wordCount} words with required sections`, 'success');
          showResult('basic-generation-result', 
            `‚úÖ Basic Generation: ${wordCount} words, structure ${hasRequiredSections ? 'valid' : 'invalid'}`, 
            'success'
          );
          
          showGeneratedContent(generatedContent);
          testResults.push({ name: 'Basic Template Generation', passed: true });
        } else {
          throw new Error('Invalid response format');
        }

        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Basic template generation failed: ${error.message}`, 'error');
        showResult('basic-generation-result', `‚ùå Basic generation error: ${error.message}`, 'error');
        testResults.push({ name: 'Basic Template Generation', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // AEM Template Generation Test
    async function testAEMTemplateGeneration() {
      const startTime = Date.now();
      log('Testing AEM template generation...');
      try {
        const aemRequest = {
          method: 'generate_template_tickets',
          params: {
            frameData: [{
              id: '11536:17598',
              name: 'Navigation Component',
              type: 'COMPONENT',
              dimensions: { width: 1200, height: 80 }
            }],
            figmaContext: {
              figmaUrl: 'https://www.figma.com/file/aem-file/AEM-Components',
              fileName: 'AEM Component Library'
            },
            platform: 'jira',
            documentType: 'component',
            teamStandards: {
              tech_stack: 'AEM 6.5 with HTL (HTML Template Language), Apache Sling framework, OSGi bundles, JCR repository'
            }
          }
        };

        log('Sending AEM template generation request...', 'info');
        log('Expected: component-aem.yml template selection', 'info');
        
        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(aemRequest)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.content && result.content[0] && result.content[0].text) {
          const generatedContent = result.content[0].text;
          const wordCount = generatedContent.split(/\s+/).length;
          
          // Check for AEM-specific content
          const hasAEMContent = [
            'HTL',
            'Sling',
            'OSGi',
            'JCR',
            'AEM'
          ].some(aemTerm => generatedContent.toLowerCase().includes(aemTerm.toLowerCase()));
          
          const hasRequiredSections = [
            'Navigation Component',
            'Acceptance Criteria',
            'Technical Requirements'
          ].every(section => generatedContent.includes(section));
          
          log(`‚úÖ Generated ${wordCount} words with AEM-specific content: ${hasAEMContent}`, 'success');
          showResult('aem-generation-result', 
            `‚úÖ AEM Generation: ${wordCount} words, AEM content ${hasAEMContent ? 'present' : 'missing'}`, 
            hasAEMContent ? 'success' : 'error'
          );
          
          testResults.push({ name: 'AEM Template Generation', passed: hasAEMContent && hasRequiredSections });
        } else {
          throw new Error('Invalid response format');
        }

        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`AEM template generation failed: ${error.message}`, 'error');
        showResult('aem-generation-result', `‚ùå AEM generation error: ${error.message}`, 'error');
        testResults.push({ name: 'AEM Template Generation', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Complex Context Generation Test
    async function testComplexContextGeneration() {
      const startTime = Date.now();
      log('Testing complex context generation...');
      try {
        const complexRequest = {
          method: 'generate_template_tickets',
          params: {
            frameData: [{
              id: '11536:17598',
              name: 'E-commerce Product Card',
              type: 'COMPONENT',
              dimensions: { width: 300, height: 400 },
              children: [
                { name: 'Product Image', type: 'RECTANGLE' },
                { name: 'Product Title', type: 'TEXT' },
                { name: 'Price Display', type: 'TEXT' },
                { name: 'Add to Cart Button', type: 'COMPONENT' }
              ]
            }],
            figmaContext: {
              figmaUrl: 'https://www.figma.com/file/ecommerce-file/E-commerce-Design-System',
              fileName: 'E-commerce Design System v3.0'
            },
            platform: 'jira',
            documentType: 'component',
            teamStandards: {
              tech_stack: 'React 18 with TypeScript, Redux Toolkit, Material-UI v5, React Query for API calls, Framer Motion for animations',
              testing_framework: 'Jest + React Testing Library',
              accessibility_level: 'WCAG-AA',
              code_style: 'Prettier + ESLint with Airbnb config'
            },
            projectContext: {
              name: 'E-commerce Platform Redesign',
              repository: 'https://github.com/company/ecommerce-frontend',
              environment: 'development'
            }
          }
        };

        log('Sending complex context generation request...', 'info');
        log('Context includes: React+TS, Redux, Material-UI, animations, testing, accessibility', 'info');
        
        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(complexRequest)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.content && result.content[0] && result.content[0].text) {
          const generatedContent = result.content[0].text;
          const wordCount = generatedContent.split(/\s+/).length;
          
          // Check for complex context integration
          const contextElements = [
            'React',
            'TypeScript',
            'Redux',
            'Material-UI',
            'Jest',
            'WCAG',
            'Product Card',
            'Add to Cart'
          ];
          
          const contextScore = contextElements.reduce((score, element) => {
            return score + (generatedContent.toLowerCase().includes(element.toLowerCase()) ? 1 : 0);
          }, 0);
          
          const contextPercentage = Math.round((contextScore / contextElements.length) * 100);
          
          log(`‚úÖ Generated ${wordCount} words with ${contextScore}/${contextElements.length} context elements (${contextPercentage}%)`, 'success');
          showResult('complex-generation-result', 
            `‚úÖ Complex Generation: ${wordCount} words, ${contextPercentage}% context integration`, 
            contextPercentage >= 70 ? 'success' : 'error'
          );
          
          showGeneratedContent(generatedContent);
          testResults.push({ name: 'Complex Context Generation', passed: contextPercentage >= 70 });
        } else {
          throw new Error('Invalid response format');
        }

        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Complex context generation failed: ${error.message}`, 'error');
        showResult('complex-generation-result', `‚ùå Complex generation error: ${error.message}`, 'error');
        testResults.push({ name: 'Complex Context Generation', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Content Structure Test
    async function testContentStructure() {
      const startTime = Date.now();
      log('Testing content structure validation...');
      try {
        // This would typically test against generated content from previous tests
        const mockGeneratedContent = `
# Button Component Implementation

## üìã Overview
Implement the Button Component from the Design System

## üéØ Acceptance Criteria
- [ ] Component matches Figma design specifications
- [ ] Supports all button variants (primary, secondary, outline)
- [ ] Implements proper hover and focus states
- [ ] Passes accessibility tests (WCAG-AA)

## üõ†Ô∏è Technical Requirements
- **Framework**: React 18 with TypeScript
- **Styling**: Material-UI components
- **Testing**: Jest + React Testing Library

## ‚è±Ô∏è Estimation
- **Complexity**: Simple
- **Hours**: 2-3 hours
        `;

        const requiredSections = [
          '# ', // H1 title
          '## üìã Overview',
          '## üéØ Acceptance Criteria',
          '## üõ†Ô∏è Technical Requirements',
          '## ‚è±Ô∏è Estimation'
        ];

        let structureScore = 0;
        for (const section of requiredSections) {
          if (mockGeneratedContent.includes(section)) {
            structureScore++;
            log(`‚úì Found section: ${section.replace('## ', '').replace('# ', '')}`, 'info');
          } else {
            log(`‚úó Missing section: ${section.replace('## ', '').replace('# ', '')}`, 'warning');
          }
        }

        const structurePercentage = Math.round((structureScore / requiredSections.length) * 100);
        
        // Check for acceptance criteria format
        const hasCheckboxes = mockGeneratedContent.includes('- [ ]');
        const hasEmojis = /üìã|üéØ|üõ†Ô∏è|‚è±Ô∏è/.test(mockGeneratedContent);
        
        log(`Structure validation: ${structureScore}/${requiredSections.length} sections (${structurePercentage}%)`, 'success');
        log(`Checkboxes present: ${hasCheckboxes}`, hasCheckboxes ? 'success' : 'warning');
        log(`Visual indicators present: ${hasEmojis}`, hasEmojis ? 'success' : 'warning');
        
        const overallPass = structurePercentage >= 80 && hasCheckboxes && hasEmojis;
        
        showResult('content-structure-result', 
          `‚úÖ Structure: ${structurePercentage}% sections, checkboxes ${hasCheckboxes ? '‚úì' : '‚úó'}, emojis ${hasEmojis ? '‚úì' : '‚úó'}`, 
          overallPass ? 'success' : 'error'
        );
        
        testResults.push({ name: 'Content Structure', passed: overallPass });
        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Content structure test failed: ${error.message}`, 'error');
        showResult('content-structure-result', `‚ùå Structure error: ${error.message}`, 'error');
        testResults.push({ name: 'Content Structure', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Variable Substitution Test
    async function testVariableSubstitution() {
      const startTime = Date.now();
      log('Testing template variable substitution...');
      try {
        const templateVariables = [
          'component_name',
          'file_name',
          'tech_stack',
          'complexity',
          'hours',
          'confidence'
        ];

        // Mock template context
        const mockContext = {
          figma: { component_name: 'Test Component', file_name: 'Design File' },
          project: { tech_stack: ['React', 'TypeScript'] },
          calculated: { complexity: 'moderate', hours: 4, confidence: 85 }
        };

        let substitutionScore = 0;
        const mockTemplate = `
# {{figma.component_name}} Implementation

**File**: {{figma.file_name}}
**Tech Stack**: {{project.tech_stack}}
**Complexity**: {{calculated.complexity}}
**Hours**: {{calculated.hours}}
**Confidence**: {{calculated.confidence}}%
        `;

        // Simulate variable substitution
        let processedTemplate = mockTemplate;
        for (const variable of templateVariables) {
          const placeholder = `{{${variable}}}`;
          if (mockTemplate.includes(placeholder)) {
            substitutionScore++;
            log(`‚úì Variable found: ${variable}`, 'info');
            
            // Mock substitution
            switch (variable) {
              case 'component_name':
                processedTemplate = processedTemplate.replace('{{figma.component_name}}', mockContext.figma.component_name);
                break;
              case 'file_name':
                processedTemplate = processedTemplate.replace('{{figma.file_name}}', mockContext.figma.file_name);
                break;
              // ... other substitutions
            }
          }
        }

        const substitutionPercentage = Math.round((substitutionScore / templateVariables.length) * 100);
        log(`Variable substitution: ${substitutionScore}/${templateVariables.length} variables (${substitutionPercentage}%)`, 'success');
        
        showResult('variable-substitution-result', 
          `‚úÖ Variable Substitution: ${substitutionScore}/${templateVariables.length} variables processed (${substitutionPercentage}%)`, 
          'success'
        );
        
        testResults.push({ name: 'Variable Substitution', passed: substitutionPercentage >= 60 });
        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Variable substitution test failed: ${error.message}`, 'error');
        showResult('variable-substitution-result', `‚ùå Substitution error: ${error.message}`, 'error');
        testResults.push({ name: 'Variable Substitution', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Template Performance Test
    async function testTemplatePerformance() {
      const startTime = Date.now();
      log('Testing template performance...');
      try {
        const performanceTests = [];
        
        // Test multiple template generations
        for (let i = 0; i < 3; i++) {
          const testStart = Date.now();
          
          const testRequest = {
            method: 'generate_template_tickets',
            params: {
              frameData: [{ id: `test-${i}`, name: `Test Component ${i}`, type: 'COMPONENT' }],
              figmaContext: { figmaUrl: 'https://figma.com/test', fileName: 'Test File' },
              platform: 'jira',
              documentType: 'component',
              teamStandards: { tech_stack: 'React TypeScript' }
            }
          };

          try {
            const response = await fetch('http://localhost:3000/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(testRequest)
            });

            const testEnd = Date.now();
            const duration = testEnd - testStart;
            performanceTests.push({ test: i + 1, duration, success: response.ok });
            
            log(`Performance test ${i + 1}: ${duration}ms`, duration < 2000 ? 'success' : 'warning');
          } catch (error) {
            const testEnd = Date.now();
            const duration = testEnd - testStart;
            performanceTests.push({ test: i + 1, duration, success: false });
            log(`Performance test ${i + 1} failed: ${error.message}`, 'error');
          }
        }

        const avgDuration = performanceTests.reduce((sum, test) => sum + test.duration, 0) / performanceTests.length;
        const successCount = performanceTests.filter(test => test.success).length;
        const successRate = Math.round((successCount / performanceTests.length) * 100);

        log(`Average response time: ${Math.round(avgDuration)}ms`, avgDuration < 2000 ? 'success' : 'warning');
        log(`Success rate: ${successCount}/${performanceTests.length} (${successRate}%)`, 'success');

        const performanceGrade = avgDuration < 1000 ? 'Excellent' : avgDuration < 2000 ? 'Good' : 'Needs Improvement';
        
        showResult('template-performance-result', 
          `‚úÖ Performance: ${Math.round(avgDuration)}ms avg, ${successRate}% success rate (${performanceGrade})`, 
          avgDuration < 2000 ? 'success' : 'error'
        );
        
        testResults.push({ name: 'Template Performance', passed: avgDuration < 2000 && successRate >= 80 });
        testTimes.push(Date.now() - startTime);
        
      } catch (error) {
        log(`Template performance test failed: ${error.message}`, 'error');
        showResult('template-performance-result', `‚ùå Performance error: ${error.message}`, 'error');
        testResults.push({ name: 'Template Performance', passed: false });
        testTimes.push(Date.now() - startTime);
      }
    }

    // Scenario Test Functions
    async function runScenario1() {
      log('Running Scenario 1: React Component with Complex Props...');
      try {
        const scenario1Request = {
          method: 'generate_template_tickets',
          params: {
            frameData: [{
              id: 'scenario1-component',
              name: 'User Profile Card',
              type: 'COMPONENT',
              dimensions: { width: 320, height: 280 },
              children: [
                { name: 'Avatar Image', type: 'ELLIPSE' },
                { name: 'User Name', type: 'TEXT' },
                { name: 'User Title', type: 'TEXT' },
                { name: 'Action Buttons', type: 'FRAME' }
              ]
            }],
            figmaContext: {
              figmaUrl: 'https://figma.com/scenario1',
              fileName: 'User Interface Components'
            },
            platform: 'jira',
            documentType: 'component',
            teamStandards: {
              tech_stack: 'React 18 with TypeScript, Material-UI v5, Emotion for styling',
              testing_framework: 'Jest + React Testing Library',
              accessibility_level: 'WCAG-AA'
            }
          }
        };

        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(scenario1Request)
        });

        if (response.ok) {
          const result = await response.json();
          const content = result.content[0].text;
          showResult('scenario1-result', '‚úÖ Scenario 1 completed successfully', 'success');
          showGeneratedContent(content);
          log('‚úÖ Scenario 1: React component generated successfully', 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        showResult('scenario1-result', `‚ùå Scenario 1 failed: ${error.message}`, 'error');
        log(`‚ùå Scenario 1 failed: ${error.message}`, 'error');
      }
    }

    async function runScenario2() {
      log('Running Scenario 2: AEM Component with HTL Template...');
      try {
        const scenario2Request = {
          method: 'generate_template_tickets',
          params: {
            frameData: [{
              id: 'scenario2-component',
              name: 'Navigation Component',
              type: 'COMPONENT',
              dimensions: { width: 1200, height: 80 },
              children: [
                { name: 'Logo', type: 'INSTANCE' },
                { name: 'Menu Items', type: 'FRAME' },
                { name: 'Search Bar', type: 'COMPONENT' },
                { name: 'User Menu', type: 'COMPONENT' }
              ]
            }],
            figmaContext: {
              figmaUrl: 'https://figma.com/scenario2',
              fileName: 'AEM Component Library'
            },
            platform: 'jira',
            documentType: 'component',
            teamStandards: {
              tech_stack: 'AEM 6.5 with HTL (HTML Template Language), Apache Sling framework, OSGi bundles, JCR repository, Touch UI components'
            }
          }
        };

        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(scenario2Request)
        });

        if (response.ok) {
          const result = await response.json();
          const content = result.content[0].text;
          showResult('scenario2-result', '‚úÖ Scenario 2 completed successfully', 'success');
          showGeneratedContent(content);
          log('‚úÖ Scenario 2: AEM component generated successfully', 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        showResult('scenario2-result', `‚ùå Scenario 2 failed: ${error.message}`, 'error');
        log(`‚ùå Scenario 2 failed: ${error.message}`, 'error');
      }
    }

    async function runScenario3() {
      log('Running Scenario 3: Vue 3 Composition API Component...');
      try {
        const scenario3Request = {
          method: 'generate_template_tickets',
          params: {
            frameData: [{
              id: 'scenario3-component',
              name: 'Shopping Cart',
              type: 'COMPONENT',
              dimensions: { width: 400, height: 600 },
              children: [
                { name: 'Cart Header', type: 'FRAME' },
                { name: 'Cart Items List', type: 'FRAME' },
                { name: 'Cart Summary', type: 'FRAME' },
                { name: 'Checkout Button', type: 'COMPONENT' }
              ]
            }],
            figmaContext: {
              figmaUrl: 'https://figma.com/scenario3',
              fileName: 'E-commerce Vue Components'
            },
            platform: 'jira',
            documentType: 'component',
            teamStandards: {
              tech_stack: 'Vue 3 with Composition API, Pinia for state management, Vite build tool, Vitest for testing'
            }
          }
        };

        const response = await fetch('http://localhost:3000/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(scenario3Request)
        });

        if (response.ok) {
          const result = await response.json();
          const content = result.content[0].text;
          showResult('scenario3-result', '‚úÖ Scenario 3 completed successfully', 'success');
          showGeneratedContent(content);
          log('‚úÖ Scenario 3: Vue component generated successfully', 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        showResult('scenario3-result', `‚ùå Scenario 3 failed: ${error.message}`, 'error');
        log(`‚ùå Scenario 3 failed: ${error.message}`, 'error');
      }
    }

    // Comprehensive Test Runner
    async function runAllTemplateTests() {
      log('üöÄ Starting comprehensive template test suite...', 'success');
      
      // Reset test results
      testResults = [];
      testTimes = [];
      
      const tests = [
        { name: 'Template Engine Health', func: testTemplateEngineHealth },
        { name: 'Template Availability', func: testTemplateAvailability },
        { name: 'Smart Template Selection', func: testSmartTemplateSelection },
        { name: 'Basic Template Generation', func: testBasicTemplateGeneration },
        { name: 'AEM Template Generation', func: testAEMTemplateGeneration },
        { name: 'Complex Context Generation', func: testComplexContextGeneration },
        { name: 'Content Structure', func: testContentStructure },
        { name: 'Variable Substitution', func: testVariableSubstitution },
        { name: 'Template Performance', func: testTemplatePerformance }
      ];

      for (const test of tests) {
        try {
          log(`Running: ${test.name}...`, 'info');
          await test.func();
          await new Promise(resolve => setTimeout(resolve, 300)); // Small delay between tests
        } catch (error) {
          log(`‚ùå ${test.name} failed: ${error.message}`, 'error');
          testResults.push({ name: test.name, passed: false });
        }
      }

      const passedTests = testResults.filter(r => r.passed).length;
      const totalTests = testResults.length;
      const successRate = Math.round((passedTests / totalTests) * 100);

      log(`üéØ Template test suite complete: ${passedTests}/${totalTests} tests passed (${successRate}%)`, 
          successRate >= 80 ? 'success' : 'warning');
      
      showResult('all-tests-result', 
        `üéØ Template Test Suite: ${passedTests}/${totalTests} tests passed (${successRate}%)`, 
        successRate >= 80 ? 'success' : 'error'
      );

      updateTestMetrics();
    }

    // Auto-run basic tests on load
    document.addEventListener('DOMContentLoaded', () => {
      log('üéØ Template & LLM Integration Test Suite loaded', 'success');
      log('Features: Template engine, smart selection, LLM integration, context generation, performance testing', 'info');
      log('Click individual test buttons or run comprehensive test suite', 'info');
      
      // Auto-test template engine health after 1 second
      setTimeout(() => {
        testTemplateEngineHealth();
      }, 1000);
    });
  </script>
</body>
</html>