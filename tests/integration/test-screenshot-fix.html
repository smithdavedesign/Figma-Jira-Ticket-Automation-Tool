<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenshot Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .success {
            border-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .code {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>🖼️ Screenshot API Fix Test</h1>
    
    <div class="test-section">
        <h2>✅ Issues Fixed</h2>
        <ul>
            <li><strong>Figma API Key Configuration</strong>: Environment variable <code>FIGMA_API_KEY</code> is now properly set</li>
            <li><strong>Permission Policy Violations</strong>: Console warnings for camera, microphone, clipboard, etc. are now suppressed</li>
            <li><strong>Screenshot Functionality</strong>: Backend API now returns real Figma image URLs instead of errors</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🧪 API Test</h2>
        <p>Test the screenshot API with the actual Figma component:</p>
        <button onclick="testScreenshotAPI()">Test Screenshot API</button>
        <button onclick="testInvalidRequest()">Test Error Handling</button>
        
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>📋 Generated Ticket Example</h2>
        <p>Here's the properly formatted ticket that should now include a working image reference:</p>
        <div class="code">
# 🎫 Component: Why Solidigm?

**Priority**: Medium | **Story Points**: 5

**🔗 Figma Design**: [View Component](https://figma.com/file/BioUSVD6t51ZNeG0g9AcNz)

<!-- START: requirements -->
## 🎯 Objective
Implement the **Why Solidigm?** component from the design specifications in Design File.

## 📐 Design Specifications
- **Component Name**: Why Solidigm?
- **Dimensions**: 1763×1005px
- **Complexity**: simple

## 📊 Intelligence Analysis

**Estimated Complexity:** simple (4.1 hours)
├── 📊 **Confidence Level:** 70%
├── ⚡ **Similar Components:** BaseComponent, StandardComponent

<!-- END: requirements -->

<!-- START: acceptance_criteria -->
## ✅ Acceptance Criteria

✅ **Visual Accuracy**: Component matches design specifications exactly

📱 **Responsive Design**: Works across all supported breakpoints

♿ **Accessibility**: Meets WCAG-AA standards

🎨 **Design System Compliance**: Uses approved design tokens

🧪 **Testing**: Unit tests with jest-rtl

<!-- END: acceptance_criteria -->

<!-- START: image_reference -->
## 🖼️ Design Reference
![Component Screenshot](LIVE_FIGMA_IMAGE_URL)
<!-- END: image_reference -->
        </div>
    </div>

    <script>
        // Suppress permission policy violations like we did in the main UI
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('[Violation] Potential permissions policy violation') ||
                    message.includes('permissions policy violation') ||
                    message.includes('camera is not allowed') ||
                    message.includes('microphone is not allowed') ||
                    message.includes('clipboard-write is not allowed') ||
                    message.includes('display-capture is not allowed')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();

        async function testScreenshotAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>🔄 Testing screenshot API...</p>';
            
            try {
                const response = await fetch('http://localhost:3000/api/figma/screenshot?fileKey=BioUSVD6t51ZNeG0g9AcNz&nodeId=I5921%3A26923%3B2587%3A12465&format=png&scale=2');
                const data = await response.json();
                
                if (response.ok && data.imageUrl) {
                    resultsDiv.innerHTML = `
                        <div class="test-section success">
                            <h3>✅ API Test Successful</h3>
                            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                            <p><strong>Image URL:</strong> <a href="${data.imageUrl}" target="_blank">${data.imageUrl.substring(0, 50)}...</a></p>
                            <p><strong>Cached:</strong> ${data.cached ? 'Yes' : 'No'}</p>
                            ${data.metadata ? `<p><strong>Request Time:</strong> ${data.metadata.requestTime}ms</p>` : ''}
                            <h4>📸 Live Figma Image:</h4>
                            <img src="${data.imageUrl}" alt="Figma Component Screenshot" style="max-width: 400px;" />
                        </div>
                    `;
                } else {
                    throw new Error(`API returned: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>❌ API Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure the server is running on port 3000</p>
                    </div>
                `;
            }
        }

        async function testInvalidRequest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>🔄 Testing error handling...</p>';
            
            try {
                const response = await fetch('http://localhost:3000/api/figma/screenshot?fileKey=invalid&nodeId=invalid&format=png&scale=2');
                const data = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="test-section">
                        <h3>✅ Error Handling Test</h3>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Error Message:</strong> ${data.message}</p>
                        <p>✅ Server properly handles invalid requests with meaningful error messages</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>❌ Error Handling Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('🧪 Running automatic screenshot API test...');
                testScreenshotAPI();
            }, 1000);
        });
    </script>
</body>
</html>