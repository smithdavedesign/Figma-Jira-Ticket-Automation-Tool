<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Ticket Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      line-height: 1.4;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    h1 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--figma-color-text);
    }
    
    .subtitle {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      margin-bottom: 16px;
    }
    
    .config-section {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .config-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 12px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--figma-color-border-selected);
      box-shadow: 0 0 0 1px var(--figma-color-border-selected);
    }
    
    .button {
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .button:hover {
      background: var(--figma-color-bg-brand-hover);
    }
    
    .button:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      cursor: not-allowed;
    }
    
    .button-secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .button-secondary:hover {
      background: var(--figma-color-bg-hover);
    }
    
    .output-section {
      margin-top: 16px;
    }
    
    #output {
      min-height: 200px;
      resize: vertical;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 11px;
    }
    
    .status.error {
      background: var(--figma-color-bg-danger);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-danger);
    }
    
    .status.success {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-success);
    }
    
    .status.loading {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .hidden {
      display: none;
    }
    
    .frame-info {
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      border-left: 3px solid var(--figma-color-bg-brand);
      font-size: 11px;
    }
    
    .frame-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .frame-details {
      color: var(--figma-color-text-secondary);
    }
    
    .template-select {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🎫 AI Ticket Generator</h1>
    <div class="subtitle">Generate Jira tickets from selected Figma frames</div>
  </div>

  <div class="config-section">
    <div class="config-title">AI Configuration</div>
    
    <div class="form-group">
      <label for="apiKey">OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>
    
    <div class="form-group">
      <label for="model">Model</label>
      <select id="model">
        <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
        <option value="gpt-4o">GPT-4o</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
      </select>
    </div>
  </div>

  <div class="config-section">
    <div class="config-title">Ticket Template</div>
    
    <div class="form-group template-select">
      <label for="template">Template Type</label>
      <select id="template">
        <option value="component">UI Component</option>
        <option value="feature">Feature Implementation</option>
        <option value="bug">Bug Fix</option>
        <option value="page">Page/Screen</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="customPrompt">Additional Instructions (Optional)</label>
      <textarea id="customPrompt" rows="3" placeholder="e.g., Include accessibility requirements, use specific design tokens..."></textarea>
    </div>
  </div>

  <div id="frameInfo" class="hidden"></div>

  <div id="status" class="hidden"></div>

  <button id="generate" class="button">
    📋 Generate Ticket from Selection
  </button>

  <div class="output-section">
    <label for="output">Generated Ticket</label>
    <textarea id="output" placeholder="Select frames in Figma and click 'Generate Ticket' to create a Jira ticket draft..."></textarea>
    
    <button id="copy" class="button button-secondary" disabled>
      📋 Copy to Clipboard
    </button>
  </div>

  <script>
    // UI Elements
    const generateBtn = document.getElementById('generate');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy');
    const apiKeyInput = document.getElementById('apiKey');
    const modelSelect = document.getElementById('model');
    const templateSelect = document.getElementById('template');
    const customPromptInput = document.getElementById('customPrompt');
    const statusDiv = document.getElementById('status');
    const frameInfoDiv = document.getElementById('frameInfo');

    // State
    let frameDataList = [];
    let isGenerating = false;

    // Load saved settings
    loadSettings();

    // Event listeners
    generateBtn.onclick = generateTicket;
    copyBtn.onclick = copyToClipboard;
    apiKeyInput.onchange = saveSettings;
    modelSelect.onchange = saveSettings;
    templateSelect.onchange = saveSettings;

    // Message handling from Figma plugin
    onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'frame-data') {
        frameDataList = msg.data;
        displayFrameInfo(frameDataList);
        await generateAITicket();
      }

      if (msg.type === 'error') {
        showStatus(msg.message, 'error');
        setGenerating(false);
      }
    };

    function generateTicket() {
      if (isGenerating) return;
      
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        showStatus('Please enter your OpenAI API key', 'error');
        return;
      }

      setGenerating(true);
      showStatus('Reading selected frames...', 'loading');
      
      // Request frame data from Figma
      parent.postMessage({ 
        pluginMessage: { type: 'generate-ticket' } 
      }, '*');
    }

    async function generateAITicket() {
      if (!frameDataList.length) {
        showStatus('No frame data received', 'error');
        setGenerating(false);
        return;
      }

      try {
        showStatus('Generating ticket with AI...', 'loading');
        
        const prompt = createPrompt(frameDataList);
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { 
                role: 'system', 
                content: 'You are a UX/UI ticket assistant. Generate clean, structured Jira tickets from Figma design context. Focus on implementation details, acceptance criteria, and technical requirements.' 
              },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 1000
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || `API request failed: ${response.status}`);
        }

        const data = await response.json();
        const ticket = data.choices[0].message.content.trim();
        
        output.value = ticket;
        copyBtn.disabled = false;
        showStatus('Ticket generated successfully!', 'success');
        
      } catch (error) {
        console.error('Error generating ticket:', error);
        showStatus(`Error: ${error.message}`, 'error');
      } finally {
        setGenerating(false);
      }
    }

    function createPrompt(frameDataList) {
      const template = templateSelect.value;
      const customInstructions = customPromptInput.value.trim();
      
      let basePrompt = '';
      
      switch (template) {
        case 'component':
          basePrompt = 'Generate a Jira ticket for implementing a UI component based on the following Figma design:';
          break;
        case 'feature':
          basePrompt = 'Generate a Jira ticket for implementing a new feature based on the following Figma design:';
          break;
        case 'bug':
          basePrompt = 'Generate a Jira ticket for fixing a UI/UX issue based on the following Figma design:';
          break;
        case 'page':
          basePrompt = 'Generate a Jira ticket for implementing a page/screen based on the following Figma design:';
          break;
        default:
          basePrompt = 'Generate a Jira ticket based on the following Figma design:';
      }

      let prompt = basePrompt + '\\n\\n';

      frameDataList.forEach((frame, index) => {
        prompt += `**Frame ${index + 1}: ${frame.name}**\\n`;
        prompt += `- Page: ${frame.pageName}\\n`;
        prompt += `- Type: ${frame.type}\\n`;
        prompt += `- Dimensions: ${frame.dimensions.width}x${frame.dimensions.height}px\\n`;
        prompt += `- Child elements: ${frame.nodeCount}\\n`;
        
        if (frame.textContent.length > 0) {
          prompt += `- Text content: ${frame.textContent.map(t => `"${t.content}"`).join(', ')}\\n`;
        }
        
        if (frame.components.length > 0) {
          prompt += `- Components used: ${frame.components.map(c => c.masterComponent).join(', ')}\\n`;
        }
        
        if (frame.colors.length > 0) {
          prompt += `- Colors: ${frame.colors.join(', ')}\\n`;
        }
        
        if (frame.hasPrototype) {
          prompt += `- Has interactive prototype\\n`;
        }
        
        // Create proper Figma deep link
        const figmaLink = `https://www.figma.com/design/${frame.fileKey}/?node-id=${encodeURIComponent(frame.id)}&t=${Date.now()}`;
        prompt += `- Figma link: ${figmaLink}\\n`;
        prompt += `- Frame ID: ${frame.id} (for developer reference)\\n\\n`;
      });

      if (customInstructions) {
        prompt += `**Additional Requirements:**\\n${customInstructions}\\n\\n`;
      }

      prompt += `Please format the response as:\\n\\n`;
      prompt += `**Title:** [Concise ticket title]\\n\\n`;
      prompt += `**Description:**\\n[Detailed description with context and requirements]\\n\\n`;
      prompt += `**Figma Reference:**\\n[Include the Figma link and frame details for easy access]\\n\\n`;
      prompt += `**Acceptance Criteria:**\\n1. [Specific, testable criteria]\\n2. [Another criteria]\\n3. [etc.]\\n\\n`;
      prompt += `**Technical Notes:**\\n[Any implementation details, dependencies, or considerations]\\n\\n`;
      prompt += `**Design Specs:**\\n[Key measurements, colors, fonts, and visual requirements from the Figma frame]`;

      return prompt;
    }

    function displayFrameInfo(frameDataList) {
      if (!frameDataList.length) {
        frameInfoDiv.classList.add('hidden');
        return;
      }

      let html = '';
      frameDataList.forEach((frame, index) => {
        html += `
          <div class="frame-info">
            <div class="frame-name">${frame.name}</div>
            <div class="frame-details">
              ${frame.type} • ${frame.dimensions.width}x${frame.dimensions.height}px • ${frame.nodeCount} elements
            </div>
          </div>
        `;
      });

      frameInfoDiv.innerHTML = html;
      frameInfoDiv.classList.remove('hidden');
    }

    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }

    function setGenerating(generating) {
      isGenerating = generating;
      generateBtn.disabled = generating;
      generateBtn.textContent = generating ? '⏳ Generating...' : '📋 Generate Ticket from Selection';
    }

    function copyToClipboard() {
      if (output.value.trim()) {
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(output.value).then(() => {
            showStatus('Copied to clipboard!', 'success');
          }).catch(() => {
            // Fallback to legacy method
            fallbackCopyToClipboard();
          });
        } else {
          // Use fallback method
          fallbackCopyToClipboard();
        }
      }
    }

    function fallbackCopyToClipboard() {
      try {
        // Create a temporary textarea element
        const textArea = document.createElement('textarea');
        textArea.value = output.value;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        
        // Select and copy the text
        textArea.focus();
        textArea.select();
        
        // Try the legacy execCommand
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
          showStatus('Copied to clipboard!', 'success');
        } else {
          // If all else fails, select the text for manual copying
          output.select();
          output.setSelectionRange(0, 99999); // For mobile devices
          showStatus('Text selected - press Ctrl+C (or Cmd+C) to copy', 'error');
        }
      } catch (error) {
        // Final fallback - just select the text
        output.select();
        output.setSelectionRange(0, 99999);
        showStatus('Text selected - press Ctrl+C (or Cmd+C) to copy', 'error');
      }
    }

    // Check if localStorage is available
    function isLocalStorageAvailable() {
      try {
        const test = '__localStorage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch(e) {
        return false;
      }
    }

    function saveSettings() {
      const settings = {
        apiKey: apiKeyInput.value,
        model: modelSelect.value,
        template: templateSelect.value
      };
      
      if (isLocalStorageAvailable()) {
        try {
          localStorage.setItem('aiTicketGenerator', JSON.stringify(settings));
        } catch (error) {
          // Fallback to session storage
          window.tempSettings = settings;
        }
      } else {
        // Store in memory for session
        window.tempSettings = settings;
      }
    }

    function loadSettings() {
      if (isLocalStorageAvailable()) {
        try {
          const settings = JSON.parse(localStorage.getItem('aiTicketGenerator') || '{}');
          if (settings.apiKey) apiKeyInput.value = settings.apiKey;
          if (settings.model) modelSelect.value = settings.model;
          if (settings.template) templateSelect.value = settings.template;
          return; // Exit early if localStorage worked
        } catch (error) {
          // Continue to fallback
        }
      }
      
      // Fallback: try session storage
      if (window.tempSettings) {
        const settings = window.tempSettings;
        if (settings.apiKey) apiKeyInput.value = settings.apiKey;
        if (settings.model) modelSelect.value = settings.model;
        if (settings.template) templateSelect.value = settings.template;
      }
    }
  </script>
</body>
</html>