<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Ticket Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      line-height: 1.4;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    h1 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--figma-color-text);
    }
    
    .subtitle {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      margin-bottom: 16px;
    }
    
    .config-section {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .config-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 12px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--figma-color-border-selected);
      box-shadow: 0 0 0 1px var(--figma-color-border-selected);
    }
    
    .button {
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .button:hover {
      background: var(--figma-color-bg-brand-hover);
    }
    
    .button:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      cursor: not-allowed;
    }
    
    .button-secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .button-secondary:hover {
      background: var(--figma-color-bg-hover);
    }
    
    .output-section {
      margin-top: 16px;
    }
    
    #output {
      min-height: 200px;
      resize: vertical;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 11px;
    }
    
    .status.error {
      background: var(--figma-color-bg-danger);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-danger);
    }
    
    .status.success {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-success);
    }
    
    .status.loading {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .hidden {
      display: none;
    }
    
    .frame-info {
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      border-left: 3px solid var(--figma-color-bg-brand);
      font-size: 11px;
    }
    
    .frame-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .frame-details {
      color: var(--figma-color-text-secondary);
    }
    
    .template-select {
      margin-bottom: 16px;
    }
    
    /* Design System Styles */
    .design-system-detected {
      background: linear-gradient(135deg, var(--figma-color-bg-success-tertiary), var(--figma-color-bg-brand-tertiary));
      border: 1px solid var(--figma-color-border-success);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .ds-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .ds-name {
      font-weight: 600;
      color: var(--figma-color-text);
      font-size: 13px;
    }
    
    .ds-confidence {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
    }
    
    .ds-stats {
      display: flex;
      gap: 12px;
    }
    
    .ds-stat {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }
    
    .compliance-info {
      background: var(--figma-color-bg-tertiary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }
    
    .compliance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .compliance-title {
      font-weight: 600;
      font-size: 12px;
    }
    
    .compliance-score {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }
    
    .compliance-breakdown {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .compliance-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: var(--figma-color-bg);
      border-radius: 4px;
      border: 1px solid var(--figma-color-border);
    }
    
    .item-label {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 2px;
    }
    
    .item-score {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 8px;
      color: white;
    }
    
    .recommendations {
      border-top: 1px solid var(--figma-color-border);
      padding-top: 12px;
    }
    
    .rec-title {
      font-weight: 600;
      font-size: 11px;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }
    
    .rec-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .rec-item {
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid;
    }
    
    .rec-item.high {
      background: var(--figma-color-bg-danger-tertiary);
      border-left-color: var(--figma-color-bg-danger);
    }
    
    .rec-item.medium {
      background: var(--figma-color-bg-warning-tertiary);
      border-left-color: var(--figma-color-bg-warning);
    }
    
    .rec-item.low {
      background: var(--figma-color-bg-success-tertiary);
      border-left-color: var(--figma-color-bg-success);
    }
    
    .rec-message {
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--figma-color-text);
    }
    
    .rec-suggestion {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
  </style>    /* Design System Styles */
    .design-system-detected {
      background: linear-gradient(135deg, var(--figma-color-bg-success-tertiary), var(--figma-color-bg-brand-tertiary));
      border: 1px solid var(--figma-color-border-success);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .ds-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .ds-name {
      font-weight: 600;
      color: var(--figma-color-text);
      font-size: 12px;
    }
    
    .ds-confidence {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }
    
    .ds-stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .ds-stat {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      border: 1px solid var(--figma-color-border);
    }
    
    .compliance-info {
      background: var(--figma-color-bg-tertiary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
    }
    
    .compliance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .compliance-title {
      font-weight: 600;
      font-size: 12px;
    }
    
    .compliance-score {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .compliance-breakdown {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .compliance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }
    
    .item-label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
    
    .item-score {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--figma-color-bg-secondary);
    }
    
    .recommendations {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--figma-color-border);
    }
    
    .rec-title {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }
    
    .rec-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .rec-item {
      background: var(--figma-color-bg-warning-tertiary);
      border: 1px solid var(--figma-color-border-warning);
      border-radius: 4px;
      padding: 8px;
      font-size: 10px;
      line-height: 1.3;
    }
    
    .rec-item.high {
      background: var(--figma-color-bg-danger-tertiary);
      border-color: var(--figma-color-border-danger);
    }
    
    .rec-item.medium {
      background: var(--figma-color-bg-warning-tertiary);
      border-color: var(--figma-color-border-warning);
    }
    
    .rec-item.low {
      background: var(--figma-color-bg-secondary);
      border-color: var(--figma-color-border);
    }
    
    .rec-message {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .rec-suggestion {
      color: var(--figma-color-text-secondary);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸŽ« AI Ticket Generator</h1>
    <div class="subtitle">Generate Jira tickets from selected Figma frames</div>
  </div>

  <div class="config-section">
    <div class="config-title">AI Configuration</div>
    
    <div class="form-group">
      <label for="apiKey">OpenAI API Key</label>
      <input type="password" id="apiKey" placeholder="sk-..." />
    </div>
    
    <div class="form-group">
      <label for="model">Model</label>
      <select id="model">
        <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
        <option value="gpt-4o">GPT-4o</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
      </select>
    </div>
  </div>

  <div class="config-section">
    <div class="config-title">Ticket Template</div>
    
    <div class="form-group template-select">
      <label for="template">Template Type</label>
      <select id="template">
        <option value="component">UI Component</option>
        <option value="feature">Feature Implementation</option>
        <option value="bug">Bug Fix</option>
        <option value="page">Page/Screen</option>
        <option value="custom">Custom</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="customPrompt">Additional Instructions (Optional)</label>
      <textarea id="customPrompt" rows="3" placeholder="e.g., Include accessibility requirements, use specific design tokens..."></textarea>
    </div>
  </div>

  <!-- Design System Section -->
  <div id="designSystemSection" class="config-section hidden">
    <div class="config-title">ðŸŽ¨ Design System Integration</div>
    
    <div id="designSystemInfo">
      <div class="design-system-detected">
        <div class="ds-header">
          <span class="ds-name" id="dsName">Design System Detected</span>
          <span class="ds-confidence" id="dsConfidence">85%</span>
        </div>
        <div class="ds-stats">
          <span class="ds-stat" id="dsColors">12 colors</span>
          <span class="ds-stat" id="dsTypography">8 text styles</span>
          <span class="ds-stat" id="dsComponents">24 components</span>
        </div>
      </div>
    </div>

    <div id="complianceInfo" class="compliance-info hidden">
      <div class="compliance-header">
        <span class="compliance-title">Compliance Analysis</span>
        <span class="compliance-score" id="complianceScore">92%</span>
      </div>
      <div class="compliance-breakdown">
        <div class="compliance-item">
          <span class="item-label">Colors:</span>
          <span class="item-score" id="colorScore">95%</span>
        </div>
        <div class="compliance-item">
          <span class="item-label">Typography:</span>
          <span class="item-score" id="typographyScore">88%</span>
        </div>
        <div class="compliance-item">
          <span class="item-label">Components:</span>
          <span class="item-score" id="componentScore">94%</span>
        </div>
      </div>
      
      <div id="recommendations" class="recommendations hidden">
        <div class="rec-title">Recommendations:</div>
        <div id="recList" class="rec-list"></div>
      </div>
    </div>
  </div>

  <div id="frameInfo" class="hidden"></div>

  <div id="status" class="hidden"></div>

  <button id="generate" class="button">
    ðŸ“‹ Generate Ticket from Selection
  </button>

  <div class="output-section">
    <label for="output">Generated Ticket</label>
    <textarea id="output" placeholder="Select frames in Figma and click 'Generate Ticket' to create a Jira ticket draft..."></textarea>
    
    <button id="copy" class="button button-secondary" disabled>
      ðŸ“‹ Copy to Clipboard
    </button>
  </div>

  <script>
    // UI Elements
    const generateBtn = document.getElementById('generate');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy');
    const apiKeyInput = document.getElementById('apiKey');
    const modelSelect = document.getElementById('model');
    const templateSelect = document.getElementById('template');
    const customPromptInput = document.getElementById('customPrompt');
    const statusDiv = document.getElementById('status');
    const frameInfoDiv = document.getElementById('frameInfo');

    // State
    let frameDataList = [];
    let isGenerating = false;

    // Load saved settings
    loadSettings();

    // Event listeners
    generateBtn.onclick = generateTicket;
    copyBtn.onclick = copyToClipboard;
    apiKeyInput.onchange = saveSettings;
    modelSelect.onchange = saveSettings;
    templateSelect.onchange = saveSettings;

    // Message handling from Figma plugin
    onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'frame-data') {
        frameDataList = msg.data;
        displayFrameInfo(frameDataList);
        displayComplianceInfo(frameDataList);
        await generateAITicket();
      }

      if (msg.type === 'error') {
        showStatus(msg.message, 'error');
        setGenerating(false);
      }

      if (msg.type === 'design-system-detected') {
        displayDesignSystemInfo(msg.designSystem);
      }

      if (msg.type === 'no-design-system') {
        hideDesignSystemSection();
      }
    };

    function generateTicket() {
      if (isGenerating) return;
      
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        showStatus('Please enter your OpenAI API key', 'error');
        return;
      }

      setGenerating(true);
      showStatus('Reading selected frames...', 'loading');
      
      // Request frame data from Figma
      parent.postMessage({ 
        pluginMessage: { type: 'generate-ticket' } 
      }, '*');
    }

    async function generateAITicket() {
      if (!frameDataList.length) {
        showStatus('No frame data received', 'error');
        setGenerating(false);
        return;
      }

      try {
        showStatus('Generating ticket with AI...', 'loading');
        
        const prompt = createPrompt(frameDataList);
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { 
                role: 'system', 
                content: 'You are a UX/UI ticket assistant. Generate clean, structured Jira tickets from Figma design context. Focus on implementation details, acceptance criteria, and technical requirements.' 
              },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 1000
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || `API request failed: ${response.status}`);
        }

        const data = await response.json();
        const ticket = data.choices[0].message.content.trim();
        
        output.value = ticket;
        copyBtn.disabled = false;
        showStatus('Ticket generated successfully!', 'success');
        
      } catch (error) {
        console.error('Error generating ticket:', error);
        showStatus(`Error: ${error.message}`, 'error');
      } finally {
        setGenerating(false);
      }
    }

    function createPrompt(frameDataList) {
      const template = templateSelect.value;
      const customInstructions = customPromptInput.value.trim();
      
      let basePrompt = '';
      
      switch (template) {
        case 'component':
          basePrompt = 'Generate a Jira ticket for implementing a UI component based on the following Figma design:';
          break;
        case 'feature':
          basePrompt = 'Generate a Jira ticket for implementing a new feature based on the following Figma design:';
          break;
        case 'bug':
          basePrompt = 'Generate a Jira ticket for fixing a UI/UX issue based on the following Figma design:';
          break;
        case 'page':
          basePrompt = 'Generate a Jira ticket for implementing a page/screen based on the following Figma design:';
          break;
        default:
          basePrompt = 'Generate a Jira ticket based on the following Figma design:';
      }

      let prompt = basePrompt + '\\n\\n';

      frameDataList.forEach((frame, index) => {
        prompt += `**Frame ${index + 1}: ${frame.name}**\\n`;
        prompt += `- Page: ${frame.pageName}\\n`;
        prompt += `- Type: ${frame.type}\\n`;
        prompt += `- Dimensions: ${frame.dimensions.width}x${frame.dimensions.height}px\\n`;
        prompt += `- Child elements: ${frame.nodeCount}\\n`;
        
        if (frame.textContent.length > 0) {
          prompt += `- Text content: ${frame.textContent.map(t => `"${t.content}"`).join(', ')}\\n`;
        }
        
        if (frame.components.length > 0) {
          prompt += `- Components used: ${frame.components.map(c => c.masterComponent).join(', ')}\\n`;
        }
        
        if (frame.colors.length > 0) {
          prompt += `- Colors: ${frame.colors.join(', ')}\\n`;
        }
        
        if (frame.hasPrototype) {
          prompt += `- Has interactive prototype\\n`;
        }

        // Add design system context if available
        if (frame.designSystemContext) {
          const context = frame.designSystemContext;
          
          if (context.designSystem) {
            prompt += `\\n**Design System Information:**\\n`;
            prompt += `- Design System: ${context.designSystem.name}\\n`;
            prompt += `- Detection Confidence: ${Math.round(context.designSystem.detectionConfidence * 100)}%\\n`;
          }

          if (context.complianceReport) {
            const report = context.complianceReport;
            prompt += `\\n**Design System Compliance:**\\n`;
            prompt += `- Overall Score: ${report.overallScore}%\\n`;
            prompt += `- Color Compliance: ${report.colorCompliance.score}% (${report.colorCompliance.tokenizedColors}/${report.colorCompliance.totalColors} using tokens)\\n`;
            prompt += `- Typography Compliance: ${report.typographyCompliance.score}% (${report.typographyCompliance.tokenizedText}/${report.typographyCompliance.totalTextElements} using styles)\\n`;
            prompt += `- Component Compliance: ${report.componentCompliance.score}% (${report.componentCompliance.standardComponents}/${report.componentCompliance.totalComponents} standard components)\\n`;
          }

          if (context.usedTokens && context.usedTokens.length > 0) {
            prompt += `\\n**Design Tokens Used:**\\n`;
            context.usedTokens.forEach(token => {
              prompt += `- ${token.name} (${token.type})\\n`;
            });
          }

          if (context.violations && context.violations.length > 0) {
            prompt += `\\n**Design System Violations:**\\n`;
            context.violations.forEach(violation => {
              prompt += `- ${violation.description}\\n`;
              prompt += `  Suggested Fix: ${violation.suggestedFix}\\n`;
            });
          }

          if (context.recommendations && context.recommendations.length > 0) {
            prompt += `\\n**Design System Recommendations:**\\n`;
            context.recommendations.slice(0, 3).forEach(rec => { // Limit to top 3
              prompt += `- [${rec.severity.toUpperCase()}] ${rec.message}\\n`;
              prompt += `  Suggestion: ${rec.suggestion}\\n`;
            });
          }
        }
        
        // Create proper Figma deep link
        const figmaLink = `https://www.figma.com/design/${frame.fileKey}/?node-id=${encodeURIComponent(frame.id)}&t=${Date.now()}`;
        prompt += `\\n- Figma link: ${figmaLink}\\n`;
        prompt += `- Frame ID: ${frame.id} (for developer reference)\\n\\n`;
      });

      if (customInstructions) {
        prompt += `**Additional Requirements:**\\n${customInstructions}\\n\\n`;
      }

      prompt += `Please format the response as:\\n\\n`;
      prompt += `**Title:** [Concise ticket title]\\n\\n`;
      prompt += `**Description:**\\n[Detailed description with context and requirements]\\n\\n`;
      prompt += `**Figma Reference:**\\n[Include the Figma link and frame details for easy access]\\n\\n`;
      prompt += `**Acceptance Criteria:**\\n1. [Specific, testable criteria]\\n2. [Another criteria]\\n3. [etc.]\\n\\n`;
      prompt += `**Technical Notes:**\\n[Any implementation details, dependencies, or considerations]\\n\\n`;
      prompt += `**Design Specs:**\\n[Key measurements, colors, fonts, and visual requirements from the Figma frame]\\n\\n`;
      
      // Add design system specific instructions if we have design system data
      const hasDesignSystemData = frameDataList.some(frame => frame.designSystemContext);
      if (hasDesignSystemData) {
        prompt += `**Design System Compliance:**\\n[Address any violations mentioned above and ensure implementation follows the design system standards. Reference specific tokens and components where applicable.]\\n\\n`;
        prompt += `**Design System Notes:**\\n[Include specific design token names, component variants, and compliance recommendations to maintain consistency with the established design system.]`;
      }

      return prompt;
    }

    function displayFrameInfo(frameDataList) {
      if (!frameDataList.length) {
        frameInfoDiv.classList.add('hidden');
        return;
      }

      let html = '';
      frameDataList.forEach((frame, index) => {
        html += `
          <div class="frame-info">
            <div class="frame-name">${frame.name}</div>
            <div class="frame-details">
              ${frame.type} â€¢ ${frame.dimensions.width}x${frame.dimensions.height}px â€¢ ${frame.nodeCount} elements
            </div>
          </div>
        `;
      });

      frameInfoDiv.innerHTML = html;
      frameInfoDiv.classList.remove('hidden');
    }

    function displayDesignSystemInfo(designSystem) {
      const section = document.getElementById('designSystemSection');
      const dsName = document.getElementById('dsName');
      const dsConfidence = document.getElementById('dsConfidence');
      const dsColors = document.getElementById('dsColors');
      const dsTypography = document.getElementById('dsTypography');
      const dsComponents = document.getElementById('dsComponents');

      dsName.textContent = designSystem.name;
      dsConfidence.textContent = `${Math.round(designSystem.detectionConfidence * 100)}%`;
      dsColors.textContent = `${designSystem.colors.length} colors`;
      dsTypography.textContent = `${designSystem.typography.length} text styles`;
      dsComponents.textContent = `${designSystem.components.components.length} components`;

      section.classList.remove('hidden');
    }

    function displayComplianceInfo(frameDataList) {
      const complianceInfo = document.getElementById('complianceInfo');
      const complianceScore = document.getElementById('complianceScore');
      const colorScore = document.getElementById('colorScore');
      const typographyScore = document.getElementById('typographyScore');
      const componentScore = document.getElementById('componentScore');
      const recommendations = document.getElementById('recommendations');
      const recList = document.getElementById('recList');

      // Find frames with design system context
      const framesWithContext = frameDataList.filter(frame => 
        frame.designSystemContext && frame.designSystemContext.complianceReport
      );

      if (framesWithContext.length === 0) {
        complianceInfo.classList.add('hidden');
        return;
      }

      // Calculate average scores
      let totalOverall = 0;
      let totalColor = 0;
      let totalTypography = 0;
      let totalComponent = 0;
      let allRecommendations = [];

      framesWithContext.forEach(frame => {
        const report = frame.designSystemContext.complianceReport;
        totalOverall += report.overallScore;
        totalColor += report.colorCompliance.score;
        totalTypography += report.typographyCompliance.score;
        totalComponent += report.componentCompliance.score;
        allRecommendations = allRecommendations.concat(report.recommendations);
      });

      const count = framesWithContext.length;
      const avgOverall = Math.round(totalOverall / count);
      const avgColor = Math.round(totalColor / count);
      const avgTypography = Math.round(totalTypography / count);
      const avgComponent = Math.round(totalComponent / count);

      complianceScore.textContent = `${avgOverall}%`;
      colorScore.textContent = `${avgColor}%`;
      typographyScore.textContent = `${avgTypography}%`;
      componentScore.textContent = `${avgComponent}%`;

      // Color code the scores
      complianceScore.style.background = getScoreColor(avgOverall);
      colorScore.style.background = getScoreColor(avgColor);
      typographyScore.style.background = getScoreColor(avgTypography);
      componentScore.style.background = getScoreColor(avgComponent);

      // Display recommendations
      if (allRecommendations.length > 0) {
        let recHtml = '';
        allRecommendations.slice(0, 3).forEach(rec => { // Show max 3 recommendations
          recHtml += `
            <div class="rec-item ${rec.severity}">
              <div class="rec-message">${rec.message}</div>
              <div class="rec-suggestion">${rec.suggestion}</div>
            </div>
          `;
        });
        recList.innerHTML = recHtml;
        recommendations.classList.remove('hidden');
      } else {
        recommendations.classList.add('hidden');
      }

      complianceInfo.classList.remove('hidden');
    }

    function getScoreColor(score) {
      if (score >= 90) return 'var(--figma-color-bg-success)';
      if (score >= 70) return 'var(--figma-color-bg-warning)';
      return 'var(--figma-color-bg-danger)';
    }

    function hideDesignSystemSection() {
      const section = document.getElementById('designSystemSection');
      section.classList.add('hidden');
    }

    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }

    function setGenerating(generating) {
      isGenerating = generating;
      generateBtn.disabled = generating;
      generateBtn.textContent = generating ? 'â³ Generating...' : 'ðŸ“‹ Generate Ticket from Selection';
    }

    function copyToClipboard() {
      if (output.value.trim()) {
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(output.value).then(() => {
            showStatus('Copied to clipboard!', 'success');
          }).catch(() => {
            // Fallback to legacy method
            fallbackCopyToClipboard();
          });
        } else {
          // Use fallback method
          fallbackCopyToClipboard();
        }
      }
    }

    function fallbackCopyToClipboard() {
      try {
        // Create a temporary textarea element
        const textArea = document.createElement('textarea');
        textArea.value = output.value;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        
        // Select and copy the text
        textArea.focus();
        textArea.select();
        
        // Try the legacy execCommand
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
          showStatus('Copied to clipboard!', 'success');
        } else {
          // If all else fails, select the text for manual copying
          output.select();
          output.setSelectionRange(0, 99999); // For mobile devices
          showStatus('Text selected - press Ctrl+C (or Cmd+C) to copy', 'error');
        }
      } catch (error) {
        // Final fallback - just select the text
        output.select();
        output.setSelectionRange(0, 99999);
        showStatus('Text selected - press Ctrl+C (or Cmd+C) to copy', 'error');
      }
    }

    // Check if localStorage is available
    function isLocalStorageAvailable() {
      try {
        const test = '__localStorage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch(e) {
        return false;
      }
    }

    function saveSettings() {
      const settings = {
        apiKey: apiKeyInput.value,
        model: modelSelect.value,
        template: templateSelect.value
      };
      
      if (isLocalStorageAvailable()) {
        try {
          localStorage.setItem('aiTicketGenerator', JSON.stringify(settings));
        } catch (error) {
          // Fallback to session storage
          window.tempSettings = settings;
        }
      } else {
        // Store in memory for session
        window.tempSettings = settings;
      }
    }

    function loadSettings() {
      if (isLocalStorageAvailable()) {
        try {
          const settings = JSON.parse(localStorage.getItem('aiTicketGenerator') || '{}');
          if (settings.apiKey) apiKeyInput.value = settings.apiKey;
          if (settings.model) modelSelect.value = settings.model;
          if (settings.template) templateSelect.value = settings.template;
          return; // Exit early if localStorage worked
        } catch (error) {
          // Continue to fallback
        }
      }
      
      // Fallback: try session storage
      if (window.tempSettings) {
        const settings = window.tempSettings;
        if (settings.apiKey) apiKeyInput.value = settings.apiKey;
        if (settings.model) modelSelect.value = settings.model;
        if (settings.template) templateSelect.value = settings.template;
      }
    }
  </script>
</body>
</html>