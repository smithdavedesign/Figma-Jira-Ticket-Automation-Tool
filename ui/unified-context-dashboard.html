<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Unified Context Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #2ecc71; }
        .status-offline { background: #e74c3c; }
        .status-loading { background: #f39c12; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .unified-dashboard {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        @media (max-width: 1200px) {
            .unified-dashboard {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-weight: 600;
            display: flex;
            justify-content: between;
            align-items: center;
            font-size: 1.1em;
        }

        .panel-content {
            padding: 20px;
        }

        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #764ba2, #667eea);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .context-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .context-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .context-viewer {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }

        .context-tabs {
            display: flex;
            background: #fff;
            border-bottom: 2px solid #e9ecef;
            padding: 0 10px;
        }

        .context-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .context-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .context-tab-content {
            display: none;
            padding: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .context-tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 500;
        }

        .design-tokens {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .token-card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            text-align: center;
            transition: all 0.3s ease;
        }

        .token-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .token-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin: 0 auto 10px;
            border: 2px solid #ecf0f1;
        }

        .token-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .token-value {
            font-size: 0.8em;
            color: #7f8c8d;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .live-logs {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-timestamp {
            color: #95a5a6;
            margin-right: 15px;
        }

        .log-info { color: #3498db; }
        .log-success { color: #2ecc71; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-success { background: #2ecc71; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-error { background: #e74c3c; color: white; }
        .badge-info { background: #3498db; color: white; }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .screenshot-preview {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 15px 0;
        }

        .error-message {
            background: #fff5f5;
            border: 2px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success-message {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            color: #2f855a;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .context-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .flow-step {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .flow-arrow {
            color: #667eea;
            font-size: 1.5em;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        /* Session Management Styles */
        .session-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metrics-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .metrics-card:hover {
            transform: translateY(-2px);
        }

        .metrics-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1em;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .persistence-indicators {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
        }

        .persistence-indicators h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .persistence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .persistence-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        .persistence-item.healthy {
            border-color: #2ecc71;
            background: #f0fff4;
        }

        .persistence-item.degraded {
            border-color: #f39c12;
            background: #fffdf0;
        }

        .persistence-item.critical {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .persistence-icon {
            font-size: 1.5em;
            margin-right: 12px;
        }

        .persistence-info {
            flex: 1;
        }

        .persistence-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .persistence-status {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .session-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .session-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        /* Session Analytics Styles */
        .analytics-section {
            margin: 15px 0;
        }

        .analytics-section h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .analytics-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .analytics-label {
            color: #6c757d;
        }

        .analytics-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .health-overview {
            text-align: center;
        }

        .health-score {
            display: inline-block;
            margin: 20px 0;
            padding: 20px;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .health-score.healthy {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .health-score.degraded {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .health-score.poor, .health-score.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .health-score-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .health-score-label {
            font-size: 0.8em;
            margin-top: 5px;
        }

        .health-checks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .health-check {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .health-check.passed {
            background: #f0fff4;
            border-left: 4px solid #2ecc71;
        }

        .health-check.failed {
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
        }

        .health-check-icon {
            margin-right: 10px;
        }

        .health-issues {
            margin-top: 20px;
            text-align: left;
        }

        .health-issues h5 {
            color: #c0392b;
            margin-bottom: 10px;
        }

        .health-issues ul {
            list-style-type: none;
            padding: 0;
        }

        .health-issues li {
            padding: 5px 0;
            color: #e74c3c;
        }

        .health-issues li::before {
            content: "‚ö†Ô∏è ";
            margin-right: 8px;
        }

        .no-issues {
            color: #2ecc71;
            font-weight: 600;
        }

        .no-issues::before {
            content: "‚úÖ ";
            margin-right: 8px;
        }

        .realtime-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .realtime-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
        }

        .realtime-label {
            font-weight: 500;
        }

        .realtime-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .realtime-timestamp {
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 15px;
        }

        /* Metric color coding */
        .metric-excellent {
            color: #2ecc71 !important;
        }

        .metric-good {
            color: #3498db !important;
        }

        .metric-fair {
            color: #f39c12 !important;
        }

        .metric-poor {
            color: #e74c3c !important;
        }

        /* Intelligence Tabs Styles */
        .intelligence-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .intel-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .intel-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }

        .intel-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1em;
        }

        .intel-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .intel-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .intel-confidence {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .intel-grade {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .intel-framework {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .intelligence-tabs-container {
            margin: 30px 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .intelligence-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .intel-tab {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .intel-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .intel-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .intel-tab-content {
            display: none;
            padding: 25px;
            min-height: 400px;
        }

        .intel-tab-content.active {
            display: block;
        }

        .intel-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .intel-content-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .intel-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .intel-actions select {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: #495057;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #6c757d;
        }

        .loading-state .spinner {
            margin-bottom: 15px;
        }

        .components-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .component-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s ease;
        }

        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .component-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .component-type {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .component-details {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }

        .component-confidence {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .confidence-bar {
            flex: 1;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            transition: width 0.3s ease;
        }

        .confidence-score {
            font-size: 0.8em;
            font-weight: 600;
            color: #495057;
        }

        .accessibility-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .accessibility-category {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .category-score {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.85em;
        }

        .score-excellent {
            background: #2ecc71;
            color: white;
        }

        .score-good {
            background: #3498db;
            color: white;
        }

        .score-fair {
            background: #f39c12;
            color: white;
        }

        .score-poor {
            background: #e74c3c;
            color: white;
        }

        .category-issues {
            margin-bottom: 15px;
        }

        .issue-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .issue-icon {
            color: #e74c3c;
            font-weight: bold;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .recommendation-icon {
            color: #2ecc71;
            font-weight: bold;
        }

        .code-preview-body {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }

        .code-tabs {
            display: flex;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
        }

        .code-tab {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.85em;
            color: #6c757d;
            transition: all 0.2s ease;
        }

        .code-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .code-tab.active {
            background: white;
            color: #2c3e50;
            font-weight: 600;
        }

        .code-content {
            display: none;
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            line-height: 1.5;
            max-height: 400px;
        }

        .code-content.active {
            display: block;
        }

        .code-content pre {
            margin: 0;
            white-space: pre;
            word-wrap: normal;
        }

        .flows-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .flow-diagram {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .flow-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .flow-confidence {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .flow-steps {
            display: flex;
            align-items: center;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .flow-step {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 10px 15px;
            min-width: 120px;
            text-align: center;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .flow-arrow {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
        }

        .intelligence-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            justify-content: center;
            flex-wrap: wrap;
        }

        .intelligence-actions .btn {
            min-width: 160px;
        }

        /* Health Monitoring Styles */
        .health-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .health-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .health-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .health-card.critical {
            border-left-color: #e74c3c;
        }

        .health-card.warning {
            border-left-color: #f39c12;
        }

        .health-card.healthy {
            border-left-color: #2ecc71;
        }

        .health-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 600;
        }

        .health-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
            line-height: 1;
        }

        .health-value.critical {
            color: #e74c3c;
        }

        .health-value.warning {
            color: #f39c12;
        }

        .health-value.healthy {
            color: #2ecc71;
        }

        .health-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .health-status, .health-indicator, .health-trend, .health-priority {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .health-status.critical, .health-priority.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .health-status.warning, .health-priority.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .health-tabs-container {
            margin: 30px 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .health-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .health-tab {
            background: none;
            border: none;
            padding: 18px 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .health-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .health-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .health-tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .health-tab-content.active {
            display: block;
        }

        .health-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .health-content-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .health-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .health-actions select {
            padding: 8px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 0.9em;
        }

        .dashboard-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .metric-card h5 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1em;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        .progress-fill.critical {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .metric-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .metric-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .metric-status.healthy {
            background: #d4edda;
            color: #155724;
        }

        .metric-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .metric-status.critical {
            background: #f8d7da;
            color: #721c24;
        }

        .metric-chart, .chart-placeholder {
            height: 100px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .uptime-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .uptime-section h5 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .uptime-display {
            text-align: center;
        }

        .uptime-value {
            font-size: 2em;
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 10px;
        }

        .uptime-details {
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
            color: #6c757d;
        }

        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .component-status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .component-status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .component-status-card.healthy {
            border-left: 4px solid #2ecc71;
        }

        .component-status-card.warning {
            border-left: 4px solid #f39c12;
        }

        .component-status-card.critical {
            border-left: 4px solid #e74c3c;
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .component-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .component-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .component-status-badge.healthy {
            background: #d4edda;
            color: #155724;
        }

        .component-status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .component-status-badge.critical {
            background: #f8d7da;
            color: #721c24;
        }

        .component-details {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }

        .component-details div {
            margin: 5px 0;
        }

        .metrics-visualization {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .chart-container h5 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .alerts-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }

        .alert-item.critical {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .alert-item.warning {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.05);
        }

        .alert-item.info {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .alert-icon {
            font-size: 1.2em;
            width: 20px;
            text-align: center;
        }

        .alert-content {
            flex: 1;
        }

        .alert-message {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .alert-details {
            font-size: 0.9em;
            color: #6c757d;
        }

        .alert-timestamp {
            font-size: 0.8em;
            color: #95a5a6;
            margin-top: 5px;
        }

        .health-actions-bar {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            justify-content: center;
            flex-wrap: wrap;
        }

        .health-actions-bar .btn {
            min-width: 140px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Unified Context Dashboard</h1>
            <p>Advanced interface combining Design System Analysis, AI Ticket Generation, Live Context Layer, and MCP Server Integration</p>
            
            <div class="status-indicators">
                <div class="status-indicator">
                    <div class="status-dot status-loading" id="server-status"></div>
                    <span id="server-text">Checking server...</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-loading" id="figma-status"></div>
                    <span id="figma-text">Checking Figma API...</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-loading" id="mcp-status"></div>
                    <span id="mcp-text">Checking MCP Server...</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-loading" id="ai-status"></div>
                    <span id="ai-text">Checking AI Services...</span>
                </div>
            </div>
        </div>

        <div class="unified-dashboard">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-header">
                        <span>üß≠ Navigation</span>
                    </div>
                    <div class="panel-content">
                        <div class="nav-buttons">
                            <button class="nav-button active" onclick="switchSection('design-system')">
                                üé® Design System
                            </button>
                            <button class="nav-button" onclick="switchSection('context-layer')">
                                üìä Context Layer
                            </button>
                            <button class="nav-button" onclick="switchSection('ai-generation')">
                                ü§ñ AI Generation
                            </button>
                            <button class="nav-button" onclick="switchSection('mcp-server')">
                                üîå MCP Server
                            </button>
                            <button class="nav-button" onclick="switchSection('intelligence-tabs')">
                                üß† Intelligence Tabs
                            </button>
                            <button class="nav-button" onclick="switchSection('session-management')">
                                üîÑ Session Management
                            </button>
                            <button class="nav-button" onclick="switchSection('health-monitoring')">
                                üè• Health Monitor
                            </button>
                            <button class="nav-button" onclick="switchSection('monitoring')">
                                üìà Live Monitoring
                            </button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span>üéØ Quick Actions</span>
                    </div>
                    <div class="panel-content">
                        <div class="input-group">
                            <label for="figma-url">Figma URL</label>
                            <input type="text" id="figma-url" placeholder="https://figma.com/file/...">
                        </div>
                        <button class="btn btn-success" onclick="analyzeDesign()">
                            üöÄ Analyze Design
                        </button>
                        <button class="btn btn-warning" onclick="generateTicket()">
                            üìù Generate Ticket
                        </button>
                        <button class="btn" onclick="clearAll()">
                            üßπ Clear All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Design System Section -->
                <div id="design-system-section" class="context-section active">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üé® Design System Analysis</span>
                            <span id="design-system-status" class="badge badge-info">Ready</span>
                        </div>
                        <div class="panel-content">
                            <div class="context-flow">
                                <div class="flow-step">Figma File</div>
                                <div class="flow-arrow">‚Üí</div>
                                <div class="flow-step">Extract Components</div>
                                <div class="flow-arrow">‚Üí</div>
                                <div class="flow-step">Design Tokens</div>
                                <div class="flow-arrow">‚Üí</div>
                                <div class="flow-step">System Analysis</div>
                            </div>

                            <div class="metrics-grid" id="design-metrics" style="display: none;">
                                <!-- Populated dynamically -->
                            </div>

                            <div class="design-tokens" id="design-tokens" style="display: none;">
                                <!-- Populated dynamically -->
                            </div>

                            <div class="context-viewer" id="design-context-viewer" style="display: none;">
                                <div class="context-tabs">
                                    <button class="context-tab active" onclick="switchContextTab('components')">Components</button>
                                    <button class="context-tab" onclick="switchContextTab('styles')">Styles</button>
                                    <button class="context-tab" onclick="switchContextTab('tokens')">Tokens</button>
                                    <button class="context-tab" onclick="switchContextTab('hierarchy')">Hierarchy</button>
                                </div>
                                <div id="components-content" class="context-tab-content active"></div>
                                <div id="styles-content" class="context-tab-content"></div>
                                <div id="tokens-content" class="context-tab-content"></div>
                                <div id="hierarchy-content" class="context-tab-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Context Layer Section -->
                <div id="context-layer-section" class="context-section">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üìä Context Layer Operations</span>
                            <span id="context-layer-status" class="badge badge-info">Ready</span>
                        </div>
                        <div class="panel-content">
                            <div class="input-group">
                                <label for="operation-type">Operation</label>
                                <select id="operation-type">
                                    <option value="extract">Extract Context</option>
                                    <option value="get">Get Stored Context</option>
                                    <option value="summary">Get Summary</option>
                                    <option value="search">Search Context</option>
                                </select>
                            </div>

                            <div class="input-group" id="search-input" style="display: none;">
                                <label for="search-query">Search Query</label>
                                <input type="text" id="search-query" placeholder="Enter search terms...">
                            </div>

                            <button class="btn btn-success" onclick="executeContextOperation()">
                                üîÑ Execute
                            </button>
                            <button class="btn btn-warning" onclick="validateContextData()">
                                ‚úÖ Validate
                            </button>

                            <div class="context-viewer" id="context-viewer" style="display: none;">
                                <div class="context-tabs">
                                    <button class="context-tab active" onclick="switchContextTab('raw')">Raw Data</button>
                                    <button class="context-tab" onclick="switchContextTab('formatted')">Formatted</button>
                                    <button class="context-tab" onclick="switchContextTab('metadata')">Metadata</button>
                                </div>
                                <div id="raw-content" class="context-tab-content active"></div>
                                <div id="formatted-content" class="context-tab-content"></div>
                                <div id="metadata-content" class="context-tab-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Generation Section -->
                <div id="ai-generation-section" class="context-section">
                    <div class="panel">
                        <div class="panel-header">
                            <span>ü§ñ AI Ticket Generation</span>
                            <span id="ai-generation-status" class="badge badge-info">Ready</span>
                        </div>
                        <div class="panel-content">
                            <div class="input-group">
                                <label for="ticket-format">Ticket Format</label>
                                <select id="ticket-format">
                                    <option value="jira">JIRA Ticket</option>
                                    <option value="wiki">Wiki Page</option>
                                    <option value="markdown">Markdown</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="generation-strategy">Generation Strategy</label>
                                <select id="generation-strategy">
                                    <option value="context-bridge">Context Bridge (Recommended)</option>
                                    <option value="ai">AI-Powered</option>
                                    <option value="template">Template-Based</option>
                                    <option value="enhanced">Enhanced</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="tech-stack">Tech Stack</label>
                                <input type="text" id="tech-stack" value="React TypeScript" placeholder="React, Vue, Angular...">
                            </div>

                            <button class="btn btn-success" onclick="generateAITicket()">
                                üéØ Generate Ticket
                            </button>
                            <button class="btn btn-warning" onclick="previewAIInput()">
                                üëÅÔ∏è Preview Input
                            </button>

                            <div class="context-viewer" id="ai-output-viewer" style="display: none;">
                                <div class="context-tabs">
                                    <button class="context-tab active" onclick="switchContextTab('ticket')">Generated Ticket</button>
                                    <button class="context-tab" onclick="switchContextTab('input')">AI Input</button>
                                    <button class="context-tab" onclick="switchContextTab('debug')">Debug Info</button>
                                </div>
                                <div id="ticket-content" class="context-tab-content active"></div>
                                <div id="input-content" class="context-tab-content"></div>
                                <div id="debug-content" class="context-tab-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Intelligence Tabs Section -->
                <div id="intelligence-tabs-section" class="context-section">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üß† Context Intelligence Dashboard</span>
                            <span id="intelligence-tabs-status" class="badge badge-info">Ready</span>
                            <button class="btn" onclick="refreshIntelligenceData()">üîÑ Refresh</button>
                        </div>
                        <div class="panel-content">
                            <!-- Intelligence Overview Cards -->
                            <div class="intelligence-overview" id="intelligence-overview">
                                <div class="intel-card">
                                    <h4>üéØ Semantic Analysis</h4>
                                    <div class="intel-value" id="semantic-components">--</div>
                                    <div class="intel-label">Components Analyzed</div>
                                    <div class="intel-confidence" id="semantic-confidence">--%</div>
                                </div>
                                <div class="intel-card">
                                    <h4>‚ôø Accessibility Score</h4>
                                    <div class="intel-value" id="accessibility-score">--</div>
                                    <div class="intel-label">WCAG Compliance</div>
                                    <div class="intel-grade" id="accessibility-grade">--</div>
                                </div>
                                <div class="intel-card">
                                    <h4>üîÑ Interaction Flows</h4>
                                    <div class="intel-value" id="interaction-flows">--</div>
                                    <div class="intel-label">User Flows Detected</div>
                                    <div class="intel-confidence" id="flow-confidence">--%</div>
                                </div>
                                <div class="intel-card">
                                    <h4>üíª Code Preview</h4>
                                    <div class="intel-value" id="code-components">--</div>
                                    <div class="intel-label">Components Ready</div>
                                    <div class="intel-framework" id="code-framework">React</div>
                                </div>
                            </div>

                            <!-- Intelligence Tabs Interface -->
                            <div class="intelligence-tabs-container" id="intelligence-tabs-container">
                                <div class="intelligence-nav">
                                    <button class="intel-tab active" onclick="switchIntelligenceTab('component-intelligence')">
                                        üéØ Component Intelligence
                                    </button>
                                    <button class="intel-tab" onclick="switchIntelligenceTab('accessibility-analysis')">
                                        ‚ôø Accessibility Analysis
                                    </button>
                                    <button class="intel-tab" onclick="switchIntelligenceTab('code-preview')">
                                        üíª Code Preview
                                    </button>
                                    <button class="intel-tab" onclick="switchIntelligenceTab('interaction-flows')">
                                        üîÑ Interaction Flows
                                    </button>
                                </div>

                                <!-- Component Intelligence Tab -->
                                <div id="component-intelligence-content" class="intel-tab-content active">
                                    <div class="intel-content-header">
                                        <h4>üéØ Semantic Component Analysis</h4>
                                        <div class="intel-actions">
                                            <button class="btn btn-sm" onclick="exportSemanticData()">üìÑ Export</button>
                                            <button class="btn btn-sm" onclick="refreshSemanticAnalysis()">üîÑ Refresh</button>
                                        </div>
                                    </div>
                                    <div id="semantic-components-list" class="components-list">
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <p>Load a Figma design to see component intelligence...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Accessibility Analysis Tab -->
                                <div id="accessibility-analysis-content" class="intel-tab-content">
                                    <div class="intel-content-header">
                                        <h4>‚ôø WCAG Compliance Analysis</h4>
                                        <div class="intel-actions">
                                            <select id="wcag-level">
                                                <option value="AA">WCAG AA</option>
                                                <option value="AAA">WCAG AAA</option>
                                            </select>
                                            <button class="btn btn-sm" onclick="exportAccessibilityReport()">üìÑ Export Report</button>
                                        </div>
                                    </div>
                                    <div id="accessibility-analysis-content-body" class="accessibility-content">
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <p>Load a Figma design to see accessibility analysis...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Code Preview Tab -->
                                <div id="code-preview-content" class="intel-tab-content">
                                    <div class="intel-content-header">
                                        <h4>üíª Generated Code Preview</h4>
                                        <div class="intel-actions">
                                            <select id="code-framework">
                                                <option value="react">React</option>
                                                <option value="vue">Vue.js</option>
                                                <option value="angular">Angular</option>
                                            </select>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="typescript-enabled" checked>
                                                TypeScript
                                            </label>
                                            <button class="btn btn-sm" onclick="downloadCodeFiles()">üíæ Download</button>
                                        </div>
                                    </div>
                                    <div id="code-preview-content-body" class="code-preview-body">
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <p>Load a Figma design to see generated code...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Interaction Flows Tab -->
                                <div id="interaction-flows-content" class="intel-tab-content">
                                    <div class="intel-content-header">
                                        <h4>üîÑ User Interaction Flows</h4>
                                        <div class="intel-actions">
                                            <button class="btn btn-sm" onclick="exportFlowDiagram()">üìä Export Diagram</button>
                                            <button class="btn btn-sm" onclick="generateUserStories()">üìù User Stories</button>
                                        </div>
                                    </div>
                                    <div id="interaction-flows-content-body" class="flows-content">
                                        <div class="loading-state">
                                            <div class="spinner"></div>
                                            <p>Load a Figma design to see interaction flows...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Intelligence Actions -->
                            <div class="intelligence-actions">
                                <button class="btn btn-success" onclick="runFullIntelligenceAnalysis()">
                                    üß† Run Full Analysis
                                </button>
                                <button class="btn btn-warning" onclick="validateIntelligenceData()">
                                    ‚úÖ Validate Data
                                </button>
                                <button class="btn" onclick="clearIntelligenceCache()">
                                    üßπ Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MCP Server Section -->
                <div id="mcp-server-section" class="context-section">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üîå MCP Server Integration</span>
                            <span id="mcp-server-status" class="badge badge-info">Ready</span>
                        </div>
                        <div class="panel-content">
                            <div class="input-group">
                                <label for="mcp-operation">MCP Operation</label>
                                <select id="mcp-operation">
                                    <option value="health">Health Check</option>
                                    <option value="tools">List Tools</option>
                                    <option value="resources">List Resources</option>
                                    <option value="call">Call Tool</option>
                                </select>
                            </div>

                            <div class="input-group" id="tool-params" style="display: none;">
                                <label for="tool-name">Tool Name</label>
                                <input type="text" id="tool-name" placeholder="figma_extract_context">
                                <label for="tool-arguments">Arguments (JSON)</label>
                                <textarea id="tool-arguments" rows="3" placeholder='{"figma_url": "...", "node_id": "..."}'></textarea>
                            </div>

                            <button class="btn btn-success" onclick="executeMCPOperation()">
                                üîå Execute
                            </button>
                            <button class="btn btn-warning" onclick="testMCPConnection()">
                                üîç Test Connection
                            </button>

                            <div class="context-viewer" id="mcp-output-viewer" style="display: none;">
                                <div class="context-tabs">
                                    <button class="context-tab active" onclick="switchContextTab('response')">Response</button>
                                    <button class="context-tab" onclick="switchContextTab('tools')">Available Tools</button>
                                    <button class="context-tab" onclick="switchContextTab('resources')">Resources</button>
                                </div>
                                <div id="response-content" class="context-tab-content active"></div>
                                <div id="tools-content" class="context-tab-content"></div>
                                <div id="resources-content" class="context-tab-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Monitoring Section -->
                <div id="health-monitoring-section" class="dashboard-section" style="display: none;">
                    <div class="section-header">
                        <h2>üè• System Health Monitoring</h2>
                        <p>Real-time system health status, performance metrics, and alert management</p>
                    </div>

                    <!-- Health Overview Cards -->
                    <div class="health-overview">
                        <div class="health-card">
                            <h4>Overall Health</h4>
                            <div class="health-value" id="overall-health">95%</div>
                            <div class="health-label">System Score</div>
                            <div class="health-status" id="overall-status">Healthy</div>
                        </div>
                        <div class="health-card">
                            <h4>Active Services</h4>
                            <div class="health-value" id="active-services">7/8</div>
                            <div class="health-label">Services Online</div>
                            <div class="health-indicator" id="services-indicator">‚úÖ</div>
                        </div>
                        <div class="health-card">
                            <h4>Error Rate</h4>
                            <div class="health-value" id="error-rate">0.2%</div>
                            <div class="health-label">Last 1 Hour</div>
                            <div class="health-trend" id="error-trend">üìâ</div>
                        </div>
                        <div class="health-card">
                            <h4>Active Alerts</h4>
                            <div class="health-value" id="active-alerts">2</div>
                            <div class="health-label">Notifications</div>
                            <div class="health-priority" id="alert-priority">‚ö†Ô∏è</div>
                        </div>
                    </div>

                    <!-- Health Monitoring Tabs -->
                    <div class="health-tabs-container">
                        <div class="health-nav">
                            <button class="health-tab active" onclick="switchHealthTab('dashboard')">
                                üìä Dashboard
                            </button>
                            <button class="health-tab" onclick="switchHealthTab('components')">
                                üîß Components
                            </button>
                            <button class="health-tab" onclick="switchHealthTab('metrics')">
                                üìà Metrics
                            </button>
                            <button class="health-tab" onclick="switchHealthTab('alerts')">
                                üö® Alerts
                            </button>
                        </div>

                        <!-- Dashboard Tab -->
                        <div class="health-tab-content active" id="dashboard-content">
                            <div class="health-content-header">
                                <h4>System Dashboard</h4>
                                <div class="health-actions">
                                    <select id="refresh-interval">
                                        <option value="10000">10s refresh</option>
                                        <option value="30000" selected>30s refresh</option>
                                        <option value="60000">1m refresh</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshHealthData()">
                                        üîÑ Refresh Now
                                    </button>
                                </div>
                            </div>
                            <div class="dashboard-content">
                                <div class="metrics-row">
                                    <div class="metric-card">
                                        <h5>Memory Usage</h5>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="memory-progress" style="width: 65%"></div>
                                        </div>
                                        <div class="metric-details">
                                            <span id="memory-value">512MB / 1GB</span>
                                            <span class="metric-status healthy">Normal</span>
                                        </div>
                                    </div>
                                    <div class="metric-card">
                                        <h5>CPU Usage</h5>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="cpu-progress" style="width: 42%"></div>
                                        </div>
                                        <div class="metric-details">
                                            <span id="cpu-value">42%</span>
                                            <span class="metric-status healthy">Normal</span>
                                        </div>
                                    </div>
                                    <div class="metric-card">
                                        <h5>Response Time</h5>
                                        <div class="metric-chart" id="response-time-chart">
                                            <div class="chart-placeholder">üìä Real-time chart</div>
                                        </div>
                                        <div class="metric-details">
                                            <span id="response-time-value">145ms avg</span>
                                            <span class="metric-status healthy">Fast</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="uptime-section">
                                    <h5>System Uptime</h5>
                                    <div class="uptime-display">
                                        <div class="uptime-value" id="uptime-value">2d 14h 32m</div>
                                        <div class="uptime-details">
                                            <span>Started: <span id="start-time">Nov 5, 2025 03:28</span></span>
                                            <span>Last restart: <span id="last-restart">None</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Components Tab -->
                        <div class="health-tab-content" id="components-content">
                            <div class="health-content-header">
                                <h4>Service Components</h4>
                                <div class="health-actions">
                                    <select id="component-filter">
                                        <option value="all">All Components</option>
                                        <option value="healthy">Healthy Only</option>
                                        <option value="issues">Issues Only</option>
                                        <option value="critical">Critical Only</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-success" onclick="checkAllComponents()">
                                        üîç Check All
                                    </button>
                                </div>
                            </div>
                            <div class="components-grid" id="components-list">
                                <!-- Component cards will be loaded here -->
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <div>Loading component status...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Metrics Tab -->
                        <div class="health-tab-content" id="metrics-content">
                            <div class="health-content-header">
                                <h4>Performance Metrics</h4>
                                <div class="health-actions">
                                    <select id="metrics-timeframe">
                                        <option value="1h">Last Hour</option>
                                        <option value="24h" selected>Last 24 Hours</option>
                                        <option value="7d">Last 7 Days</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" onclick="exportMetrics()">
                                        üì• Export Data
                                    </button>
                                </div>
                            </div>
                            <div class="metrics-visualization">
                                <div class="chart-container">
                                    <h5>Memory Usage Over Time</h5>
                                    <div class="chart-placeholder" id="memory-chart">
                                        üìà Memory usage chart will appear here
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <h5>CPU Usage Over Time</h5>
                                    <div class="chart-placeholder" id="cpu-chart">
                                        üìä CPU usage chart will appear here
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <h5>Request Volume & Response Times</h5>
                                    <div class="chart-placeholder" id="requests-chart">
                                        üìâ Request metrics chart will appear here
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alerts Tab -->
                        <div class="health-tab-content" id="alerts-content">
                            <div class="health-content-header">
                                <h4>System Alerts</h4>
                                <div class="health-actions">
                                    <select id="alert-severity">
                                        <option value="all">All Severities</option>
                                        <option value="critical">Critical</option>
                                        <option value="warning">Warning</option>
                                        <option value="info">Info</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearOldAlerts()">
                                        üóëÔ∏è Clear Old
                                    </button>
                                </div>
                            </div>
                            <div class="alerts-list" id="alerts-list">
                                <!-- Alerts will be loaded here -->
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <div>Loading alerts...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Health Actions -->
                    <div class="health-actions-bar">
                        <button class="btn btn-primary" onclick="runSystemHealthCheck()">
                            ü©∫ Full Health Check
                        </button>
                        <button class="btn btn-outline-secondary" onclick="downloadHealthReport()">
                            üìã Health Report
                        </button>
                        <button class="btn btn-outline-info" onclick="showHealthHistory()">
                            üìä View History
                        </button>
                        <button class="btn btn-outline-warning" onclick="configureAlerts()">
                            ‚öôÔ∏è Alert Settings
                        </button>
                    </div>
                </div>

                <!-- Session Management Section -->
                <div id="session-management-section" class="context-section">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üîÑ Session Management Performance</span>
                            <span id="session-management-status" class="badge badge-info">Ready</span>
                            <button class="btn" onclick="refreshSessionMetrics()">üîÑ Refresh</button>
                        </div>
                        <div class="panel-content">
                            <!-- Session Performance Overview -->
                            <div class="session-overview" id="session-overview">
                                <div class="metrics-card">
                                    <h4>üéØ Performance Score</h4>
                                    <div class="metric-value" id="performance-score">--</div>
                                    <div class="metric-label">Health Score</div>
                                </div>
                                <div class="metrics-card">
                                    <h4>üìä Active Sessions</h4>
                                    <div class="metric-value" id="active-sessions">--</div>
                                    <div class="metric-label">Currently Active</div>
                                </div>
                                <div class="metrics-card">
                                    <h4>‚ö° Cache Hit Rate</h4>
                                    <div class="metric-value" id="cache-hit-rate">--%</div>
                                    <div class="metric-label">Memory + Redis</div>
                                </div>
                                <div class="metrics-card">
                                    <h4>üïê Response Time</h4>
                                    <div class="metric-value" id="avg-response-time">--ms</div>
                                    <div class="metric-label">Average</div>
                                </div>
                            </div>

                            <!-- Session Persistence Indicators -->
                            <div class="persistence-indicators" id="persistence-indicators">
                                <h4>üíæ Session Persistence Status</h4>
                                <div class="persistence-grid">
                                    <div class="persistence-item" id="redis-status">
                                        <div class="persistence-icon">üî¥</div>
                                        <div class="persistence-info">
                                            <div class="persistence-name">Redis Connection</div>
                                            <div class="persistence-status">Checking...</div>
                                        </div>
                                    </div>
                                    <div class="persistence-item" id="memory-status">
                                        <div class="persistence-icon">üü°</div>
                                        <div class="persistence-info">
                                            <div class="persistence-name">Memory Fallback</div>
                                            <div class="persistence-status">Checking...</div>
                                        </div>
                                    </div>
                                    <div class="persistence-item" id="figma-session-status">
                                        <div class="persistence-icon">üî¥</div>
                                        <div class="persistence-info">
                                            <div class="persistence-name">Figma Session Manager</div>
                                            <div class="persistence-status">Checking...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Session Analytics -->
                            <div class="context-viewer" id="session-analytics-viewer" style="display: none;">
                                <div class="context-tabs">
                                    <button class="context-tab active" onclick="switchSessionTab('performance')">Performance</button>
                                    <button class="context-tab" onclick="switchSessionTab('cache')">Cache Stats</button>
                                    <button class="context-tab" onclick="switchSessionTab('health')">Health Check</button>
                                    <button class="context-tab" onclick="switchSessionTab('realtime')">Real-time</button>
                                </div>
                                <div id="performance-content" class="context-tab-content active"></div>
                                <div id="cache-content" class="context-tab-content"></div>
                                <div id="health-content" class="context-tab-content"></div>
                                <div id="realtime-content" class="context-tab-content"></div>
                            </div>

                            <div class="session-actions">
                                <button class="btn btn-success" onclick="showSessionAnalytics()">
                                    üìä Show Analytics
                                </button>
                                <button class="btn btn-warning" onclick="runSessionHealthCheck()">
                                    üè• Health Check
                                </button>
                                <button class="btn" onclick="clearSessionCache()">
                                    üßπ Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Section -->
                <div id="monitoring-section" class="context-section">
                    <div class="panel">
                        <div class="panel-header">
                            <span>üìà Live System Monitoring</span>
                            <button class="btn" onclick="refreshMonitoring()">üîÑ Refresh</button>
                        </div>
                        <div class="panel-content">
                            <div class="metrics-grid" id="system-metrics">
                                <!-- Populated dynamically -->
                            </div>

                            <div class="live-logs" id="live-logs">
                                <!-- Live logs appear here -->
                            </div>

                            <div style="margin-top: 15px;">
                                <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                                <button class="btn" onclick="toggleAutoScroll()">üìú Auto-scroll: ON</button>
                                <button class="btn" onclick="exportLogs()">üíæ Export Logs</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Context Layer Client -->
    <script src="js/context-layer-client.js"></script>
    
    <script>
        // =============================================================================
        // UNIFIED CONTEXT DASHBOARD CONTROLLER
        // =============================================================================

        class UnifiedContextDashboard {
            constructor() {
                this.currentSection = 'design-system';
                this.contextData = null;
                this.logs = [];
                this.autoScroll = true;
                this.statusCheckers = {};
                
                this.init();
            }

            async init() {
                this.log('üöÄ Unified Context Dashboard initialized', 'info');
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Start status monitoring
                this.startStatusMonitoring();
                
                // Check initial system status
                await this.checkAllSystems();
            }

            setupEventListeners() {
                // Operation type change for context layer
                document.getElementById('operation-type').addEventListener('change', (e) => {
                    const searchInput = document.getElementById('search-input');
                    searchInput.style.display = e.target.value === 'search' ? 'block' : 'none';
                });

                // MCP operation change
                document.getElementById('mcp-operation').addEventListener('change', (e) => {
                    const toolParams = document.getElementById('tool-params');
                    toolParams.style.display = e.target.value === 'call' ? 'block' : 'none';
                });
            }

            startStatusMonitoring() {
                // Check systems every 30 seconds
                this.statusCheckers.interval = setInterval(() => {
                    this.checkAllSystems();
                }, 30000);
            }

            async checkAllSystems() {
                await Promise.all([
                    this.checkServerStatus(),
                    this.checkFigmaStatus(),
                    this.checkMCPStatus(),
                    this.checkAIStatus()
                ]);
            }

            async checkServerStatus() {
                try {
                    const response = await fetch('http://localhost:3000/health');
                    const data = await response.json();
                    
                    this.updateStatus('server', 'online', `${data.services?.length || 0} services`);
                    
                } catch (error) {
                    this.updateStatus('server', 'offline', 'Unreachable');
                }
            }

            async checkFigmaStatus() {
                try {
                    const response = await fetch('http://localhost:3000/api/figma/health');
                    const data = await response.json();
                    
                    this.updateStatus('figma', 'online', data.success ? 'Connected' : 'Error');
                    
                } catch (error) {
                    this.updateStatus('figma', 'offline', 'API Error');
                }
            }

            async checkMCPStatus() {
                try {
                    const response = await fetch('http://localhost:3000/api/mcp/health');
                    const data = await response.json();
                    
                    this.updateStatus('mcp', data.success ? 'online' : 'offline', 
                                    data.success ? 'Connected' : 'Unavailable');
                    
                } catch (error) {
                    this.updateStatus('mcp', 'offline', 'Server Down');
                }
            }

            async checkAIStatus() {
                try {
                    const response = await fetch('http://localhost:3000/api/ai/health');
                    const data = await response.json();
                    
                    const providers = data.data?.providers || [];
                    this.updateStatus('ai', providers.length > 0 ? 'online' : 'offline', 
                                    `${providers.length} providers`);
                    
                } catch (error) {
                    this.updateStatus('ai', 'offline', 'No providers');
                }
            }

            updateStatus(system, status, text) {
                const statusDot = document.getElementById(`${system}-status`);
                const statusText = document.getElementById(`${system}-text`);
                
                if (statusDot && statusText) {
                    statusDot.className = `status-dot status-${status}`;
                    statusText.textContent = text;
                }
            }

            // =============================================================================
            // DESIGN SYSTEM ANALYSIS
            // =============================================================================

            async analyzeDesign() {
                // Check if we have context data from plugin first
                if (window.figmaContextData) {
                    this.log('üîÑ Using context data from Figma plugin', 'info');
                    this.contextData = window.figmaContextData;
                    this.updateDesignSystemView(this.contextData);
                    this.setOperationStatus('design-system', 'success', 'Plugin Data');
                    this.log('‚úÖ Design system analysis completed using plugin data', 'success');
                    return;
                }

                const figmaUrl = document.getElementById('figma-url').value.trim();
                if (!figmaUrl) {
                    this.showError('Please enter a Figma URL or use the plugin integration');
                    return;
                }

                this.setOperationStatus('design-system', 'loading', 'Analyzing...');
                this.log(`üé® Starting design system analysis for: ${figmaUrl}`, 'info');

                try {
                    // Extract context with design system focus
                    const result = await ContextLayer.extractAndStore(figmaUrl, {
                        includeScreenshot: true,
                        analyzeDesignSystem: true
                    });

                    if (result.success) {
                        this.contextData = result.data;
                        this.updateDesignSystemView(this.contextData);
                        this.setOperationStatus('design-system', 'success', 'Complete');
                        this.log('‚úÖ Design system analysis completed', 'success');
                    } else {
                        throw new Error(result.error || 'Analysis failed');
                    }

                } catch (error) {
                    this.setOperationStatus('design-system', 'error', 'Failed');
                    this.showError(`Design analysis error: ${error.message}`);
                    this.log(`‚ùå Design analysis failed: ${error.message}`, 'error');
                }
            }

            updateDesignSystemView(data) {
                // Update metrics
                const metrics = [
                    { label: 'Components', value: data.components?.length || 0 },
                    { label: 'Styles', value: data.styles?.length || 0 },
                    { label: 'Colors', value: data.designTokens?.colors?.length || 0 },
                    { label: 'Typography', value: data.designTokens?.typography?.length || 0 },
                    { label: 'Nodes', value: data.nodes?.length || 0 },
                    { label: 'Confidence', value: Math.floor((data.confidence || 0) * 100) + '%' }
                ];

                this.updateMetricsGrid('design-metrics', metrics);

                // Update design tokens
                this.updateDesignTokens(data.designTokens || {});

                // Update context viewer
                this.updateDesignContextViewer(data);
            }

            updateDesignTokens(tokens) {
                const container = document.getElementById('design-tokens');
                if (!tokens.colors && !tokens.typography) {
                    container.style.display = 'none';
                    return;
                }

                let html = '';

                // Colors
                if (tokens.colors) {
                    html += tokens.colors.slice(0, 6).map(color => `
                        <div class="token-card">
                            <div class="token-preview" style="background-color: ${color.value}"></div>
                            <div class="token-name">${color.name}</div>
                            <div class="token-value">${color.value}</div>
                        </div>
                    `).join('');
                }

                // Typography preview
                if (tokens.typography) {
                    html += tokens.typography.slice(0, 4).map(typo => `
                        <div class="token-card">
                            <div class="token-preview" style="
                                font-family: ${typo.fontFamily};
                                font-size: 14px;
                                font-weight: ${typo.fontWeight};
                                background: #f8f9fa;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">Aa</div>
                            <div class="token-name">${typo.name}</div>
                            <div class="token-value">${typo.fontSize}px</div>
                        </div>
                    `).join('');
                }

                container.innerHTML = html;
                container.style.display = 'grid';
            }

            updateDesignContextViewer(data) {
                const viewer = document.getElementById('design-context-viewer');
                
                // Components
                document.getElementById('components-content').textContent = 
                    JSON.stringify(data.components || [], null, 2);
                
                // Styles
                document.getElementById('styles-content').textContent = 
                    JSON.stringify(data.styles || [], null, 2);
                
                // Tokens
                document.getElementById('tokens-content').textContent = 
                    JSON.stringify(data.designTokens || {}, null, 2);
                
                // Hierarchy
                document.getElementById('hierarchy-content').textContent = 
                    JSON.stringify(data.hierarchy || {}, null, 2);

                viewer.style.display = 'block';
            }

            // =============================================================================
            // CONTEXT LAYER OPERATIONS
            // =============================================================================

            async executeContextOperation() {
                const operation = document.getElementById('operation-type').value;
                const figmaUrl = document.getElementById('figma-url').value.trim();
                const searchQuery = document.getElementById('search-query').value.trim();

                if (!figmaUrl && operation !== 'search') {
                    this.showError('Please enter a Figma URL');
                    return;
                }

                if (operation === 'search' && !searchQuery) {
                    this.showError('Please enter a search query');
                    return;
                }

                this.setOperationStatus('context-layer', 'loading', 'Processing...');
                this.log(`üìä Executing context operation: ${operation}`, 'info');

                try {
                    let result;

                    switch (operation) {
                        case 'extract':
                            result = await ContextLayer.extractAndStore(figmaUrl);
                            break;
                        case 'get':
                            const fileKey = this.extractFileKey(figmaUrl);
                            result = await ContextLayer.getContext(fileKey);
                            break;
                        case 'summary':
                            const summaryFileKey = this.extractFileKey(figmaUrl);
                            result = await ContextLayer.getContextSummary(summaryFileKey);
                            break;
                        case 'search':
                            result = await ContextLayer.searchContext(searchQuery, { limit: 20 });
                            break;
                    }

                    if (result.success) {
                        this.contextData = result.data;
                        this.updateContextViewer(result);
                        this.setOperationStatus('context-layer', 'success', 'Complete');
                        this.log(`‚úÖ Context operation completed: ${operation}`, 'success');
                    } else {
                        throw new Error(result.error || 'Operation failed');
                    }

                } catch (error) {
                    this.setOperationStatus('context-layer', 'error', 'Failed');
                    this.showError(`Context operation error: ${error.message}`);
                    this.log(`‚ùå Context operation failed: ${error.message}`, 'error');
                }
            }

            updateContextViewer(result) {
                const viewer = document.getElementById('context-viewer');
                
                // Raw data
                document.getElementById('raw-content').textContent = 
                    JSON.stringify(result, null, 2);
                
                // Formatted data
                const formatted = ContextLayer.formatContext(result);
                document.getElementById('formatted-content').textContent = 
                    JSON.stringify(formatted, null, 2);
                
                // Metadata
                document.getElementById('metadata-content').textContent = 
                    JSON.stringify(result.metadata || {}, null, 2);

                viewer.style.display = 'block';
            }

            async validateContextData() {
                if (!this.contextData) {
                    this.showError('No context data to validate. Run an operation first.');
                    return;
                }

                const validation = ContextLayer.validateContext(this.contextData);
                
                const message = `Validation: ${validation.valid ? 'PASSED' : 'FAILED'}\n` +
                              `Score: ${validation.score}/100\n` +
                              `Errors: ${validation.errors.length}\n` +
                              `Warnings: ${validation.warnings.length}`;

                if (validation.valid) {
                    this.showSuccess(message);
                } else {
                    this.showError(message);
                }

                this.log(`üîç Context validation: ${validation.score}/100`, 
                        validation.valid ? 'success' : 'warning');
            }

            // =============================================================================
            // AI GENERATION
            // =============================================================================

            async generateAITicket() {
                // Use plugin context data if available, otherwise use analyzed data
                const contextData = window.figmaContextData || this.contextData;
                if (!contextData) {
                    this.showError('No context data available. Analyze a design first or use plugin integration.');
                    return;
                }

                const format = document.getElementById('ticket-format').value;
                const strategy = document.getElementById('generation-strategy').value;
                const techStack = document.getElementById('tech-stack').value;

                this.setOperationStatus('ai-generation', 'loading', 'Generating...');
                this.log(`ü§ñ Starting AI ticket generation - Format: ${format}, Strategy: ${strategy}`, 'info');

                try {
                    const response = await fetch('http://localhost:3000/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            format,
                            strategy,
                            techStack,
                            frameData: this.contextData.nodes || [],
                            enhancedFrameData: this.contextData,
                            documentType: 'component'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.updateAIOutputViewer(result);
                        this.setOperationStatus('ai-generation', 'success', 'Complete');
                        this.log('‚úÖ AI ticket generation completed', 'success');
                    } else {
                        throw new Error(result.error || 'Generation failed');
                    }

                } catch (error) {
                    this.setOperationStatus('ai-generation', 'error', 'Failed');
                    this.showError(`AI generation error: ${error.message}`);
                    this.log(`‚ùå AI generation failed: ${error.message}`, 'error');
                }
            }

            updateAIOutputViewer(result) {
                const viewer = document.getElementById('ai-output-viewer');
                
                // Generated ticket
                document.getElementById('ticket-content').textContent = 
                    result.data?.content || result.data?.ticket || 'No content generated';
                
                // AI input (what was sent to AI)
                document.getElementById('input-content').textContent = 
                    JSON.stringify(result.data?.aiInput || {}, null, 2);
                
                // Debug info
                document.getElementById('debug-content').textContent = 
                    JSON.stringify(result.metadata || {}, null, 2);

                viewer.style.display = 'block';
            }

            async previewAIInput() {
                if (!this.contextData) {
                    this.showError('No context data available. Analyze a design first.');
                    return;
                }

                const aiInput = {
                    contextData: this.contextData,
                    nodes: this.contextData.nodes?.length || 0,
                    components: this.contextData.components?.length || 0,
                    styles: this.contextData.styles?.length || 0,
                    confidence: this.contextData.confidence,
                    timestamp: new Date().toISOString()
                };

                document.getElementById('input-content').textContent = 
                    JSON.stringify(aiInput, null, 2);
                
                const viewer = document.getElementById('ai-output-viewer');
                viewer.style.display = 'block';
                
                // Switch to input tab
                this.switchContextTab('input');
            }

            // =============================================================================
            // MCP SERVER INTEGRATION
            // =============================================================================

            async executeMCPOperation() {
                const operation = document.getElementById('mcp-operation').value;
                
                this.setOperationStatus('mcp-server', 'loading', 'Processing...');
                this.log(`üîå Executing MCP operation: ${operation}`, 'info');

                try {
                    let result;

                    switch (operation) {
                        case 'health':
                            result = await this.mcpHealthCheck();
                            break;
                        case 'tools':
                            result = await this.mcpListTools();
                            break;
                        case 'resources':
                            result = await this.mcpListResources();
                            break;
                        case 'call':
                            result = await this.mcpCallTool();
                            break;
                    }

                    this.updateMCPOutputViewer(result);
                    this.setOperationStatus('mcp-server', 'success', 'Complete');
                    this.log(`‚úÖ MCP operation completed: ${operation}`, 'success');

                } catch (error) {
                    this.setOperationStatus('mcp-server', 'error', 'Failed');
                    this.showError(`MCP operation error: ${error.message}`);
                    this.log(`‚ùå MCP operation failed: ${error.message}`, 'error');
                }
            }

            async mcpHealthCheck() {
                const response = await fetch('http://localhost:3000/api/mcp/health');
                return await response.json();
            }

            async mcpListTools() {
                const response = await fetch('http://localhost:3000/api/mcp/tools');
                return await response.json();
            }

            async mcpListResources() {
                const response = await fetch('http://localhost:3000/api/mcp/resources');
                return await response.json();
            }

            async mcpCallTool() {
                const toolName = document.getElementById('tool-name').value.trim();
                const argumentsText = document.getElementById('tool-arguments').value.trim();

                if (!toolName) {
                    throw new Error('Please enter a tool name');
                }

                let toolArguments = {};
                if (argumentsText) {
                    try {
                        toolArguments = JSON.parse(argumentsText);
                    } catch (error) {
                        throw new Error('Invalid JSON in tool arguments');
                    }
                }

                const response = await fetch('http://localhost:3000/api/mcp/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: toolName,
                        arguments: toolArguments
                    })
                });

                return await response.json();
            }

            updateMCPOutputViewer(result) {
                const viewer = document.getElementById('mcp-output-viewer');
                
                // Response
                document.getElementById('response-content').textContent = 
                    JSON.stringify(result, null, 2);
                
                // Tools (if available)
                if (result.data?.tools) {
                    document.getElementById('tools-content').textContent = 
                        JSON.stringify(result.data.tools, null, 2);
                }
                
                // Resources (if available)
                if (result.data?.resources) {
                    document.getElementById('resources-content').textContent = 
                        JSON.stringify(result.data.resources, null, 2);
                }

                viewer.style.display = 'block';
            }

            async testMCPConnection() {
                this.log('üîç Testing MCP server connection', 'info');
                await this.checkMCPStatus();
            }

            // =============================================================================
            // MONITORING
            // =============================================================================

            async refreshMonitoring() {
                this.log('üìà Refreshing system monitoring', 'info');

                try {
                    // Get system health
                    const healthResponse = await fetch('http://localhost:3000/health');
                    const healthData = await healthResponse.json();

                    // Get cache stats
                    const cacheStats = ContextLayer.getCacheStats();

                    // Update metrics
                    const systemMetrics = [
                        { label: 'Uptime', value: Math.floor(healthData.uptime / 60) + 'm' },
                        { label: 'Services', value: healthData.services?.length || 0 },
                        { label: 'Memory (MB)', value: Math.floor((healthData.memory?.heapUsed || 0) / 1024 / 1024) },
                        { label: 'Cache Size', value: cacheStats.size },
                        { label: 'Architecture', value: healthData.architecture?.split(' ')[0] || 'Unknown' },
                        { label: 'Node Version', value: healthData.versions?.node || 'Unknown' }
                    ];

                    this.updateMetricsGrid('system-metrics', systemMetrics);
                    this.log('‚úÖ System monitoring refreshed', 'success');

                } catch (error) {
                    this.log(`‚ùå Monitoring refresh failed: ${error.message}`, 'error');
                }
            }

            // =============================================================================
            // UTILITY METHODS
            // =============================================================================

            setOperationStatus(section, type, text) {
                const badge = document.getElementById(`${section}-status`);
                if (badge) {
                    badge.className = `badge badge-${type === 'loading' ? 'warning' : type}`;
                    badge.textContent = text;
                }
            }

            updateMetricsGrid(containerId, metrics) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = metrics.map(metric => `
                    <div class="metric-card">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `).join('');

                container.style.display = 'grid';
            }

            switchSection(sectionName) {
                // Hide all sections
                document.querySelectorAll('.context-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Remove active state from all nav buttons
                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Show selected section
                document.getElementById(`${sectionName}-section`).classList.add('active');
                
                // Set active nav button
                event.target.classList.add('active');
                
                this.currentSection = sectionName;
                this.log(`üìã Switched to ${sectionName} section`, 'info');
            }

            switchContextTab(tabName) {
                const parent = event.target.closest('.context-viewer');
                if (!parent) return;

                // Remove active from all tabs in this viewer
                parent.querySelectorAll('.context-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                parent.querySelectorAll('.context-tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Activate selected tab
                event.target.classList.add('active');
                const content = parent.querySelector(`#${tabName}-content`);
                if (content) {
                    content.classList.add('active');
                }
            }

            extractFileKey(input) {
                if (!input) return '';
                if (!input.includes('/')) return input;
                const match = input.match(/\/file\/([a-zA-Z0-9]+)/);
                return match ? match[1] : input;
            }

            showError(message) {
                // Could implement toast notifications here
                console.error(message);
                this.log(`‚ùå ${message}`, 'error');
            }

            showSuccess(message) {
                // Could implement toast notifications here
                console.log(message);
                this.log(`‚úÖ ${message}`, 'success');
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = { timestamp, message, type };
                
                this.logs.push(logEntry);
                
                // Keep only last 100 logs
                if (this.logs.length > 100) {
                    this.logs.shift();
                }
                
                this.renderLogs();
            }

            renderLogs() {
                const container = document.getElementById('live-logs');
                if (!container) return;

                container.innerHTML = this.logs.map(log => `
                    <div class="log-entry">
                        <span class="log-timestamp">[${log.timestamp}]</span>
                        <span class="log-${log.type}">${log.message}</span>
                    </div>
                `).join('');

                if (this.autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            clearLogs() {
                this.logs = [];
                this.renderLogs();
                this.log('Logs cleared', 'info');
            }

            // =====================================================================
            // SESSION MANAGEMENT METHODS
            // =====================================================================

            async refreshSessionMetrics() {
                try {
                    this.log('üîÑ Refreshing session metrics...', 'info');
                    
                    // Get performance metrics
                    const performanceResponse = await fetch('/api/session-metrics/performance');
                    const performanceData = await performanceResponse.json();
                    
                    // Get persistence indicators
                    const persistenceResponse = await fetch('/api/session-metrics/persistence');
                    const persistenceData = await persistenceResponse.json();
                    
                    // Get health check
                    const healthResponse = await fetch('/api/session-metrics/health-check');
                    const healthData = await healthResponse.json();
                    
                    if (performanceData.success && persistenceData.success && healthData.success) {
                        this.updateSessionOverview(performanceData.data, healthData.data);
                        this.updatePersistenceIndicators(persistenceData.data);
                        this.updateSessionStatus('healthy');
                        this.log('‚úÖ Session metrics refreshed successfully', 'success');
                    } else {
                        throw new Error('Failed to fetch session metrics');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Failed to refresh session metrics: ${error.message}`, 'error');
                    this.updateSessionStatus('error');
                }
            }

            updateSessionOverview(performanceData, healthData) {
                // Update performance score
                document.getElementById('performance-score').textContent = healthData.score || '--';
                
                // Update active sessions
                document.getElementById('active-sessions').textContent = performanceData.sessions?.active || '--';
                
                // Update cache hit rate
                const hitRate = performanceData.cache?.hitRate || 0;
                document.getElementById('cache-hit-rate').textContent = `${Math.round(hitRate)}%`;
                
                // Update response time
                const avgTime = performanceData.performance?.averageResponseTime || 0;
                document.getElementById('avg-response-time').textContent = `${Math.round(avgTime)}ms`;
                
                // Color code the metrics based on performance
                this.colorCodeMetric('performance-score', healthData.score, [90, 70, 40]);
                this.colorCodeMetric('cache-hit-rate', hitRate, [70, 50, 30]);
                this.colorCodeMetric('avg-response-time', avgTime, [100, 300, 500], true); // Reverse scale
            }

            updatePersistenceIndicators(persistenceData) {
                const indicators = persistenceData.indicators || {};
                
                // Update Redis status
                this.updatePersistenceItem('redis-status', {
                    connected: persistenceData.summary?.redisConnected > 0,
                    status: persistenceData.summary?.redisConnected > 0 ? 'Connected' : 'Disconnected',
                    icon: persistenceData.summary?.redisConnected > 0 ? 'üü¢' : 'üî¥'
                });
                
                // Update Memory status
                this.updatePersistenceItem('memory-status', {
                    connected: persistenceData.summary?.memoryFallback > 0,
                    status: persistenceData.summary?.memoryFallback > 0 ? 'Active Fallback' : 'Standby',
                    icon: persistenceData.summary?.memoryFallback > 0 ? 'üü°' : 'üü¢'
                });
                
                // Update Figma Session Manager status
                const figmaStatus = indicators['FigmaSessionManager'] || indicators['figma'] || {};
                this.updatePersistenceItem('figma-session-status', {
                    connected: figmaStatus.redisConnected || false,
                    status: figmaStatus.persistenceHealth || 'Unknown',
                    icon: figmaStatus.redisConnected ? 'üü¢' : figmaStatus.memoryFallback ? 'üü°' : 'üî¥'
                });
            }

            updatePersistenceItem(itemId, { connected, status, icon }) {
                const item = document.getElementById(itemId);
                if (!item) return;
                
                const iconElement = item.querySelector('.persistence-icon');
                const statusElement = item.querySelector('.persistence-status');
                
                if (iconElement) iconElement.textContent = icon;
                if (statusElement) statusElement.textContent = status;
                
                // Update item class based on status
                item.classList.remove('healthy', 'degraded', 'critical');
                if (connected) {
                    item.classList.add('healthy');
                } else if (status.includes('Fallback') || status.includes('Standby')) {
                    item.classList.add('degraded');
                } else {
                    item.classList.add('critical');
                }
            }

            colorCodeMetric(elementId, value, thresholds, reverse = false) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                element.classList.remove('metric-excellent', 'metric-good', 'metric-fair', 'metric-poor');
                
                let className = 'metric-poor';
                if (reverse) {
                    if (value <= thresholds[0]) className = 'metric-excellent';
                    else if (value <= thresholds[1]) className = 'metric-good';
                    else if (value <= thresholds[2]) className = 'metric-fair';
                } else {
                    if (value >= thresholds[0]) className = 'metric-excellent';
                    else if (value >= thresholds[1]) className = 'metric-good';
                    else if (value >= thresholds[2]) className = 'metric-fair';
                }
                
                element.classList.add(className);
            }

            updateSessionStatus(status) {
                const statusElement = document.getElementById('session-management-status');
                if (!statusElement) return;
                
                statusElement.classList.remove('badge-success', 'badge-warning', 'badge-danger', 'badge-info');
                
                switch (status) {
                    case 'healthy':
                        statusElement.classList.add('badge-success');
                        statusElement.textContent = 'Healthy';
                        break;
                    case 'degraded':
                        statusElement.classList.add('badge-warning');
                        statusElement.textContent = 'Degraded';
                        break;
                    case 'error':
                        statusElement.classList.add('badge-danger');
                        statusElement.textContent = 'Error';
                        break;
                    default:
                        statusElement.classList.add('badge-info');
                        statusElement.textContent = 'Ready';
                }
            }

            async showSessionAnalytics() {
                try {
                    this.log('üìä Loading session analytics...', 'info');
                    
                    const viewer = document.getElementById('session-analytics-viewer');
                    viewer.style.display = 'block';
                    
                    // Load performance data
                    await this.loadSessionPerformanceData();
                    
                    // Load cache stats
                    await this.loadSessionCacheData();
                    
                    // Load health data
                    await this.loadSessionHealthData();
                    
                    // Start real-time updates
                    this.startSessionRealTimeUpdates();
                    
                    this.log('‚úÖ Session analytics loaded', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Failed to load session analytics: ${error.message}`, 'error');
                }
            }

            async loadSessionPerformanceData() {
                const response = await fetch('/api/session-metrics/performance');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('performance-content');
                    content.innerHTML = `
                        <div class="analytics-section">
                            <h4>üìä Session Performance</h4>
                            <div class="analytics-grid">
                                <div class="analytics-item">
                                    <span class="analytics-label">Sessions Created:</span>
                                    <span class="analytics-value">${data.data.sessions?.created || 0}</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Active Sessions:</span>
                                    <span class="analytics-value">${data.data.sessions?.active || 0}</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Average Response:</span>
                                    <span class="analytics-value">${Math.round(data.data.performance?.averageResponseTime || 0)}ms</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Min Response:</span>
                                    <span class="analytics-value">${Math.round(data.data.performance?.minResponseTime || 0)}ms</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Max Response:</span>
                                    <span class="analytics-value">${Math.round(data.data.performance?.maxResponseTime || 0)}ms</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Total Errors:</span>
                                    <span class="analytics-value">${data.data.errors || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            async loadSessionCacheData() {
                const response = await fetch('/api/session-metrics/cache-stats');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('cache-content');
                    content.innerHTML = `
                        <div class="analytics-section">
                            <h4>üíæ Cache Performance</h4>
                            <div class="analytics-grid">
                                <div class="analytics-item">
                                    <span class="analytics-label">Overall Hit Rate:</span>
                                    <span class="analytics-value">${Math.round(data.data.overall?.hitRate || 0)}%</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Total Hits:</span>
                                    <span class="analytics-value">${data.data.overall?.totalHits || 0}</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Total Misses:</span>
                                    <span class="analytics-value">${data.data.overall?.totalMisses || 0}</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Cache Efficiency:</span>
                                    <span class="analytics-value">${data.data.performance?.cacheEfficiency || 'Unknown'}</span>
                                </div>
                                <div class="analytics-item">
                                    <span class="analytics-label">Recent Hit Rate:</span>
                                    <span class="analytics-value">${Math.round(data.data.recent?.hitRate || 0)}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            async loadSessionHealthData() {
                const response = await fetch('/api/session-metrics/health-check');
                const data = await response.json();
                
                if (data.success) {
                    const content = document.getElementById('health-content');
                    const issues = data.data.issues || [];
                    
                    content.innerHTML = `
                        <div class="analytics-section">
                            <h4>üè• Health Status</h4>
                            <div class="health-overview">
                                <div class="health-score ${data.data.status}">
                                    <span class="health-score-value">${data.data.score}/100</span>
                                    <span class="health-score-label">${data.data.status.toUpperCase()}</span>
                                </div>
                                <div class="health-checks">
                                    ${Object.entries(data.data.checks || {}).map(([check, passed]) => `
                                        <div class="health-check ${passed ? 'passed' : 'failed'}">
                                            <span class="health-check-icon">${passed ? '‚úÖ' : '‚ùå'}</span>
                                            <span class="health-check-name">${check.replace(/([A-Z])/g, ' $1').trim()}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${issues.length > 0 ? `
                                    <div class="health-issues">
                                        <h5>Issues Found:</h5>
                                        <ul>
                                            ${issues.map(issue => `<li>${issue}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : '<div class="health-issues"><span class="no-issues">No issues detected</span></div>'}
                            </div>
                        </div>
                    `;
                }
            }

            startSessionRealTimeUpdates() {
                if (this.sessionRealTimeInterval) {
                    clearInterval(this.sessionRealTimeInterval);
                }
                
                this.sessionRealTimeInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/session-metrics/realtime');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.updateRealTimeTab(data.data);
                        }
                    } catch (error) {
                        console.warn('Failed to update real-time session data:', error);
                    }
                }, 5000); // Update every 5 seconds
            }

            updateRealTimeTab(realtimeData) {
                const content = document.getElementById('realtime-content');
                if (!content) return;
                
                content.innerHTML = `
                    <div class="analytics-section">
                        <h4>‚ö° Real-time Metrics</h4>
                        <div class="realtime-metrics">
                            <div class="realtime-item">
                                <span class="realtime-label">Current Response Time:</span>
                                <span class="realtime-value">${Math.round(realtimeData.performance?.current?.averageResponseTime || 0)}ms</span>
                            </div>
                            <div class="realtime-item">
                                <span class="realtime-label">Requests/sec:</span>
                                <span class="realtime-value">${Math.round(realtimeData.performance?.current?.requestsPerSecond || 0)}</span>
                            </div>
                            <div class="realtime-item">
                                <span class="realtime-label">Active Sessions:</span>
                                <span class="realtime-value">${realtimeData.sessions?.active || 0}</span>
                            </div>
                            <div class="realtime-item">
                                <span class="realtime-label">Cache Hit Rate:</span>
                                <span class="realtime-value">${Math.round(realtimeData.cache?.hitRate || 0)}%</span>
                            </div>
                            <div class="realtime-item">
                                <span class="realtime-label">Health Score:</span>
                                <span class="realtime-value">${realtimeData.health?.score || '--'}/100</span>
                            </div>
                        </div>
                        <div class="realtime-timestamp">
                            Last updated: ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                `;
            }

            async runSessionHealthCheck() {
                try {
                    this.log('üè• Running session health check...', 'info');
                    
                    const response = await fetch('/api/session-metrics/health-check');
                    const data = await response.json();
                    
                    if (data.success) {
                        const issues = data.data.issues || [];
                        const status = data.data.status;
                        
                        this.updateSessionStatus(status);
                        
                        if (issues.length === 0) {
                            this.log('‚úÖ Session health check passed - no issues found', 'success');
                        } else {
                            this.log(`‚ö†Ô∏è Session health check found ${issues.length} issues: ${issues.join(', ')}`, 'warning');
                        }
                    } else {
                        throw new Error(data.error || 'Health check failed');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Session health check failed: ${error.message}`, 'error');
                    this.updateSessionStatus('error');
                }
            }

            async clearSessionCache() {
                try {
                    this.log('üßπ Clearing session cache...', 'info');
                    
                    // This would need to be implemented in the backend
                    const response = await fetch('/api/session-metrics/clear-cache', { method: 'POST' });
                    
                    if (response.ok) {
                        this.log('‚úÖ Session cache cleared successfully', 'success');
                        await this.refreshSessionMetrics(); // Refresh to show updated stats
                    } else {
                        throw new Error('Failed to clear cache');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Failed to clear session cache: ${error.message}`, 'error');
                }
            }

            switchSessionTab(tabName) {
                const parent = document.getElementById('session-analytics-viewer');
                if (!parent) return;

                // Remove active from all tabs
                parent.querySelectorAll('.context-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                parent.querySelectorAll('.context-tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Activate selected tab
                event.target.classList.add('active');
                const content = parent.querySelector(`#${tabName}-content`);
                if (content) {
                    content.classList.add('active');
                }
            }

            clearAll() {
                this.contextData = null;
                document.getElementById('figma-url').value = '';
                document.getElementById('search-query').value = '';
                document.getElementById('tool-name').value = '';
                document.getElementById('tool-arguments').value = '';
                
                // Hide all viewers
                document.querySelectorAll('.context-viewer').forEach(viewer => {
                    viewer.style.display = 'none';
                });
                
                // Hide metrics
                document.querySelectorAll('.metrics-grid').forEach(grid => {
                    grid.style.display = 'none';
                });
                
                // Reset status badges
                document.querySelectorAll('[id$="-status"]').forEach(badge => {
                    badge.className = 'badge badge-info';
                    badge.textContent = 'Ready';
                });
                
                this.log('üßπ All data and views cleared', 'info');
            }

            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                const btn = document.querySelector('[onclick="toggleAutoScroll()"]');
                if (btn) {
                    btn.textContent = `üìú Auto-scroll: ${this.autoScroll ? 'ON' : 'OFF'}`;
                }
                this.log(`Auto-scroll ${this.autoScroll ? 'enabled' : 'disabled'}`, 'info');
            }

            populateWithFigmaContext(contextData) {
                this.log('üìä Populating dashboard with Figma context data', 'info');
                
                try {
                    // Update the Figma URL field if we have file context
                    if (contextData.figmaData?.fileContext?.fileName) {
                        const urlInput = document.getElementById('figma-url');
                        if (urlInput && !urlInput.value) {
                            urlInput.value = `https://figma.com/file/demo/${contextData.figmaData.fileContext.fileName}`;
                        }
                    }
                    
                    // Update tech stack if available
                    if (contextData.techStack?.description) {
                        const techStackInput = document.getElementById('tech-stack');
                        if (techStackInput) {
                            techStackInput.value = contextData.techStack.description;
                        }
                    }
                    
                    // Store context data globally
                    window.figmaContextData = contextData;
                    
                    // Update context tabs with real data
                    this.updateContextTabs(contextData);
                    
                    // Simulate successful analysis
                    setTimeout(() => {
                        this.log(`‚úÖ Loaded ${contextData.components?.length || 0} components, ${Object.keys(contextData.designTokens || {}).length} token categories`, 'success');
                        this.updateStatus('figma', 'online', 'Plugin Data Loaded');
                    }, 500);
                    
                } catch (error) {
                    this.log(`‚ùå Error populating dashboard: ${error.message}`, 'error');
                    console.error('Dashboard population error:', error);
                }
            }

            updateContextTabs(contextData) {
                // Update Overview tab
                const overviewContent = document.getElementById('overview-content');
                if (overviewContent && contextData.figmaData) {
                    overviewContent.innerHTML = `
                        <div class="context-metrics">
                            <div class="metric-item">
                                <span class="metric-label">Selection Count:</span>
                                <span class="metric-value">${contextData.figmaData.selection?.length || 0}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Components:</span>
                                <span class="metric-value">${contextData.components?.length || 0}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Design Tokens:</span>
                                <span class="metric-value">${Object.keys(contextData.designTokens || {}).length}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">File:</span>
                                <span class="metric-value">${contextData.figmaData.fileContext?.fileName || 'Unknown'}</span>
                            </div>
                        </div>
                    `;
                }

                // Update Raw Data tab
                const rawContent = document.getElementById('raw-content');
                if (rawContent) {
                    rawContent.innerHTML = `<pre>${JSON.stringify(contextData, null, 2)}</pre>`;
                }

                // Update Tokens tab if design tokens exist
                const tokensContent = document.getElementById('tokens-content');
                if (tokensContent && contextData.designTokens) {
                    const tokenHtml = Object.entries(contextData.designTokens).map(([category, tokens]) => {
                        if (Array.isArray(tokens) && tokens.length > 0) {
                            return `
                                <div class="token-category">
                                    <h4>${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                                    <div class="token-list">
                                        ${tokens.slice(0, 10).map(token => `<span class="token-item">${token}</span>`).join('')}
                                        ${tokens.length > 10 ? `<span class="token-more">+${tokens.length - 10} more</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                    
                    tokensContent.innerHTML = tokenHtml || '<p>No design tokens found</p>';
                }
            }

            exportLogs() {
                const logText = this.logs.map(log => 
                    `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`
                ).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `context-dashboard-logs-${new Date().toISOString().slice(0, 19)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.log('üì• Logs exported', 'info');
            }

            // =============================================================================
            // INTELLIGENCE TABS METHODS
            // =============================================================================

            switchIntelligenceTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.intel-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.intel-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const targetContent = document.getElementById(`${tabName}-content`);
                const targetTab = document.querySelector(`[onclick="switchIntelligenceTab('${tabName}')"]`);
                
                if (targetContent) targetContent.classList.add('active');
                if (targetTab) targetTab.classList.add('active');
                
                // Load content for the selected tab
                this.loadTabContent(tabName);
                this.log(`üß† Switched to ${tabName} intelligence tab`, 'info');
            }

            async loadTabContent(tabName) {
                try {
                    switch (tabName) {
                        case 'components':
                            await this.loadSemanticComponents();
                            break;
                        case 'accessibility':
                            await this.loadAccessibilityAnalysis();
                            break;
                        case 'code':
                            await this.loadCodePreview();
                            break;
                        case 'flows':
                            await this.loadInteractionFlows();
                            break;
                    }
                } catch (error) {
                    this.log(`‚ùå Error loading ${tabName} content: ${error.message}`, 'error');
                    this.showTabError(tabName, error.message);
                }
            }

            async loadSemanticComponents() {
                const container = document.getElementById('components-content');
                if (!container) return;
                
                try {
                    this.showLoadingState('components-content');
                    this.log('üîç Loading semantic components analysis...', 'info');
                    
                    const response = await fetch('/api/context-intelligence/semantic-analysis');
                    const data = await response.json();
                    
                    if (data.success && data.components) {
                        this.renderSemanticComponents(data.components);
                        this.log(`‚úÖ Loaded ${data.components.length} semantic components`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to load semantic components');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load semantic components: ${error.message}`, 'error');
                    this.showTabError('components-content', error.message);
                }
            }

            renderSemanticComponents(components) {
                const container = document.getElementById('components-content');
                
                const html = `
                    <div class="intel-content-header">
                        <h4>Semantic Component Analysis</h4>
                        <div class="intel-actions">
                            <select id="component-filter" onchange="filterComponents()">
                                <option value="all">All Components</option>
                                <option value="high">High Confidence</option>
                                <option value="medium">Medium Confidence</option>
                                <option value="low">Low Confidence</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshComponents()">
                                Refresh Analysis
                            </button>
                        </div>
                    </div>
                    <div class="components-list">
                        ${components.map(component => `
                            <div class="component-card" data-confidence="${this.getConfidenceLevel(component.confidence)}">
                                <div class="component-header">
                                    <div class="component-name">${component.name || 'Unknown Component'}</div>
                                    <div class="component-type">${component.type || 'Element'}</div>
                                </div>
                                <div class="component-details">
                                    <div><strong>Purpose:</strong> ${component.purpose || 'Not determined'}</div>
                                    <div><strong>Context:</strong> ${component.context || 'No context available'}</div>
                                    ${component.properties ? `<div><strong>Properties:</strong> ${Object.keys(component.properties).join(', ')}</div>` : ''}
                                </div>
                                <div class="component-confidence">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${component.confidence * 100}%"></div>
                                    </div>
                                    <div class="confidence-score">${Math.round(component.confidence * 100)}%</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.innerHTML = html;
            }

            async loadAccessibilityAnalysis() {
                try {
                    this.showLoadingState('accessibility-content');
                    this.log('‚ôø Loading accessibility analysis...', 'info');
                    
                    const response = await fetch('/api/context-intelligence/accessibility-score');
                    const data = await response.json();
                    
                    if (data.success && data.analysis) {
                        this.renderAccessibilityAnalysis(data.analysis);
                        this.log(`‚úÖ Accessibility analysis complete (Score: ${data.analysis.overallScore || 'N/A'})`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to load accessibility analysis');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load accessibility analysis: ${error.message}`, 'error');
                    this.showTabError('accessibility-content', error.message);
                }
            }

            renderAccessibilityAnalysis(analysis) {
                const container = document.getElementById('accessibility-content');
                
                const html = `
                    <div class="intel-content-header">
                        <h4>Accessibility Analysis</h4>
                        <div class="intel-actions">
                            <label class="checkbox-label">
                                <input type="checkbox" id="show-passing" checked onchange="toggleAccessibilityFilter()">
                                Show Passing Items
                            </label>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshAccessibility()">
                                Re-analyze
                            </button>
                        </div>
                    </div>
                    <div class="accessibility-content">
                        ${Object.entries(analysis.categories || {}).map(([category, data]) => `
                            <div class="accessibility-category">
                                <div class="category-header">
                                    <div class="category-name">${this.formatCategoryName(category)}</div>
                                    <div class="category-score ${this.getScoreClass(data.score)}">${data.score}/100</div>
                                </div>
                                ${data.issues && data.issues.length > 0 ? `
                                    <div class="category-issues">
                                        <strong>Issues Found:</strong>
                                        ${data.issues.map(issue => `
                                            <div class="issue-item">
                                                <span class="issue-icon">‚ö†</span>
                                                <span>${issue.description || issue}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${data.recommendations && data.recommendations.length > 0 ? `
                                    <div class="category-recommendations">
                                        <strong>Recommendations:</strong>
                                        ${data.recommendations.map(rec => `
                                            <div class="recommendation-item">
                                                <span class="recommendation-icon">‚úì</span>
                                                <span>${rec.description || rec}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.innerHTML = html;
            }

            async loadCodePreview() {
                try {
                    this.showLoadingState('code-content');
                    this.log('üíª Generating code preview...', 'info');
                    
                    const framework = document.getElementById('framework-select')?.value || 'react';
                    const response = await fetch(`/api/context-intelligence/code-preview?framework=${framework}`);
                    const data = await response.json();
                    
                    if (data.success && data.code) {
                        this.renderCodePreview(data.code, framework);
                        this.log(`‚úÖ Code preview generated for ${framework}`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to generate code preview');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to generate code preview: ${error.message}`, 'error');
                    this.showTabError('code-content', error.message);
                }
            }

            renderCodePreview(codeData, framework) {
                const container = document.getElementById('code-content');
                
                const frameworks = ['react', 'vue', 'angular'];
                const html = `
                    <div class="intel-content-header">
                        <h4>Generated Code Preview</h4>
                        <div class="intel-actions">
                            <select id="framework-select" onchange="switchFramework()">
                                ${frameworks.map(fw => `
                                    <option value="${fw}" ${fw === framework ? 'selected' : ''}>
                                        ${fw.charAt(0).toUpperCase() + fw.slice(1)}
                                    </option>
                                `).join('')}
                            </select>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadCode()">
                                Download Code
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshCodePreview()">
                                Regenerate
                            </button>
                        </div>
                    </div>
                    <div class="code-preview-body">
                        <div class="code-tabs">
                            ${Object.keys(codeData).map(fileType => `
                                <button class="code-tab ${fileType === 'component' ? 'active' : ''}" 
                                        onclick="switchCodeTab('${fileType}')">
                                    ${this.formatFileType(fileType)}
                                </button>
                            `).join('')}
                        </div>
                        ${Object.entries(codeData).map(([fileType, code]) => `
                            <div class="code-content ${fileType === 'component' ? 'active' : ''}" 
                                 id="code-${fileType}">
                                <pre><code>${this.escapeHtml(code)}</code></pre>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.innerHTML = html;
            }

            async loadInteractionFlows() {
                try {
                    this.showLoadingState('flows-content');
                    this.log('üîÑ Loading interaction flows...', 'info');
                    
                    const response = await fetch('/api/context-intelligence/interaction-flows');
                    const data = await response.json();
                    
                    if (data.success && data.flows) {
                        this.renderInteractionFlows(data.flows);
                        this.log(`‚úÖ Loaded ${data.flows.length} interaction flows`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to load interaction flows');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load interaction flows: ${error.message}`, 'error');
                    this.showTabError('flows-content', error.message);
                }
            }

            renderInteractionFlows(flows) {
                const container = document.getElementById('flows-content');
                
                const html = `
                    <div class="intel-content-header">
                        <h4>User Interaction Flows</h4>
                        <div class="intel-actions">
                            <select id="flow-filter" onchange="filterFlows()">
                                <option value="all">All Flows</option>
                                <option value="primary">Primary Flows</option>
                                <option value="secondary">Secondary Flows</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshFlows()">
                                Refresh Analysis
                            </button>
                        </div>
                    </div>
                    <div class="flows-content">
                        ${flows.map(flow => `
                            <div class="flow-diagram" data-type="${flow.type || 'primary'}">
                                <div class="flow-header">
                                    <div class="flow-name">${flow.name || 'Unnamed Flow'}</div>
                                    <div class="flow-confidence">${Math.round((flow.confidence || 0.8) * 100)}% Confidence</div>
                                </div>
                                <div class="flow-steps">
                                    ${(flow.steps || []).map((step, index) => `
                                        <div class="flow-step">${step.name || `Step ${index + 1}`}</div>
                                        ${index < flow.steps.length - 1 ? '<div class="flow-arrow">‚Üí</div>' : ''}
                                    `).join('')}
                                </div>
                                ${flow.description ? `
                                    <div class="flow-description" style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                                        ${flow.description}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.innerHTML = html;
            }

            // Intelligence Tab Helper Methods
            showLoadingState(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <div>Loading intelligence data...</div>
                        </div>
                    `;
                }
            }

            showTabError(containerId, message) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="loading-state">
                            <div style="color: #e74c3c; font-size: 2em;">‚ö†</div>
                            <div>Error loading data: ${message}</div>
                            <button class="btn btn-outline-primary" onclick="location.reload()">
                                Retry
                            </button>
                        </div>
                    `;
                }
            }

            getConfidenceLevel(confidence) {
                if (confidence >= 0.8) return 'high';
                if (confidence >= 0.6) return 'medium';
                return 'low';
            }

            formatCategoryName(category) {
                return category.split('_').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }

            getScoreClass(score) {
                if (score >= 90) return 'score-excellent';
                if (score >= 70) return 'score-good';
                if (score >= 50) return 'score-fair';
                return 'score-poor';
            }

            formatFileType(fileType) {
                const types = {
                    component: 'Component',
                    styles: 'Styles',
                    types: 'Types',
                    tests: 'Tests',
                    story: 'Storybook'
                };
                return types[fileType] || fileType;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            switchCodeTab(tabName) {
                document.querySelectorAll('.code-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.code-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector(`[onclick="switchCodeTab('${tabName}')"]`).classList.add('active');
                document.getElementById(`code-${tabName}`).classList.add('active');
            }

            // Intelligence Action Methods
            async generateCodePreview() {
                await this.loadCodePreview();
            }

            async runFullIntelligenceAnalysis() {
                try {
                    this.log('üß† Starting full intelligence analysis...', 'info');
                    
                    // Show loading state
                    document.querySelectorAll('.intel-value').forEach(el => {
                        el.textContent = '...';
                    });

                    // Load overview data
                    const response = await fetch('/api/context-intelligence/summary');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateIntelligenceOverview(data.summary);
                        this.log('‚úÖ Intelligence summary updated', 'success');
                    }

                    // Refresh current tab content
                    const activeTab = document.querySelector('.intel-tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.toLowerCase().replace(' ', '-');
                        if (tabName.includes('component')) {
                            await this.loadSemanticComponents();
                        } else if (tabName.includes('accessibility')) {
                            await this.loadAccessibilityAnalysis();
                        } else if (tabName.includes('code')) {
                            await this.loadCodePreview();
                        } else if (tabName.includes('flow')) {
                            await this.loadInteractionFlows();
                        }
                    }
                    
                    this.log('üéâ Full intelligence analysis complete', 'success');
                } catch (error) {
                    this.log(`‚ùå Error running full intelligence analysis: ${error.message}`, 'error');
                }
            }

            updateIntelligenceOverview(summary) {
                if (summary.semanticComponents) {
                    const element = document.getElementById('semantic-count');
                    if (element) element.textContent = summary.semanticComponents.count || 0;
                }
                if (summary.accessibilityScore) {
                    const element = document.getElementById('accessibility-score');
                    if (element) element.textContent = summary.accessibilityScore.overall || 0;
                }
                if (summary.interactionFlows) {
                    const element = document.getElementById('flows-count');
                    if (element) element.textContent = summary.interactionFlows.count || 0;
                }
                if (summary.codeComponents) {
                    const element = document.getElementById('code-components');
                    if (element) element.textContent = summary.codeComponents.count || 0;
                }
            }

            // Event Handlers for Intelligence Features
            refreshComponents() {
                this.loadSemanticComponents();
            }

            refreshAccessibility() {
                this.loadAccessibilityAnalysis();
            }

            refreshCodePreview() {
                this.loadCodePreview();
            }

            refreshFlows() {
                this.loadInteractionFlows();
            }

            switchFramework() {
                this.loadCodePreview();
            }

            downloadCode() {
                const activeContent = document.querySelector('.code-content.active pre code');
                if (activeContent) {
                    const blob = new Blob([activeContent.textContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'generated-component.txt';
                    a.click();
                    URL.revokeObjectURL(url);
                    this.log('üì• Code downloaded', 'success');
                }
            }

            filterComponents() {
                const filter = document.getElementById('component-filter').value;
                const components = document.querySelectorAll('.component-card');
                
                components.forEach(card => {
                    const confidence = card.dataset.confidence;
                    if (filter === 'all' || confidence === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                this.log(`üîç Filtered components by ${filter} confidence`, 'info');
            }

            toggleAccessibilityFilter() {
                const showPassing = document.getElementById('show-passing').checked;
                this.log(`‚ôø Accessibility filter: ${showPassing ? 'showing' : 'hiding'} passing items`, 'info');
            }

            filterFlows() {
                const filter = document.getElementById('flow-filter').value;
                const flows = document.querySelectorAll('.flow-diagram');
                
                flows.forEach(flow => {
                    const type = flow.dataset.type;
                    if (filter === 'all' || type === filter) {
                        flow.style.display = 'block';
                    } else {
                        flow.style.display = 'none';
                    }
                });
                
                this.log(`üîÑ Filtered flows by ${filter} type`, 'info');
            }

            // =============================================================================
            // HEALTH MONITORING METHODS
            // =============================================================================

            switchHealthTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.health-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.health-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const targetContent = document.getElementById(`${tabName}-content`);
                const targetTab = document.querySelector(`[onclick="switchHealthTab('${tabName}')"]`);
                
                if (targetContent) targetContent.classList.add('active');
                if (targetTab) targetTab.classList.add('active');
                
                // Load content for the selected tab
                this.loadHealthTabContent(tabName);
                this.log(`üè• Switched to ${tabName} health tab`, 'info');
            }

            async loadHealthTabContent(tabName) {
                try {
                    switch (tabName) {
                        case 'dashboard':
                            await this.loadHealthDashboard();
                            break;
                        case 'components':
                            await this.loadComponentsStatus();
                            break;
                        case 'metrics':
                            await this.loadMetricsVisualization();
                            break;
                        case 'alerts':
                            await this.loadSystemAlerts();
                            break;
                    }
                } catch (error) {
                    this.log(`‚ùå Error loading ${tabName} health content: ${error.message}`, 'error');
                    this.showHealthTabError(tabName, error.message);
                }
            }

            async refreshHealthData() {
                try {
                    this.log('üîÑ Refreshing health data...', 'info');
                    
                    // Update overview cards
                    await this.updateHealthOverview();
                    
                    // Refresh current tab content
                    const activeTab = document.querySelector('.health-tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.toLowerCase().replace(/[^a-z]/g, '');
                        await this.loadHealthTabContent(tabName);
                    }
                    
                    this.log('‚úÖ Health data refreshed', 'success');
                } catch (error) {
                    this.log(`‚ùå Failed to refresh health data: ${error.message}`, 'error');
                }
            }

            async updateHealthOverview() {
                try {
                    const response = await fetch('/api/health-monitoring/summary');
                    const data = await response.json();
                    
                    if (data.success) {
                        const summary = data.data;
                        
                        // Update overall health
                        const overallHealth = document.getElementById('overall-health');
                        const overallStatus = document.getElementById('overall-status');
                        if (overallHealth) overallHealth.textContent = `${summary.overall.score}%`;
                        if (overallStatus) {
                            overallStatus.textContent = summary.overall.status;
                            overallStatus.className = `health-status ${summary.overall.status}`;
                        }
                        
                        // Update active services
                        const activeServices = document.getElementById('active-services');
                        if (activeServices) {
                            activeServices.textContent = `${summary.services.healthy}/${summary.services.total}`;
                        }
                        
                        // Update error rate
                        const errorRate = document.getElementById('error-rate');
                        if (errorRate) {
                            errorRate.textContent = `${(summary.performance.errorRate * 100).toFixed(1)}%`;
                        }
                        
                        // Update active alerts
                        const activeAlerts = document.getElementById('active-alerts');
                        if (activeAlerts) {
                            activeAlerts.textContent = summary.alerts.recent;
                        }
                        
                        // Update uptime
                        const uptimeValue = document.getElementById('uptime-value');
                        if (uptimeValue) {
                            uptimeValue.textContent = this.formatUptime(summary.overall.uptime);
                        }
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to update health overview: ${error.message}`, 'error');
                }
            }

            async loadHealthDashboard() {
                try {
                    const response = await fetch('/api/health-monitoring/realtime');
                    const data = await response.json();
                    
                    if (data.success) {
                        const metrics = data.data;
                        
                        // Update memory usage
                        if (metrics.memoryUsage) {
                            const memoryProgress = document.getElementById('memory-progress');
                            const memoryValue = document.getElementById('memory-value');
                            if (memoryProgress) {
                                const percentage = metrics.memoryUsage.value * 100;
                                memoryProgress.style.width = `${percentage}%`;
                                memoryProgress.className = `progress-fill ${this.getHealthClass(percentage, 70, 85)}`;
                            }
                            if (memoryValue && metrics.memoryUsage.details) {
                                memoryValue.textContent = `${metrics.memoryUsage.details.heapUsed}MB / ${metrics.memoryUsage.details.heapTotal}MB`;
                            }
                        }
                        
                        // Update CPU usage
                        if (metrics.cpuUsage) {
                            const cpuProgress = document.getElementById('cpu-progress');
                            const cpuValue = document.getElementById('cpu-value');
                            if (cpuProgress) {
                                const percentage = metrics.cpuUsage.value;
                                cpuProgress.style.width = `${percentage}%`;
                                cpuProgress.className = `progress-fill ${this.getHealthClass(percentage, 60, 80)}`;
                            }
                            if (cpuValue) {
                                cpuValue.textContent = `${metrics.cpuUsage.value.toFixed(1)}%`;
                            }
                        }
                        
                        // Update uptime
                        const uptimeValue = document.getElementById('uptime-value');
                        if (uptimeValue) {
                            uptimeValue.textContent = this.formatUptime(metrics.uptime);
                        }
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load health dashboard: ${error.message}`, 'error');
                }
            }

            async loadComponentsStatus() {
                try {
                    this.showHealthLoadingState('components-list');
                    
                    const response = await fetch('/api/health-monitoring/components');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderComponentsStatus(data.data.components);
                        this.log(`‚úÖ Loaded ${data.data.components.length} component statuses`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to load components status');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load components status: ${error.message}`, 'error');
                    this.showHealthTabError('components-list', error.message);
                }
            }

            renderComponentsStatus(components) {
                const container = document.getElementById('components-list');
                
                const html = components.map(component => `
                    <div class="component-status-card ${component.status}">
                        <div class="component-header">
                            <div class="component-name">${component.name}</div>
                            <div class="component-status-badge ${component.status}">
                                ${component.status.toUpperCase()}
                            </div>
                        </div>
                        <div class="component-details">
                            <div><strong>Type:</strong> ${component.type}</div>
                            <div><strong>Critical:</strong> ${component.critical ? 'Yes' : 'No'}</div>
                            <div><strong>Last Check:</strong> ${component.lastCheck ? new Date(component.lastCheck).toLocaleString() : 'Never'}</div>
                            <div><strong>Response Time:</strong> ${component.responseTime ? `${component.responseTime}ms` : 'N/A'}</div>
                            <div><strong>Errors:</strong> ${component.errors}</div>
                            ${component.details && Object.keys(component.details).length > 0 ? `
                                <div><strong>Details:</strong> ${JSON.stringify(component.details)}</div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            }

            async loadMetricsVisualization() {
                try {
                    const response = await fetch('/api/health-monitoring/metrics/history');
                    const data = await response.json();
                    
                    if (data.success) {
                        // For now, show placeholder charts
                        // In a real implementation, you would use a charting library
                        document.getElementById('memory-chart').innerHTML = `
                            <div class="chart-placeholder">
                                üìä Memory usage over time<br>
                                <small>Latest: ${data.data.memory ? data.data.memory[data.data.memory.length - 1]?.details?.heapUsed + 'MB' : 'N/A'}</small>
                            </div>
                        `;
                        
                        document.getElementById('cpu-chart').innerHTML = `
                            <div class="chart-placeholder">
                                üìà CPU usage over time<br>
                                <small>Latest: ${data.data.cpu ? data.data.cpu[data.data.cpu.length - 1]?.value.toFixed(1) + '%' : 'N/A'}</small>
                            </div>
                        `;
                        
                        document.getElementById('requests-chart').innerHTML = `
                            <div class="chart-placeholder">
                                üìâ Request metrics over time<br>
                                <small>Response times and volume</small>
                            </div>
                        `;
                        
                        this.log('‚úÖ Metrics visualization loaded', 'success');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load metrics visualization: ${error.message}`, 'error');
                }
            }

            async loadSystemAlerts() {
                try {
                    this.showHealthLoadingState('alerts-list');
                    
                    const response = await fetch('/api/health-monitoring/alerts');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderSystemAlerts(data.data.alerts);
                        this.log(`‚úÖ Loaded ${data.data.alerts.length} alerts`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to load alerts');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to load system alerts: ${error.message}`, 'error');
                    this.showHealthTabError('alerts-list', error.message);
                }
            }

            renderSystemAlerts(alerts) {
                const container = document.getElementById('alerts-list');
                
                if (alerts.length === 0) {
                    container.innerHTML = `
                        <div class="alert-item info">
                            <div class="alert-icon">‚úÖ</div>
                            <div class="alert-content">
                                <div class="alert-message">No active alerts</div>
                                <div class="alert-details">System is running normally</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const html = alerts.map(alert => `
                    <div class="alert-item ${alert.type}">
                        <div class="alert-icon">
                            ${alert.type === 'critical' ? 'üö®' : alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                        </div>
                        <div class="alert-content">
                            <div class="alert-message">${alert.message}</div>
                            <div class="alert-details">
                                Component: ${alert.component} | 
                                ${alert.threshold ? `Threshold: ${alert.threshold} | ` : ''}
                                ${alert.value ? `Value: ${alert.value}` : ''}
                            </div>
                            <div class="alert-timestamp">
                                ${new Date(alert.timestamp).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            }

            // Health Monitoring Helper Methods
            showHealthLoadingState(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <div>Loading health data...</div>
                        </div>
                    `;
                }
            }

            showHealthTabError(containerId, message) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="loading-state">
                            <div style="color: #e74c3c; font-size: 2em;">‚ö†</div>
                            <div>Error loading health data: ${message}</div>
                            <button class="btn btn-outline-primary" onclick="refreshHealthData()">
                                Retry
                            </button>
                        </div>
                    `;
                }
            }

            getHealthClass(value, warningThreshold, criticalThreshold) {
                if (value >= criticalThreshold) return 'critical';
                if (value >= warningThreshold) return 'warning';
                return 'healthy';
            }

            formatUptime(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                if (days > 0) {
                    return `${days}d ${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${minutes}m`;
                }
            }

            // Health Monitoring Action Methods
            async checkAllComponents() {
                try {
                    this.log('üîç Running comprehensive component check...', 'info');
                    
                    // This would trigger checks for all components
                    // For now, just refresh the components view
                    await this.loadComponentsStatus();
                    
                    this.log('‚úÖ Component check completed', 'success');
                } catch (error) {
                    this.log(`‚ùå Component check failed: ${error.message}`, 'error');
                }
            }

            async exportMetrics() {
                try {
                    const response = await fetch('/api/health-monitoring/metrics/history');
                    const data = await response.json();
                    
                    if (data.success) {
                        const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `health-metrics-${new Date().toISOString().slice(0, 19)}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        this.log('üì• Health metrics exported', 'success');
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to export metrics: ${error.message}`, 'error');
                }
            }

            async clearOldAlerts() {
                try {
                    const response = await fetch('/api/health-monitoring/alerts/clear', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ maxAge: 3600000 }) // 1 hour
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.log(`üóëÔ∏è Cleared ${data.data.cleared} old alerts`, 'success');
                        await this.loadSystemAlerts(); // Refresh alerts view
                    }
                } catch (error) {
                    this.log(`‚ùå Failed to clear alerts: ${error.message}`, 'error');
                }
            }

            async runSystemHealthCheck() {
                try {
                    this.log('ü©∫ Running full system health check...', 'info');
                    
                    // Update all health data
                    await this.updateHealthOverview();
                    await this.loadHealthDashboard();
                    await this.loadComponentsStatus();
                    
                    this.log('‚úÖ Full system health check completed', 'success');
                } catch (error) {
                    this.log(`‚ùå Health check failed: ${error.message}`, 'error');
                }
            }

            async downloadHealthReport() {
                try {
                    const [statusResp, componentsResp, alertsResp] = await Promise.all([
                        fetch('/api/health-monitoring/status'),
                        fetch('/api/health-monitoring/components'),
                        fetch('/api/health-monitoring/alerts')
                    ]);
                    
                    const [status, components, alerts] = await Promise.all([
                        statusResp.json(),
                        componentsResp.json(),
                        alertsResp.json()
                    ]);
                    
                    const report = {
                        timestamp: new Date().toISOString(),
                        status: status.success ? status.data : null,
                        components: components.success ? components.data : null,
                        alerts: alerts.success ? alerts.data : null
                    };
                    
                    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `health-report-${new Date().toISOString().slice(0, 19)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    this.log('üìã Health report downloaded', 'success');
                } catch (error) {
                    this.log(`‚ùå Failed to download health report: ${error.message}`, 'error');
                }
            }

            showHealthHistory() {
                this.log('üìä Health history feature coming soon', 'info');
                // Placeholder for health history visualization
            }

            configureAlerts() {
                this.log('‚öôÔ∏è Alert configuration feature coming soon', 'info');
                // Placeholder for alert configuration interface
            }
        }

        // =============================================================================
        // GLOBAL FUNCTIONS AND INITIALIZATION
        // =============================================================================

        let dashboard;

        // Session Management Functions
        const refreshSessionMetrics = () => dashboard.refreshSessionMetrics();
        const showSessionAnalytics = () => dashboard.showSessionAnalytics();
        const runSessionHealthCheck = () => dashboard.runSessionHealthCheck();
        const clearSessionCache = () => dashboard.clearSessionCache();
        const switchSessionTab = (tabName) => dashboard.switchSessionTab(tabName);

        // Intelligence Tabs Functions
        const switchIntelligenceTab = (tabName) => dashboard.switchIntelligenceTab(tabName);
        const loadSemanticComponents = () => dashboard.loadSemanticComponents();
        const loadAccessibilityAnalysis = () => dashboard.loadAccessibilityAnalysis();
        const loadCodePreview = () => dashboard.loadCodePreview();
        const loadInteractionFlows = () => dashboard.loadInteractionFlows();
        const generateCodePreview = () => dashboard.generateCodePreview();
        const runFullIntelligenceAnalysis = () => dashboard.runFullIntelligenceAnalysis();
        const refreshComponents = () => dashboard.refreshComponents();
        const refreshAccessibility = () => dashboard.refreshAccessibility();
        const refreshCodePreview = () => dashboard.refreshCodePreview();
        const refreshFlows = () => dashboard.refreshFlows();
        const switchFramework = () => dashboard.switchFramework();
        const downloadCode = () => dashboard.downloadCode();
        const filterComponents = () => dashboard.filterComponents();
        const toggleAccessibilityFilter = () => dashboard.toggleAccessibilityFilter();
        const filterFlows = () => dashboard.filterFlows();
        const switchCodeTab = (tabName) => dashboard.switchCodeTab(tabName);

        // Health Monitoring Functions
        const switchHealthTab = (tabName) => dashboard.switchHealthTab(tabName);
        const refreshHealthData = () => dashboard.refreshHealthData();
        const checkAllComponents = () => dashboard.checkAllComponents();
        const exportMetrics = () => dashboard.exportMetrics();
        const clearOldAlerts = () => dashboard.clearOldAlerts();
        const runSystemHealthCheck = () => dashboard.runSystemHealthCheck();
        const downloadHealthReport = () => dashboard.downloadHealthReport();
        const showHealthHistory = () => dashboard.showHealthHistory();
        const configureAlerts = () => dashboard.configureAlerts();

        // Global functions for onclick handlers
        const switchSection = (sectionName) => dashboard.switchSection(sectionName);
        const switchContextTab = (tabName) => dashboard.switchContextTab(tabName);
        const analyzeDesign = () => dashboard.analyzeDesign();
        const generateTicket = () => dashboard.generateAITicket();
        const executeContextOperation = () => dashboard.executeContextOperation();
        const validateContextData = () => dashboard.validateContextData();
        const generateAITicket = () => dashboard.generateAITicket();
        const previewAIInput = () => dashboard.previewAIInput();
        const executeMCPOperation = () => dashboard.executeMCPOperation();
        const testMCPConnection = () => dashboard.testMCPConnection();
        const refreshMonitoring = () => dashboard.refreshMonitoring();
        const clearLogs = () => dashboard.clearLogs();
        const clearAll = () => dashboard.clearAll();
        const toggleAutoScroll = () => dashboard.toggleAutoScroll();
        const exportLogs = () => dashboard.exportLogs();

        // Listen for context data from Figma plugin
        window.addEventListener('message', (event) => {
            if (event.data.type === 'figma-context-data' && event.data.source === 'figma-plugin') {
                console.log('üì¶ Received context data from Figma plugin:', event.data.data);
                
                if (dashboard) {
                    // Populate dashboard with received context data
                    dashboard.populateWithFigmaContext(event.data.data);
                    dashboard.log('‚úÖ Context data received from Figma plugin', 'success');
                } else {
                    // Store data for when dashboard is ready
                    window.pendingFigmaContext = event.data.data;
                    console.log('üìã Stored context data for dashboard initialization');
                }
            }
        });

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new UnifiedContextDashboard();
            
            // Initialize intelligence tabs (set first tab as active)
            const firstTab = document.querySelector('.intel-tab');
            const firstContent = document.querySelector('.intel-tab-content');
            if (firstTab && firstContent) {
                firstTab.classList.add('active');
                firstContent.classList.add('active');
                // Load initial intelligence overview
                dashboard.runFullIntelligenceAnalysis();
            }
            
            // Initialize health monitoring tabs
            const firstHealthTab = document.querySelector('.health-tab');
            const firstHealthContent = document.querySelector('.health-tab-content');
            if (firstHealthTab && firstHealthContent) {
                firstHealthTab.classList.add('active');
                firstHealthContent.classList.add('active');
                // Load initial health data
                dashboard.refreshHealthData();
            }
            
            // If we have pending context data, apply it
            if (window.pendingFigmaContext) {
                console.log('üìä Applying pending Figma context data');
                dashboard.populateWithFigmaContext(window.pendingFigmaContext);
                dashboard.log('‚úÖ Applied pending context data from Figma plugin', 'success');
                window.pendingFigmaContext = null;
            }
        });
    </script>
</body>
</html>