<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ðŸŽ¨ Figma Plugin Simulator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6;
      background: #f0f0f0;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    .simulator-container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }

    .figma-panel {
      background: #2c2c2c;
      border-radius: 8px;
      padding: 20px;
      color: white;
      height: fit-content;
    }

    .plugin-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      height: 800px;
    }

    .figma-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #fff;
    }

    .selection-area {
      background: #3c3c3c;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .selection-item {
      background: #4a4a4a;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .selection-item:hover {
      background: #5a5a5a;
    }

    .selection-item.selected {
      background: #667eea;
    }

    .item-type {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
    }

    .item-name {
      font-weight: 500;
      margin-top: 4px;
    }

    .item-dimensions {
      font-size: 11px;
      color: #ccc;
      margin-top: 2px;
    }

    .test-controls {
      margin-top: 16px;
    }

    .test-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }

    .test-btn:hover {
      background: #5a6fd8;
    }

    .test-btn.secondary {
      background: #6b7280;
    }

    .plugin-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    .message-log {
      background: #1a1a1a;
      color: #00ff00;
      font-family: monospace;
      font-size: 12px;
      padding: 12px;
      height: 200px;
      overflow-y: auto;
      border-radius: 6px;
      margin-top: 16px;
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-connected { background: #10b981; }
    .status-disconnected { background: #ef4444; }
    .status-processing { background: #f59e0b; animation: pulse 1s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="simulator-container">
    <!-- Figma Simulation Panel -->
    <div class="figma-panel">
      <div class="figma-header">ðŸŽ¨ Figma Simulator</div>
      
      <div class="selection-area">
        <h4 style="margin: 0 0 12px 0; color: #ccc;">Current Selection</h4>
        
        <div class="selection-item" data-id="1" data-type="FRAME" data-name="Login Form" data-width="400" data-height="300">
          <div class="item-type">Frame</div>
          <div class="item-name">Login Form</div>
          <div class="item-dimensions">400 Ã— 300</div>
        </div>
        
        <div class="selection-item" data-id="2" data-type="COMPONENT" data-name="Primary Button" data-width="120" data-height="40">
          <div class="item-type">Component</div>
          <div class="item-name">Primary Button</div>
          <div class="item-dimensions">120 Ã— 40</div>
        </div>
        
        <div class="selection-item" data-id="3" data-type="INSTANCE" data-name="Input Field" data-width="280" data-height="44">
          <div class="item-type">Instance</div>
          <div class="item-name">Input Field</div>
          <div class="item-dimensions">280 Ã— 44</div>
        </div>
        
        <div class="selection-item" data-id="4" data-type="FRAME" data-name="Dashboard Overview" data-width="1200" data-height="800">
          <div class="item-type">Frame</div>
          <div class="item-name">Dashboard Overview</div>
          <div class="item-dimensions">1200 Ã— 800</div>
        </div>
      </div>

      <div class="test-controls">
        <h4 style="margin: 0 0 12px 0; color: #ccc;">Test Actions</h4>
        
        <button class="test-btn" onclick="sendFileContext()">Send File Context</button>
        <button class="test-btn" onclick="sendSelectionData()">Send Selection</button>
        <button class="test-btn secondary" onclick="clearSelection()">Clear Selection</button>
        <br>
        <button class="test-btn" onclick="simulateGeneration()">Simulate Generation</button>
        <button class="test-btn" onclick="simulateScreenshot()">Capture Screenshot</button>
        <button class="test-btn secondary" onclick="simulateError()">Test Error</button>
      </div>

      <div class="message-log" id="messageLog">
        <div style="color: #00ff00;">ðŸ”— Figma Plugin Simulator Ready</div>
        <div style="color: #999;">Click items above to select, then test plugin communication...</div>
      </div>
    </div>

    <!-- Plugin Panel -->
    <div class="plugin-panel">
      <iframe 
        class="plugin-frame" 
        src="http://localhost:8085/ui/plugin/index.html"
        id="pluginFrame">
      </iframe>
    </div>
  </div>

  <script>
    // Simulate Figma environment
    let selectedItems = [];
    let messageLog = document.getElementById('messageLog');
    let pluginFrame = document.getElementById('pluginFrame');

    // Mock file data
    const mockFileData = {
      fileKey: 'test-file-12345',
      fileName: 'Enhanced UI Test File',
      currentPage: 'Main Page'
    };

    function log(message, color = '#00ff00') {
      const timestamp = new Date().toLocaleTimeString();
      messageLog.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
      messageLog.scrollTop = messageLog.scrollHeight;
      console.log(message);
    }

    // Selection handling
    document.addEventListener('click', (e) => {
      if (e.target.closest('.selection-item')) {
        const item = e.target.closest('.selection-item');
        const isSelected = item.classList.contains('selected');
        
        if (e.metaKey || e.ctrlKey) {
          // Multi-select
          if (isSelected) {
            item.classList.remove('selected');
            selectedItems = selectedItems.filter(id => id !== item.dataset.id);
          } else {
            item.classList.add('selected');
            selectedItems.push(item.dataset.id);
          }
        } else {
          // Single select
          document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('selected'));
          selectedItems = [];
          
          if (!isSelected) {
            item.classList.add('selected');
            selectedItems.push(item.dataset.id);
          }
        }
        
        log(`Selection: ${selectedItems.length} items selected`, '#60a5fa');
      }
    });

    // Message passing to plugin
    function sendMessageToPlugin(message) {
      if (pluginFrame.contentWindow) {
        pluginFrame.contentWindow.postMessage({ pluginMessage: message }, '*');
        log(`ðŸ“¤ Sent: ${message.type}`, '#f59e0b');
      }
    }

    // Test functions
    function sendFileContext() {
      sendMessageToPlugin({
        type: 'file-context',
        fileKey: mockFileData.fileKey,
        fileName: mockFileData.fileName
      });
    }

    function sendSelectionData() {
      const selectionData = selectedItems.map(id => {
        const item = document.querySelector(`[data-id="${id}"]`);
        return {
          id: item.dataset.id,
          name: item.dataset.name,
          type: item.dataset.type,
          width: parseInt(item.dataset.width),
          height: parseInt(item.dataset.height),
          children: generateMockChildren(item.dataset.type)
        };
      });

      sendMessageToPlugin({
        type: 'frame-data',
        data: selectionData
      });
    }

    function generateMockChildren(type) {
      // Generate realistic mock children based on type
      if (type === 'FRAME') {
        return [
          { name: 'Title', type: 'TEXT', characters: 'Welcome Back' },
          { name: 'Subtitle', type: 'TEXT', characters: 'Sign in to continue' },
          { name: 'Email Input', type: 'COMPONENT' },
          { name: 'Password Input', type: 'COMPONENT' },
          { name: 'Login Button', type: 'COMPONENT' }
        ];
      } else if (type === 'COMPONENT') {
        return [
          { name: 'Button Text', type: 'TEXT', characters: 'Click me' },
          { name: 'Icon', type: 'VECTOR' }
        ];
      }
      return [];
    }

    function clearSelection() {
      document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('selected'));
      selectedItems = [];
      log('ðŸ—‘ï¸ Selection cleared', '#94a3b8');
    }

    function simulateGeneration() {
      sendMessageToPlugin({
        type: 'generate-ticket'
      });
    }

    function simulateScreenshot() {
      sendMessageToPlugin({
        type: 'capture-screenshot'
      });
    }

    function simulateError() {
      sendMessageToPlugin({
        type: 'error',
        message: 'Simulated error for testing error handling'
      });
    }

    // Listen for messages from plugin
    window.addEventListener('message', (event) => {
      if (event.data.pluginMessage) {
        const msg = event.data.pluginMessage;
        log(`ðŸ“¥ Received: ${msg.type}`, '#10b981');
        
        // Respond to specific message types
        switch (msg.type) {
          case 'get-context':
            log('ðŸ”„ Plugin requested context, sending file info...', '#8b5cf6');
            setTimeout(() => {
              sendFileContext();
              if (selectedItems.length > 0) {
                sendSelectionData();
              }
            }, 100);
            break;
            
          case 'generate-ticket':
            log('ðŸŽ« Plugin requested ticket generation...', '#8b5cf6');
            if (selectedItems.length === 0) {
              sendMessageToPlugin({
                type: 'error',
                message: 'No selection available'
              });
            } else {
              sendSelectionData();
            }
            break;
            
          case 'capture-screenshot':
            log('ðŸ“¸ Plugin requested screenshot capture...', '#8b5cf6');
            setTimeout(() => {
              sendMessageToPlugin({
                type: 'screenshot-captured',
                screenshot: {
                  dataUrl: createMockScreenshot(),
                  width: 400,
                  height: 300,
                  size: '2.1 KB',
                  selectionCount: selectedItems.length
                }
              });
            }, 500);
            break;
        }
      }
    });

    function createMockScreenshot() {
      return 'data:image/svg+xml;base64,' + btoa(`
        <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
          <rect width="400" height="300" fill="#f8fafc" stroke="#e2e8f0"/>
          <rect x="20" y="20" width="360" height="40" rx="8" fill="#667eea"/>
          <text x="200" y="45" text-anchor="middle" fill="white" font-family="Arial" font-size="16">Simulated Figma Design</text>
          <rect x="50" y="80" width="120" height="35" rx="4" fill="#e2e8f0"/>
          <text x="110" y="102" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="12">Email</text>
          <rect x="230" y="80" width="120" height="35" rx="4" fill="#e2e8f0"/>
          <text x="290" y="102" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="12">Password</text>
          <rect x="150" y="140" width="100" height="35" rx="4" fill="#10b981"/>
          <text x="200" y="162" text-anchor="middle" fill="white" font-family="Arial" font-size="12">Login</text>
          <text x="200" y="250" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="10">Generated by Figma Simulator</text>
          <text x="200" y="270" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="10">${selectedItems.length} items selected</text>
        </svg>
      `);
    }

    // Auto-test on load
    window.addEventListener('load', () => {
      log('ðŸš€ Figma Plugin Simulator initialized', '#10b981');
      log('ðŸ’¡ Select items above and test plugin communication', '#6b7280');
      
      // Auto-select first item for demo
      setTimeout(() => {
        document.querySelector('.selection-item').click();
        log('âœ¨ Auto-selected first item for demo', '#8b5cf6');
      }, 1000);
    });
  </script>
</body>
</html>