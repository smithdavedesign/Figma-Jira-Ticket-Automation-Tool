<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Layer Live Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #2ecc71; }
        .status-offline { background: #e74c3c; }
        .status-loading { background: #f39c12; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .panel-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success { background: #2ecc71; }
        .btn-success:hover { background: #27ae60; }

        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }

        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }

        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }

        .result-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .result-success {
            border-left-color: #2ecc71;
            background: #d5f4e6;
        }

        .result-error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .result-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 12px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .tab.active {
            background: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
        }

        .tab-content.active {
            display: block;
        }

        .endpoint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .endpoint-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .endpoint-card:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        .endpoint-card.active {
            border-color: #2ecc71;
            background: #d5f4e6;
        }

        .endpoint-method {
            font-weight: bold;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
        }

        .method-get { background: #2ecc71; }
        .method-post { background: #3498db; }
        .method-put { background: #f39c12; }
        .method-delete { background: #e74c3c; }

        .context-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .search-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .search-result-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .search-result-meta {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .search-result-preview {
            background: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logs {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 5px;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-info { border-left-color: #3498db; }
        .log-success { border-left-color: #2ecc71; }
        .log-warning { border-left-color: #f39c12; }
        .log-error { border-left-color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Context Layer Live Testing Dashboard</h1>
            <p>
                <span id="server-status" class="status-indicator status-loading"></span>
                <span id="server-status-text">Checking server status...</span>
            </p>
            <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Test and manage Figma Context Layer API endpoints
            </p>
        </div>

        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('context-manager')">Context Manager</button>
                <button class="tab" onclick="switchTab('api-endpoints')">API Endpoints</button>
                <button class="tab" onclick="switchTab('search-explorer')">Search & Explorer</button>
                <button class="tab" onclick="switchTab('live-logs')">Live Logs</button>
            </div>

            <!-- Context Manager Tab -->
            <div id="context-manager" class="tab-content active">
                <div class="dashboard">
                    <div>
                        <h3 style="margin-bottom: 15px;">üìÅ File Context Management</h3>
                        <div class="form-group">
                            <label>Figma URL or File Key</label>
                            <input type="text" id="figma-input" placeholder="https://www.figma.com/file/..." 
                                   value="https://www.figma.com/file/abc123/TestFile">
                        </div>
                        <div class="form-group">
                            <label>Node ID (optional)</label>
                            <input type="text" id="node-input" placeholder="123:456">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-success" onclick="extractContext()">üîç Extract Context</button>
                            <button class="btn" onclick="getContext()">üìã Get Context</button>
                            <button class="btn btn-secondary" onclick="getContextSummary()">üìä Get Summary</button>
                        </div>

                        <div class="context-summary" id="context-metrics" style="display: none;">
                            <div class="metric-card">
                                <div class="metric-value" id="metric-confidence">0</div>
                                <div class="metric-label">Confidence</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metric-nodes">0</div>
                                <div class="metric-label">Nodes Analyzed</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metric-components">0</div>
                                <div class="metric-label">Components</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="metric-styles">0</div>
                                <div class="metric-label">Styles</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 15px;">‚úèÔ∏è Context Data Editor</h3>
                        <div class="form-group">
                            <label>Context Data (JSON)</label>
                            <textarea id="context-data" placeholder='{"confidence": 0.85, "nodes": [...], "styles": [...]}'></textarea>
                        </div>
                        <div class="form-group">
                            <label>Metadata (JSON)</label>
                            <textarea id="context-metadata" placeholder='{"source": "manual", "tags": ["ui", "design"]}'></textarea>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="storeContext()">üíæ Store Context</button>
                            <button class="btn btn-warning" onclick="updateContext()">üìù Update Context</button>
                            <button class="btn btn-danger" onclick="deleteContext()">üóëÔ∏è Delete Context</button>
                        </div>
                    </div>
                </div>

                <div id="context-result" class="result-container" style="display: none;">
                    <h4>Result:</h4>
                    <div id="context-result-content" class="result-code"></div>
                </div>
            </div>

            <!-- API Endpoints Tab -->
            <div id="api-endpoints" class="tab-content">
                <h3 style="margin-bottom: 20px;">üîó Available Context Layer Endpoints</h3>
                
                <div class="endpoint-grid">
                    <div class="endpoint-card" onclick="testEndpoint('GET', '/context/:fileKey', 'getContext')">
                        <div>
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/context/:fileKey</strong>
                        </div>
                        <p style="margin-top: 8px; font-size: 13px; color: #666;">Get context data for a file</p>
                    </div>
                    
                    <div class="endpoint-card" onclick="testEndpoint('POST', '/context/:fileKey', 'storeContext')">
                        <div>
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/context/:fileKey</strong>
                        </div>
                        <p style="margin-top: 8px; font-size: 13px; color: #666;">Store new context data</p>
                    </div>
                    
                    <div class="endpoint-card" onclick="testEndpoint('PUT', '/context/:fileKey', 'updateContext')">
                        <div>
                            <span class="endpoint-method method-put">PUT</span>
                            <strong>/context/:fileKey</strong>
                        </div>
                        <p style="margin-top: 8px; font-size: 13px; color: #666;">Update existing context</p>
                    </div>
                    
                    <div class="endpoint-card" onclick="testEndpoint('DELETE', '/context/:fileKey', 'deleteContext')">
                        <div>
                            <span class="endpoint-method method-delete">DELETE</span>
                            <strong>/context/:fileKey</strong>
                        </div>
                        <p style="margin-top: 8px; font-size: 13px; color: #666;">Delete context data</p>
                    </div>
                    
                    <div class="endpoint-card" onclick="testEndpoint('GET', '/context-summary/:fileKey', 'getContextSummary')">
                        <div>
                            <span class="endpoint-method method-get">GET</span>
                            <strong>/context-summary/:fileKey</strong>
                        </div>
                        <p style="margin-top: 8px; font-size: 13px; color: #666;">Get context summary</p>
                    </div>
                    
                    <div class="endpoint-card" onclick="testEndpoint('POST', '/context-search', 'searchContext')">
                        <div>
                            <span class="endpoint-method method-post">POST</span>
                            <strong>/context-search</strong>
                        </div>
                        <p style="margin-top: 8px; font-size: 13px; color: #666;">Search context data</p>
                    </div>
                </div>

                <div id="endpoint-result" class="result-container" style="display: none;">
                    <h4>Endpoint Test Result:</h4>
                    <div id="endpoint-result-content" class="result-code"></div>
                </div>
            </div>

            <!-- Search & Explorer Tab -->
            <div id="search-explorer" class="tab-content">
                <div class="dashboard">
                    <div>
                        <h3 style="margin-bottom: 15px;">üîç Context Search</h3>
                        <div class="form-group">
                            <label>Search Query</label>
                            <input type="text" id="search-query" placeholder="button, component, style...">
                        </div>
                        <div class="form-group">
                            <label>File Keys (optional, comma-separated)</label>
                            <input type="text" id="search-files" placeholder="abc123,def456">
                        </div>
                        <div class="form-group">
                            <label>Result Limit</label>
                            <select id="search-limit">
                                <option value="10">10 results</option>
                                <option value="20" selected>20 results</option>
                                <option value="50">50 results</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="performSearch()">üîç Search</button>
                        <button class="btn btn-secondary" onclick="clearSearchResults()">üßπ Clear</button>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 15px;">üìä Context Explorer</h3>
                        <div class="form-group">
                            <label>File Key for Summary</label>
                            <input type="text" id="explorer-file" placeholder="abc123">
                        </div>
                        <button class="btn" onclick="exploreFile()">üîç Explore File</button>
                        <button class="btn btn-secondary" onclick="refreshCache()">üîÑ Refresh Cache</button>
                        
                        <div style="margin-top: 20px;">
                            <h4>Cache Statistics</h4>
                            <div id="cache-stats" class="result-container">
                                <div class="result-code">Cache stats will appear here...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="search-results" id="search-results" style="display: none;">
                    <h4>Search Results:</h4>
                    <div id="search-results-content"></div>
                </div>
            </div>

            <!-- Live Logs Tab -->
            <div id="live-logs" class="tab-content">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                    <h3>üìù Live Activity Logs</h3>
                    <div>
                        <button class="btn btn-secondary" onclick="clearLogs()">üßπ Clear Logs</button>
                        <button class="btn" onclick="toggleAutoScroll()" id="auto-scroll-btn">üìú Auto-scroll: ON</button>
                    </div>
                </div>
                
                <div id="logs-container" class="logs">
                    <div class="log-entry log-info">
                        [INFO] Context Layer Dashboard initialized
                    </div>
                    <div class="log-entry log-info">
                        [INFO] Ready for testing...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the Context Layer Client -->
    <script src="js/context-layer-client.js"></script>
    
    <script>
        // Global state
        let autoScroll = true;
        let logCount = 0;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            updateCacheStats();
            log('Dashboard loaded successfully', 'success');
        });

        // =============================================================================
        // SERVER STATUS AND HEALTH
        // =============================================================================

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3000/api/figma/health');
                const data = await response.json();
                
                if (data.success) {
                    updateServerStatus('online', 'Server Online - Context Layer Available');
                    log('Server status: Online ‚úÖ', 'success');
                } else {
                    updateServerStatus('offline', 'Server Error');
                    log('Server status: Error ‚ùå', 'error');
                }
            } catch (error) {
                updateServerStatus('offline', 'Server Offline');
                log('Server status: Offline ‚ùå', 'error');
            }
        }

        function updateServerStatus(status, text) {
            const indicator = document.getElementById('server-status');
            const statusText = document.getElementById('server-status-text');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // =============================================================================
        // TAB MANAGEMENT
        // =============================================================================

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            log(`Switched to ${tabName} tab`, 'info');
        }

        // =============================================================================
        // CONTEXT MANAGEMENT FUNCTIONS
        // =============================================================================

        async function extractContext() {
            const figmaInput = document.getElementById('figma-input').value;
            const nodeInput = document.getElementById('node-input').value;
            
            if (!figmaInput) {
                showResult('Please enter a Figma URL or file key', 'error');
                return;
            }

            log(`Extracting context from: ${figmaInput}`, 'info');
            
            try {
                const result = await ContextLayer.extractAndStore(figmaInput, {
                    nodeId: nodeInput || undefined,
                    includeScreenshot: false
                });
                
                showResult(JSON.stringify(result, null, 2), 'success');
                updateContextMetrics(result.data);
                log('Context extraction successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`Context extraction failed: ${error.message}`, 'error');
            }
        }

        async function getContext() {
            const figmaInput = document.getElementById('figma-input').value;
            const nodeInput = document.getElementById('node-input').value;
            
            if (!figmaInput) {
                showResult('Please enter a Figma URL or file key', 'error');
                return;
            }

            const fileKey = extractFileKey(figmaInput);
            log(`Getting context for file: ${fileKey}`, 'info');
            
            try {
                const result = await ContextLayer.getContext(fileKey, {
                    nodeId: nodeInput || undefined
                });
                
                showResult(JSON.stringify(result, null, 2), 'success');
                updateContextMetrics(result.data);
                
                // Populate editor with current context
                if (result.data && result.data.context) {
                    document.getElementById('context-data').value = JSON.stringify(result.data.context, null, 2);
                }
                
                log('Context retrieval successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`Context retrieval failed: ${error.message}`, 'error');
            }
        }

        async function storeContext() {
            const figmaInput = document.getElementById('figma-input').value;
            const nodeInput = document.getElementById('node-input').value;
            const contextData = document.getElementById('context-data').value;
            const metadataData = document.getElementById('context-metadata').value;
            
            if (!figmaInput || !contextData) {
                showResult('Please enter file key and context data', 'error');
                return;
            }

            const fileKey = extractFileKey(figmaInput);
            log(`Storing context for file: ${fileKey}`, 'info');
            
            try {
                const context = JSON.parse(contextData);
                const metadata = metadataData ? JSON.parse(metadataData) : {};
                
                const result = await ContextLayer.storeContext(fileKey, context, {
                    nodeId: nodeInput || undefined,
                    metadata
                });
                
                showResult(JSON.stringify(result, null, 2), 'success');
                log('Context storage successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`Context storage failed: ${error.message}`, 'error');
            }
        }

        async function updateContext() {
            const figmaInput = document.getElementById('figma-input').value;
            const nodeInput = document.getElementById('node-input').value;
            const contextData = document.getElementById('context-data').value;
            const metadataData = document.getElementById('context-metadata').value;
            
            if (!figmaInput || !contextData) {
                showResult('Please enter file key and context data', 'error');
                return;
            }

            const fileKey = extractFileKey(figmaInput);
            log(`Updating context for file: ${fileKey}`, 'info');
            
            try {
                const context = JSON.parse(contextData);
                const metadata = metadataData ? JSON.parse(metadataData) : {};
                
                const result = await ContextLayer.updateContext(fileKey, context, {
                    nodeId: nodeInput || undefined,
                    metadata,
                    merge: true
                });
                
                showResult(JSON.stringify(result, null, 2), 'success');
                log('Context update successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`Context update failed: ${error.message}`, 'error');
            }
        }

        async function deleteContext() {
            const figmaInput = document.getElementById('figma-input').value;
            const nodeInput = document.getElementById('node-input').value;
            
            if (!figmaInput) {
                showResult('Please enter a Figma URL or file key', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete this context data?')) {
                return;
            }

            const fileKey = extractFileKey(figmaInput);
            log(`Deleting context for file: ${fileKey}`, 'info');
            
            try {
                const result = await ContextLayer.deleteContext(fileKey, {
                    nodeId: nodeInput || undefined
                });
                
                showResult(JSON.stringify(result, null, 2), 'success');
                document.getElementById('context-data').value = '';
                hideContextMetrics();
                log('Context deletion successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`Context deletion failed: ${error.message}`, 'error');
            }
        }

        async function getContextSummary() {
            const figmaInput = document.getElementById('figma-input').value;
            
            if (!figmaInput) {
                showResult('Please enter a Figma URL or file key', 'error');
                return;
            }

            const fileKey = extractFileKey(figmaInput);
            log(`Getting context summary for file: ${fileKey}`, 'info');
            
            try {
                const result = await ContextLayer.getContextSummary(fileKey);
                showResult(JSON.stringify(result, null, 2), 'success');
                log('Context summary retrieval successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`Context summary failed: ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // SEARCH AND EXPLORER FUNCTIONS
        // =============================================================================

        async function performSearch() {
            const query = document.getElementById('search-query').value;
            const files = document.getElementById('search-files').value;
            const limit = parseInt(document.getElementById('search-limit').value);
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            log(`Searching context data: "${query}"`, 'info');
            
            try {
                const fileKeys = files ? files.split(',').map(f => f.trim()) : [];
                const result = await ContextLayer.searchContext(query, {
                    fileKeys,
                    limit
                });
                
                displaySearchResults(result.data);
                log(`Search completed: ${result.data.totalResults} results found`, 'success');
                
            } catch (error) {
                alert(`Search failed: ${error.message}`);
                log(`Search failed: ${error.message}`, 'error');
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('search-results');
            const content = document.getElementById('search-results-content');
            
            if (!results.results || results.results.length === 0) {
                content.innerHTML = '<p>No results found</p>';
                container.style.display = 'block';
                return;
            }
            
            const html = results.results.map(result => `
                <div class="search-result">
                    <div class="search-result-header">
                        üìÅ ${result.fileKey}${result.nodeId ? ` / ${result.nodeId}` : ''}
                    </div>
                    <div class="search-result-meta">
                        Relevance: ${(result.relevance * 100).toFixed(1)}% | 
                        Confidence: ${(result.metadata.confidence * 100).toFixed(1)}% | 
                        Updated: ${result.metadata.updated || 'Unknown'}
                    </div>
                    <div class="search-result-preview">${result.preview}</div>
                </div>
            `).join('');
            
            content.innerHTML = html;
            container.style.display = 'block';
        }

        function clearSearchResults() {
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('search-query').value = '';
            log('Search results cleared', 'info');
        }

        async function exploreFile() {
            const fileKey = document.getElementById('explorer-file').value;
            
            if (!fileKey) {
                alert('Please enter a file key');
                return;
            }

            log(`Exploring file: ${fileKey}`, 'info');
            
            try {
                const result = await ContextLayer.getContextSummary(fileKey);
                showResult(JSON.stringify(result, null, 2), 'success');
                log('File exploration successful ‚úÖ', 'success');
                
            } catch (error) {
                showResult(`Error: ${error.message}`, 'error');
                log(`File exploration failed: ${error.message}`, 'error');
            }
        }

        function refreshCache() {
            ContextLayer.clearCache();
            updateCacheStats();
            log('Cache cleared and refreshed', 'success');
        }

        function updateCacheStats() {
            const stats = ContextLayer.getCacheStats();
            document.getElementById('cache-stats').innerHTML = `
                <div class="result-code">Cache Size: ${stats.size} items
Keys: ${stats.keys.join(', ') || 'None'}</div>
            `;
        }

        // =============================================================================
        // ENDPOINT TESTING
        // =============================================================================

        async function testEndpoint(method, path, action) {
            log(`Testing endpoint: ${method} ${path}`, 'info');
            
            // Highlight the selected endpoint
            document.querySelectorAll('.endpoint-card').forEach(card => card.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            try {
                let result;
                const testFileKey = 'abc123';
                
                switch (action) {
                    case 'getContext':
                        result = await ContextLayer.getContext(testFileKey);
                        break;
                    case 'storeContext':
                        result = await ContextLayer.storeContext(testFileKey, {
                            test: true,
                            confidence: 0.8,
                            nodes: [{ id: '1', type: 'FRAME' }]
                        });
                        break;
                    case 'updateContext':
                        result = await ContextLayer.updateContext(testFileKey, {
                            updated: true,
                            timestamp: new Date().toISOString()
                        });
                        break;
                    case 'deleteContext':
                        if (confirm('Delete test context data?')) {
                            result = await ContextLayer.deleteContext(testFileKey);
                        } else {
                            return;
                        }
                        break;
                    case 'getContextSummary':
                        result = await ContextLayer.getContextSummary(testFileKey);
                        break;
                    case 'searchContext':
                        result = await ContextLayer.searchContext('test', { limit: 5 });
                        break;
                    default:
                        result = { error: 'Unknown action' };
                }
                
                document.getElementById('endpoint-result-content').textContent = JSON.stringify(result, null, 2);
                document.getElementById('endpoint-result').className = 'result-container result-success';
                document.getElementById('endpoint-result').style.display = 'block';
                
                log(`Endpoint test successful: ${method} ${path}`, 'success');
                
            } catch (error) {
                document.getElementById('endpoint-result-content').textContent = `Error: ${error.message}`;
                document.getElementById('endpoint-result').className = 'result-container result-error';
                document.getElementById('endpoint-result').style.display = 'block';
                
                log(`Endpoint test failed: ${method} ${path} - ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // UTILITY FUNCTIONS
        // =============================================================================

        function extractFileKey(input) {
            if (input.includes('figma.com')) {
                const match = input.match(/figma\.com\/file\/([a-zA-Z0-9_-]+)/);
                return match ? match[1] : input;
            }
            return input;
        }

        function showResult(content, type = 'info') {
            const container = document.getElementById('context-result');
            const contentEl = document.getElementById('context-result-content');
            
            contentEl.textContent = content;
            container.className = `result-container result-${type}`;
            container.style.display = 'block';
        }

        function updateContextMetrics(data) {
            if (!data || !data.context) {
                hideContextMetrics();
                return;
            }

            const context = data.context;
            document.getElementById('metric-confidence').textContent = 
                Math.round((context.confidence || 0) * 100) + '%';
            document.getElementById('metric-nodes').textContent = 
                context.nodesAnalyzed || 0;
            document.getElementById('metric-components').textContent = 
                context.componentsFound || 0;
            document.getElementById('metric-styles').textContent = 
                context.stylesExtracted || 0;
            
            document.getElementById('context-metrics').style.display = 'grid';
        }

        function hideContextMetrics() {
            document.getElementById('context-metrics').style.display = 'none';
        }

        // =============================================================================
        // LOGGING SYSTEM
        // =============================================================================

        function log(message, type = 'info') {
            const container = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(logEntry);
            logCount++;
            
            // Keep only last 100 logs
            if (logCount > 100) {
                container.removeChild(container.firstChild);
                logCount--;
            }
            
            // Auto-scroll to bottom
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function clearLogs() {
            document.getElementById('logs-container').innerHTML = '';
            logCount = 0;
            log('Logs cleared', 'info');
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            document.getElementById('auto-scroll-btn').textContent = 
                `üìú Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
            log(`Auto-scroll ${autoScroll ? 'enabled' : 'disabled'}`, 'info');
        }

        // Auto-refresh server status every 30 seconds
        setInterval(checkServerStatus, 30000);
        
        // Auto-update cache stats every 10 seconds  
        setInterval(updateCacheStats, 10000);
    </script>
</body>
</html>