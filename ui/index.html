<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enhanced Figma Plugin</title>
  <style>
    /* Modern CSS Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      line-height: 1.5;
      background: #f8fafc;
      color: #1a202c;
      padding: 20px;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    .content {
      padding: 24px;
    }

    /* Enhanced Context Preview Styles */
    .context-preview-container {
      margin: 20px 0;
    }

    .context-preview {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .context-preview-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .context-preview-title {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .context-preview-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 10px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .context-preview-subtitle {
      margin: 0;
      font-size: 13px;
      color: #64748b;
    }

    .context-preview-body {
      padding: 20px;
    }

    .context-sections {
      display: grid;
      gap: 16px;
      margin-bottom: 24px;
    }

    .context-section {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .context-section:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .context-section.has-content {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .section-header {
      background: #f8fafc;
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .section-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .status-indicator {
      font-size: 8px;
    }

    .status-text {
      color: #6b7280;
    }

    .section-content {
      padding: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
    }

    .empty-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 8px;
    }

    .empty-state p {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #6b7280;
    }

    .empty-state small {
      font-size: 12px;
      color: #9ca3af;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    #techStackInput {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    #techStackInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select, input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
    }

    .button-ai {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      position: relative;
      overflow: hidden;
    }

    .button-ai:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .button-ai::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .button-ai:hover::before {
      left: 100%;
    }

    /* Debug Panel Styles */
    .debug-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      margin: 20px 0;
      font-family: 'Monaco', 'Consolas', monospace;
      overflow: hidden;
    }

    .debug-header {
      background: #2a2a2a;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }

    .debug-header h3 {
      color: #00ff88;
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .button-debug {
      background: #444;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .button-debug:hover {
      background: #555;
    }

    .debug-content {
      max-height: 400px;
      overflow-y: auto;
    }

    .debug-section {
      padding: 16px;
      border-bottom: 1px solid #333;
    }

    .debug-section:last-child {
      border-bottom: none;
    }

    .debug-section h4 {
      color: #00aaff;
      margin: 0 0 12px 0;
      font-size: 12px;
      font-weight: 600;
    }

    .debug-code {
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 12px;
      font-size: 11px;
      color: #00ff88;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      margin: 0;
    }

    .debug-validation {
      font-size: 12px;
    }

    .validation-pass {
      color: #00ff88;
      background: rgba(0, 255, 136, 0.1);
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #00ff88;
    }

    .validation-error {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #ff4444;
      margin-bottom: 8px;
    }

    .validation-warning {
      color: #ffaa00;
      background: rgba(255, 170, 0, 0.1);
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #ffaa00;
      margin-bottom: 8px;
    }

    .debug-mcp {
      font-size: 11px;
      color: #ccc;
    }

    /* Test Panel Styles */
    .test-panel {
      background: #f0f8ff;
      border: 2px solid #4a90e2;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }

    .test-panel h3 {
      margin: 0 0 12px 0;
      color: #2c5282;
      font-size: 14px;
    }

    .test-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
    }

    .button-success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }

    .button-success:hover {
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
    }

    .button-secondary {
      background: #6b7280;
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 8px;
    }

    /* Status and Results */
    .status-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .confidence-score {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .confidence-high { background: #dcfce7; color: #166534; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }

    .suggestions {
      margin-top: 12px;
    }

    .suggestion-pill {
      display: inline-block;
      padding: 4px 12px;
      margin: 2px 4px 2px 0;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-pill:hover {
      background: #c7d2fe;
    }

    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .suggestions-grid .suggestion-pill {
      padding: 8px 12px;
      text-align: center;
      font-weight: 500;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
    }

    /* Color-coded tech stack pills */
    .suggestion-pill[data-type="react"] { background: linear-gradient(135deg, #61DAFB, #21A1C4); color: white; }
    .suggestion-pill[data-type="vue"] { background: linear-gradient(135deg, #4FC08D, #42B883); color: white; }
    .suggestion-pill[data-type="angular"] { background: linear-gradient(135deg, #DD0031, #C73225); color: white; }
    .suggestion-pill[data-type="next"] { background: linear-gradient(135deg, #000000, #333333); color: white; }
    .suggestion-pill[data-type="mern"] { background: linear-gradient(135deg, #3C873A, #68A063); color: white; }
    .suggestion-pill[data-type="mean"] { background: linear-gradient(135deg, #FFA500, #FF8C00); color: white; }
    .suggestion-pill[data-type="python"] { background: linear-gradient(135deg, #3776AB, #FFD43B); color: white; }
    .suggestion-pill[data-type="java"] { background: linear-gradient(135deg, #ED8B00, #EA7600); color: white; }
    .suggestion-pill[data-type="dotnet"] { background: linear-gradient(135deg, #512BD4, #9A4993); color: white; }
    .suggestion-pill[data-type="aem"] { background: linear-gradient(135deg, #FA0F00, #C20E00); color: white; }
    .suggestion-pill[data-type="design"] { background: linear-gradient(135deg, #9333EA, #7C3AED); color: white; }

    #results {
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    #results.hidden {
      display: none;
    }

    #results textarea {
      width: 100%;
      min-height: 300px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      background: white;
      resize: vertical;
    }

    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 6px;
    }

    .fallback-notice {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      color: #9a3412;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .copy-success {
      color: #059669;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 6px;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #6b7280;
      font-size: 14px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Hidden class */
    .hidden {
      display: none;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 16px;
    }

    .tab-btn {
      padding: 12px 20px;
      border: none;
      background: #f8fafc;
      color: #64748b;
      border-radius: 8px 8px 0 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
    }

    .tab-btn:hover:not(.active) {
      background: #e2e8f0;
      color: #374151;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Design Health Styles */
    .health-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .metric-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .metric-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #374151;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #667eea;
      margin: 8px 0;
    }

    .metric-card p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }

    .health-analysis {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }

    .health-analysis h3 {
      margin: 0 0 16px 0;
      color: #374151;
    }

    .analysis-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
    }

    .status-good {
      color: #10b981;
    }

    .status-warning {
      color: #f59e0b;
    }

    .status-error {
      color: #ef4444;
    }

    /* Template Preview Styles */
    .template-preview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }

    .template-preview h4 {
      margin: 0 0 12px 0;
      color: #374151;
      font-size: 14px;
    }

    .template-content {
      font-size: 13px;
      line-height: 1.5;
    }

    #context-preview-wrapper {
      margin: 24px 0;
      transition: all 0.3s ease;
    }

    .context-success-info {
      animation: slideInFadeIn 0.5s ease-out;
    }

    @keyframes slideInFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Action buttons for context preview */
    .context-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .action-btn.primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .action-btn.primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .action-btn.secondary {
      background: #f8fafc;
      color: #374151;
      border: 1px solid #e2e8f0;
    }

    .action-btn.secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    /* Context metrics styles */
    .context-metrics {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .metrics-title {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .metric-item {
      text-align: center;
    }

    .metric-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .metric-detail {
      font-size: 10px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="header">
      <h1>🎨 Enhanced Figma Plugin</h1>
      <div class="subtitle">AI-powered ticket generation with design intelligence preview</div>
    </div>

    <div class="content">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="generator">🎫 Smart Generator</button>
        <button class="tab-btn" data-tab="health">📊 Design Health</button>
      </div>

      <!-- Generator Tab -->
      <div class="tab-content active" id="generator-tab">
      <div class="panel-header">
        <h2 class="panel-title">🎫 Enhanced Document Generator</h2>
        <p class="panel-subtitle">See exactly what context is sent to AI before generation</p>
      </div>

      <div class="form-group">
        <label for="techStackInput">Tech Stack Description</label>
        <textarea 
          id="techStackInput" 
          placeholder="Describe your tech stack, frameworks, libraries, and architecture. Be specific about versions, patterns, and tools you're using.

Examples:
• React 18 with TypeScript, Material-UI v5, React Query for state management
• Vue 3 with Composition API, Pinia for state, Vite build tool
• Next.js 13 with App Router, TailwindCSS, Prisma ORM, PostgreSQL
• Angular 15 with NgRx, Angular Material, RxJS patterns"></textarea>
        
        <!-- Parse Tech Button -->
        <button id="parseTechBtn" class="button-secondary" type="button">🔍 Parse Tech Stack</button>
      </div>

      <!-- Popular Combinations Section -->
      <div class="form-group">
        <label>💡 Popular Tech Stack Combinations</label>
        <div class="suggestions-grid">
          <div class="suggestion-pill" data-type="react" onclick="selectTechStack(this)">
            React + TypeScript + Material-UI
          </div>
          <div class="suggestion-pill" data-type="vue" onclick="selectTechStack(this)">
            Vue 3 + Composition API + Pinia
          </div>
          <div class="suggestion-pill" data-type="angular" onclick="selectTechStack(this)">
            Angular 15 + NgRx + Material
          </div>
          <div class="suggestion-pill" data-type="next" onclick="selectTechStack(this)">
            Next.js + TailwindCSS + Prisma
          </div>
          <div class="suggestion-pill" data-type="aem" onclick="selectTechStack(this)">
            AEM 6.5 + HTL + Sling + OSGi
          </div>
          <div class="suggestion-pill" data-type="design" onclick="selectTechStack(this)">
            Figma + Design System + Tokens
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="documentType">Document Type</label>
        <select id="documentType" onchange="updateTemplateContext()">
          <option value="jira">Jira Ticket</option>
          <option value="confluence">Confluence Page</option>
          <option value="wiki">Wiki Documentation</option>
          <option value="agent">Agent Task</option>
          <option value="code">Code Generation</option>
        </select>
      </div>

      <!-- Context Template Display -->
      <div class="template-preview" id="templatePreview">
        <h4>📝 LLM Context Template</h4>
        <div class="template-content" id="templateContent">
          <!-- Will be populated based on document type -->
        </div>
      </div>

      <div class="status-section" style="display: none;">
        <div class="confidence-indicator">
          <span>📊 Confidence:</span>
          <span class="confidence-score confidence-high">85%</span>
        </div>
        <div class="suggestions">
          <span class="suggestion-pill">Add testing framework</span>
          <span class="suggestion-pill">Specify API architecture</span>
          <span class="suggestion-pill">Include deployment strategy</span>
        </div>
      </div>

      <!-- MCP Server Status Section -->
      <div class="context-preview">
        <div class="context-preview-header">
          <h3 class="context-preview-title">
            🔌 MCP Server Status
            <span id="server-status-badge" class="context-preview-badge">Checking...</span>
          </h3>
          <p class="context-preview-subtitle">Model Context Protocol server connection</p>
        </div>
        <div class="context-preview-body">
          <div class="context-section" id="server-status-section">
            <div class="section-header">
              <h4 class="section-title">🚀 Server Connection</h4>
              <div class="section-status" id="server-connection-status">
                <span class="status-indicator">⚪</span>
                <span class="status-text">Connecting...</span>
              </div>
            </div>
            <div class="section-content" id="server-connection-content">
              <div class="empty-state">
                <span class="empty-icon">🔌</span>
                <p>Checking MCP server connection...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    <!-- Enhanced Context Preview Section -->
      <div id="context-preview-wrapper" class="hidden">
        <div class="context-preview">
          <div class="context-preview-header">
            <h3 class="context-preview-title">
              🔍 Context Preview
              <span class="context-preview-badge">Review Before Sending</span>
            </h3>
            <p class="context-preview-subtitle">Review what will be sent to the AI for processing</p>
          </div>

          <div class="context-preview-body">
            <div class="context-sections">
              <!-- Tech Stack Section -->
              <div class="context-section" data-section="techstack">
                <div class="section-header">
                  <h4 class="section-title">🛠️ Tech Stack Analysis</h4>
                  <div class="section-status" id="techstack-status">
                    <span class="status-indicator">⚪</span>
                    <span class="status-text">Not analyzed</span>
                  </div>
                </div>
                <div class="section-content" id="techstack-content">
                  <div class="empty-state">
                    <span class="empty-icon">📝</span>
                    <p>Enter your tech stack description to see analysis here</p>
                  </div>
                </div>
              </div>

              <!-- Screenshot Section -->
              <div class="context-section" data-section="screenshot">
                <div class="section-header">
                  <h4 class="section-title">📸 Visual Context</h4>
                  <div class="section-status" id="screenshot-status">
                    <span class="status-indicator">⚪</span>
                    <span class="status-text">No screenshot</span>
                  </div>
                </div>
                <div class="section-content" id="screenshot-content">
                  <div class="empty-state">
                    <span class="empty-icon">🖼️</span>
                    <p>No visual context available</p>
                    <small>Screenshots help AI understand design layouts and requirements</small>
                  </div>
                </div>
              </div>

              <!-- Figma Context Section -->
              <div class="context-section" data-section="figma">
                <div class="section-header">
                  <h4 class="section-title">🎨 Figma Selection</h4>
                  <div class="section-status" id="figma-status">
                    <span class="status-indicator">⚪</span>
                    <span class="status-text">No selection</span>
                  </div>
                </div>
                <div class="section-content" id="figma-content">
                  <div class="empty-state">
                    <span class="empty-icon">🎯</span>
                    <p>Select elements in Figma to see context here</p>
                    <small>Frame data, components, and design details</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Context Quality Metrics -->
            <div class="context-metrics">
              <h4 class="metrics-title">📊 Context Quality Metrics</h4>
              <div class="metrics-grid">
                <div class="metric-item">
                  <div class="metric-label">Context Richness</div>
                  <div class="metric-value" id="richness-score">0%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Confidence</div>
                  <div class="metric-value" id="confidence-score">0%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Selection Count</div>
                  <div class="metric-value" id="selection-count">0</div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="context-actions">
              <button class="action-btn secondary" id="edit-context-btn">
                ✏️ Edit Context
              </button>
              <button class="action-btn primary" id="submit-context-btn" disabled>
                🚀 Generate with Context
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button id="generate" class="button">🔍 Preview Context & Generate</button>
        <button id="generateAI" class="button button-ai">🤖 Generate AI Ticket</button>
      </div>
      
      <div style="text-align: center; margin: 10px 0;">
        <button id="showDebug" class="button-debug">🔍 Show MCP Data Debug</button>
      </div>

      <!-- Standalone Testing Panel -->
      <div class="test-panel">
        <h3>🧪 Standalone Testing (No Figma Required)</h3>
        <div class="test-buttons">
          <button id="testMockAI" class="button button-success">🤖 Test Mock AI Generation</button>
          <button id="testMockData" class="button button-success">📊 Test Mock Data Extraction</button>
          <button id="testMCPDirect" class="button button-success">🔧 Test MCP Server Direct</button>
        </div>
      </div>

      <!-- Debug Panel for Data Layer Validation -->
      <div id="debugPanel" class="debug-panel hidden">
        <div class="debug-header">
          <h3>🔍 MCP Data Layer Debug</h3>
          <button id="toggleDebug" class="button-debug">Hide Debug</button>
        </div>
        <div class="debug-content">
          <div class="debug-section">
            <h4>📊 Extracted Data Schema</h4>
            <pre id="debugDataSchema" class="debug-code"></pre>
          </div>
          <div class="debug-section">
            <h4>✅ Validation Results</h4>
            <div id="debugValidation" class="debug-validation"></div>
          </div>
          <div class="debug-section">
            <h4>📡 MCP Server Communication</h4>
            <div id="debugMCP" class="debug-mcp"></div>
          </div>
        </div>
      </div>

      <div id="results" class="hidden">
        <label>Generated Content</label>
        <textarea id="generatedContent" readonly></textarea>
        <button id="copyBtn" class="copy-btn button button-secondary">📋 Copy to Clipboard</button>
      </div>
      </div>

      <!-- Design Health Tab -->
      <div class="tab-content" id="health-tab">
        <div class="panel-header">
          <h2 class="panel-title">📊 Design System Health</h2>
          <p class="panel-subtitle">Analyze design consistency and component usage patterns</p>
        </div>

        <div class="health-metrics">
          <div class="metric-card">
            <h3>🎨 Component Coverage</h3>
            <div class="metric-value">85%</div>
            <p>Design system adoption rate</p>
          </div>
          <div class="metric-card">
            <h3>🔄 Consistency Score</h3>
            <div class="metric-value">92%</div>
            <p>Cross-platform alignment</p>
          </div>
          <div class="metric-card">
            <h3>🚀 Performance</h3>
            <div class="metric-value">A+</div>
            <p>Asset optimization grade</p>
          </div>
        </div>

        <div class="health-analysis">
          <h3>🔍 Analysis Results</h3>
          <div class="analysis-item">
            <span class="status-good">✅</span>
            <strong>Color Palette:</strong> All colors match design tokens
          </div>
          <div class="analysis-item">
            <span class="status-warning">⚠️</span>
            <strong>Typography:</strong> 3 inconsistent font sizes detected
          </div>
          <div class="analysis-item">
            <span class="status-good">✅</span>
            <strong>Spacing:</strong> Grid system properly implemented
          </div>
        </div>

        <button class="button" id="analyzeHealthBtn">🔍 Analyze Current Selection</button>
      </div>
    </div>
  </div>

  <script>
    const techStackInput = document.getElementById('techStackInput');
    const documentTypeSelect = document.getElementById('documentType');
    const generateBtn = document.getElementById('generate');
    const resultsDiv = document.getElementById('results');
    const resultsTextarea = document.getElementById('generatedContent');
    const copyBtn = document.getElementById('copyBtn');
    const statusSection = document.querySelector('.status-section');

    // Context preview elements
    const contextPreviewWrapper = document.getElementById('context-preview-wrapper');
    const submitContextBtn = document.getElementById('submit-context-btn');
    const editContextBtn = document.getElementById('edit-context-btn');

    // Figma context variables
    let figmaContext = null;
    let frameData = null;
    let figmaFileInfo = null;
    let pendingContextData = null;

    // Document-specific LLM templates
    const documentTemplates = {
      jira: {
        title: "Jira Ticket Template",
        context: [
          "Focus on: User story, acceptance criteria, design requirements",
          "Include: Visual description, component specifications, interaction details",
          "Exclude: Technical implementation details unless specifically requested",
          "Format: Jira ticket with clear user story format"
        ],
        prompt: "Create a detailed Jira ticket based on the selected Figma design. Focus on user experience requirements and design specifications rather than technical implementation."
      },
      confluence: {
        title: "Confluence Documentation Template", 
        context: [
          "Focus on: Design rationale, component documentation, usage guidelines",
          "Include: Visual examples, design patterns, accessibility considerations",
          "Exclude: Code implementation details",
          "Format: Structured documentation with clear sections"
        ],
        prompt: "Create comprehensive Confluence documentation for the selected design. Focus on design decisions, component usage, and guidelines for the design system."
      },
      wiki: {
        title: "Wiki Documentation Template",
        context: [
          "Focus on: Knowledge sharing, design patterns, best practices",
          "Include: Visual design principles, component relationships, design rationale", 
          "Exclude: Implementation specifics",
          "Format: Educational wiki content with examples"
        ],
        prompt: "Create wiki documentation that explains the design patterns and principles shown in the selected Figma elements. Focus on educational content for design teams."
      },
      agent: {
        title: "Agent Task Template",
        context: [
          "Focus on: Actionable tasks, design requirements, deliverables",
          "Include: Specific design tasks, review criteria, expected outcomes",
          "Exclude: Low-level implementation details",
          "Format: Clear task breakdown with success criteria"
        ],
        prompt: "Create specific agent tasks based on the selected design. Focus on actionable design work and clear deliverables."
      },
      code: {
        title: "Code Generation Template",
        context: [
          "Focus on: Technical implementation, component structure, styling details",
          "Include: Technology stack, coding patterns, responsive behavior",
          "Include: Tech stack analysis and implementation approach",
          "Format: Technical specifications for development"
        ],
        prompt: "Create detailed technical specifications for implementing the selected design. Include technology recommendations and coding approach."
      }
    };

    // Update template preview based on document type
    function updateTemplateContext() {
      const documentType = document.getElementById('documentType').value;
      const template = documentTemplates[documentType];
      const previewDiv = document.getElementById('templateContent');
      
      if (template && previewDiv) {
        previewDiv.innerHTML = `
          <div style="background: #f0f9ff; border: 1px solid #0284c7; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
            <strong style="color: #0284c7;">${template.title}</strong>
          </div>
          <div style="font-size: 13px; line-height: 1.4;">
            ${template.context.map(item => `
              <div style="margin-bottom: 4px; padding: 4px 0;">
                <span style="color: #059669;">•</span> ${item}
              </div>
            `).join('')}
          </div>
          <div style="background: #fefce8; border: 1px solid #ca8a04; border-radius: 4px; padding: 8px; margin-top: 8px; font-size: 12px; font-style: italic; color: #a16207;">
            ${template.prompt}
          </div>
        `;
      }
    }
    // Tech Stack Suggestions Database
    const techStackTemplates = {
      react: "React 18 with TypeScript, Material-UI v5, React Query for state management, Jest for testing, Webpack bundling",
      vue: "Vue 3 with Composition API, Pinia for state management, Vite build tool, Vitest for unit testing, Vue Router",
      angular: "Angular 15 with NgRx for state management, Angular Material UI components, RxJS for reactive programming, Jasmine/Karma testing",
      next: "Next.js 13 with App Router, TailwindCSS for styling, Prisma ORM, PostgreSQL database, Vercel deployment",
      aem: "AEM 6.5 with HTL (HTML Template Language), Apache Sling framework, OSGi bundles, JCR repository, Touch UI components",
      design: "Figma design system with design tokens, component library, style guide, accessibility standards, responsive breakpoints"
    };

    // MCP Server Configuration
    const MCP_SERVER_URL = 'http://localhost:3000';
    let mcpServerStatus = {
      connected: false,
      tools: [],
      version: null,
      lastCheck: null
    };

    // Check MCP Server Status
    async function checkMCPServerStatus() {
      try {
        console.log('🔌 Checking MCP server status...');
        const response = await fetch(MCP_SERVER_URL, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const serverInfo = await response.json();
          mcpServerStatus = {
            connected: true,
            tools: serverInfo.tools || [],
            version: serverInfo.version,
            lastCheck: new Date()
          };
          
          console.log('✅ MCP server connected:', serverInfo);
          updateServerStatusUI(true, serverInfo);
        } else {
          throw new Error(`Server responded with ${response.status}`);
        }
      } catch (error) {
        console.error('❌ MCP server connection failed:', error);
        mcpServerStatus = {
          connected: false,
          tools: [],
          version: null,
          lastCheck: new Date()
        };
        updateServerStatusUI(false, { error: error.message });
      }
    }

    // Update Server Status UI
    function updateServerStatusUI(connected, info) {
      const badge = document.getElementById('server-status-badge');
      const section = document.getElementById('server-status-section');
      const status = document.getElementById('server-connection-status');
      const content = document.getElementById('server-connection-content');

      if (connected) {
        badge.textContent = 'Connected';
        badge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        
        section.classList.add('has-content');
        
        status.innerHTML = `
          <span class="status-indicator">✅</span>
          <span class="status-text">Connected (v${info.version})</span>
        `;

        content.innerHTML = `
          <div style="font-size: 13px;">
            <div><strong>Server URL:</strong> ${MCP_SERVER_URL}</div>
            <div><strong>Available Tools:</strong> ${info.tools.length}</div>
            <div style="margin-top: 8px;">
              ${info.tools.map(tool => 
                `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px 4px 2px 0;">${tool}</span>`
              ).join('')}
            </div>
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 8px 12px; font-size: 12px; color: #166534; margin-top: 8px;">
              🚀 MCP Server Ready - AI-powered design analysis available
            </div>
          </div>
        `;
      } else {
        badge.textContent = 'Disconnected';
        badge.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        
        section.classList.remove('has-content');
        
        status.innerHTML = `
          <span class="status-indicator">❌</span>
          <span class="status-text">Connection Failed</span>
        `;

        content.innerHTML = `
          <div style="font-size: 13px; color: #dc2626;">
            <div><strong>Error:</strong> ${info.error}</div>
            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
              Make sure the MCP server is running:<br>
              <code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px;">cd server && npm start</code>
            </div>
          </div>
        `;
      }
    }

    // Call MCP Server Tool
    async function callMCPTool(toolName, params) {
      if (!mcpServerStatus.connected) {
        throw new Error('MCP server not connected');
      }

      console.log(`🔧 Calling MCP tool: ${toolName}`, params);

      try {
        const response = await fetch(MCP_SERVER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            method: toolName,
            params: params
          })
        });

        if (!response.ok) {
          throw new Error(`MCP call failed: ${response.status}`);
        }

        const result = await response.json();
        console.log(`✅ MCP tool ${toolName} completed:`, result);
        return result;

      } catch (error) {
        console.error(`❌ MCP tool ${toolName} failed:`, error);
        throw error;
      }
    }

    // Initialize Figma plugin communication
    function initializeFigmaIntegration() {
      // Check MCP server status first
      checkMCPServerStatus();
      
      // Set up periodic server status checks
      setInterval(checkMCPServerStatus, 30000); // Check every 30 seconds

      // Listen for messages from Figma plugin code
        window.addEventListener('message', (event) => {
          console.log('🎨 Received message:', event.data);
          if (event.data.pluginMessage) {
            const msg = event.data.pluginMessage;
            switch (msg.type) {
              case 'selection-context':
                handleSelectionContext(msg.data);
                break;
              case 'file-context':
                handleFileContext(msg);
                break;
              case 'get-real-file-key':
                // Extract real file key from browser URL
                const urlMatch = window.location.href.match(/file\/([a-zA-Z0-9]+)/);
                const realFileKey = urlMatch ? urlMatch[1] : 'dev-file';
                console.log('🔍 Extracted file key from URL:', realFileKey);
                
                // Send back to plugin with the callback
                parent.postMessage({ 
                  pluginMessage: { 
                    type: 'real-file-key-response',
                    fileKey: realFileKey,
                    callback: msg.callback
                  } 
                }, '*');
                break;
              case 'screenshot-captured':
                // Use real screenshot if available, fallback to mock
                console.log('📸 Screenshot message received:', msg);
                let screenshotData = msg.screenshot;
                if (!screenshotData || !screenshotData.dataUrl) {
                  console.log('⚠️ No valid screenshot data, using mock');
                  screenshotData = createMockScreenshot();
                  screenshotData.fallback = true;
                } else {
                  console.log('✅ Valid screenshot data received, using LIVE');
                  screenshotData.fallback = false;
                }
                updateScreenshotSection(screenshotData);
                break;
              case 'enhanced-frame-data':
                handleEnhancedFrameData(msg.data, msg.fileContext, msg.processingSummary);
                break;
              case 'ai-ticket-data':
                handleAITicketData(msg.data);
                break;
              case 'error':
                console.error('Figma error:', msg.message);
                break;
              default:
                console.log('Unhandled message type:', msg.type);
            }
          }
        });
      
      // Request initial context from Figma
      parent.postMessage({ pluginMessage: { type: 'get-context' } }, '*');
    }

    // Handle selection context from Figma
    function handleSelectionContext(selectionData) {
      console.log('📋 Received selection context:', selectionData);
      
      if (selectionData && selectionData.length > 0) {
        // Update global context
        frameData = selectionData;
        
        // Trigger screenshot capture for visual context
        console.log('📸 Triggering screenshot capture...');
        parent.postMessage({ pluginMessage: { type: 'capture-screenshot' } }, '*');
        
        // Update UI to show selection data
        const figmaSection = document.querySelector('[data-section="figma"]');
        if (figmaSection) {
          figmaSection.classList.add('has-content');
          
          const status = figmaSection.querySelector('#figma-status');
          const content = figmaSection.querySelector('#figma-content');
          
          if (status && content) {
            status.innerHTML = `
              <span class="status-indicator">🎨</span>
              <span class="status-text">${selectionData.length} items selected</span>
            `;
            
            content.innerHTML = `
              <div style="font-size: 13px;">
                ${selectionData.map(item => `
                  <div style="margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;">
                    <strong>${item.name}</strong> (${item.type})<br>
                    <small style="color: #6b7280;">${item.dimensions.width}×${item.dimensions.height}px</small>
                  </div>
                `).join('')}
              </div>
            `;
          }
        }
        
        // Update metrics
        updateContextMetrics({
          figmaContext: {
            hasSelection: true,
            selectionCount: selectionData.length
          }
        });
      }
    }

    // Handle file context from Figma
    function handleFileContext(fileData) {
      console.log('📁 Received file context:', fileData);
      figmaFileInfo = {
        fileName: fileData.fileName || 'Untitled',
        fileKey: fileData.fileKey
      };
    }

    // Select tech stack from suggestions
    function selectTechStack(element) {
      const techType = element.getAttribute('data-type');
      const template = techStackTemplates[techType];
      
      if (template) {
        techStackInput.value = template;
        
        // Visual feedback
        element.style.transform = 'scale(0.95)';
        setTimeout(() => {
          element.style.transform = 'scale(1)';
        }, 150);
        
        // Trigger parsing and confidence update
        const parsed = parseTechStack(template);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
      }
    }

    // Parse tech stack button functionality
    function parseTechStackManually() {
      const techStackDesc = techStackInput.value.trim();
      
      if (!techStackDesc) {
        showError('Please enter a tech stack description to parse.');
        return;
      }
      
      const parsed = parseTechStack(techStackDesc);
      updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
    }

    // Handle AI ticket data from plugin and process with MCP + AI
    async function handleAITicketData(aiData) {
      console.log('🤖 Processing AI ticket data:', aiData);
      
      // Update debug panel with extracted data
      updateDebugPanel(aiData);
      
      const aiBtn = document.getElementById('generateAI');
      const techStackDesc = techStackInput.value.trim();
      const documentType = documentTypeSelect.value;
      
      try {
        aiBtn.innerHTML = '<div class="spinner"></div> Processing with AI...';
        showStatus('🧠 Sending data to MCP server for AI processing...', 'loading');
        
        // Prepare data for MCP server generate_ai_ticket tool
        const mcpParams = {
          enhancedFrameData: aiData.enhancedFrameData,
          screenshot: aiData.screenshot,
          figmaUrl: `https://www.figma.com/file/${aiData.fileContext.fileKey}/${encodeURIComponent(aiData.fileContext.fileName)}`,
          techStack: techStackDesc,
          documentType: documentType,
          projectName: aiData.fileContext.fileName,
          fileContext: aiData.fileContext,
          metadata: aiData.metadata,
          useAI: true
        };

        console.log('📤 Calling MCP generate_ai_ticket with enhanced data...');
        showStatus('🔮 AI analyzing design and generating intelligent ticket...', 'loading');
        
        // Call MCP server generate_ai_ticket tool
        const result = await callMCPTool('generate_ai_ticket', mcpParams);
        
        // Process the AI-generated result
        let generatedContent = '';
        if (result.content && Array.isArray(result.content)) {
          generatedContent = result.content
            .filter(item => item.type === 'text')
            .map(item => typeof item.text === 'string' ? item.text : JSON.stringify(item.text))
            .join('\n\n');
        } else if (result.ticket) {
          generatedContent = typeof result.ticket === 'string' ? result.ticket : JSON.stringify(result.ticket);
        } else {
          throw new Error('No content received from AI generation');
        }

        // Display the AI-generated ticket
        document.getElementById('generatedContent').value = generatedContent;
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('copyBtn').disabled = false;
        
        showStatus('✅ AI-powered ticket generated successfully!', 'success');
        console.log('✅ AI ticket generation completed');
        
      } catch (error) {
        console.error('❌ AI ticket processing failed:', error);
        showError(`AI ticket generation failed: ${error.message}`);
        
        // Fallback to standard generation
        try {
          console.log('🔄 Falling back to standard generation...');
          const fallbackContent = generateFallbackTicket(aiData);
          document.getElementById('generatedContent').value = fallbackContent;
          document.getElementById('results').classList.remove('hidden');
          document.getElementById('copyBtn').disabled = false;
          showStatus('⚠️ Used fallback generation (AI unavailable)', 'warning');
        } catch (fallbackError) {
          console.error('❌ Fallback generation also failed:', fallbackError);
          showError('Both AI and fallback generation failed. Please try again.');
        }
        
      } finally {
        aiBtn.disabled = false;
        aiBtn.innerHTML = '🤖 Generate AI Ticket';
      }
    }

    // Generate fallback ticket when AI fails
    function generateFallbackTicket(aiData) {
      const frameData = aiData.enhancedFrameData[0] || {};
      const fileContext = aiData.fileContext || {};
      
      return `# ${frameData.name || 'Design Component'} Implementation

## Overview
Implement the ${frameData.name || 'selected component'} from ${fileContext.fileName || 'Figma design'}.

## Component Details
- **Type**: ${frameData.type || 'Component'}
- **Dimensions**: ${frameData.dimensions?.width || 0}×${frameData.dimensions?.height || 0}px
- **Page**: ${fileContext.pageName || 'Unknown'}
- **Hierarchy Depth**: ${frameData.hierarchy?.totalDepth || 1}
- **Component Count**: ${frameData.hierarchy?.componentCount || 0}

## Technical Requirements
- Implement using ${techStackInput.value || 'specified tech stack'}
- Maintain responsive design principles
- Follow accessibility best practices
- Use design system tokens where applicable

## Acceptance Criteria
- [ ] Component renders correctly at specified dimensions
- [ ] Responsive behavior matches design
- [ ] Accessibility requirements met
- [ ] Design system tokens used appropriately

## Story Points
${Math.max(3, Math.min(8, Math.ceil((frameData.hierarchy?.componentCount || 1) * 2)))}

---
*Generated with enhanced fallback mode - AI processing unavailable*
*Extracted at: ${aiData.metadata?.extractedAt || new Date().toISOString()}*`;
    }

    // Debug Panel Functions
    function updateDebugPanel(aiData) {
      console.log('🔍 Updating debug panel with data:', aiData);
      
      // Show debug panel
      document.getElementById('debugPanel').classList.remove('hidden');
      
      // Update data schema display
      const schemaElement = document.getElementById('debugDataSchema');
      if (schemaElement) {
        schemaElement.textContent = JSON.stringify(aiData, null, 2);
      }
      
      // Validate the data and show results
      const validationElement = document.getElementById('debugValidation');
      if (validationElement && aiData.enhancedFrameData) {
        let validationHTML = '';
        
        aiData.enhancedFrameData.forEach((frameData, index) => {
          const validation = validateFrameDataSchema(frameData);
          
          if (validation.isValid && validation.warnings.length === 0) {
            validationHTML += `<div class="validation-pass">✅ Frame ${index + 1} (${frameData.name || 'Unnamed'}): All validations passed</div>`;
          } else {
            if (validation.errors.length > 0) {
              validationHTML += `<div class="validation-error">❌ Frame ${index + 1} Errors: ${validation.errors.join(', ')}</div>`;
            }
            if (validation.warnings.length > 0) {
              validationHTML += `<div class="validation-warning">⚠️ Frame ${index + 1} Warnings: ${validation.warnings.join(', ')}</div>`;
            }
          }
        });
        
        validationElement.innerHTML = validationHTML || '<div class="validation-pass">✅ No data to validate</div>';
      }
      
      // Update MCP communication status
      const mcpElement = document.getElementById('debugMCP');
      if (mcpElement) {
        mcpElement.innerHTML = `
          <div>📊 Data Size: ${JSON.stringify(aiData).length} bytes</div>
          <div>🎯 Frames: ${aiData.enhancedFrameData?.length || 0}</div>
          <div>📸 Screenshot: ${aiData.screenshot ? 'Available' : 'Not captured'}</div>
          <div>📄 File: ${aiData.fileContext?.fileName || 'Unknown'}</div>
          <div>🕒 Extracted: ${aiData.metadata?.extractedAt || 'Unknown'}</div>
        `;
      }
    }

    function validateFrameDataSchema(data) {
      const errors = [];
      const warnings = [];
      
      // Required field validation
      if (!data.id) errors.push('Missing required field: id');
      if (!data.name) warnings.push('Missing field: name');
      if (!data.type) errors.push('Missing required field: type');
      if (!data.dimensions) errors.push('Missing required field: dimensions');
      else {
        if (typeof data.dimensions.width !== 'number') errors.push('dimensions.width must be a number');
        if (typeof data.dimensions.height !== 'number') errors.push('dimensions.height must be a number');
      }
      
      // Hierarchy validation
      if (!data.hierarchy) errors.push('Missing required field: hierarchy');
      else {
        if (!Array.isArray(data.hierarchy.layers)) errors.push('hierarchy.layers must be an array');
        if (typeof data.hierarchy.totalDepth !== 'number') warnings.push('hierarchy.totalDepth should be a number');
        if (typeof data.hierarchy.componentCount !== 'number') warnings.push('hierarchy.componentCount should be a number');
      }
      
      // Metadata validation
      if (!data.metadata) errors.push('Missing required field: metadata');
      else {
        if (!Array.isArray(data.metadata.colors)) warnings.push('metadata.colors should be an array');
        if (!data.metadata.semanticRole) warnings.push('Missing metadata.semanticRole');
      }
      
      return {
        isValid: errors.length === 0,
        errors,
        warnings
      };
    }

    // Handle enhanced frame data from regular generate button (for debugging)
    function handleEnhancedFrameData(data, fileContext, processingSummary) {
      console.log('📊 Enhanced frame data received:', { data, fileContext, processingSummary });
      
      // Create debug-friendly data structure
      const debugData = {
        enhancedFrameData: data,
        fileContext: fileContext,
        metadata: {
          extractedAt: new Date().toISOString(),
          processingSummary: processingSummary
        }
      };
      
      // Update debug panel
      updateDebugPanel(debugData);
      
      // Show success message
      showStatus(`✅ Enhanced data extracted: ${data.length} frame(s) processed`, 'success');
    }

    function toggleDebugPanel() {
      const debugPanel = document.getElementById('debugPanel');
      const toggleBtn = document.getElementById('showDebug');
      const hideBtn = document.getElementById('toggleDebug');
      
      if (debugPanel.classList.contains('hidden')) {
        debugPanel.classList.remove('hidden');
        toggleBtn.textContent = '🔍 Hide MCP Data Debug';
      } else {
        debugPanel.classList.add('hidden');
        toggleBtn.textContent = '🔍 Show MCP Data Debug';
      }
    }

    // Mock Data Generator for Testing Without Figma
    function generateMockAITicketData() {
      return {
        enhancedFrameData: [
          {
            id: "mock-frame-1",
            name: "Primary Button Component",
            type: "COMPONENT",
            description: "component component: Primary Button Component",
            pageName: "Design System",
            dimensions: { width: 120, height: 40 },
            position: { x: 100, y: 200 },
            hierarchy: {
              layers: [
                {
                  id: "mock-layer-1",
                  name: "Button Background",
                  type: "RECTANGLE",
                  position: { x: 0, y: 0 },
                  size: { width: 120, height: 40 },
                  semanticRole: "background"
                },
                {
                  id: "mock-layer-2", 
                  name: "Button Text",
                  type: "TEXT",
                  position: { x: 10, y: 12 },
                  size: { width: 100, height: 16 },
                  semanticRole: "text"
                }
              ],
              totalDepth: 2,
              componentCount: 1,
              textLayerCount: 1
            },
            componentInstances: [],
            designSystemLinks: {
              buttons: "design-system/buttons",
              colors: "design-system/colors",
              typography: "design-system/typography",
              spacing: "design-system/spacing"
            },
            exportScreenshots: [],
            fileKey: "mock-file-key-123",
            fileName: "Design System Components",
            metadata: {
              nodeCount: 2,
              textContent: [],
              colors: ["#007AFF", "#FFFFFF"],
              hasPrototype: false,
              semanticRole: "button",
              accessibility: {
                hasLabel: true,
                role: "button",
                colorContrast: "unknown",
                focusable: true,
                issues: []
              }
            }
          },
          {
            id: "mock-frame-2",
            name: "Navigation Card",
            type: "FRAME",
            description: "frame component: Navigation Card",
            pageName: "Components",
            dimensions: { width: 300, height: 200 },
            position: { x: 0, y: 0 },
            hierarchy: {
              layers: [
                {
                  id: "mock-layer-3",
                  name: "Card Background",
                  type: "RECTANGLE",
                  position: { x: 0, y: 0 },
                  size: { width: 300, height: 200 },
                  semanticRole: "container"
                },
                {
                  id: "mock-layer-4",
                  name: "Card Title",
                  type: "TEXT",
                  position: { x: 20, y: 20 },
                  size: { width: 260, height: 24 },
                  semanticRole: "heading"
                }
              ],
              totalDepth: 2,
              componentCount: 0,
              textLayerCount: 1
            },
            componentInstances: [],
            designSystemLinks: {
              buttons: null,
              colors: "design-system/colors",
              typography: "design-system/typography",
              spacing: "design-system/spacing"
            },
            exportScreenshots: [],
            fileKey: "mock-file-key-123",
            fileName: "Design System Components", 
            metadata: {
              nodeCount: 2,
              textContent: [],
              colors: ["#F8F9FA", "#1A202C"],
              hasPrototype: false,
              semanticRole: "card",
              accessibility: {
                hasLabel: true,
                role: "container",
                colorContrast: "unknown",
                focusable: false,
                issues: []
              }
            }
          }
        ],
        screenshot: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
        fileContext: {
          fileKey: "mock-file-key-123",
          fileName: "Design System Components",
          pageName: "Components",
          selectionCount: 2
        },
        metadata: {
          extractedAt: new Date().toISOString(),
          totalFrames: 2,
          hasScreenshot: true
        }
      };
    }

    function generateMockEnhancedFrameData() {
      const mockData = generateMockAITicketData();
      return {
        data: mockData.enhancedFrameData,
        fileContext: mockData.fileContext,
        processingSummary: {
          processed: 2,
          skipped: 0,
          total: 2,
          message: "Successfully processed 2 frame(s) with mock data"
        }
      };
    }

    // Test functions for standalone testing
    async function testMockAIGeneration() {
      const mockData = generateMockAITicketData();
      
      showStatus('🧪 Testing with mock data...', 'loading');
      console.log('🧪 Generated mock AI ticket data:', mockData);
      
      // Update debug panel with mock data
      updateDebugPanel(mockData);
      
      // Simulate AI processing
      try {
        const aiBtn = document.getElementById('generateAI');
        aiBtn.disabled = true;
        aiBtn.innerHTML = '<div class="spinner"></div> Processing Mock Data...';
        
        // Call MCP server with mock data
        const mcpParams = {
          enhancedFrameData: mockData.enhancedFrameData,
          screenshot: mockData.screenshot,
          figmaUrl: `https://www.figma.com/file/${mockData.fileContext.fileKey}/${encodeURIComponent(mockData.fileContext.fileName)}`,
          techStack: techStackInput.value.trim() || 'React + TypeScript',
          documentType: documentTypeSelect.value,
          projectName: mockData.fileContext.fileName,
          fileContext: mockData.fileContext,
          metadata: mockData.metadata,
          useAI: true
        };

        console.log('📤 Calling MCP with mock data...');
        const result = await callMCPTool('generate_ai_ticket', mcpParams);
        
        // Process result
        let generatedContent = '';
        if (result.content && Array.isArray(result.content)) {
          generatedContent = result.content
            .filter(item => item.type === 'text')
            .map(item => typeof item.text === 'string' ? item.text : JSON.stringify(item.text))
            .join('\n\n');
        }
        
        // Display result
        document.getElementById('generatedContent').value = generatedContent;
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('copyBtn').disabled = false;
        
        showStatus('✅ Mock AI ticket generated successfully!', 'success');
        
      } catch (error) {
        console.error('❌ Mock test failed:', error);
        showError(`Mock test failed: ${error.message}`);
      } finally {
        const aiBtn = document.getElementById('generateAI');
        aiBtn.disabled = false;
        aiBtn.innerHTML = '🤖 Generate AI Ticket';
      }
    }

    function testMockEnhancedData() {
      const mockData = generateMockEnhancedFrameData();
      
      showStatus('🧪 Testing enhanced data extraction...', 'loading');
      console.log('🧪 Generated mock enhanced frame data:', mockData);
      
      // Simulate the enhanced frame data message
      handleEnhancedFrameData(mockData.data, mockData.fileContext, mockData.processingSummary);
      
      showStatus('✅ Mock enhanced data processed!', 'success');
    }

    async function testMCPServerDirect() {
      showStatus('🔧 Testing MCP server direct connection...', 'loading');
      
      try {
        // Test 1: Server health check
        console.log('1️⃣ Testing server health...');
        const healthResponse = await fetch('http://localhost:3000/');
        if (!healthResponse.ok) throw new Error('Server health check failed');
        
        const healthData = await healthResponse.json();
        console.log('✅ Server health:', healthData);
        
        // Test 2: Available tools
        console.log('2️⃣ Testing available tools...');
        console.log('🔧 Available tools:', healthData.tools);
        
        // Test 3: Generate AI ticket with minimal data
        console.log('3️⃣ Testing generate_ai_ticket...');
        const testResponse = await callMCPTool('generate_ai_ticket', {
          figmaUrl: 'https://figma.com/file/test123/Test-Design',
          techStack: 'React + TypeScript',
          documentType: 'jira',
          useAI: true
        });
        
        console.log('✅ AI ticket generation test:', testResponse);
        
        // Test 4: Enhanced ticket generation
        console.log('4️⃣ Testing generate_enhanced_ticket...');
        const enhancedResponse = await callMCPTool('generate_enhanced_ticket', {
          figmaUrl: 'https://figma.com/file/test123/Test-Design',
          techStack: 'React + TypeScript',
          documentType: 'jira'
        });
        
        console.log('✅ Enhanced ticket generation test:', enhancedResponse);
        
        // Display success
        showStatus('✅ All MCP server tests passed!', 'success');
        
        // Show results in textarea
        const results = `🔧 MCP Server Direct Test Results

✅ Server Health: ${healthData.name} v${healthData.version}
✅ Available Tools: ${healthData.tools?.join(', ') || 'Unknown'}
✅ AI Ticket Generation: ${testResponse.content?.[0]?.text?.length || 0} chars
✅ Enhanced Ticket Generation: ${enhancedResponse.content?.[0]?.text?.length || 0} chars

All tests completed successfully at ${new Date().toLocaleString()}`;

        document.getElementById('generatedContent').value = results;
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('copyBtn').disabled = false;
        
      } catch (error) {
        console.error('❌ MCP server test failed:', error);
        showError(`MCP server test failed: ${error.message}`);
      }
    }

    // Tech stack parsing and confidence calculation
    function parseTechStack(description) {
      const frameworks = ['react', 'vue', 'angular', 'svelte', 'next.js', 'nuxt', 'gatsby'];
      const languages = ['typescript', 'javascript', 'python', 'java', 'c#', 'go', 'rust'];
      const tools = ['webpack', 'vite', 'parcel', 'rollup', 'esbuild'];
      
      const lowerDesc = description.toLowerCase();
      
      const detected = {
        frameworks: frameworks.filter(f => lowerDesc.includes(f)),
        languages: languages.filter(l => lowerDesc.includes(l)),
        tools: tools.filter(t => lowerDesc.includes(t))
      };
      
      // Calculate confidence based on specificity
      let confidence = 50;
      if (detected.frameworks.length > 0) confidence += 20;
      if (detected.languages.length > 0) confidence += 15;
      if (detected.tools.length > 0) confidence += 10;
      if (lowerDesc.includes('version') || /\d+/.test(lowerDesc)) confidence += 10;
      
      confidence = Math.min(confidence, 95);
      
      // Generate suggestions
      const suggestions = [];
      if (detected.frameworks.length > 0) {
        detected.frameworks.forEach(f => suggestions.push(f.charAt(0).toUpperCase() + f.slice(1)));
      }
      if (suggestions.length === 0) {
        suggestions.push('Add specific versions', 'Include testing framework', 'Mention state management');
      }
      
      return { detected, confidence, suggestions };
    }

    // Update confidence indicator
    function updateConfidenceIndicator(confidence, suggestions = []) {
      const indicator = statusSection.querySelector('.confidence-indicator');
      const scoreEl = statusSection.querySelector('.confidence-score');
      const suggestionsEl = statusSection.querySelector('.suggestions');
      
      scoreEl.textContent = `${confidence}%`;
      scoreEl.className = `confidence-score ${
        confidence >= 80 ? 'confidence-high' : 
        confidence >= 60 ? 'confidence-medium' : 'confidence-low'
      }`;
      
      suggestionsEl.innerHTML = suggestions.map(s => 
        `<span class="suggestion-pill">${s}</span>`
      ).join('');
      
      statusSection.style.display = 'flex';
    }

    // Show context preview
    function showContextPreview(contextData) {
      // Update tech stack section
      if (contextData.techStack) {
        updateTechStackSection(contextData.techStack);
      }

      // Update Figma section
      if (contextData.figmaContext) {
        updateFigmaSection(contextData.figmaContext);
      }

      // Update screenshot section
      if (contextData.screenshot) {
        updateScreenshotSection(contextData.screenshot);
      }

      // Update metrics
      updateContextMetrics(contextData);

      // Show the preview section
      contextPreviewWrapper.classList.remove('hidden');
      
      // Scroll to preview
      contextPreviewWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Update the main generate button
      generateBtn.innerHTML = '👀 Context Preview Active';
      generateBtn.disabled = true;
      
      // Store context for actual generation
      pendingContextData = contextData;

      // Enable submit button
      submitContextBtn.disabled = false;
    }

    function updateTechStackSection(techStackData) {
      const section = document.querySelector('[data-section="techstack"]');
      const status = section.querySelector('#techstack-status');
      const content = section.querySelector('#techstack-content');

      section.classList.add('has-content');
      
      status.innerHTML = `
        <span class="status-indicator">✅</span>
        <span class="status-text">Analyzed (${techStackData.confidence}% confidence)</span>
      `;

      content.innerHTML = `
        <div style="font-size: 13px; line-height: 1.5;">
          <div style="margin-bottom: 12px;">
            <strong>Detected Technologies:</strong><br>
            ${techStackData.detected.frameworks.map(f => 
              `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px 4px 2px 0;">${f}</span>`
            ).join('')}
            ${techStackData.detected.languages.map(l => 
              `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px 4px 2px 0;">${l}</span>`
            ).join('')}
          </div>
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 8px 12px; font-size: 12px; color: #166534;">
            📊 Analysis Confidence: ${techStackData.confidence}%
          </div>
        </div>
      `;
    }

    function updateFigmaSection(figmaContextData) {
      const section = document.querySelector('[data-section="figma"]');
      const status = section.querySelector('#figma-status');
      const content = section.querySelector('#figma-content');

      if (figmaContextData && figmaContextData.hasSelection) {
        section.classList.add('has-content');
        
        status.innerHTML = `
          <span class="status-indicator">🎨</span>
          <span class="status-text">${figmaContextData.selectionCount} items selected</span>
        `;

        content.innerHTML = `
          <div style="font-size: 13px;">
            <div><strong>File:</strong> ${figmaContextData.fileName || 'Untitled'}</div>
            <div><strong>Selection:</strong> ${figmaContextData.selectionCount} elements</div>
            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
              Live Figma selection data captured
            </div>
          </div>
        `;
      }
    }

    function updateScreenshotSection(screenshotData) {
      const section = document.querySelector('[data-section="screenshot"]');
      const status = section.querySelector('#screenshot-status');
      const content = section.querySelector('#screenshot-content');

      section.classList.add('has-content');
      
      status.innerHTML = `
        <span class="status-indicator">📸</span>
        <span class="status-text">Captured (${screenshotData.size || 'Unknown size'})</span>
        ${screenshotData.fallback ? '<span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 8px;">MOCK</span>' : '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 8px;">LIVE</span>'}
      `;

      content.innerHTML = `
        <div style="text-align: center;">
          <img src="${screenshotData.dataUrl}" alt="Design Screenshot" style="max-width: 100%; max-height: 200px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
          <div style="font-size: 12px; color: #6b7280;">
            ${screenshotData.width}×${screenshotData.height}px • ${screenshotData.size || 'Unknown size'}
            ${screenshotData.nodeName ? `<br><strong style="color: #4b5563;">${screenshotData.nodeName}</strong> (${screenshotData.nodeType || 'Node'})` : ''}
            ${screenshotData.fallback ? '<br><small style="color: #94a3b8;">Mock context for testing</small>' : '<br><small style="color: #10b981;">Live Figma capture with enhanced export</small>'}
          </div>
        </div>
      `;
    }

    function updateContextMetrics(contextData) {
      let richness = 0;
      let confidence = 0;
      let selectionCount = 0;

      if (contextData.techStack) {
        richness += 40;
        confidence = contextData.techStack.confidence || 0;
      }
      if (contextData.screenshot) richness += 30;
      if (contextData.figmaContext?.hasSelection) {
        richness += 30;
        selectionCount = contextData.figmaContext.selectionCount || 0;
      }

      document.getElementById('richness-score').textContent = `${Math.min(richness, 100)}%`;
      document.getElementById('confidence-score').textContent = `${confidence}%`;
      document.getElementById('selection-count').textContent = selectionCount;
    }

    // Generate AI-powered ticket using MCP data layer + Gemini
    async function generateAITicket() {
      const techStackDesc = techStackInput.value.trim();
      const documentType = documentTypeSelect.value;
      
      if (!techStackDesc) {
        showError('Please describe your tech stack for AI ticket generation.');
        return;
      }
      
      // Update button state
      const aiBtn = document.getElementById('generateAI');
      aiBtn.disabled = true;
      aiBtn.innerHTML = '<div class="spinner"></div> Generating AI Ticket...';
      showStatus('🤖 Starting AI-powered ticket generation...', 'loading');
      
      try {
        // Step 1: Request enhanced data from plugin
        parent.postMessage({ pluginMessage: { type: 'generate-ai-ticket' } }, '*');
        
        // Wait for AI ticket data to be processed
        // The response will be handled by the message listener
        
      } catch (error) {
        console.error('❌ AI ticket generation failed:', error);
        showError('AI ticket generation failed. Please try again.');
        aiBtn.disabled = false;
        aiBtn.innerHTML = '🤖 Generate AI Ticket';
      }
    }

    // Generate content - enhanced with context preview
    async function generateContent() {
      const techStackDesc = techStackInput.value.trim();
      const documentType = documentTypeSelect.value;
      
      if (!techStackDesc) {
        showError('Please describe your tech stack to generate a document.');
        return;
      }
      
      // Check if we're running standalone (not in Figma)
      const isStandalone = window.parent === window;
      console.log('🔍 Checking mode - isStandalone:', isStandalone);
      
      if (isStandalone) {
        // Standalone mode - generate directly
        console.log('🌐 Running in standalone mode, calling generateStandalone...');
        return await generateStandalone(techStackDesc, documentType);
      }
      
      // Figma mode - Step 1: Collect context and show preview
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="spinner"></div> Collecting Context...';
      
      try {
        // First, request fresh context from Figma
        parent.postMessage({ pluginMessage: { type: 'get-context' } }, '*');
        
        // Wait a moment for the context to be received
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Parse tech stack
        const parsed = parseTechStack(techStackDesc);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
        
        // Create mock screenshot
        const screenshotData = createMockScreenshot();
        
        // Prepare comprehensive context data
        const contextData = {
          techStack: {
            ...parsed,
            description: techStackDesc
          },
          screenshot: screenshotData,
          figmaContext: {
            hasSelection: frameData && frameData.length > 0,
            selectionCount: frameData ? frameData.length : 0,
            fileName: figmaFileInfo?.fileName || 'Test Design File'
          },
          documentType: documentType
        };
        
        // Show context preview
        showContextPreview(contextData);
        
      } catch (error) {
        console.error('Context collection failed:', error);
        showError('Failed to collect context. Please try again.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '🔍 Preview Context & Generate';
      }
    }

    // Standalone generation function
    async function generateStandalone(techStackDesc, documentType) {
      console.log('🚀 generateStandalone called with:', { techStackDesc, documentType });
      
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="spinner"></div> Generating...';
      
      // Show results div immediately
      console.log('📝 Showing results div...');
      resultsDiv.classList.remove('hidden');
      resultsTextarea.value = 'Connecting to MCP server...';
      
      try {
        // Check MCP server connection first
        if (!mcpServerStatus.connected) {
          await checkMCPServerStatus();
          if (!mcpServerStatus.connected) {
            throw new Error('MCP server is not available. Starting fallback generation...');
          }
        }

        // Parse tech stack for confidence
        const parsed = parseTechStack(techStackDesc);
        
        // Prepare MCP parameters for standalone mode
        const mcpParams = {
          figmaUrl: 'https://www.figma.com/file/standalone/Test-Design',
          techStack: techStackDesc,
          documentType: documentType,
          visualContext: null,
          selectionCount: 0,
          standaloneMode: true
        };

        console.log('🎯 Calling MCP generate_enhanced_ticket tool (standalone)...');
        resultsTextarea.value = 'Generating content using AI-powered MCP server...';

        // Call MCP server to generate enhanced ticket
        const result = await callMCPTool('generate_enhanced_ticket', mcpParams);

        // Extract the generated content
        let generatedContent = '';
        if (result.content && Array.isArray(result.content)) {
          generatedContent = result.content
            .filter(item => item.type === 'text')
            .map(item => typeof item.text === 'string' ? item.text : JSON.stringify(item.text))
            .join('\n\n');
        } else if (result.ticket && typeof result.ticket === 'object' && result.ticket.ticket) {
          // Handle nested ticket structure
          generatedContent = result.ticket.ticket;
        } else if (result.ticket && typeof result.ticket === 'string') {
          generatedContent = result.ticket;
        } else if (result.text) {
          generatedContent = result.text;
        } else {
          // Safe JSON stringify with fallback
          try {
            generatedContent = JSON.stringify(result, null, 2);
          } catch (e) {
            generatedContent = `Error displaying result: ${e.message}\n\nResult type: ${typeof result}`;
          }
        }

        // Display the generated content
        resultsTextarea.value = generatedContent;
        copyBtn.disabled = false;
        
        console.log('✅ Standalone generation completed successfully');

      } catch (error) {
        console.error('Standalone generation failed:', error);
        
        // Fallback to basic generation
        const fallbackContent = generateBasicTicket(techStackDesc, documentType);
        resultsTextarea.value = fallbackContent;
        copyBtn.disabled = false;
        
        showError(`MCP Server unavailable. Generated basic ${documentType} ticket instead.`);
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '🔍 Preview Context & Generate';
      }
    }

    // Basic fallback ticket generation
    function generateBasicTicket(techStack, documentType) {
      const templates = {
        jira: `# Feature Implementation - Tech Stack Integration

## Summary
Implement features using ${techStack}

## Description
Based on the specified tech stack: ${techStack}

## Acceptance Criteria
- [ ] Implement core functionality using specified technologies
- [ ] Follow best practices for ${techStack}
- [ ] Ensure proper testing coverage
- [ ] Document implementation approach

## Technical Notes
- Tech Stack: ${techStack}
- Generated: ${new Date().toLocaleDateString()}
- Mode: Standalone (no Figma integration)

## Story Points
5`,
        confluence: `# ${techStack} Implementation Guide

## Overview
This document outlines the implementation approach for ${techStack}.

## Technical Stack
${techStack}

## Implementation Details
[To be completed based on specific requirements]

## Best Practices
- Follow ${techStack} conventions
- Implement proper error handling  
- Use appropriate testing strategies

## Resources
- Generated: ${new Date().toLocaleDateString()}
- Mode: Standalone documentation`,
        wiki: `# ${techStack} - Implementation Notes

**Tech Stack**: ${techStack}

**Last Updated**: ${new Date().toLocaleDateString()}

## Overview
Documentation for ${techStack} implementation.

## Key Components
[To be detailed based on specific requirements]

## Usage Guidelines
[Implementation-specific guidelines to be added]

---
*Generated in standalone mode*`,
        agent: `# Agent Task: ${techStack} Implementation

## Objective
Implement functionality using ${techStack}

## Task Details
- **Tech Stack**: ${techStack}
- **Priority**: Medium
- **Estimated Effort**: 2-3 days

## Deliverables
- [ ] Core implementation
- [ ] Testing coverage
- [ ] Documentation update

## Success Criteria
Implementation follows ${techStack} best practices

*Generated: ${new Date().toISOString()}*`,
        code: `# ${techStack} - Code Implementation Plan

## Tech Stack Analysis
${techStack}

## Implementation Approach
\`\`\`
// Implementation structure for ${techStack}
// Generated: ${new Date().toISOString()}
\`\`\`

## Next Steps
1. Set up project structure
2. Implement core features
3. Add testing coverage
4. Document API/interfaces

---
*Standalone mode - no Figma context available*`
      };

      return templates[documentType] || templates.jira;
    }

    // Function called when user submits from context preview
    async function proceedWithGeneration(contextData) {
      const documentType = contextData.documentType;
      
      // Show loading state
      submitContextBtn.disabled = true;
      submitContextBtn.innerHTML = '<div class="spinner"></div> Generating with MCP...';
      
      resultsDiv.classList.remove('hidden');
      resultsTextarea.value = 'Connecting to MCP server for AI-powered generation...';
      
      try {
        // Check MCP server connection first
        if (!mcpServerStatus.connected) {
          await checkMCPServerStatus();
          if (!mcpServerStatus.connected) {
            throw new Error('MCP server is not available. Please start the server first.');
          }
        }

        // Prepare MCP parameters
        // Extract real file key from current page URL
        const urlMatch = window.location.href.match(/file\/([a-zA-Z0-9]+)/);
        const realFileKey = urlMatch ? urlMatch[1] : 'dev-file';
        const fileName = contextData.figmaContext?.fileName || 'current-file';
        const figmaUrl = `https://www.figma.com/file/${realFileKey}/${encodeURIComponent(fileName)}`;
        
        console.log('🔗 Real file key extracted:', realFileKey);
        console.log('🔗 Generated Figma URL:', figmaUrl);
        
        const mcpParams = {
          figmaUrl: figmaUrl,
          techStack: contextData.techStack.description,
          documentType: documentType,
          visualContext: contextData.screenshot ? {
            hasScreenshot: true,
            description: `Screenshot of ${contextData.figmaContext?.selectionCount || 0} selected elements`
          } : null,
          selectionCount: contextData.figmaContext?.selectionCount || 0
        };

        console.log('🎯 Calling MCP generate_enhanced_ticket tool...');
        resultsTextarea.value = 'Generating content using AI-powered MCP server...';

        // Call MCP server to generate enhanced ticket
        const result = await callMCPTool('generate_enhanced_ticket', mcpParams);

        // Extract the generated content
        let generatedContent = '';
        if (result.content && Array.isArray(result.content)) {
          generatedContent = result.content
            .filter(item => item.type === 'text')
            .map(item => typeof item.text === 'string' ? item.text : JSON.stringify(item.text))
            .join('\n\n');
        } else if (result.ticket && typeof result.ticket === 'object' && result.ticket.ticket) {
          // Handle nested ticket structure
          generatedContent = result.ticket.ticket;
        } else if (result.ticket && typeof result.ticket === 'string') {
          generatedContent = result.ticket;
        } else if (result.text) {
          generatedContent = result.text;
        } else {
          // Safe JSON stringify with fallback
          try {
            generatedContent = JSON.stringify(result, null, 2);
          } catch (e) {
            generatedContent = `Error displaying result: ${e.message}\n\nResult type: ${typeof result}`;
          }
        }

        // Display the generated content
        resultsTextarea.value = generatedContent;
        
        // Show enhanced context info
        const contextInfo = document.createElement('div');
        contextInfo.className = 'context-success-info';
        contextInfo.innerHTML = `
          <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
            <strong>✅ Generated with MCP Server:</strong><br>
            • AI-Powered Analysis via MCP Protocol<br>
            • Tech Stack Analysis (${contextData.techStack.confidence}% confidence)<br>
            ${contextData.figmaContext?.hasSelection ? `• Figma Selection (${contextData.figmaContext.selectionCount} items)<br>` : ''}
            ${contextData.screenshot ? '• Visual Design Screenshot<br>' : ''}
            • Server: ${MCP_SERVER_URL}<br>
            • Tools Available: ${mcpServerStatus.tools.length}
          </div>
        `;
        resultsDiv.insertBefore(contextInfo, resultsDiv.firstChild.nextSibling);
        
        setTimeout(() => contextInfo.remove(), 15000);
        
      } catch (error) {
        console.error('MCP generation failed:', error);
        resultsTextarea.value = `# ❌ Generation Failed

**Error**: ${error.message}

## Troubleshooting:

1. **Check MCP Server Status**: Make sure the server is running
   \`\`\`bash
   cd server
   npm start
   \`\`\`

2. **Server URL**: ${MCP_SERVER_URL}

3. **Available Tools**: ${mcpServerStatus.tools.join(', ') || 'None - server disconnected'}

4. **Last Check**: ${mcpServerStatus.lastCheck ? new Date(mcpServerStatus.lastCheck).toLocaleTimeString() : 'Never'}

## Fallback Content:

Based on your input:
- **Tech Stack**: ${contextData.techStack.description}
- **Document Type**: ${documentType}
- **Selection**: ${contextData.figmaContext?.selectionCount || 0} items

Please fix the MCP server connection and try again.`;
        
        showError(`MCP Server Error: ${error.message}`);
      } finally {
        submitContextBtn.disabled = false;
        submitContextBtn.innerHTML = '🚀 Generate with MCP';
      }
    }

    // Helper function to create mock screenshot
    function createMockScreenshot() {
      const firstNode = frameData && frameData.length > 0 ? frameData[0] : null;
      const width = firstNode?.dimensions?.width || 400;
      const height = firstNode?.dimensions?.height || 200;
      // Sanitize text content to avoid btoa encoding issues
      const nodeName = (firstNode?.name || 'Enhanced Figma Context').replace(/[^\x00-\x7F]/g, '?');
      const nodeType = (firstNode?.type || 'FRAME').replace(/[^\x00-\x7F]/g, '?');
      
      const svgContent = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
        <rect width="${width}" height="${height}" fill="#f8fafc"/>
        <rect x="20" y="20" width="${width-40}" height="40" rx="8" fill="#667eea"/>
        <text x="${width/2}" y="45" text-anchor="middle" fill="white" font-family="Arial" font-size="16">${nodeName}</text>
        <text x="${width/2}" y="80" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="12">${nodeType} • Live Figma Context</text>
        <text x="${width/2}" y="100" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="10">Enhanced with design intelligence</text>
        ${firstNode ? `<rect x="20" y="120" width="${Math.min(width-40, 120)}" height="30" rx="4" fill="#10b981"/>
        <text x="${20 + Math.min(width-40, 120)/2}" y="140" text-anchor="middle" fill="white" font-family="Arial" font-size="12">Selected</text>` : ''}
      </svg>`;
      
      // Use encodeURIComponent for safer encoding
      const encodedSvg = encodeURIComponent(svgContent);
      
      return {
        dataUrl: `data:image/svg+xml,${encodedSvg}`,
        width: width,
        height: height,
        size: `${Math.round((width * height) / 1000)} KB`,
        nodeName: firstNode?.name || 'Enhanced Figma Context',
        nodeType: firstNode?.type || 'FRAME',
        fallback: true
      };
    }

    // Show error message
    function showError(message) {
      // Remove existing error messages
      document.querySelectorAll('.error-message').forEach(el => el.remove());
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      techStackInput.parentNode.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Show status message (required by test functions and AI generation)
    function showStatus(message, type = 'info') {
      console.log(`[Status] ${message}`);
      
      // Also show as temporary status indicator
      const statusDiv = document.createElement('div');
      statusDiv.className = `status status-${type}`;
      statusDiv.textContent = message;
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'pass' ? '#48bb78' : type === 'fail' ? '#f56565' : type === 'warn' ? '#ed8936' : '#4299e1'};
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
      `;
      
      document.body.appendChild(statusDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        if (statusDiv.parentNode) {
          statusDiv.remove();
        }
      }, 3000);
    }

    // Copy to clipboard
    function copyToClipboard() {
      resultsTextarea.select();
      resultsTextarea.setSelectionRange(0, 99999);
      
      try {
        document.execCommand('copy');
        copyBtn.textContent = '✅ Copied!';
        setTimeout(() => {
          copyBtn.textContent = '📋 Copy to Clipboard';
        }, 2000);
      } catch (err) {
        console.error('Copy failed:', err);
        copyBtn.textContent = '❌ Copy failed';
        setTimeout(() => {
          copyBtn.textContent = '📋 Copy to Clipboard';
        }, 2000);
      }
    }

    // Event listeners
    generateBtn.addEventListener('click', generateContent);
    document.getElementById('generateAI').addEventListener('click', generateAITicket);
    copyBtn.addEventListener('click', copyToClipboard);
    document.getElementById('parseTechBtn').addEventListener('click', parseTechStackManually);
    
    // Debug panel event listeners
    document.getElementById('showDebug').addEventListener('click', toggleDebugPanel);
    document.getElementById('toggleDebug').addEventListener('click', toggleDebugPanel);
    
    // Standalone testing event listeners
    document.getElementById('testMockAI').addEventListener('click', testMockAIGeneration);
    document.getElementById('testMockData').addEventListener('click', testMockEnhancedData);
    document.getElementById('testMCPDirect').addEventListener('click', testMCPServerDirect);

    // Context preview event listeners
    submitContextBtn.addEventListener('click', () => {
      if (pendingContextData) {
        proceedWithGeneration(pendingContextData);
      }
    });

    editContextBtn.addEventListener('click', () => {
      // Hide context preview to allow editing
      contextPreviewWrapper.classList.add('hidden');
      generateBtn.disabled = false;
      generateBtn.textContent = '🔍 Preview Context & Generate';
    });
    
    // Tech stack input validation and suggestions
    techStackInput.addEventListener('input', () => {
      const techStack = parseTechStack(techStackInput.value);
      if (techStackInput.value.length > 20) {
        updateConfidenceIndicator(techStack.confidence, techStack.suggestions);
      } else {
        statusSection.style.display = 'none';
      }
    });

    // Initialize the application
    initializeFigmaIntegration();

    // Tab functionality
    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.getAttribute('data-tab');
          
          // Remove active class from all tabs and contents
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          btn.classList.add('active');
          document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Design Health functionality
    function analyzeDesignHealth() {
      // Placeholder for design health analysis
      console.log('🔍 Analyzing design health...');
      
      // Send message to Figma plugin code for analysis
      parent.postMessage({ 
        pluginMessage: { 
          type: 'analyze-design-health'
        } 
      }, '*');
    }

    // Initialize tabs
    initializeTabs();

    // Initialize template preview
    updateTemplateContext();

    // Add event listener for design health analysis
    document.getElementById('analyzeHealthBtn').addEventListener('click', analyzeDesignHealth);

    console.log('🎯 Enhanced Figma Plugin with Context Preview loaded successfully');
  </script>
</body>
</html>