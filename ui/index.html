<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enhanced Figma Plugin</title>
  <style>
    /* Modern CSS Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      line-height: 1.5;
      background: #f8fafc;
      color: #1a202c;
      padding: 20px;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    .content {
      padding: 24px;
    }

    /* Enhanced Context Preview Styles */
    .context-preview-container {
      margin: 20px 0;
    }

    .context-preview {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .context-preview-header {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
    }

    .context-preview-title {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .context-preview-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 10px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .context-preview-subtitle {
      margin: 0;
      font-size: 13px;
      color: #64748b;
    }

    .context-preview-body {
      padding: 20px;
    }

    .context-sections {
      display: grid;
      gap: 16px;
      margin-bottom: 24px;
    }

    .context-section {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .context-section:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .context-section.has-content {
      border-color: #10b981;
      background: #f0fdf4;
    }

    .section-header {
      background: #f8fafc;
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .section-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .status-indicator {
      font-size: 8px;
    }

    .status-text {
      color: #6b7280;
    }

    .section-content {
      padding: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
    }

    .empty-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 8px;
    }

    .empty-state p {
      margin: 0 0 4px 0;
      font-size: 14px;
      color: #6b7280;
    }

    .empty-state small {
      font-size: 12px;
      color: #9ca3af;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    #techStackInput {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    #techStackInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select, input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-secondary {
      background: #6b7280;
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 8px;
    }

    /* Status and Results */
    .status-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .confidence-score {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .confidence-high { background: #dcfce7; color: #166534; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }

    .suggestions {
      margin-top: 12px;
    }

    .suggestion-pill {
      display: inline-block;
      padding: 4px 12px;
      margin: 2px 4px 2px 0;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-pill:hover {
      background: #c7d2fe;
    }

    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .suggestions-grid .suggestion-pill {
      padding: 8px 12px;
      text-align: center;
      font-weight: 500;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
    }

    /* Color-coded tech stack pills */
    .suggestion-pill[data-type="react"] { background: linear-gradient(135deg, #61DAFB, #21A1C4); color: white; }
    .suggestion-pill[data-type="vue"] { background: linear-gradient(135deg, #4FC08D, #42B883); color: white; }
    .suggestion-pill[data-type="angular"] { background: linear-gradient(135deg, #DD0031, #C73225); color: white; }
    .suggestion-pill[data-type="next"] { background: linear-gradient(135deg, #000000, #333333); color: white; }
    .suggestion-pill[data-type="mern"] { background: linear-gradient(135deg, #3C873A, #68A063); color: white; }
    .suggestion-pill[data-type="mean"] { background: linear-gradient(135deg, #FFA500, #FF8C00); color: white; }
    .suggestion-pill[data-type="python"] { background: linear-gradient(135deg, #3776AB, #FFD43B); color: white; }
    .suggestion-pill[data-type="java"] { background: linear-gradient(135deg, #ED8B00, #EA7600); color: white; }
    .suggestion-pill[data-type="dotnet"] { background: linear-gradient(135deg, #512BD4, #9A4993); color: white; }
    .suggestion-pill[data-type="aem"] { background: linear-gradient(135deg, #FA0F00, #C20E00); color: white; }
    .suggestion-pill[data-type="design"] { background: linear-gradient(135deg, #9333EA, #7C3AED); color: white; }

    #results {
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    #results.hidden {
      display: none;
    }

    #results textarea {
      width: 100%;
      min-height: 300px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      background: white;
      resize: vertical;
    }

    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 6px;
    }

    .fallback-notice {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      color: #9a3412;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .copy-success {
      color: #059669;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 6px;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #6b7280;
      font-size: 14px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Hidden class */
    .hidden {
      display: none;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 16px;
    }

    .tab-btn {
      padding: 12px 20px;
      border: none;
      background: #f8fafc;
      color: #64748b;
      border-radius: 8px 8px 0 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
    }

    .tab-btn:hover:not(.active) {
      background: #e2e8f0;
      color: #374151;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Design Health Styles */
    .health-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .metric-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .metric-card h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #374151;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #667eea;
      margin: 8px 0;
    }

    .metric-card p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }

    .health-analysis {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }

    .health-analysis h3 {
      margin: 0 0 16px 0;
      color: #374151;
    }

    .analysis-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      font-size: 14px;
    }

    .status-good {
      color: #10b981;
    }

    .status-warning {
      color: #f59e0b;
    }

    .status-error {
      color: #ef4444;
    }

    /* Template Preview Styles */
    .template-preview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
    }

    .template-preview h4 {
      margin: 0 0 12px 0;
      color: #374151;
      font-size: 14px;
    }

    .template-content {
      font-size: 13px;
      line-height: 1.5;
    }

    #context-preview-wrapper {
      margin: 24px 0;
      transition: all 0.3s ease;
    }

    .context-success-info {
      animation: slideInFadeIn 0.5s ease-out;
    }

    @keyframes slideInFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Action buttons for context preview */
    .context-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .action-btn.primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .action-btn.primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .action-btn.secondary {
      background: #f8fafc;
      color: #374151;
      border: 1px solid #e2e8f0;
    }

    .action-btn.secondary:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    /* Context metrics styles */
    .context-metrics {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .metrics-title {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .metric-item {
      text-align: center;
    }

    .metric-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .metric-detail {
      font-size: 10px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="header">
      <h1>🎨 Enhanced Figma Plugin</h1>
      <div class="subtitle">AI-powered ticket generation with design intelligence preview</div>
    </div>

    <div class="content">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="generator">🎫 Smart Generator</button>
        <button class="tab-btn" data-tab="health">📊 Design Health</button>
      </div>

      <!-- Generator Tab -->
      <div class="tab-content active" id="generator-tab">
      <div class="panel-header">
        <h2 class="panel-title">🎫 Enhanced Document Generator</h2>
        <p class="panel-subtitle">See exactly what context is sent to AI before generation</p>
      </div>

      <div class="form-group">
        <label for="techStackInput">Tech Stack Description</label>
        <textarea 
          id="techStackInput" 
          placeholder="Describe your tech stack, frameworks, libraries, and architecture. Be specific about versions, patterns, and tools you're using.

Examples:
• React 18 with TypeScript, Material-UI v5, React Query for state management
• Vue 3 with Composition API, Pinia for state, Vite build tool
• Next.js 13 with App Router, TailwindCSS, Prisma ORM, PostgreSQL
• Angular 15 with NgRx, Angular Material, RxJS patterns"></textarea>
        
        <!-- Parse Tech Button -->
        <button id="parseTechBtn" class="button-secondary" type="button">🔍 Parse Tech Stack</button>
      </div>

      <!-- Popular Combinations Section -->
      <div class="form-group">
        <label>💡 Popular Tech Stack Combinations</label>
        <div class="suggestions-grid">
          <div class="suggestion-pill" data-type="react" onclick="selectTechStack(this)">
            React + TypeScript + Material-UI
          </div>
          <div class="suggestion-pill" data-type="vue" onclick="selectTechStack(this)">
            Vue 3 + Composition API + Pinia
          </div>
          <div class="suggestion-pill" data-type="angular" onclick="selectTechStack(this)">
            Angular 15 + NgRx + Material
          </div>
          <div class="suggestion-pill" data-type="next" onclick="selectTechStack(this)">
            Next.js + TailwindCSS + Prisma
          </div>
          <div class="suggestion-pill" data-type="aem" onclick="selectTechStack(this)">
            AEM 6.5 + HTL + Sling + OSGi
          </div>
          <div class="suggestion-pill" data-type="design" onclick="selectTechStack(this)">
            Figma + Design System + Tokens
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="documentType">Document Type</label>
        <select id="documentType" onchange="updateTemplateContext()">
          <option value="jira">Jira Ticket</option>
          <option value="confluence">Confluence Page</option>
          <option value="wiki">Wiki Documentation</option>
          <option value="agent">Agent Task</option>
          <option value="code">Code Generation</option>
        </select>
      </div>

      <!-- Context Template Display -->
      <div class="template-preview" id="templatePreview">
        <h4>📝 LLM Context Template</h4>
        <div class="template-content" id="templateContent">
          <!-- Will be populated based on document type -->
        </div>
      </div>

      <div class="status-section" style="display: none;">
        <div class="confidence-indicator">
          <span>📊 Confidence:</span>
          <span class="confidence-score confidence-high">85%</span>
        </div>
        <div class="suggestions">
          <span class="suggestion-pill">Add testing framework</span>
          <span class="suggestion-pill">Specify API architecture</span>
          <span class="suggestion-pill">Include deployment strategy</span>
        </div>
      </div>

      <!-- MCP Server Status Section -->
      <div class="context-preview">
        <div class="context-preview-header">
          <h3 class="context-preview-title">
            🔌 MCP Server Status
            <span id="server-status-badge" class="context-preview-badge">Checking...</span>
          </h3>
          <p class="context-preview-subtitle">Model Context Protocol server connection</p>
        </div>
        <div class="context-preview-body">
          <div class="context-section" id="server-status-section">
            <div class="section-header">
              <h4 class="section-title">🚀 Server Connection</h4>
              <div class="section-status" id="server-connection-status">
                <span class="status-indicator">⚪</span>
                <span class="status-text">Connecting...</span>
              </div>
            </div>
            <div class="section-content" id="server-connection-content">
              <div class="empty-state">
                <span class="empty-icon">🔌</span>
                <p>Checking MCP server connection...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    <!-- Enhanced Context Preview Section -->
      <div id="context-preview-wrapper" class="hidden">
        <div class="context-preview">
          <div class="context-preview-header">
            <h3 class="context-preview-title">
              🔍 Context Preview
              <span class="context-preview-badge">Review Before Sending</span>
            </h3>
            <p class="context-preview-subtitle">Review what will be sent to the AI for processing</p>
          </div>

          <div class="context-preview-body">
            <div class="context-sections">
              <!-- Tech Stack Section -->
              <div class="context-section" data-section="techstack">
                <div class="section-header">
                  <h4 class="section-title">🛠️ Tech Stack Analysis</h4>
                  <div class="section-status" id="techstack-status">
                    <span class="status-indicator">⚪</span>
                    <span class="status-text">Not analyzed</span>
                  </div>
                </div>
                <div class="section-content" id="techstack-content">
                  <div class="empty-state">
                    <span class="empty-icon">📝</span>
                    <p>Enter your tech stack description to see analysis here</p>
                  </div>
                </div>
              </div>

              <!-- Screenshot Section -->
              <div class="context-section" data-section="screenshot">
                <div class="section-header">
                  <h4 class="section-title">📸 Visual Context</h4>
                  <div class="section-status" id="screenshot-status">
                    <span class="status-indicator">⚪</span>
                    <span class="status-text">No screenshot</span>
                  </div>
                </div>
                <div class="section-content" id="screenshot-content">
                  <div class="empty-state">
                    <span class="empty-icon">🖼️</span>
                    <p>No visual context available</p>
                    <small>Screenshots help AI understand design layouts and requirements</small>
                  </div>
                </div>
              </div>

              <!-- Figma Context Section -->
              <div class="context-section" data-section="figma">
                <div class="section-header">
                  <h4 class="section-title">🎨 Figma Selection</h4>
                  <div class="section-status" id="figma-status">
                    <span class="status-indicator">⚪</span>
                    <span class="status-text">No selection</span>
                  </div>
                </div>
                <div class="section-content" id="figma-content">
                  <div class="empty-state">
                    <span class="empty-icon">🎯</span>
                    <p>Select elements in Figma to see context here</p>
                    <small>Frame data, components, and design details</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Context Quality Metrics -->
            <div class="context-metrics">
              <h4 class="metrics-title">📊 Context Quality Metrics</h4>
              <div class="metrics-grid">
                <div class="metric-item">
                  <div class="metric-label">Context Richness</div>
                  <div class="metric-value" id="richness-score">0%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Confidence</div>
                  <div class="metric-value" id="confidence-score">0%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Selection Count</div>
                  <div class="metric-value" id="selection-count">0</div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="context-actions">
              <button class="action-btn secondary" id="edit-context-btn">
                ✏️ Edit Context
              </button>
              <button class="action-btn primary" id="submit-context-btn" disabled>
                🚀 Generate with Context
              </button>
            </div>
          </div>
        </div>
      </div>

      <button id="generate" class="button">🔍 Preview Context & Generate</button>

      <div id="results" class="hidden">
        <label>Generated Content</label>
        <textarea id="generatedContent" readonly></textarea>
        <button id="copyBtn" class="copy-btn button button-secondary">📋 Copy to Clipboard</button>
      </div>
      </div>

      <!-- Design Health Tab -->
      <div class="tab-content" id="health-tab">
        <div class="panel-header">
          <h2 class="panel-title">📊 Design System Health</h2>
          <p class="panel-subtitle">Analyze design consistency and component usage patterns</p>
        </div>

        <div class="health-metrics">
          <div class="metric-card">
            <h3>🎨 Component Coverage</h3>
            <div class="metric-value">85%</div>
            <p>Design system adoption rate</p>
          </div>
          <div class="metric-card">
            <h3>🔄 Consistency Score</h3>
            <div class="metric-value">92%</div>
            <p>Cross-platform alignment</p>
          </div>
          <div class="metric-card">
            <h3>🚀 Performance</h3>
            <div class="metric-value">A+</div>
            <p>Asset optimization grade</p>
          </div>
        </div>

        <div class="health-analysis">
          <h3>🔍 Analysis Results</h3>
          <div class="analysis-item">
            <span class="status-good">✅</span>
            <strong>Color Palette:</strong> All colors match design tokens
          </div>
          <div class="analysis-item">
            <span class="status-warning">⚠️</span>
            <strong>Typography:</strong> 3 inconsistent font sizes detected
          </div>
          <div class="analysis-item">
            <span class="status-good">✅</span>
            <strong>Spacing:</strong> Grid system properly implemented
          </div>
        </div>

        <button class="button" id="analyzeHealthBtn">🔍 Analyze Current Selection</button>
      </div>
    </div>
  </div>

  <script>
    const techStackInput = document.getElementById('techStackInput');
    const documentTypeSelect = document.getElementById('documentType');
    const generateBtn = document.getElementById('generate');
    const resultsDiv = document.getElementById('results');
    const resultsTextarea = document.getElementById('generatedContent');
    const copyBtn = document.getElementById('copyBtn');
    const statusSection = document.querySelector('.status-section');

    // Context preview elements
    const contextPreviewWrapper = document.getElementById('context-preview-wrapper');
    const submitContextBtn = document.getElementById('submit-context-btn');
    const editContextBtn = document.getElementById('edit-context-btn');

    // Figma context variables
    let figmaContext = null;
    let frameData = null;
    let figmaFileInfo = null;
    let pendingContextData = null;

    // Document-specific LLM templates
    const documentTemplates = {
      jira: {
        title: "Jira Ticket Template",
        context: [
          "Focus on: User story, acceptance criteria, design requirements",
          "Include: Visual description, component specifications, interaction details",
          "Exclude: Technical implementation details unless specifically requested",
          "Format: Jira ticket with clear user story format"
        ],
        prompt: "Create a detailed Jira ticket based on the selected Figma design. Focus on user experience requirements and design specifications rather than technical implementation."
      },
      confluence: {
        title: "Confluence Documentation Template", 
        context: [
          "Focus on: Design rationale, component documentation, usage guidelines",
          "Include: Visual examples, design patterns, accessibility considerations",
          "Exclude: Code implementation details",
          "Format: Structured documentation with clear sections"
        ],
        prompt: "Create comprehensive Confluence documentation for the selected design. Focus on design decisions, component usage, and guidelines for the design system."
      },
      wiki: {
        title: "Wiki Documentation Template",
        context: [
          "Focus on: Knowledge sharing, design patterns, best practices",
          "Include: Visual design principles, component relationships, design rationale", 
          "Exclude: Implementation specifics",
          "Format: Educational wiki content with examples"
        ],
        prompt: "Create wiki documentation that explains the design patterns and principles shown in the selected Figma elements. Focus on educational content for design teams."
      },
      agent: {
        title: "Agent Task Template",
        context: [
          "Focus on: Actionable tasks, design requirements, deliverables",
          "Include: Specific design tasks, review criteria, expected outcomes",
          "Exclude: Low-level implementation details",
          "Format: Clear task breakdown with success criteria"
        ],
        prompt: "Create specific agent tasks based on the selected design. Focus on actionable design work and clear deliverables."
      },
      code: {
        title: "Code Generation Template",
        context: [
          "Focus on: Technical implementation, component structure, styling details",
          "Include: Technology stack, coding patterns, responsive behavior",
          "Include: Tech stack analysis and implementation approach",
          "Format: Technical specifications for development"
        ],
        prompt: "Create detailed technical specifications for implementing the selected design. Include technology recommendations and coding approach."
      }
    };

    // Update template preview based on document type
    function updateTemplateContext() {
      const documentType = document.getElementById('documentType').value;
      const template = documentTemplates[documentType];
      const previewDiv = document.getElementById('templateContent');
      
      if (template && previewDiv) {
        previewDiv.innerHTML = `
          <div style="background: #f0f9ff; border: 1px solid #0284c7; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
            <strong style="color: #0284c7;">${template.title}</strong>
          </div>
          <div style="font-size: 13px; line-height: 1.4;">
            ${template.context.map(item => `
              <div style="margin-bottom: 4px; padding: 4px 0;">
                <span style="color: #059669;">•</span> ${item}
              </div>
            `).join('')}
          </div>
          <div style="background: #fefce8; border: 1px solid #ca8a04; border-radius: 4px; padding: 8px; margin-top: 8px; font-size: 12px; font-style: italic; color: #a16207;">
            ${template.prompt}
          </div>
        `;
      }
    }
    // Tech Stack Suggestions Database
    const techStackTemplates = {
      react: "React 18 with TypeScript, Material-UI v5, React Query for state management, Jest for testing, Webpack bundling",
      vue: "Vue 3 with Composition API, Pinia for state management, Vite build tool, Vitest for unit testing, Vue Router",
      angular: "Angular 15 with NgRx for state management, Angular Material UI components, RxJS for reactive programming, Jasmine/Karma testing",
      next: "Next.js 13 with App Router, TailwindCSS for styling, Prisma ORM, PostgreSQL database, Vercel deployment",
      aem: "AEM 6.5 with HTL (HTML Template Language), Apache Sling framework, OSGi bundles, JCR repository, Touch UI components",
      design: "Figma design system with design tokens, component library, style guide, accessibility standards, responsive breakpoints"
    };

    // MCP Server Configuration
    const MCP_SERVER_URL = 'http://localhost:3000';
    let mcpServerStatus = {
      connected: false,
      tools: [],
      version: null,
      lastCheck: null
    };

    // Check MCP Server Status
    async function checkMCPServerStatus() {
      try {
        console.log('🔌 Checking MCP server status...');
        const response = await fetch(MCP_SERVER_URL, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const serverInfo = await response.json();
          mcpServerStatus = {
            connected: true,
            tools: serverInfo.tools || [],
            version: serverInfo.version,
            lastCheck: new Date()
          };
          
          console.log('✅ MCP server connected:', serverInfo);
          updateServerStatusUI(true, serverInfo);
        } else {
          throw new Error(`Server responded with ${response.status}`);
        }
      } catch (error) {
        console.error('❌ MCP server connection failed:', error);
        mcpServerStatus = {
          connected: false,
          tools: [],
          version: null,
          lastCheck: new Date()
        };
        updateServerStatusUI(false, { error: error.message });
      }
    }

    // Update Server Status UI
    function updateServerStatusUI(connected, info) {
      const badge = document.getElementById('server-status-badge');
      const section = document.getElementById('server-status-section');
      const status = document.getElementById('server-connection-status');
      const content = document.getElementById('server-connection-content');

      if (connected) {
        badge.textContent = 'Connected';
        badge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        
        section.classList.add('has-content');
        
        status.innerHTML = `
          <span class="status-indicator">✅</span>
          <span class="status-text">Connected (v${info.version})</span>
        `;

        content.innerHTML = `
          <div style="font-size: 13px;">
            <div><strong>Server URL:</strong> ${MCP_SERVER_URL}</div>
            <div><strong>Available Tools:</strong> ${info.tools.length}</div>
            <div style="margin-top: 8px;">
              ${info.tools.map(tool => 
                `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px 4px 2px 0;">${tool}</span>`
              ).join('')}
            </div>
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 8px 12px; font-size: 12px; color: #166534; margin-top: 8px;">
              🚀 MCP Server Ready - AI-powered design analysis available
            </div>
          </div>
        `;
      } else {
        badge.textContent = 'Disconnected';
        badge.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        
        section.classList.remove('has-content');
        
        status.innerHTML = `
          <span class="status-indicator">❌</span>
          <span class="status-text">Connection Failed</span>
        `;

        content.innerHTML = `
          <div style="font-size: 13px; color: #dc2626;">
            <div><strong>Error:</strong> ${info.error}</div>
            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
              Make sure the MCP server is running:<br>
              <code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px;">cd mcp-server && npm start</code>
            </div>
          </div>
        `;
      }
    }

    // Call MCP Server Tool
    async function callMCPTool(toolName, params) {
      if (!mcpServerStatus.connected) {
        throw new Error('MCP server not connected');
      }

      console.log(`🔧 Calling MCP tool: ${toolName}`, params);

      try {
        const response = await fetch(MCP_SERVER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            method: toolName,
            params: params
          })
        });

        if (!response.ok) {
          throw new Error(`MCP call failed: ${response.status}`);
        }

        const result = await response.json();
        console.log(`✅ MCP tool ${toolName} completed:`, result);
        return result;

      } catch (error) {
        console.error(`❌ MCP tool ${toolName} failed:`, error);
        throw error;
      }
    }

    // Initialize Figma plugin communication
    function initializeFigmaIntegration() {
      // Check MCP server status first
      checkMCPServerStatus();
      
      // Set up periodic server status checks
      setInterval(checkMCPServerStatus, 30000); // Check every 30 seconds

      // Listen for messages from Figma plugin code
        window.addEventListener('message', (event) => {
          console.log('🎨 Received message:', event.data);
          if (event.data.pluginMessage) {
            const msg = event.data.pluginMessage;
            switch (msg.type) {
              case 'selection-context':
                handleSelectionContext(msg.data);
                break;
              case 'file-context':
                handleFileContext(msg);
                break;
              case 'screenshot-captured':
                // Use real screenshot if available, fallback to mock
                let screenshotData = msg.screenshot;
                if (!screenshotData || !screenshotData.dataUrl) {
                  screenshotData = createMockScreenshot();
                  screenshotData.fallback = true;
                } else {
                  screenshotData.fallback = false;
                }
                updateScreenshotSection(screenshotData);
                break;
              case 'error':
                console.error('Figma error:', msg.message);
                break;
              default:
                console.log('Unhandled message type:', msg.type);
            }
          }
        });
      
      // Request initial context from Figma
      parent.postMessage({ pluginMessage: { type: 'get-context' } }, '*');
    }

    // Handle selection context from Figma
    function handleSelectionContext(selectionData) {
      console.log('📋 Received selection context:', selectionData);
      
      if (selectionData && selectionData.length > 0) {
        // Update global context
        frameData = selectionData;
        
        // Update UI to show selection data
        const figmaSection = document.querySelector('[data-section="figma"]');
        if (figmaSection) {
          figmaSection.classList.add('has-content');
          
          const status = figmaSection.querySelector('#figma-status');
          const content = figmaSection.querySelector('#figma-content');
          
          if (status && content) {
            status.innerHTML = `
              <span class="status-indicator">🎨</span>
              <span class="status-text">${selectionData.length} items selected</span>
            `;
            
            content.innerHTML = `
              <div style="font-size: 13px;">
                ${selectionData.map(item => `
                  <div style="margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;">
                    <strong>${item.name}</strong> (${item.type})<br>
                    <small style="color: #6b7280;">${item.dimensions.width}×${item.dimensions.height}px</small>
                  </div>
                `).join('')}
              </div>
            `;
          }
        }
        
        // Update metrics
        updateContextMetrics({
          figmaContext: {
            hasSelection: true,
            selectionCount: selectionData.length
          }
        });
      }
    }

    // Handle file context from Figma
    function handleFileContext(fileData) {
      console.log('📁 Received file context:', fileData);
      figmaFileInfo = {
        fileName: fileData.fileName || 'Untitled',
        fileKey: fileData.fileKey
      };
    }

    // Select tech stack from suggestions
    function selectTechStack(element) {
      const techType = element.getAttribute('data-type');
      const template = techStackTemplates[techType];
      
      if (template) {
        techStackInput.value = template;
        
        // Visual feedback
        element.style.transform = 'scale(0.95)';
        setTimeout(() => {
          element.style.transform = 'scale(1)';
        }, 150);
        
        // Trigger parsing and confidence update
        const parsed = parseTechStack(template);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
      }
    }

    // Parse tech stack button functionality
    function parseTechStackManually() {
      const techStackDesc = techStackInput.value.trim();
      
      if (!techStackDesc) {
        showError('Please enter a tech stack description to parse.');
        return;
      }
      
      const parsed = parseTechStack(techStackDesc);
      updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
    }

    // Tech stack parsing and confidence calculation
    function parseTechStack(description) {
      const frameworks = ['react', 'vue', 'angular', 'svelte', 'next.js', 'nuxt', 'gatsby'];
      const languages = ['typescript', 'javascript', 'python', 'java', 'c#', 'go', 'rust'];
      const tools = ['webpack', 'vite', 'parcel', 'rollup', 'esbuild'];
      
      const lowerDesc = description.toLowerCase();
      
      const detected = {
        frameworks: frameworks.filter(f => lowerDesc.includes(f)),
        languages: languages.filter(l => lowerDesc.includes(l)),
        tools: tools.filter(t => lowerDesc.includes(t))
      };
      
      // Calculate confidence based on specificity
      let confidence = 50;
      if (detected.frameworks.length > 0) confidence += 20;
      if (detected.languages.length > 0) confidence += 15;
      if (detected.tools.length > 0) confidence += 10;
      if (lowerDesc.includes('version') || /\d+/.test(lowerDesc)) confidence += 10;
      
      confidence = Math.min(confidence, 95);
      
      // Generate suggestions
      const suggestions = [];
      if (detected.frameworks.length > 0) {
        detected.frameworks.forEach(f => suggestions.push(f.charAt(0).toUpperCase() + f.slice(1)));
      }
      if (suggestions.length === 0) {
        suggestions.push('Add specific versions', 'Include testing framework', 'Mention state management');
      }
      
      return { detected, confidence, suggestions };
    }

    // Update confidence indicator
    function updateConfidenceIndicator(confidence, suggestions = []) {
      const indicator = statusSection.querySelector('.confidence-indicator');
      const scoreEl = statusSection.querySelector('.confidence-score');
      const suggestionsEl = statusSection.querySelector('.suggestions');
      
      scoreEl.textContent = `${confidence}%`;
      scoreEl.className = `confidence-score ${
        confidence >= 80 ? 'confidence-high' : 
        confidence >= 60 ? 'confidence-medium' : 'confidence-low'
      }`;
      
      suggestionsEl.innerHTML = suggestions.map(s => 
        `<span class="suggestion-pill">${s}</span>`
      ).join('');
      
      statusSection.style.display = 'flex';
    }

    // Show context preview
    function showContextPreview(contextData) {
      // Update tech stack section
      if (contextData.techStack) {
        updateTechStackSection(contextData.techStack);
      }

      // Update Figma section
      if (contextData.figmaContext) {
        updateFigmaSection(contextData.figmaContext);
      }

      // Update screenshot section
      if (contextData.screenshot) {
        updateScreenshotSection(contextData.screenshot);
      }

      // Update metrics
      updateContextMetrics(contextData);

      // Show the preview section
      contextPreviewWrapper.classList.remove('hidden');
      
      // Scroll to preview
      contextPreviewWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Update the main generate button
      generateBtn.innerHTML = '👀 Context Preview Active';
      generateBtn.disabled = true;
      
      // Store context for actual generation
      pendingContextData = contextData;

      // Enable submit button
      submitContextBtn.disabled = false;
    }

    function updateTechStackSection(techStackData) {
      const section = document.querySelector('[data-section="techstack"]');
      const status = section.querySelector('#techstack-status');
      const content = section.querySelector('#techstack-content');

      section.classList.add('has-content');
      
      status.innerHTML = `
        <span class="status-indicator">✅</span>
        <span class="status-text">Analyzed (${techStackData.confidence}% confidence)</span>
      `;

      content.innerHTML = `
        <div style="font-size: 13px; line-height: 1.5;">
          <div style="margin-bottom: 12px;">
            <strong>Detected Technologies:</strong><br>
            ${techStackData.detected.frameworks.map(f => 
              `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px 4px 2px 0;">${f}</span>`
            ).join('')}
            ${techStackData.detected.languages.map(l => 
              `<span style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px 4px 2px 0;">${l}</span>`
            ).join('')}
          </div>
          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 8px 12px; font-size: 12px; color: #166534;">
            📊 Analysis Confidence: ${techStackData.confidence}%
          </div>
        </div>
      `;
    }

    function updateFigmaSection(figmaContextData) {
      const section = document.querySelector('[data-section="figma"]');
      const status = section.querySelector('#figma-status');
      const content = section.querySelector('#figma-content');

      if (figmaContextData && figmaContextData.hasSelection) {
        section.classList.add('has-content');
        
        status.innerHTML = `
          <span class="status-indicator">🎨</span>
          <span class="status-text">${figmaContextData.selectionCount} items selected</span>
        `;

        content.innerHTML = `
          <div style="font-size: 13px;">
            <div><strong>File:</strong> ${figmaContextData.fileName || 'Untitled'}</div>
            <div><strong>Selection:</strong> ${figmaContextData.selectionCount} elements</div>
            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
              Live Figma selection data captured
            </div>
          </div>
        `;
      }
    }

    function updateScreenshotSection(screenshotData) {
      const section = document.querySelector('[data-section="screenshot"]');
      const status = section.querySelector('#screenshot-status');
      const content = section.querySelector('#screenshot-content');

      section.classList.add('has-content');
      
      status.innerHTML = `
        <span class="status-indicator">📸</span>
        <span class="status-text">Captured (${screenshotData.size || 'Unknown size'})</span>
        ${screenshotData.fallback ? '<span style="background: #fbbf24; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 8px;">MOCK</span>' : '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 8px;">LIVE</span>'}
      `;

      content.innerHTML = `
        <div style="text-align: center;">
          <img src="${screenshotData.dataUrl}" alt="Design Screenshot" style="max-width: 100%; max-height: 200px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
          <div style="font-size: 12px; color: #6b7280;">
            ${screenshotData.width}×${screenshotData.height}px • ${screenshotData.size || 'Unknown size'}
            ${screenshotData.nodeName ? `<br><strong style="color: #4b5563;">${screenshotData.nodeName}</strong> (${screenshotData.nodeType || 'Node'})` : ''}
            ${screenshotData.fallback ? '<br><small style="color: #94a3b8;">Mock context for testing</small>' : '<br><small style="color: #10b981;">Live Figma capture with enhanced export</small>'}
          </div>
        </div>
      `;
    }

    function updateContextMetrics(contextData) {
      let richness = 0;
      let confidence = 0;
      let selectionCount = 0;

      if (contextData.techStack) {
        richness += 40;
        confidence = contextData.techStack.confidence || 0;
      }
      if (contextData.screenshot) richness += 30;
      if (contextData.figmaContext?.hasSelection) {
        richness += 30;
        selectionCount = contextData.figmaContext.selectionCount || 0;
      }

      document.getElementById('richness-score').textContent = `${Math.min(richness, 100)}%`;
      document.getElementById('confidence-score').textContent = `${confidence}%`;
      document.getElementById('selection-count').textContent = selectionCount;
    }

    // Generate content - enhanced with context preview
    async function generateContent() {
      const techStackDesc = techStackInput.value.trim();
      const documentType = documentTypeSelect.value;
      
      if (!techStackDesc) {
        showError('Please describe your tech stack to generate a document.');
        return;
      }
      
      // Step 1: Collect context and show preview
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="spinner"></div> Collecting Context...';
      
      try {
        // First, request fresh context from Figma
        parent.postMessage({ pluginMessage: { type: 'get-context' } }, '*');
        
        // Wait a moment for the context to be received
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Parse tech stack
        const parsed = parseTechStack(techStackDesc);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
        
        // Create mock screenshot
        const screenshotData = createMockScreenshot();
        
        // Prepare comprehensive context data
        const contextData = {
          techStack: {
            ...parsed,
            description: techStackDesc
          },
          screenshot: screenshotData,
          figmaContext: {
            hasSelection: frameData && frameData.length > 0,
            selectionCount: frameData ? frameData.length : 0,
            fileName: figmaFileInfo?.fileName || 'Test Design File'
          },
          documentType: documentType
        };
        
        // Show context preview
        showContextPreview(contextData);
        
      } catch (error) {
        console.error('Context collection failed:', error);
        showError('Failed to collect context. Please try again.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '🔍 Preview Context & Generate';
      }
    }

    // Function called when user submits from context preview
    async function proceedWithGeneration(contextData) {
      const documentType = contextData.documentType;
      
      // Show loading state
      submitContextBtn.disabled = true;
      submitContextBtn.innerHTML = '<div class="spinner"></div> Generating with MCP...';
      
      resultsDiv.classList.remove('hidden');
      resultsTextarea.value = 'Connecting to MCP server for AI-powered generation...';
      
      try {
        // Check MCP server connection first
        if (!mcpServerStatus.connected) {
          await checkMCPServerStatus();
          if (!mcpServerStatus.connected) {
            throw new Error('MCP server is not available. Please start the server first.');
          }
        }

        // Prepare MCP parameters
        const mcpParams = {
          figmaUrl: `https://figma.com/file/${contextData.figmaContext?.fileName || 'current-file'}`,
          techStack: contextData.techStack.description,
          documentType: documentType,
          visualContext: contextData.screenshot ? {
            hasScreenshot: true,
            description: `Screenshot of ${contextData.figmaContext?.selectionCount || 0} selected elements`
          } : null,
          selectionCount: contextData.figmaContext?.selectionCount || 0
        };

        console.log('🎯 Calling MCP generate_enhanced_ticket tool...');
        resultsTextarea.value = 'Generating content using AI-powered MCP server...';

        // Call MCP server to generate enhanced ticket
        const result = await callMCPTool('generate_enhanced_ticket', mcpParams);

        // Extract the generated content
        let generatedContent = '';
        if (result.content && Array.isArray(result.content)) {
          generatedContent = result.content
            .filter(item => item.type === 'text')
            .map(item => item.text)
            .join('\n\n');
        } else if (result.text) {
          generatedContent = result.text;
        } else {
          generatedContent = JSON.stringify(result, null, 2);
        }

        // Display the generated content
        resultsTextarea.value = generatedContent;
        
        // Show enhanced context info
        const contextInfo = document.createElement('div');
        contextInfo.className = 'context-success-info';
        contextInfo.innerHTML = `
          <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
            <strong>✅ Generated with MCP Server:</strong><br>
            • AI-Powered Analysis via MCP Protocol<br>
            • Tech Stack Analysis (${contextData.techStack.confidence}% confidence)<br>
            ${contextData.figmaContext?.hasSelection ? `• Figma Selection (${contextData.figmaContext.selectionCount} items)<br>` : ''}
            ${contextData.screenshot ? '• Visual Design Screenshot<br>' : ''}
            • Server: ${MCP_SERVER_URL}<br>
            • Tools Available: ${mcpServerStatus.tools.length}
          </div>
        `;
        resultsDiv.insertBefore(contextInfo, resultsDiv.firstChild.nextSibling);
        
        setTimeout(() => contextInfo.remove(), 15000);
        
      } catch (error) {
        console.error('MCP generation failed:', error);
        resultsTextarea.value = `# ❌ Generation Failed

**Error**: ${error.message}

## Troubleshooting:

1. **Check MCP Server Status**: Make sure the server is running
   \`\`\`bash
   cd mcp-server
   npm start
   \`\`\`

2. **Server URL**: ${MCP_SERVER_URL}

3. **Available Tools**: ${mcpServerStatus.tools.join(', ') || 'None - server disconnected'}

4. **Last Check**: ${mcpServerStatus.lastCheck ? new Date(mcpServerStatus.lastCheck).toLocaleTimeString() : 'Never'}

## Fallback Content:

Based on your input:
- **Tech Stack**: ${contextData.techStack.description}
- **Document Type**: ${documentType}
- **Selection**: ${contextData.figmaContext?.selectionCount || 0} items

Please fix the MCP server connection and try again.`;
        
        showError(`MCP Server Error: ${error.message}`);
      } finally {
        submitContextBtn.disabled = false;
        submitContextBtn.innerHTML = '🚀 Generate with MCP';
      }
    }

    // Helper function to create mock screenshot
    function createMockScreenshot() {
      const firstNode = frameData && frameData.length > 0 ? frameData[0] : null;
      const width = firstNode?.dimensions?.width || 400;
      const height = firstNode?.dimensions?.height || 200;
      // Sanitize text content to avoid btoa encoding issues
      const nodeName = (firstNode?.name || 'Enhanced Figma Context').replace(/[^\x00-\x7F]/g, '?');
      const nodeType = (firstNode?.type || 'FRAME').replace(/[^\x00-\x7F]/g, '?');
      
      const svgContent = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
        <rect width="${width}" height="${height}" fill="#f8fafc"/>
        <rect x="20" y="20" width="${width-40}" height="40" rx="8" fill="#667eea"/>
        <text x="${width/2}" y="45" text-anchor="middle" fill="white" font-family="Arial" font-size="16">${nodeName}</text>
        <text x="${width/2}" y="80" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="12">${nodeType} • Live Figma Context</text>
        <text x="${width/2}" y="100" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="10">Enhanced with design intelligence</text>
        ${firstNode ? `<rect x="20" y="120" width="${Math.min(width-40, 120)}" height="30" rx="4" fill="#10b981"/>
        <text x="${20 + Math.min(width-40, 120)/2}" y="140" text-anchor="middle" fill="white" font-family="Arial" font-size="12">Selected</text>` : ''}
      </svg>`;
      
      // Use encodeURIComponent for safer encoding
      const encodedSvg = encodeURIComponent(svgContent);
      
      return {
        dataUrl: `data:image/svg+xml,${encodedSvg}`,
        width: width,
        height: height,
        size: `${Math.round((width * height) / 1000)} KB`,
        nodeName: firstNode?.name || 'Enhanced Figma Context',
        nodeType: firstNode?.type || 'FRAME',
        fallback: true
      };
    }

    // Show error message
    function showError(message) {
      // Remove existing error messages
      document.querySelectorAll('.error-message').forEach(el => el.remove());
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      techStackInput.parentNode.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Copy to clipboard
    function copyToClipboard() {
      resultsTextarea.select();
      resultsTextarea.setSelectionRange(0, 99999);
      
      try {
        document.execCommand('copy');
        copyBtn.textContent = '✅ Copied!';
        setTimeout(() => {
          copyBtn.textContent = '📋 Copy to Clipboard';
        }, 2000);
      } catch (err) {
        console.error('Copy failed:', err);
        copyBtn.textContent = '❌ Copy failed';
        setTimeout(() => {
          copyBtn.textContent = '📋 Copy to Clipboard';
        }, 2000);
      }
    }

    // Event listeners
    generateBtn.addEventListener('click', generateContent);
    copyBtn.addEventListener('click', copyToClipboard);
    document.getElementById('parseTechBtn').addEventListener('click', parseTechStackManually);

    // Context preview event listeners
    submitContextBtn.addEventListener('click', () => {
      if (pendingContextData) {
        proceedWithGeneration(pendingContextData);
      }
    });

    editContextBtn.addEventListener('click', () => {
      // Hide context preview to allow editing
      contextPreviewWrapper.classList.add('hidden');
      generateBtn.disabled = false;
      generateBtn.textContent = '🔍 Preview Context & Generate';
    });
    
    // Tech stack input validation and suggestions
    techStackInput.addEventListener('input', () => {
      const techStack = parseTechStack(techStackInput.value);
      if (techStackInput.value.length > 20) {
        updateConfidenceIndicator(techStack.confidence, techStack.suggestions);
      } else {
        statusSection.style.display = 'none';
      }
    });

    // Initialize the application
    initializeFigmaIntegration();

    // Tab functionality
    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.getAttribute('data-tab');
          
          // Remove active class from all tabs and contents
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          btn.classList.add('active');
          document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Design Health functionality
    function analyzeDesignHealth() {
      // Placeholder for design health analysis
      console.log('🔍 Analyzing design health...');
      
      // Send message to Figma plugin code for analysis
      parent.postMessage({ 
        pluginMessage: { 
          type: 'analyze-design-health'
        } 
      }, '*');
    }

    // Initialize tabs
    initializeTabs();

    // Initialize template preview
    updateTemplateContext();

    // Add event listener for design health analysis
    document.getElementById('analyzeHealthBtn').addEventListener('click', analyzeDesignHealth);

    console.log('🎯 Enhanced Figma Plugin with Context Preview loaded successfully');
  </script>
</body>
</html>