<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enhanced Figma Plugin</title>
  <style>
    /* Modern CSS Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      line-height: 1.5;
      background: #f8fafc;
      color: #1a202c;
      padding: 20px;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    .content {
      padding: 24px;
    }

    /* Tab Navigation */
    .tab-header {
      background: #f7fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 24px;
    }

    .tab-nav {
      display: flex;
      gap: 4px;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      border-bottom: none;
    }

    .tab-btn:hover {
      background: #e2e8f0;
      color: #334155;
    }

    .tab-btn.active {
      background: white;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
    }

    .tab-content {
      display: none;
      padding: 24px;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    #techStackInput {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    #techStackInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select, input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-secondary {
      background: #6b7280;
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 8px;
    }

    /* Status and Results */
    .status-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .confidence-score {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .confidence-high { background: #dcfce7; color: #166534; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }

    .suggestions {
      margin-top: 12px;
    }

    .suggestion-pill {
      display: inline-block;
      padding: 4px 12px;
      margin: 2px 4px 2px 0;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-pill:hover {
      background: #c7d2fe;
    }

    #results {
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    #results.hidden {
      display: none;
    }

    #results textarea {
      width: 100%;
      min-height: 300px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      background: white;
      resize: vertical;
    }

    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 6px;
    }

    .fallback-notice {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      color: #9a3412;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .copy-success {
      color: #059669;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 6px;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #6b7280;
      font-size: 14px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Config Sections */
    .config-section {
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }

    .config-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
    }

    .mode-selection {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .radio-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .radio-group:hover {
      border-color: #d1d5db;
      background: #f9fafb;
    }

    .radio-group:has(input:checked) {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .radio-group input[type="radio"] {
      margin-top: 2px;
    }

    .radio-group label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      margin-bottom: 0;
    }

    .radio-label {
      font-weight: 600;
      color: #374151;
    }

    .radio-description {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }

    .mcp-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
    }

    .status-indicator {
      font-size: 16px;
    }

    .status-text {
      font-size: 14px;
      color: #6b7280;
    }

    /* Design Health Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-excellent { color: #059669; }
    .metric-good { color: #0891b2; }
    .metric-fair { color: #d97706; }
    .metric-poor { color: #dc2626; }
  </style>
</head>

<body>
  <div id="app">
    <div class="header">
      <h1>Enhanced Figma Plugin</h1>
      <div class="subtitle">AI-powered ticket generation with design health insights</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-header">
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="generator">🎫 Ticket Generator</button>
        <button class="tab-btn" data-tab="health">📊 Design Health</button>
      </div>
    </div>

    <!-- Ticket Generator Tab -->
    <div class="tab-content active" id="generator-tab">
      <div class="content">
        <div class="panel-header">
          <h2 class="panel-title">🎫 Figma to Document Generator</h2>
          <p class="panel-subtitle">Transform Figma designs into professional documents</p>
        </div>

        <!-- Generation Mode Selection -->
        <div class="config-section">
          <div class="config-title">Generation Mode</div>
          
          <div class="mode-selection">
            <div class="radio-group">
              <input type="radio" id="modeMCP" name="generationMode" value="mcp" checked>
              <label for="modeMCP">
                <span class="radio-label">🚀 MCP Server (Enhanced)</span>
                <span class="radio-description">Local Model Context Protocol server with strategic design analysis</span>
              </label>
            </div>
            
            <div class="radio-group">
              <input type="radio" id="modeOpenAI" name="generationMode" value="openai">
              <label for="modeOpenAI">
                <span class="radio-label">🤖 OpenAI API</span>
                <span class="radio-description">Cloud-based AI generation (requires API key)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- OpenAI Configuration (hidden by default) -->
        <div class="config-section" id="openaiConfig" style="display: none;">
          <div class="config-title">OpenAI Configuration</div>
          
          <div class="form-group">
            <label for="apiKey">OpenAI API Key</label>
            <input type="password" id="apiKey" placeholder="sk-..." />
          </div>
          
          <div class="form-group">
            <label for="model">Model</label>
            <select id="model">
              <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            </select>
          </div>
        </div>

        <!-- MCP Configuration (visible by default) -->
        <div class="config-section" id="mcpConfig">
          <div class="config-title">MCP Configuration</div>
          <div class="mcp-status">
            <span class="status-indicator" id="mcpStatus">🔄</span>
            <span class="status-text" id="mcpStatusText">Checking MCP server...</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="techStackInput">Tech Stack Description</label>
          <textarea 
            id="techStackInput" 
            placeholder="Describe your tech stack, frameworks, libraries, and architecture. Be specific about versions, patterns, and tools you're using.

Examples:
• React 18 with TypeScript, Material-UI v5, React Query for state management
• Vue 3 with Composition API, Pinia for state, Vite build tool
• Next.js 13 with App Router, TailwindCSS, Prisma ORM, PostgreSQL
• Angular 15 with NgRx, Angular Material, RxJS patterns"></textarea>
        </div>

        <div class="form-group">
          <label for="documentType">Document Type</label>
          <select id="documentType">
            <option value="jira">Jira Ticket</option>
            <option value="confluence">Confluence Page</option>
            <option value="wiki">Wiki Documentation</option>
            <option value="agent">Agent Task</option>
          </select>
        </div>

        <div class="status-section" style="display: none;">
          <div class="confidence-indicator">
            <span>📊 Confidence:</span>
            <span class="confidence-score confidence-high">85%</span>
          </div>
          <div class="suggestions">
            <span class="suggestion-pill">Add testing framework</span>
            <span class="suggestion-pill">Specify API architecture</span>
            <span class="suggestion-pill">Include deployment strategy</span>
          </div>
        </div>

        <button id="generate" class="button">🚀 Generate Enhanced Document</button>

        <div id="results" class="hidden">
          <label>Generated Content</label>
          <textarea id="generatedContent" readonly></textarea>
          <button id="copyBtn" class="copy-btn button button-secondary">📋 Copy to Clipboard</button>
        </div>
      </div>
    </div>

    <!-- Design Health Tab -->
    <div class="tab-content" id="health-tab">
      <div class="content">
        <h2>📊 Design System Health</h2>
        <p style="color: #64748b; margin-bottom: 24px;">Monitor and improve your design system consistency</p>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value metric-excellent" id="overallScore">87%</div>
            <div class="metric-label">Overall Score</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-value metric-good" id="complianceRate">92%</div>
            <div class="metric-label">Compliance Rate</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-value metric-fair" id="componentUsage">78%</div>
            <div class="metric-label">Component Usage</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-value metric-good" id="tokenAdoption">85%</div>
            <div class="metric-label">Token Adoption</div>
          </div>
        </div>

        <!-- Component Analysis -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 16px; color: #374151; font-size: 16px;">Component Analysis</h3>
          
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Standard Components</span>
              <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">85%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Custom Components</span>
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">68%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 500;">Most Used Component</span>
              <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">Button</span>
            </div>
          </div>
        </div>

        <!-- Token Adoption -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 16px; color: #374151; font-size: 16px;">Token Adoption</h3>
          
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Color Tokens</span>
              <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">92%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Typography Tokens</span>
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">76%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 500;">Spacing Tokens</span>
              <span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">64%</span>
            </div>
          </div>
        </div>

        <!-- Recommendations -->
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
          <h3 style="margin-bottom: 12px; color: #374151;">Recommendations</h3>
          <div id="recommendations">
            <div style="margin-bottom: 8px;">✅ <strong>Good:</strong> High color token adoption rate</div>
            <div style="margin-bottom: 8px;">⚠️ <strong>Improve:</strong> Increase spacing token consistency</div>
            <div>💡 <strong>Suggestion:</strong> Standardize typography scale usage</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    const techStackInput = document.getElementById('techStackInput');
    const documentTypeSelect = document.getElementById('documentType');
    const generateBtn = document.getElementById('generate');
    const resultsDiv = document.getElementById('results');
    const resultsTextarea = document.getElementById('generatedContent');
    const copyBtn = document.getElementById('copyBtn');
    const statusSection = document.querySelector('.status-section');

    // Tab Management
    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Remove active class from all tabs and buttons
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          btn.classList.add('active');
          document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Mode Selection Management
    function initializeModeSelection() {
      const mcpRadio = document.getElementById('modeMCP');
      const openaiRadio = document.getElementById('modeOpenAI');
      const openaiConfig = document.getElementById('openaiConfig');
      const mcpConfig = document.getElementById('mcpConfig');
      
      function updateModeDisplay() {
        if (mcpRadio.checked) {
          openaiConfig.style.display = 'none';
          mcpConfig.style.display = 'block';
          checkMCPServer();
        } else {
          openaiConfig.style.display = 'block';
          mcpConfig.style.display = 'none';
        }
      }
      
      mcpRadio.addEventListener('change', updateModeDisplay);
      openaiRadio.addEventListener('change', updateModeDisplay);
      
      // Initialize display
      updateModeDisplay();
    }

    // Check MCP Server Status
    async function checkMCPServer() {
      const mcpStatus = document.getElementById('mcpStatus');
      const mcpStatusText = document.getElementById('mcpStatusText');
      
      try {
        mcpStatus.textContent = '🔄';
        mcpStatusText.textContent = 'Checking MCP server...';
        
        const response = await fetch('http://localhost:3000', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            jsonrpc: '2.0',
            method: 'ping',
            id: 1 
          })
        });
        
        if (response.ok) {
          mcpStatus.textContent = '✅';
          mcpStatusText.textContent = 'MCP server available';
        } else {
          throw new Error('Server responded with error');
        }
      } catch (error) {
        mcpStatus.textContent = '❌';
        mcpStatusText.textContent = 'MCP server unavailable';
        console.warn('MCP server check failed:', error);
      }
    }

    // MCP Server Communication
    async function callMCPServer(method, params) {
      try {
        console.log('🔍 Calling MCP server:', method, params);
        
        const response = await fetch('http://localhost:3000', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            method: method,
            params: params,
            id: 1
          }),
        });
        
        console.log('📡 MCP response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`MCP Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('📦 MCP response data:', data);
        return data.result || data;
      } catch (error) {
        console.error('❌ MCP call failed:', error);
        throw error;
      }
    }

    // Tech stack parsing and confidence calculation
    function parseTechStack(description) {
      const frameworks = ['react', 'vue', 'angular', 'svelte', 'next.js', 'nuxt', 'gatsby'];
      const languages = ['typescript', 'javascript', 'python', 'java', 'c#', 'go', 'rust'];
      const tools = ['webpack', 'vite', 'parcel', 'rollup', 'esbuild'];
      const testing = ['jest', 'vitest', 'cypress', 'playwright', 'testing-library'];
      
      const lowerDesc = description.toLowerCase();
      
      const detected = {
        frameworks: frameworks.filter(f => lowerDesc.includes(f)),
        languages: languages.filter(l => lowerDesc.includes(l)),
        tools: tools.filter(t => lowerDesc.includes(t)),
        testing: testing.filter(t => lowerDesc.includes(t))
      };
      
      // Calculate confidence based on specificity
      let confidence = 50;
      if (detected.frameworks.length > 0) confidence += 20;
      if (detected.languages.length > 0) confidence += 15;
      if (detected.tools.length > 0) confidence += 10;
      if (detected.testing.length > 0) confidence += 5;
      if (lowerDesc.includes('version') || /\d+/.test(lowerDesc)) confidence += 10;
      
      confidence = Math.min(confidence, 95);
      
      // Generate suggestions based on detected tech
      const suggestions = [];
      if (detected.frameworks.length > 0) {
        detected.frameworks.forEach(f => suggestions.push(f.charAt(0).toUpperCase() + f.slice(1)));
      }
      if (detected.languages.length > 0) {
        detected.languages.forEach(l => suggestions.push(l.charAt(0).toUpperCase() + l.slice(1)));
      }
      
      // Add default suggestions if none detected
      if (suggestions.length === 0) {
        suggestions.push('Add specific versions', 'Include testing framework', 'Mention state management');
      }
      
      return { detected, confidence, suggestions };
    }

    // Update confidence indicator
    function updateConfidenceIndicator(confidence, suggestions = []) {
      const indicator = statusSection.querySelector('.confidence-indicator');
      const scoreEl = statusSection.querySelector('.confidence-score');
      const suggestionsEl = statusSection.querySelector('.suggestions');
      
      scoreEl.textContent = `${confidence}%`;
      scoreEl.className = `confidence-score ${
        confidence >= 80 ? 'confidence-high' : 
        confidence >= 60 ? 'confidence-medium' : 'confidence-low'
      }`;
      
      suggestionsEl.innerHTML = suggestions.map(s => 
        `<span class="suggestion-pill">${s}</span>`
      ).join('');
      
      statusSection.style.display = 'flex';
    }

    // Generate content
    async function generateContent() {
      const techStackDesc = techStackInput.value.trim();
      const documentType = documentTypeSelect.value;
      const selectedMode = document.querySelector('input[name="generationMode"]:checked').value;
      
      if (!techStackDesc) {
        showError('Please describe your tech stack to generate a document.');
        return;
      }
      
      // Show loading state
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="spinner"></div> Generating...';
      resultsDiv.classList.remove('hidden');
      resultsTextarea.value = 'Generating enhanced content...';
      
      try {
        // Parse tech stack for confidence
        const parsed = parseTechStack(techStackDesc);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
        
        let result;
        
        if (selectedMode === 'mcp') {
          // Call MCP server
          result = await callMCPServer('analyze_project', {
            techStack: techStackDesc,
            documentType: documentType,
            confidence: parsed.confidence,
            detectedTech: parsed.detected
          });
        } else {
          // Call OpenAI API
          result = await callOpenAI(techStackDesc, documentType);
        }
        
        // Handle different response formats
        let content = '';
        if (result.ticket) {
          content = result.ticket;
        } else if (result.content) {
          content = result.content;
        } else if (typeof result === 'string') {
          content = result;
        } else {
          content = JSON.stringify(result, null, 2);
        }
        
        resultsTextarea.value = content;
        
        // Show fallback notice if applicable
        if (result.isFallback) {
          showFallbackNotice();
        }
        
      } catch (error) {
        console.error('Generation failed:', error);
        resultsTextarea.value = `Error generating content: ${error.message}`;
        showError('Failed to generate content. Please try again.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '🚀 Generate Enhanced Document';
      }
    }

    // OpenAI API Communication
    async function callOpenAI(techStack, documentType) {
      const apiKey = document.getElementById('apiKey').value.trim();
      const model = document.getElementById('model').value;
      
      if (!apiKey) {
        throw new Error('Please enter your OpenAI API key');
      }
      
      const prompt = `Create a ${documentType} for a project using this tech stack: ${techStack}`;
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { 
              role: 'system', 
              content: 'You are a UX/UI ticket assistant. Generate clean, structured Jira tickets from tech stack descriptions. Focus on implementation details, acceptance criteria, and technical requirements.'
            },
            { role: 'user', content: prompt }
          ],
          max_tokens: 1500,
          temperature: 0.7
        })
      });
      
      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }
      
      const data = await response.json();
      return { 
        content: data.choices[0].message.content,
        isOpenAI: true 
      };
    }

    // Show error message
    function showError(message) {
      // Remove existing error messages
      document.querySelectorAll('.error-message').forEach(el => el.remove());
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      techStackInput.parentNode.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Show fallback notice
    function showFallbackNotice() {
      const notice = document.createElement('div');
      notice.className = 'fallback-notice';
      notice.innerHTML = '⚠️ Enhanced analysis temporarily unavailable - using fallback generation';
      
      resultsDiv.insertBefore(notice, resultsDiv.firstChild);
      
      setTimeout(() => {
        notice.remove();
      }, 8000);
    }

    // Copy to clipboard
    function copyToClipboard() {
      resultsTextarea.select();
      resultsTextarea.setSelectionRange(0, 99999);
      
      try {
        document.execCommand('copy');
        copyBtn.textContent = '✅ Copied!';
        
        // Show copy success message
        const successDiv = document.createElement('div');
        successDiv.className = 'copy-success';
        successDiv.textContent = 'Content copied to clipboard successfully!';
        resultsDiv.appendChild(successDiv);
        
        setTimeout(() => {
          copyBtn.textContent = '📋 Copy to Clipboard';
          successDiv.remove();
        }, 2000);
      } catch (err) {
        console.error('Copy failed:', err);
        copyBtn.textContent = '❌ Copy failed';
        setTimeout(() => {
          copyBtn.textContent = '📋 Copy to Clipboard';
        }, 2000);
      }
    }

    // Update design health metrics (placeholder)
    function updateDesignHealth() {
      document.getElementById('overallScore').textContent = '87%';
      document.getElementById('complianceRate').textContent = '92%';
      document.getElementById('componentUsage').textContent = '78%';
      document.getElementById('tokenAdoption').textContent = '85%';
      
      document.getElementById('recommendations').innerHTML = `
        <div style="margin-bottom: 8px;">✅ <strong>Good:</strong> High token adoption rate</div>
        <div style="margin-bottom: 8px;">⚠️ <strong>Improve:</strong> Increase component reuse in navigation areas</div>
        <div>💡 <strong>Suggestion:</strong> Consider standardizing button variants</div>
      `;
    }

    // Event listeners
    generateBtn.addEventListener('click', generateContent);
    copyBtn.addEventListener('click', copyToClipboard);
    
    // Tech stack input validation and suggestions
    techStackInput.addEventListener('input', () => {
      const techStack = parseTechStack(techStackInput.value);
      if (techStackInput.value.length > 20) {
        updateConfidenceIndicator(techStack.confidence, techStack.suggestions);
      } else {
        statusSection.style.display = 'none';
      }
    });

    // Initialize the application
    initializeTabs();
    initializeModeSelection();
    updateDesignHealth();

    console.log('🎯 Enhanced Figma Plugin loaded successfully');
  </script>
</body>
</html>