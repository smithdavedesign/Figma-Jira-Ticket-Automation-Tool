<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enhanced Figma Plugin</title>
  <style>
    /* Modern CSS Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      line-height: 1.5;
      background: #f8fafc;
      color: #1a202c;
      padding: 20px;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    .content {
      padding: 24px;
    }

    /* Tab Navigation */
    .tab-header {
      background: #f7fafc;
      border-bottom: 1px solid #e2e8f0;
      padding: 0 24px;
    }

    .tab-nav {
      display: flex;
      gap: 4px;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      border-bottom: none;
    }

    .tab-btn:hover {
      background: #e2e8f0;
      color: #334155;
    }

    .tab-btn.active {
      background: white;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
    }

    .tab-content {
      display: none;
      padding: 24px;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    #techStackInput {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    #techStackInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    select, input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-secondary {
      background: #6b7280;
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
      margin-top: 8px;
    }

    /* Status and Results */
    .status-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .confidence-score {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .confidence-high { background: #dcfce7; color: #166534; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }

    .suggestions {
      margin-top: 12px;
    }

    .suggestion-pill {
      display: inline-block;
      padding: 4px 12px;
      margin: 2px 4px 2px 0;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-pill:hover {
      background: #c7d2fe;
    }

    #results {
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    #results.hidden {
      display: none;
    }

    #results textarea {
      width: 100%;
      min-height: 300px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      background: white;
      resize: vertical;
    }

    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 6px;
    }

    .fallback-notice {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      color: #9a3412;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .copy-success {
      color: #059669;
      font-size: 14px;
      margin-top: 8px;
      padding: 8px 12px;
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 6px;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #6b7280;
      font-size: 14px;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Config Sections */
    .config-section {
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }

    .config-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
    }

    .mode-selection {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .radio-group {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .radio-group:hover {
      border-color: #d1d5db;
      background: #f9fafb;
    }

    .radio-group:has(input:checked) {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .radio-group input[type="radio"] {
      margin-top: 2px;
    }

    .radio-group label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      margin-bottom: 0;
    }

    .radio-label {
      font-weight: 600;
      color: #374151;
    }

    .radio-description {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }

    .mcp-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
    }

    .status-indicator {
      font-size: 16px;
    }

    .status-text {
      font-size: 14px;
      color: #6b7280;
    }

    /* Design Health Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-excellent { color: #059669; }
    .metric-good { color: #0891b2; }
    .metric-fair { color: #d97706; }
    .metric-poor { color: #dc2626; }

    /* Enhanced Tech Stack Interface Styles */
    .tech-stack-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .tech-stack-title {
      font-weight: 600;
      color: #374151;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-powered-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 10px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tech-suggestions {
      margin-bottom: 16px;
    }

    .suggestions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    .suggestion-pill {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border: 2px solid transparent;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      min-height: 36px;
    }

    .suggestion-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .suggestion-pill[data-type="react"] {
      background: linear-gradient(135deg, #61dafb20 0%, #61dafb40 100%);
      border-color: #61dafb;
      color: #0a7e95;
    }

    .suggestion-pill[data-type="vue"] {
      background: linear-gradient(135deg, #4fc08d20 0%, #4fc08d40 100%);
      border-color: #4fc08d;
      color: #2c5530;
    }

    .suggestion-pill[data-type="angular"] {
      background: linear-gradient(135deg, #dd002420 0%, #dd002440 100%);
      border-color: #dd0024;
      color: #990018;
    }

    .suggestion-pill[data-type="node"] {
      background: linear-gradient(135deg, #68a06320 0%, #68a06340 100%);
      border-color: #68a063;
      color: #3e5d3b;
    }

    .suggestion-pill[data-type="python"] {
      background: linear-gradient(135deg, #ffd43b20 0%, #4584b640 100%);
      border-color: #4584b6;
      color: #2d5aa0;
    }

    .suggestion-pill[data-type="design"] {
      background: linear-gradient(135deg, #ff6b3520 0%, #ff6b3540 100%);
      border-color: #ff6b35;
      color: #cc4a20;
    }

    .suggestion-pill[data-type="aem"] {
      background: linear-gradient(135deg, #ff000020 0%, #cc000040 100%);
      border-color: #ff0000;
      color: #cc0000;
    }

    .parse-button-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }

    .parse-tech-stack {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .parse-tech-stack:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .parse-tech-stack:active {
      transform: translateY(0);
    }

    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .confidence-indicator.show {
      opacity: 1;
    }

    .confidence-bar {
      width: 60px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #dc2626 0%, #f59e0b 50%, #10b981 100%);
      transition: width 0.5s ease;
      border-radius: 2px;
    }

    /* Context Preview Wrapper */
    .hidden {
      display: none;
    }

    #context-preview-wrapper {
      margin: 24px 0;
      transition: all 0.3s ease;
    }

    .context-success-info {
      animation: slideInFadeIn 0.5s ease-out;
    }

    @keyframes slideInFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="header">
      <h1>Enhanced Figma Plugin</h1>
      <div class="subtitle">AI-powered ticket generation with design health insights</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-header">
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="generator">üé´ Ticket Generator</button>
        <button class="tab-btn" data-tab="health">üìä Design Health</button>
      </div>
    </div>

    <!-- Ticket Generator Tab -->
    <div class="tab-content active" id="generator-tab">
      <div class="content">
        <div class="panel-header">
          <h2 class="panel-title">üé´ Figma to Document Generator</h2>
          <p class="panel-subtitle">Transform Figma designs into professional documents</p>
        </div>

        <!-- Generation Mode Selection -->
        <div class="config-section">
          <div class="config-title">Generation Mode</div>
          
          <div class="mode-selection">
            <div class="radio-group">
              <input type="radio" id="modeMCP" name="generationMode" value="mcp" checked>
              <label for="modeMCP">
                <span class="radio-label">üöÄ MCP Server (Enhanced)</span>
                <span class="radio-description">Local Model Context Protocol server with strategic design analysis</span>
              </label>
            </div>
            
            <div class="radio-group">
              <input type="radio" id="modeOpenAI" name="generationMode" value="openai">
              <label for="modeOpenAI">
                <span class="radio-label">ü§ñ OpenAI API</span>
                <span class="radio-description">Cloud-based AI generation (requires API key)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- OpenAI Configuration (hidden by default) -->
        <div class="config-section" id="openaiConfig" style="display: none;">
          <div class="config-title">OpenAI Configuration</div>
          
          <div class="form-group">
            <label for="apiKey">OpenAI API Key</label>
            <input type="password" id="apiKey" placeholder="sk-..." />
          </div>
          
          <div class="form-group">
            <label for="model">Model</label>
            <select id="model">
              <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            </select>
          </div>
        </div>

        <!-- MCP Configuration (visible by default) -->
        <div class="config-section" id="mcpConfig">
          <div class="config-title">MCP Configuration</div>
          <div class="mcp-status">
            <span class="status-indicator" id="mcpStatus">üîÑ</span>
            <span class="status-text" id="mcpStatusText">Checking MCP server...</span>
          </div>
        </div>
        
        <div class="form-group">
          <div class="tech-stack-header">
            <h3 class="tech-stack-title">üõ†Ô∏è Describe Your Tech Stack 
              <span class="ai-powered-badge">AI-Powered</span>
            </h3>
          </div>
          <p class="tech-stack-subtitle">Tell us about your project in plain English:</p>
          <textarea 
            id="techStackInput" 
            placeholder="e.g., I need a React app with TypeScript, using Material-UI for styling, Jest for testing, and I want to deploy on Vercel..."
            rows="4"></textarea>
          
          <div class="tech-suggestions">
            <p class="suggestions-label">Or try these popular combinations:</p>
            <div class="suggestions-grid">
              <div class="suggestion-pill" data-type="react">React + TypeScript + Tailwind</div>
              <div class="suggestion-pill" data-type="vue">Vue 3 + Pinia + SCSS</div>
              <div class="suggestion-pill" data-type="angular">Angular + Material</div>
              <div class="suggestion-pill" data-type="node">Node.js + Express + MongoDB</div>
              <div class="suggestion-pill" data-type="python">Python + FastAPI + PostgreSQL</div>
              <div class="suggestion-pill" data-type="aem">AEM 6.5 + HTL + Sling + OSGi</div>
              <div class="suggestion-pill" data-type="design">Figma + Design System</div>
            </div>
          </div>
          
          <div class="parse-button-container">
            <button class="parse-tech-stack">üß† Parse Tech Stack</button>
            <div class="confidence-indicator">
              <span>Confidence:</span>
              <div class="confidence-bar">
                <div class="confidence-fill"></div>
              </div>
              <span class="confidence-text">0%</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="documentType">Document Type</label>
          <select id="documentType">
            <option value="jira">Jira Ticket</option>
            <option value="confluence">Confluence Page</option>
            <option value="wiki">Wiki Documentation</option>
            <option value="agent">Agent Task</option>
          </select>
        </div>

        <div class="status-section" style="display: none;">
          <div class="confidence-indicator">
            <span>üìä Confidence:</span>
            <span class="confidence-score confidence-high">85%</span>
          </div>
          <div class="suggestions">
            <span class="suggestion-pill">Add testing framework</span>
            <span class="suggestion-pill">Specify API architecture</span>
            <span class="suggestion-pill">Include deployment strategy</span>
          </div>
        </div>

        <!-- Context Preview Section (inserted before generation) -->
        <div id="context-preview-wrapper" class="hidden">
          <div id="context-preview-container"></div>
        </div>

        <button id="generate" class="button">üöÄ Generate Enhanced Document</button>

        <div id="results" class="hidden">
          <label>Generated Content</label>
          <textarea id="generatedContent" readonly></textarea>
          <button id="copyBtn" class="copy-btn button button-secondary">üìã Copy to Clipboard</button>
        </div>
      </div>
    </div>

    <!-- Design Health Tab -->
    <div class="tab-content" id="health-tab">
      <div class="content">
        <h2>üìä Design System Health</h2>
        <p style="color: #64748b; margin-bottom: 24px;">Monitor and improve your design system consistency</p>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value metric-excellent" id="overallScore">87%</div>
            <div class="metric-label">Overall Score</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-value metric-good" id="complianceRate">92%</div>
            <div class="metric-label">Compliance Rate</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-value metric-fair" id="componentUsage">78%</div>
            <div class="metric-label">Component Usage</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-value metric-good" id="tokenAdoption">85%</div>
            <div class="metric-label">Token Adoption</div>
          </div>
        </div>

        <!-- Component Analysis -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 16px; color: #374151; font-size: 16px;">Component Analysis</h3>
          
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Standard Components</span>
              <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">85%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Custom Components</span>
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">68%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 500;">Most Used Component</span>
              <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">Button</span>
            </div>
          </div>
        </div>

        <!-- Token Adoption -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 16px; color: #374151; font-size: 16px;">Token Adoption</h3>
          
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Color Tokens</span>
              <span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">92%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 500;">Typography Tokens</span>
              <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">76%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 500;">Spacing Tokens</span>
              <span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">64%</span>
            </div>
          </div>
        </div>

        <!-- Recommendations -->
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
          <h3 style="margin-bottom: 12px; color: #374151;">Recommendations</h3>
          <div id="recommendations">
            <div style="margin-bottom: 8px;">‚úÖ <strong>Good:</strong> High color token adoption rate</div>
            <div style="margin-bottom: 8px;">‚ö†Ô∏è <strong>Improve:</strong> Increase spacing token consistency</div>
            <div>üí° <strong>Suggestion:</strong> Standardize typography scale usage</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    const techStackInput = document.getElementById('techStackInput');
    const documentTypeSelect = document.getElementById('documentType');
    const generateBtn = document.getElementById('generate');
    const resultsDiv = document.getElementById('results');
    const resultsTextarea = document.getElementById('generatedContent');
    const copyBtn = document.getElementById('copyBtn');
    const statusSection = document.querySelector('.status-section');

    // Context Preview Integration
    let contextPreview = null;
    let pendingContextData = null;

    function initializeContextPreview() {
      contextPreview = new ContextPreview('context-preview-container', {
        showAdvancedMetrics: true,
        enableEditing: true,
        showTokenCount: true,
        collapsible: true,
        onDataChange: (data) => {
          pendingContextData = data;
          console.log('Context data updated:', data);
        },
        onSubmit: (data) => {
          proceedWithGeneration(data);
        }
      });
    }

    // Tab Management
    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Remove active class from all tabs and buttons
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          btn.classList.add('active');
          document.getElementById(`${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Mode Selection Management
    function initializeModeSelection() {
      const mcpRadio = document.getElementById('modeMCP');
      const openaiRadio = document.getElementById('modeOpenAI');
      const openaiConfig = document.getElementById('openaiConfig');
      const mcpConfig = document.getElementById('mcpConfig');
      
      function updateModeDisplay() {
        if (mcpRadio.checked) {
          openaiConfig.style.display = 'none';
          mcpConfig.style.display = 'block';
          checkMCPServer();
        } else {
          openaiConfig.style.display = 'block';
          mcpConfig.style.display = 'none';
        }
      }
      
      mcpRadio.addEventListener('change', updateModeDisplay);
      openaiRadio.addEventListener('change', updateModeDisplay);
      
      // Initialize display
      updateModeDisplay();
    }

    // Check MCP Server Status
    async function checkMCPServer() {
      const mcpStatus = document.getElementById('mcpStatus');
      const mcpStatusText = document.getElementById('mcpStatusText');
      
      try {
        mcpStatus.textContent = 'üîÑ';
        mcpStatusText.textContent = 'Checking MCP server...';
        
        const response = await fetch('http://localhost:3000', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            jsonrpc: '2.0',
            method: 'ping',
            id: 1 
          })
        });
        
        if (response.ok) {
          mcpStatus.textContent = '‚úÖ';
          mcpStatusText.textContent = 'MCP server available';
        } else {
          throw new Error('Server responded with error');
        }
      } catch (error) {
        mcpStatus.textContent = '‚ùå';
        mcpStatusText.textContent = 'MCP server unavailable';
        console.warn('MCP server check failed:', error);
      }
    }

    // MCP Server Communication
    async function callMCPServer(method, params) {
      try {
        console.log('üîç Calling MCP server:', method, params);
        
        const response = await fetch('http://localhost:3000', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            jsonrpc: '2.0',
            method: method,
            params: params,
            id: 1
          }),
        });
        
        console.log('üì° MCP response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`MCP Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì¶ MCP response data:', data);
        return data.result || data;
      } catch (error) {
        console.error('‚ùå MCP call failed:', error);
        throw error;
      }
    }

    // Tech stack parsing and confidence calculation with optional Figma context (Phase 1)
    function parseTechStack(description, figmaContext = null) {
      const frameworks = ['react', 'vue', 'angular', 'svelte', 'next.js', 'nuxt', 'gatsby'];
      const languages = ['typescript', 'javascript', 'python', 'java', 'c#', 'go', 'rust'];
      const tools = ['webpack', 'vite', 'parcel', 'rollup', 'esbuild'];
      const testing = ['jest', 'vitest', 'cypress', 'playwright', 'testing-library'];
      
      const lowerDesc = description.toLowerCase();
      
      const detected = {
        frameworks: frameworks.filter(f => lowerDesc.includes(f)),
        languages: languages.filter(l => lowerDesc.includes(l)),
        tools: tools.filter(t => lowerDesc.includes(t)),
        testing: testing.filter(t => lowerDesc.includes(t))
      };
      
      // Calculate confidence based on specificity
      let confidence = 50;
      if (detected.frameworks.length > 0) confidence += 20;
      if (detected.languages.length > 0) confidence += 15;
      if (detected.tools.length > 0) confidence += 10;
      if (detected.testing.length > 0) confidence += 5;
      if (lowerDesc.includes('version') || /\d+/.test(lowerDesc)) confidence += 10;
      
      confidence = Math.min(confidence, 95);
      
      // Generate suggestions based on detected tech
      const suggestions = [];
      if (detected.frameworks.length > 0) {
        detected.frameworks.forEach(f => suggestions.push(f.charAt(0).toUpperCase() + f.slice(1)));
      }
      if (detected.languages.length > 0) {
        detected.languages.forEach(l => suggestions.push(l.charAt(0).toUpperCase() + l.slice(1)));
      }
      
      // Add default suggestions if none detected
      if (suggestions.length === 0) {
        suggestions.push('Add specific versions', 'Include testing framework', 'Mention state management');
      }
      
      // Phase 1: Enhanced analysis with Figma context
      let designContext = null;
      let enhanced = false;
      
      if (figmaContext && figmaContext.layers) {
        enhanced = true;
        // Analyze design patterns from Figma context
        const patterns = analyzeDesignPatterns(figmaContext);
        const componentTypes = detectComponentTypes(figmaContext);
        
        // Calculate design confidence boost
        const designBoost = calculateDesignConfidenceBoost(detected, patterns, componentTypes);
        confidence = Math.min(confidence + designBoost, 98);
        
        // Add design-based suggestions
        const designSuggestions = generateDesignSuggestions(detected, patterns, componentTypes);
        suggestions.push(...designSuggestions);
        
        // Store design context for display
        designContext = {
          patterns,
          componentTypes,
          confidenceBoost: designBoost,
          source: figmaContext.source || 'figma'
        };
      }
      
      return { detected, confidence, suggestions, designContext, enhanced };
    }

    // Phase 1: Enhanced Design Analysis Functions
    function analyzeDesignPatterns(figmaContext) {
      const patterns = [];
      const layers = figmaContext.layers || [];
      
      // Extract text content and layer names for analysis
      const textContent = extractTextFromLayers(layers).toLowerCase();
      const layerNames = extractLayerNames(layers).toLowerCase();
      const combinedText = textContent + ' ' + layerNames;
      
      // Detect form patterns
      if (combinedText.includes('input') || combinedText.includes('form') || combinedText.includes('email') || combinedText.includes('password')) {
        patterns.push({
          type: 'form',
          confidence: 85,
          elements: ['input fields', 'form validation', 'submit actions'],
          suggestedLibraries: ['react-hook-form', 'formik', 'yup']
        });
      }
      
      // Detect navigation patterns
      if (combinedText.includes('nav') || combinedText.includes('menu') || combinedText.includes('header') || combinedText.includes('home about contact')) {
        patterns.push({
          type: 'navigation',
          confidence: 80,
          elements: ['navigation menu', 'routing', 'page transitions'],
          suggestedLibraries: ['react-router', 'vue-router', '@angular/router']
        });
      }
      
      // Detect data display patterns
      if (combinedText.includes('table') || combinedText.includes('list') || combinedText.includes('data') || combinedText.includes('row')) {
        patterns.push({
          type: 'dataDisplay',
          confidence: 75,
          elements: ['data tables', 'lists', 'filtering', 'sorting'],
          suggestedLibraries: ['ag-grid', 'react-table', 'antd table']
        });
      }
      
      return patterns;
    }

    function detectComponentTypes(figmaContext) {
      const components = [];
      const layers = figmaContext.layers || [];
      
      layers.forEach(layer => {
        if (layer.type === 'FRAME' && layer.name) {
          const name = layer.name.toLowerCase();
          
          if (name.includes('button')) {
            components.push({
              type: 'button',
              complexity: 'low',
              layerId: layer.id,
              layerName: layer.name,
              estimatedEffort: '30 minutes',
              suggestedProps: ['onClick', 'disabled', 'variant']
            });
          }
          
          if (name.includes('input') || name.includes('field')) {
            components.push({
              type: 'input',
              complexity: 'medium',
              layerId: layer.id,
              layerName: layer.name,
              estimatedEffort: '1-2 hours',
              suggestedProps: ['value', 'onChange', 'placeholder', 'validation']
            });
          }
          
          if (name.includes('card') || name.includes('item')) {
            components.push({
              type: 'card',
              complexity: 'medium',
              layerId: layer.id,
              layerName: layer.name,
              estimatedEffort: '2-3 hours',
              suggestedProps: ['title', 'content', 'actions', 'onClick']
            });
          }
          
          if (name.includes('modal') || name.includes('dialog')) {
            components.push({
              type: 'modal',
              complexity: 'high',
              layerId: layer.id,
              layerName: layer.name,
              estimatedEffort: '4-6 hours',
              suggestedProps: ['isOpen', 'onClose', 'title', 'children']
            });
          }
        }
      });
      
      return components;
    }

    function calculateDesignConfidenceBoost(detected, patterns, components) {
      let boost = 0;
      
      // Boost based on pattern-framework alignment
      const detectedFramework = detected.frameworks[0];
      if (detectedFramework) {
        patterns.forEach(pattern => {
          if (pattern.type === 'form' && ['react', 'vue', 'angular'].includes(detectedFramework)) {
            boost += 5;
          }
          if (pattern.type === 'navigation' && detectedFramework === 'react') {
            boost += 3;
          }
          if (pattern.type === 'dataDisplay' && ['react', 'angular'].includes(detectedFramework)) {
            boost += 4;
          }
        });
      }
      
      // Boost based on component complexity alignment
      const hasComplexComponents = components.some(c => c.complexity === 'high');
      if (hasComplexComponents && ['react', 'vue'].includes(detectedFramework)) {
        boost += 3;
      }
      
      return Math.min(boost, 15);
    }

    function generateDesignSuggestions(detected, patterns, components) {
      const suggestions = [];
      
      patterns.forEach(pattern => {
        if (pattern.suggestedLibraries && pattern.suggestedLibraries.length > 0) {
          suggestions.push(`Consider ${pattern.suggestedLibraries[0]} for ${pattern.type}`);
        }
      });
      
      const hasComplexComponents = components.some(c => c.complexity === 'high');
      if (hasComplexComponents) {
        suggestions.push('Add state management library');
      }
      
      const hasInputs = components.some(c => c.type === 'input');
      if (hasInputs) {
        suggestions.push('Include form validation');
      }
      
      return suggestions.slice(0, 3);
    }

    function extractTextFromLayers(layers) {
      let text = '';
      layers.forEach(layer => {
        if (layer.type === 'TEXT' && layer.characters) {
          text += layer.characters + ' ';
        }
        if (layer.children && Array.isArray(layer.children)) {
          text += extractTextFromLayers(layer.children);
        }
      });
      return text;
    }

    function extractLayerNames(layers) {
      let names = '';
      layers.forEach(layer => {
        if (layer.name) {
          names += layer.name + ' ';
        }
        if (layer.children && Array.isArray(layer.children)) {
          names += extractLayerNames(layer.children);
        }
      });
      return names;
    }

    function createMockFigmaContextForDemo(techStackDesc) {
      const lowerDesc = techStackDesc.toLowerCase();
      const mockLayers = [];
      
      if (lowerDesc.includes('form') || lowerDesc.includes('login') || lowerDesc.includes('register')) {
        mockLayers.push(
          { id: '1', name: 'Login Form', type: 'FRAME' },
          { id: '2', name: 'Email Input', type: 'TEXT', characters: 'Email Address' },
          { id: '3', name: 'Password Input', type: 'TEXT', characters: 'Password' },
          { id: '4', name: 'Login Button', type: 'RECTANGLE' }
        );
      }
      
      if (lowerDesc.includes('nav') || lowerDesc.includes('menu') || lowerDesc.includes('header')) {
        mockLayers.push(
          { id: '5', name: 'Main Navigation', type: 'FRAME' },
          { id: '6', name: 'Nav Menu Items', type: 'TEXT', characters: 'Home About Contact' },
          { id: '7', name: 'Header Logo', type: 'TEXT', characters: 'Logo' }
        );
      }
      
      if (lowerDesc.includes('table') || lowerDesc.includes('list') || lowerDesc.includes('data')) {
        mockLayers.push(
          { id: '8', name: 'Data Table', type: 'FRAME' },
          { id: '9', name: 'Table Header', type: 'TEXT', characters: 'Name Email Role' },
          { id: '10', name: 'Table Row', type: 'FRAME' }
        );
      }
      
      if (lowerDesc.includes('card') || lowerDesc.includes('product')) {
        mockLayers.push(
          { id: '11', name: 'Product Card', type: 'FRAME' },
          { id: '12', name: 'Card Title', type: 'TEXT', characters: 'Product Name' },
          { id: '13', name: 'Card Button', type: 'RECTANGLE' }
        );
      }
      
      if (mockLayers.length === 0) {
        mockLayers.push(
          { id: '1', name: 'Main Component', type: 'FRAME' },
          { id: '2', name: 'Action Button', type: 'RECTANGLE' },
          { id: '3', name: 'Content Text', type: 'TEXT', characters: 'Main content' }
        );
      }
      
      return {
        layers: mockLayers,
        source: 'mock-demo',
        timestamp: new Date().toISOString()
      };
    }

    // Update confidence indicator
    function updateConfidenceIndicator(confidence, suggestions = []) {
      const indicator = statusSection.querySelector('.confidence-indicator');
      const scoreEl = statusSection.querySelector('.confidence-score');
      const suggestionsEl = statusSection.querySelector('.suggestions');
      
      scoreEl.textContent = `${confidence}%`;
      scoreEl.className = `confidence-score ${
        confidence >= 80 ? 'confidence-high' : 
        confidence >= 60 ? 'confidence-medium' : 'confidence-low'
      }`;
      
      suggestionsEl.innerHTML = suggestions.map(s => 
        `<span class="suggestion-pill">${s}</span>`
      ).join('');
      
      statusSection.style.display = 'flex';
    }

    // Generate content - now shows context preview first
    async function generateContent() {
      const techStackDesc = techStackInput.value.trim();
      const documentType = documentTypeSelect.value;
      const selectedMode = document.querySelector('input[name="generationMode"]:checked').value;
      
      if (!techStackDesc) {
        showError('Please describe your tech stack to generate a document.');
        return;
      }
      
      // Step 1: Collect and analyze context
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="spinner"></div> Analyzing Context...';
      
      try {
        // Parse tech stack for confidence and analysis
        const parsed = parseTechStack(techStackDesc);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
        
        // Check MCP server status
        let mcpData = null;
        if (selectedMode === 'mcp') {
          try {
            mcpData = await getMCPServerInfo();
          } catch (error) {
            console.warn('MCP server unavailable:', error);
          }
        }
        
        // Create mock screenshot for demo (in real scenario this would come from actual capture)
        const mockScreenshot = createMockScreenshot();
        
        // Prepare context data
        const contextData = {
          techStack: parsed,
          screenshot: mockScreenshot,
          mcpData: mcpData,
          designSystem: null, // Would be populated by design system scanner
          customContext: null,
          documentType: documentType,
          selectedMode: selectedMode
        };
        
        // Step 2: Show context preview
        showContextPreview(contextData);
        
      } catch (error) {
        console.error('Context analysis failed:', error);
        showError('Failed to analyze context. Please try again.');
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'üöÄ Generate Enhanced Document';
      }
    }

    // New function to show context preview
    function showContextPreview(contextData) {
      const previewWrapper = document.getElementById('context-preview-wrapper');
      
      // Initialize context preview if not already done
      if (!contextPreview) {
        initializeContextPreview();
      }
      
      // Update context preview with data
      contextPreview.updateContext(contextData);
      
      // Show the preview section
      previewWrapper.classList.remove('hidden');
      
      // Scroll to preview
      previewWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Update the main generate button text
      generateBtn.innerHTML = 'üëÄ Review Context First';
      generateBtn.disabled = true;
      
      // Store context for actual generation
      pendingContextData = contextData;
    }

    // Function called when user clicks submit in context preview
    async function proceedWithGeneration(contextData) {
      const documentType = contextData.documentType;
      const selectedMode = contextData.selectedMode;
      
      // Show loading state
      const submitBtn = document.querySelector('#submit-context-btn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div> Generating...';
      }
      
      resultsDiv.classList.remove('hidden');
      resultsTextarea.value = 'Generating enhanced content with your context...';
      
      try {
        let result;
        
        if (selectedMode === 'mcp') {
          // Call MCP server with full context
          result = await callMCPServer('generate_enhanced_ticket', {
            techStack: contextData.techStack.description || '',
            documentType: documentType,
            confidence: contextData.techStack.confidence,
            detectedTech: contextData.techStack.detected,
            designContext: contextData.techStack.designContext,
            visualContext: contextData.screenshot,
            mcpData: contextData.mcpData,
            customContext: contextData.customContext
          });
        } else {
          // Call OpenAI API with context
          result = await callOpenAI(contextData.techStack.description || '', documentType);
        }
        
        // Handle different response formats
        let content = '';
        if (result.ticket) {
          content = result.ticket;
        } else if (result.content) {
          content = result.content;
        } else if (typeof result === 'string') {
          content = result;
        } else {
          content = JSON.stringify(result, null, 2);
        }
        
        resultsTextarea.value = content;
        
        // Show success with context info
        if (contextData.screenshot) {
          const contextInfo = document.createElement('div');
          contextInfo.className = 'context-success-info';
          contextInfo.innerHTML = `
            <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
              <strong>‚úÖ Generated with Enhanced Context:</strong><br>
              ‚Ä¢ Tech Stack Analysis (${contextData.techStack.confidence}% confidence)<br>
              ${contextData.screenshot ? '‚Ä¢ Visual Design Screenshot<br>' : ''}
              ${contextData.mcpData ? '‚Ä¢ MCP Server Data<br>' : ''}
              ${contextData.designSystem ? '‚Ä¢ Design System Tokens<br>' : ''}
              ${contextData.customContext ? '‚Ä¢ Custom Requirements<br>' : ''}
            </div>
          `;
          resultsDiv.insertBefore(contextInfo, resultsDiv.firstChild.nextSibling);
          
          setTimeout(() => contextInfo.remove(), 12000);
        }
        
        // Show fallback notice if applicable
        if (result.isFallback) {
          showFallbackNotice();
        }
        
      } catch (error) {
        console.error('Generation failed:', error);
        resultsTextarea.value = `Error generating content: ${error.message}`;
        showError('Failed to generate content. Please try again.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'üöÄ Generate with Context';
        }
      }
    }

    // Helper function to get MCP server info
    async function getMCPServerInfo() {
      const response = await fetch('http://localhost:3000', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          jsonrpc: '2.0',
          method: 'list_tools',
          id: 1 
        })
      });
      
      if (!response.ok) {
        throw new Error('MCP server unavailable');
      }
      
      const data = await response.json();
      return {
        tools: data.result?.tools || [],
        status: 'connected'
      };
    }

    // Helper function to create mock screenshot for demo
    function createMockScreenshot() {
      // In real implementation, this would capture actual screenshot
      return {
        dataUrl: 'data:image/svg+xml;base64,' + btoa(`
          <svg width="400" height="200" xmlns="http://www.w3.org/2000/svg">
            <rect width="400" height="200" fill="#f8fafc"/>
            <rect x="20" y="20" width="360" height="40" rx="8" fill="#667eea"/>
            <text x="200" y="45" text-anchor="middle" fill="white" font-family="Arial" font-size="16">Design Preview</text>
            <rect x="20" y="80" width="100" height="30" rx="4" fill="#e2e8f0"/>
            <rect x="140" y="80" width="100" height="30" rx="4" fill="#e2e8f0"/>
            <rect x="260" y="80" width="120" height="30" rx="4" fill="#10b981"/>
            <text x="320" y="100" text-anchor="middle" fill="white" font-family="Arial" font-size="12">Submit</text>
            <text x="200" y="140" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="12">Mock design screenshot</text>
            <text x="200" y="160" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="10">Generated for demo purposes</text>
          </svg>
        `),
        width: 400,
        height: 200,
        size: '2.1 KB'
      };
    }

    // OpenAI API Communication
    async function callOpenAI(techStack, documentType) {
      const apiKey = document.getElementById('apiKey').value.trim();
      const model = document.getElementById('model').value;
      
      if (!apiKey) {
        throw new Error('Please enter your OpenAI API key');
      }
      
      const prompt = `Create a ${documentType} for a project using this tech stack: ${techStack}`;
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { 
              role: 'system', 
              content: 'You are a UX/UI ticket assistant. Generate clean, structured Jira tickets from tech stack descriptions. Focus on implementation details, acceptance criteria, and technical requirements.'
            },
            { role: 'user', content: prompt }
          ],
          max_tokens: 1500,
          temperature: 0.7
        })
      });
      
      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status}`);
      }
      
      const data = await response.json();
      return { 
        content: data.choices[0].message.content,
        isOpenAI: true 
      };
    }

    // Show error message
    function showError(message) {
      // Remove existing error messages
      document.querySelectorAll('.error-message').forEach(el => el.remove());
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      techStackInput.parentNode.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Show fallback notice
    function showFallbackNotice() {
      const notice = document.createElement('div');
      notice.className = 'fallback-notice';
      notice.innerHTML = '‚ö†Ô∏è Enhanced analysis temporarily unavailable - using fallback generation';
      
      resultsDiv.insertBefore(notice, resultsDiv.firstChild);
      
      setTimeout(() => {
        notice.remove();
      }, 8000);
    }

    // Copy to clipboard
    function copyToClipboard() {
      resultsTextarea.select();
      resultsTextarea.setSelectionRange(0, 99999);
      
      try {
        document.execCommand('copy');
        copyBtn.textContent = '‚úÖ Copied!';
        
        // Show copy success message
        const successDiv = document.createElement('div');
        successDiv.className = 'copy-success';
        successDiv.textContent = 'Content copied to clipboard successfully!';
        resultsDiv.appendChild(successDiv);
        
        setTimeout(() => {
          copyBtn.textContent = 'üìã Copy to Clipboard';
          successDiv.remove();
        }, 2000);
      } catch (err) {
        console.error('Copy failed:', err);
        copyBtn.textContent = '‚ùå Copy failed';
        setTimeout(() => {
          copyBtn.textContent = 'üìã Copy to Clipboard';
        }, 2000);
      }
    }

    // Update design health metrics (placeholder)
    function updateDesignHealth() {
      document.getElementById('overallScore').textContent = '87%';
      document.getElementById('complianceRate').textContent = '92%';
      document.getElementById('componentUsage').textContent = '78%';
      document.getElementById('tokenAdoption').textContent = '85%';
      
      document.getElementById('recommendations').innerHTML = `
        <div style="margin-bottom: 8px;">‚úÖ <strong>Good:</strong> High token adoption rate</div>
        <div style="margin-bottom: 8px;">‚ö†Ô∏è <strong>Improve:</strong> Increase component reuse in navigation areas</div>
        <div>üí° <strong>Suggestion:</strong> Consider standardizing button variants</div>
      `;
    }

    // Event listeners
    generateBtn.addEventListener('click', generateContent);
    copyBtn.addEventListener('click', copyToClipboard);
    
    // Tech stack input validation and suggestions
    techStackInput.addEventListener('input', () => {
      const techStack = parseTechStack(techStackInput.value);
      if (techStackInput.value.length > 20) {
        updateConfidenceIndicator(techStack.confidence, techStack.suggestions);
      } else {
        statusSection.style.display = 'none';
      }
    });

    // Enhanced tech stack interface event listeners
    const suggestionPills = document.querySelectorAll('.suggestion-pill');
    suggestionPills.forEach(pill => {
      pill.addEventListener('click', () => {
        const techStack = pill.textContent.trim();
        techStackInput.value = techStack;
        
        // Trigger the parse analysis
        const parsed = parseTechStack(techStack);
        updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
        
        // Visual feedback
        pill.style.transform = 'scale(0.95)';
        setTimeout(() => {
          pill.style.transform = '';
        }, 150);
      });
    });

    // Parse tech stack button functionality
    const parseButton = document.querySelector('.parse-tech-stack');
    if (parseButton) {
      parseButton.addEventListener('click', () => {
        const techStackValue = techStackInput.value.trim();
        if (!techStackValue) {
          techStackInput.focus();
          techStackInput.style.borderColor = '#f59e0b';
          setTimeout(() => {
            techStackInput.style.borderColor = '';
          }, 1000);
          return;
        }

        // Show loading state
        parseButton.innerHTML = '<span>üß†</span> Analyzing...';
        parseButton.disabled = true;

        // Simulate AI analysis with enhanced parsing (Phase 1)
        setTimeout(() => {
          // Create mock Figma context for enhanced analysis demo
          const mockFigmaContext = createMockFigmaContextForDemo(techStackValue);
          
          // Enhanced parsing with Figma context
          const parsed = parseTechStack(techStackValue, mockFigmaContext);
          updateConfidenceIndicator(parsed.confidence, parsed.suggestions);
          
          // Log enhanced analysis results
          if (parsed.enhanced) {
            console.log('‚ú® Enhanced tech stack analysis completed');
            console.log('üìä Design patterns detected:', parsed.designContext?.patterns || []);
            console.log('üß© Component types identified:', parsed.designContext?.componentTypes || []);
          }
          
          // Reset button
          parseButton.innerHTML = '<span>üß†</span> Parse Tech Stack';
          parseButton.disabled = false;
          
          // Show success feedback
          const indicator = document.querySelector('.confidence-indicator');
          if (indicator) {
            indicator.style.background = '#f0fdf4';
            indicator.style.padding = '8px 12px';
            indicator.style.borderRadius = '6px';
            indicator.style.border = '1px solid #bbf7d0';
            setTimeout(() => {
              indicator.style.background = '';
              indicator.style.padding = '';
              indicator.style.borderRadius = '';
              indicator.style.border = '';
            }, 2000);
          }
        }, 1500);
      });
    }

    // Initialize the application
    initializeTabs();
    initializeModeSelection();
    updateDesignHealth();

    console.log('üéØ Enhanced Figma Plugin loaded successfully');
  </script>

  <!-- Include Context Preview Component -->
  <script src="../components/context-preview.js"></script>

  <script>
    // Initialize context preview after component is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Additional initialization if needed
      console.log('üîç Context Preview component ready');
    });
  </script>
</body>
</html>