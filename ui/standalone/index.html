<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Enhanced Figma Plugin</title>
  <style>
    /* Modern CSS Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      line-height: 1.5;
      background: #f8fafc;
      color: #1a202c;
      padding: 20px;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 0.875rem;
    }

    .content {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    #techStackInput {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #techStackInput:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #documentType {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    #documentType:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #generate {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
    }

    #generate:hover {
      background: #2563eb;
    }

    #generate:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .confidence-indicator {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .confidence-high {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .confidence-medium {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    .confidence-low {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .suggestions {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .suggestion-pill {
      background: #f3f4f6;
      color: #374151;
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }

    .suggestion-pill:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin: 16px 0;
      display: none;
    }

    .progress-fill {
      height: 100%;
      background: #3b82f6;
      border-radius: 2px;
      animation: progress 2s ease-in-out infinite;
    }

    @keyframes progress {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      border: 1px solid #fca5a5;
      display: none;
    }

    .fallback-notice {
      background: #fef3c7;
      color: #92400e;
      padding: 12px;
      border-radius: 6px;
      margin: 16px 0;
      border: 1px solid #fcd34d;
      display: none;
    }

    #results {
      margin-top: 24px;
      display: none;
    }

    #generatedContent {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

    #copyBtn {
      background: #22c55e;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 12px;
      min-height: 44px;
    }

    #copyBtn:hover {
      background: #16a34a;
    }

    .copy-success {
      color: #22c55e;
      font-size: 12px;
      margin-left: 8px;
      display: none;
    }

    /* Accessibility improvements */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f9fafb;
      padding: 0 16px;
      margin-bottom: 24px;
    }
    
    .tab-button {
      background: none;
      border: none;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .tab-button.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
      background-color: #ffffff;
    }
    
    .tab-button:hover {
      color: #3b82f6;
      background-color: #f3f4f6;
    }
    
    /* Panel Headers */
    .panel-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 8px 0;
    }
    
    .panel-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    
    /* Output section */
    #output {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .output-placeholder {
      color: #6b7280;
      font-style: italic;
    }
    *:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    /* Tab Navigation Styles */
    .tab-nav {
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .tab-button:hover {
      color: #3b82f6;
      background-color: #f3f4f6;
    }

    .tab-button.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      body {
        padding: 12px;
      }
      
      #app {
        border-radius: 8px;
      }
      
      .header {
        padding: 16px;
      }
      
      .content {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="app" role="main">
    <header class="header">
      <h1>Enhanced Figma Plugin</h1>
      <p class="subtitle">Smart Tech Stack Detection & Professional Document Generation</p>
    </header>
    
    <!-- Tab Navigation -->
    <nav class="tab-nav" role="tablist" aria-label="Application sections">
      <button 
        class="tab-button active" 
        data-tab="generator" 
        role="tab" 
        aria-selected="true" 
        aria-controls="generator-tab"
        id="generator-tab-button"
      >
        🎫 Ticket Generator
      </button>
    </nav>
    
    <div class="content" id="generator-tab" role="tabpanel" aria-labelledby="generator-tab">
      <div class="panel-header">
        <h2 class="panel-title">Figma to Document Generator</h2>
        <p class="panel-subtitle">Transform Figma designs into professional documents</p>
      </div>
      <form role="form" aria-label="Document Generation Form">
        <div class="form-group">
          <label for="techStackInput">Tech Stack Description</label>
          <input 
            type="text" 
            id="techStackInput" 
            name="techStackInput"
            placeholder='Describe your tech stack (e.g., "React with TypeScript and Material-UI")'
            aria-label="Tech stack description"
            role="textbox"
            required
          />
          
          <div class="confidence-indicator" style="display: none;" aria-live="polite"></div>
          
          <div class="suggestions" aria-label="Tech stack suggestions"></div>
        </div>
        
        <div class="form-group">
          <label for="documentType">Document Type</label>
          <select id="documentType" name="documentType" aria-label="Document type selection" role="combobox">
            <option value="jira">Jira Ticket</option>
            <option value="confluence">Confluence Page</option>
            <option value="wiki">Wiki Documentation</option>
            <option value="agent">Agent Task</option>
          </select>
        </div>
        
        <button 
          type="button" 
          id="generate"
          data-generate-btn="generateBtn"
          role="button"
          aria-describedby="generate-help"
        >
          Generate Enhanced Document
        </button>
        
        <div id="generate-help" class="sr-only">
          Generates a professional document based on your tech stack description and selected format
        </div>
      </form>
      
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
      
      <div class="error-message" role="alert" aria-live="assertive"></div>
      <div class="fallback-notice" aria-live="polite"></div>
      
      <!-- Output section for test compatibility -->
      <div id="output" aria-label="Generation output area" role="region">
        <div class="output-placeholder">Ready to generate your document...</div>
      </div>
      
      <div id="results" aria-label="Generated document results" role="region">
        <h3>Generated Document</h3>
        <div id="generatedContent" role="region" aria-label="Generated document content"></div>
        <button id="copyBtn" type="button">📋 Copy to Clipboard</button>
        <span class="copy-success">✅ Copied to clipboard!</span>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let isGenerating = false;
    let currentTechStack = null;

    // DOM elements
    const techStackInput = document.getElementById('techStackInput');
    const documentType = document.getElementById('documentType');
    const generateBtn = document.getElementById('generate');
    const results = document.getElementById('results');
    const generatedContent = document.getElementById('generatedContent');
    const copyBtn = document.getElementById('copyBtn');
    const progressBar = document.querySelector('.progress-bar');
    const errorMessage = document.querySelector('.error-message');
    const fallbackNotice = document.querySelector('.fallback-notice');
    const confidenceIndicator = document.querySelector('.confidence-indicator');
    const suggestions = document.querySelector('.suggestions');
    const copySuccess = document.querySelector('.copy-success');

    // Tech stack parsing function
    function parseTechStack(description) {
      if (!description || description.length < 3) {
        return null;
      }

      const frameworks = ['React', 'Vue', 'Angular', 'Svelte', 'Next.js', 'Nuxt.js', 'SvelteKit'];
      const languages = ['JavaScript', 'TypeScript', 'Python', 'Java', 'C#', 'Go', 'Rust', 'Dart'];
      const styling = ['CSS', 'Sass', 'SCSS', 'Less', 'Tailwind', 'Material-UI', 'Chakra UI', 'styled-components'];
      const testing = ['Jest', 'Vitest', 'Cypress', 'Playwright', 'Jasmine', 'Mocha', 'React Testing Library'];

      const lowerDesc = description.toLowerCase();
      
      let matches = 0;
      let detectedFramework = null;
      let detectedLanguage = null;
      let detectedStyling = null;
      let detectedTesting = null;

      // Framework detection
      for (const framework of frameworks) {
        if (lowerDesc.includes(framework.toLowerCase())) {
          detectedFramework = framework;
          matches++;
          break;
        }
      }

      // Language detection
      for (const language of languages) {
        if (lowerDesc.includes(language.toLowerCase())) {
          detectedLanguage = language;
          matches++;
          break;
        }
      }

      // Styling detection
      for (const style of styling) {
        if (lowerDesc.includes(style.toLowerCase())) {
          detectedStyling = style;
          matches++;
          break;
        }
      }

      // Testing detection
      for (const test of testing) {
        if (lowerDesc.includes(test.toLowerCase())) {
          detectedTesting = test;
          matches++;
          break;
        }
      }

      const confidence = Math.min(95, Math.max(20, (matches * 20) + (description.length > 10 ? 10 : 0)));

      return {
        framework: detectedFramework,
        language: detectedLanguage,
        styling: detectedStyling,
        testing: detectedTesting,
        confidence: confidence,
        matches: matches,
        description: description
      };
    }

    // Update confidence indicator
    function updateConfidenceIndicator(techStack) {
      if (!techStack) {
        confidenceIndicator.style.display = 'none';
        suggestions.innerHTML = '';
        return;
      }

      confidenceIndicator.style.display = 'block';
      confidenceIndicator.textContent = `Confidence: ${techStack.confidence}% (${techStack.matches} matches detected)`;
      
      // Set confidence class
      confidenceIndicator.className = 'confidence-indicator';
      if (techStack.confidence >= 80) {
        confidenceIndicator.classList.add('confidence-high');
      } else if (techStack.confidence >= 60) {
        confidenceIndicator.classList.add('confidence-medium');
      } else {
        confidenceIndicator.classList.add('confidence-low');
      }

      // Update suggestions
      suggestions.innerHTML = '';
      const detected = [techStack.framework, techStack.language, techStack.styling, techStack.testing]
        .filter(Boolean);
      
      detected.forEach(item => {
        const pill = document.createElement('span');
        pill.className = 'suggestion-pill';
        pill.textContent = item;
        pill.setAttribute('role', 'button');
        pill.setAttribute('tabindex', '0');
        suggestions.appendChild(pill);
      });
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    // Show fallback notice
    function showFallback(message) {
      fallbackNotice.textContent = message;
      fallbackNotice.style.display = 'block';
      setTimeout(() => {
        fallbackNotice.style.display = 'none';
      }, 8000);
    }

    // Generate document
    async function generateDocument() {
      const techStackDesc = techStackInput.value.trim();
      
      if (!techStackDesc) {
        showError('Please describe your tech stack before generating a document.');
        return;
      }

      if (isGenerating) {
        return;
      }

      isGenerating = true;
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';
      progressBar.style.display = 'block';
      results.style.display = 'none';

      try {
        currentTechStack = parseTechStack(techStackDesc);
        
        // Try MCP server first
        let content = null;
        let usedMCP = false;

        try {
          const mcpResponse = await fetch('http://localhost:3000', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              jsonrpc: '2.0',
              method: 'generate_enhanced_ticket',
              params: {
                description: `Generate ${documentType.value} document for: ${techStackDesc}`,
                documentType: documentType.value,
                techStackContext: currentTechStack
              },
              id: 1
            }),
            timeout: 10000
          });

          if (mcpResponse.ok) {
            const mcpData = await mcpResponse.json();
            if (mcpData.content && mcpData.content[0] && mcpData.content[0].text) {
              content = mcpData.content[0].text;
              usedMCP = true;
              
              // Check if this is fallback content
              if (mcpData.isFallback) {
                showFallback(mcpData.fallbackReason || 'Enhanced analysis temporarily unavailable');
              }
            }
          }
        } catch (mcpError) {
          console.log('MCP server unavailable:', mcpError.message);
          showFallback('Enhanced analysis temporarily unavailable');
        }

        // Fallback to basic generation
        if (!content) {
          content = generateBasicDocument(techStackDesc, documentType.value, currentTechStack);
        }

        // Display results
        generatedContent.textContent = content;
        results.style.display = 'block';
        
        if (usedMCP) {
          console.log('✅ Used enhanced MCP generation');
        }

      } catch (error) {
        console.error('Generation error:', error);
        showError('❌ Failed to generate document. Please try again.');
      } finally {
        isGenerating = false;
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate Enhanced Document';
        progressBar.style.display = 'none';
      }
    }

    // Basic document generation (fallback)
    function generateBasicDocument(description, type, techStack) {
      const timestamp = new Date().toLocaleString();
      
      if (type === 'jira') {
        return `# Feature Implementation

**Summary:** Implement feature based on requirements

**Description:**
${description}

**Tech Stack Context:**
${techStack ? `- Framework: ${techStack.framework || 'Not specified'}
- Language: ${techStack.language || 'Not specified'}  
- Styling: ${techStack.styling || 'Not specified'}
- Testing: ${techStack.testing || 'Not specified'}
- Detection Confidence: ${techStack.confidence}%` : 'No tech stack analysis available'}

**Acceptance Criteria:**
1. ✅ Feature matches design specifications
2. ✅ Code follows project conventions
3. ✅ Unit tests are included
4. ✅ Documentation is updated

**Story Points:** ${techStack && techStack.confidence > 70 ? '3' : '5'}

**Labels:** feature, ${techStack?.framework?.toLowerCase() || 'development'}

**Generated:** ${timestamp}`;

      } else if (type === 'confluence') {
        return `# Technical Specification

## Overview
${description}

## Technical Details
${techStack ? `
### Technology Stack
- **Framework:** ${techStack.framework || 'TBD'}
- **Language:** ${techStack.language || 'TBD'}
- **Styling:** ${techStack.styling || 'TBD'}  
- **Testing:** ${techStack.testing || 'TBD'}
- **Analysis Confidence:** ${techStack.confidence}%
` : ''}

## Implementation Guidelines
1. Follow existing code patterns
2. Ensure proper error handling
3. Add comprehensive tests
4. Update documentation

## Acceptance Criteria
- [ ] Functionality works as expected
- [ ] Code quality meets standards
- [ ] Tests pass with coverage
- [ ] Documentation complete

**Generated:** ${timestamp}`;

      } else { // agent
        return JSON.stringify({
          task: "implement_feature",
          description: description,
          techStackContext: techStack,
          requirements: [
            "Follow project conventions",
            "Include tests",
            "Update documentation"
          ],
          priority: "medium",
          estimatedEffort: techStack && techStack.confidence > 70 ? "medium" : "high",
          generated: timestamp
        }, null, 2);
      }
    }

    // Copy to clipboard
    async function copyToClipboard() {
      try {
        await navigator.clipboard.writeText(generatedContent.textContent);
        copySuccess.style.display = 'inline';
        setTimeout(() => {
          copySuccess.style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error('Copy failed:', error);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = generatedContent.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        copySuccess.style.display = 'inline';
        setTimeout(() => {
          copySuccess.style.display = 'none';
        }, 3000);
      }
    }

    // Event listeners
    techStackInput.addEventListener('input', () => {
      const techStack = parseTechStack(techStackInput.value);
      updateConfidenceIndicator(techStack);
      
      // Hide error when user starts typing
      if (errorMessage.style.display === 'block') {
        errorMessage.style.display = 'none';
      }
    });

    generateBtn.addEventListener('click', generateDocument);
    copyBtn.addEventListener('click', copyToClipboard);

    // Keyboard support
    generateBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        generateDocument();
      }
    });

    copyBtn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        copyToClipboard();
      }
    });

    // Initialize
    console.log('✅ Enhanced Figma Plugin UI loaded');
  </script>
</body>
</html>