<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Ticket Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    /* Main Layout - 50/50 Split */
    .main-container {
      display: flex;
      gap: 20px;
      min-height: calc(100vh - 40px);
    }
    
    .panel {
      flex: 1;
      min-width: 0; /* Prevents flex items from overflowing */
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--figma-color-border);
    }
    
    .panel-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--figma-color-text);
      margin: 0;
    }
    
    .panel-subtitle {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin: 4px 0 0 0;
    }
    
    /* Health Metrics Panel Styles */
    .health-panel {
      background: var(--figma-color-bg);
      border-right: 1px solid var(--figma-color-border);
      padding-right: 20px;
    }
    
    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .metric-value.excellent { color: #0d9f3c; }
    .metric-value.good { color: #f4a113; }
    .metric-value.needs-attention { color: #e34f47; }
    
    .metric-label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .detailed-metrics {
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--figma-color-text);
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--figma-color-border-subtle);
    }
    
    .metric-row:last-child {
      border-bottom: none;
    }
    
    .metric-name {
      font-size: 11px;
      color: var(--figma-color-text);
    }
    
    .metric-score {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .metric-score.high {
      background: var(--figma-color-bg-success-tertiary);
      color: var(--figma-color-text-success);
    }
    
    .metric-score.medium {
      background: var(--figma-color-bg-warning-tertiary);
      color: var(--figma-color-text-warning);
    }
    
    .metric-score.low {
      background: var(--figma-color-bg-danger-tertiary);
      color: var(--figma-color-text-danger);
    }
    
    /* Ticket Panel Styles */
    .ticket-panel {
      background: var(--figma-color-bg);
      padding-left: 20px;
    }
    
    /* Compliance Analysis Styles */
    .analysis-summary {
      margin-bottom: 12px;
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
    }
    
    .summary-stat {
      display: flex;
      justify-content: space-between;
    }
    
    .stat-label {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }
    
    .stat-value {
      font-weight: 600;
      color: var(--figma-color-text);
    }
    
    .breakdown-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }
    
    .breakdown-item {
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      text-align: center;
    }
    
    .breakdown-label {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 4px;
    }
    
    .breakdown-score {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .breakdown-score.excellent {
      color: var(--figma-color-text-success);
    }
    
    .breakdown-score.good {
      color: var(--figma-color-text-success);
    }
    
    .breakdown-score.medium {
      color: var(--figma-color-text-warning);
    }
    
    .breakdown-score.needs-attention {
      color: var(--figma-color-text-warning);
    }
    
    .breakdown-score.poor {
      color: var(--figma-color-text-danger);
    }
    
    .breakdown-details {
      font-size: 10px;
      color: var(--figma-color-text-tertiary);
    }
    
    /* Recommendation Styles */
    .recommendation-item {
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 3px solid;
    }
    
    .recommendation-item.high {
      background: var(--figma-color-bg-danger-tertiary);
      border-color: var(--figma-color-border-danger);
    }
    
    .recommendation-item.medium {
      background: var(--figma-color-bg-warning-tertiary);
      border-color: var(--figma-color-border-warning);
    }
    
    .recommendation-item.low {
      background: var(--figma-color-bg-secondary);
      border-color: var(--figma-color-border);
    }
    
    .rec-priority {
      font-size: 9px;
      font-weight: 600;
      color: var(--figma-color-text-secondary);
      margin-bottom: 2px;
    }
    
    .rec-category {
      font-size: 11px;
      font-weight: 600;
      color: var(--figma-color-text);
      margin-bottom: 4px;
    }
    
    .rec-description {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 4px;
    }
    
    .rec-action {
      font-size: 10px;
      color: var(--figma-color-text);
      font-style: italic;
    }
    
    .placeholder-text.error {
      color: var(--figma-color-text-danger);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      line-height: 1.4;
      min-height: 100vh;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    h1 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--figma-color-text);
    }
    
    .subtitle {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      margin-bottom: 16px;
    }
    
    .config-section {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .config-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 12px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--figma-color-border-selected);
      box-shadow: 0 0 0 1px var(--figma-color-border-selected);
    }
    
    .button {
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .button:hover {
      background: var(--figma-color-bg-brand-hover);
    }
    
    .button:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      cursor: not-allowed;
    }
    
    .button-secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .button-secondary:hover {
      background: var(--figma-color-bg-hover);
    }
    
    /* Radio Button Styles */
    .mode-selection {
      margin-bottom: 16px;
    }
    
    .radio-group {
      margin-bottom: 12px;
    }
    
    .radio-group input[type="radio"] {
      display: none;
    }
    
    .radio-group label {
      display: flex;
      flex-direction: column;
      padding: 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--figma-color-bg);
    }
    
    .radio-group input[type="radio"]:checked + label {
      border-color: var(--figma-color-border-brand);
      background: var(--figma-color-bg-brand-secondary);
    }
    
    .radio-group label:hover {
      border-color: var(--figma-color-border-brand);
    }
    
    .radio-label {
      font-weight: 600;
      font-size: 12px;
      color: var(--figma-color-text);
      margin-bottom: 4px;
    }
    
    .radio-description {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 1.4;
    }
    
    .mcp-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      font-size: 11px;
    }
    
    .status-indicator {
      font-size: 14px;
    }
    
    .status-text {
      color: var(--figma-color-text-secondary);
    }
    
    .output-section {
      margin-top: 16px;
    }
    
    #output {
      min-height: 200px;
      resize: vertical;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 11px;
    }
    
    .status.error {
      background: var(--figma-color-bg-danger);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-danger);
    }
    
    .status.success {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-success);
    }
    
    .status.loading {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .hidden {
      display: none;
    }
    
    .frame-info {
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      border-left: 3px solid var(--figma-color-bg-brand);
      font-size: 11px;
    }
    
    .frame-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .frame-details {
      color: var(--figma-color-text-secondary);
    }
    
    .template-select {
      margin-bottom: 16px;
    }
    
    /* Design System Styles */
    .design-system-detected {
      background: linear-gradient(135deg, var(--figma-color-bg-success-tertiary), var(--figma-color-bg-brand-tertiary));
      border: 1px solid var(--figma-color-border-success);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .ds-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .ds-name {
      font-weight: 600;
      color: var(--figma-color-text);
      font-size: 13px;
    }
    
    .ds-confidence {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
    }
    
    .ds-stats {
      display: flex;
      gap: 12px;
    }
    
    .ds-stat {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }
    
    .compliance-info {
      background: var(--figma-color-bg-tertiary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }
    
    .compliance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .compliance-title {
      font-weight: 600;
      font-size: 12px;
    }
    
    .compliance-score {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }
    
    .compliance-breakdown {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .compliance-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: var(--figma-color-bg);
      border-radius: 4px;
      border: 1px solid var(--figma-color-border);
    }
    
    .item-label {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 2px;
    }
    
    .item-score {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 8px;
      color: white;
    }
    
    .recommendations {
      border-top: 1px solid var(--figma-color-border);
      padding-top: 12px;
    }
    
    .rec-title {
      font-weight: 600;
      font-size: 11px;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }
    
    .rec-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .rec-item {
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid;
    }
    
    .rec-item.high {
      background: var(--figma-color-bg-danger-tertiary);
      border-left-color: var(--figma-color-bg-danger);
    }
    
    .rec-item.medium {
      background: var(--figma-color-bg-warning-tertiary);
      border-left-color: var(--figma-color-bg-warning);
    }
    
    .rec-item.low {
      background: var(--figma-color-bg-success-tertiary);
      border-left-color: var(--figma-color-bg-success);
    }
    
    .rec-message {
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--figma-color-text);
    }
    
    .rec-suggestion {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }
    
    /* Tab Navigation Styles */
    .tab-header {
      background: var(--figma-color-bg);
      border-bottom: 1px solid var(--figma-color-border);
      padding: 12px 16px 0;
    }
    
    .tab-nav {
      display: flex;
      gap: 4px;
    }
    
    .tab-btn {
      background: none;
      border: none;
      padding: 8px 16px;
      border-radius: 6px 6px 0 0;
      font-size: 12px;
      font-weight: 500;
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      border-bottom: none;
    }
    
    .tab-btn:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }
    
    .tab-btn.active {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
      border-bottom: 1px solid var(--figma-color-bg);
      margin-bottom: -1px;
    }
    
    .tab-container {
      width: 100%;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
      min-height: 400px;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>

<body>
  <!-- Tab Navigation -->
  <div class="tab-header">
    <div class="tab-nav">
      <button class="tab-btn" data-tab="health">ðŸ“Š Design Health</button>
      <button class="tab-btn active" data-tab="generator">ðŸŽ« Ticket Generator</button>
    </div>
  </div>

  <!-- Tab Content Container -->
  <div class="tab-container">
    <!-- Health Metrics Tab -->
    <div class="tab-content" id="health-tab">
      <div class="panel health-panel">
        <div class="panel-header">
        <h2 class="panel-title">ðŸ“Š Design System Health</h2>
      </div>
      <p class="panel-subtitle">Real-time compliance and usage metrics</p>
      
      <!-- Overall Health Score -->
      <div class="metric-grid">
        <div class="metric-card">
          <div class="metric-value excellent" id="overallScore">--</div>
          <div class="metric-label">Overall Score</div>
        </div>
        <div class="metric-card">
          <div class="metric-value good" id="complianceRate">--</div>
          <div class="metric-label">Compliance Rate</div>
        </div>
        <div class="metric-card">
          <div class="metric-value good" id="componentUsage">--</div>
          <div class="metric-label">Component Usage</div>
        </div>
        <div class="metric-card">
          <div class="metric-value needs-attention" id="tokenAdoption">--</div>
          <div class="metric-label">Token Adoption</div>
        </div>
      </div>
      
      <!-- Detailed Metrics -->
      <div class="detailed-metrics">
        <div class="section-title">Component Analysis</div>
        <div class="metric-row">
          <span class="metric-name">Standard Components</span>
          <span class="metric-score high" id="standardComponents">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Custom Components</span>
          <span class="metric-score medium" id="customComponents">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Most Used Component</span>
          <span class="metric-score high" id="topComponent">--</span>
        </div>
      </div>
      
      <div class="detailed-metrics">
        <div class="section-title">Token Adoption</div>
        <div class="metric-row">
          <span class="metric-name">Color Tokens</span>
          <span class="metric-score high" id="colorTokens">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Typography Tokens</span>
          <span class="metric-score medium" id="typographyTokens">--</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Spacing Tokens</span>
          <span class="metric-score low" id="spacingTokens">--</span>
        </div>
      </div>
      
      <!-- Health Recommendations -->
      <div class="detailed-metrics">
        <div class="section-title">Recommendations</div>
        <div id="healthRecommendations">
          <div class="metric-row">
            <span class="metric-name">Loading health data...</span>
          </div>
        </div>
      </div>
      </div>
    </div>
    <!-- End Health Tab -->

    <!-- Ticket Generator Tab -->
    <div class="tab-content active" id="generator-tab">
      <div class="panel ticket-panel">
      <div class="panel-header">
        <h2 class="panel-title">ðŸŽ« AI Ticket Generator</h2>
      </div>
      <p class="panel-subtitle">Generate Jira tickets from selected Figma frames</p>

      <div class="config-section">
        <div class="config-title">Generation Mode</div>
        
        <div class="mode-selection">
          <div class="radio-group">
            <input type="radio" id="modeMCP" name="generationMode" value="mcp" checked>
            <label for="modeMCP">
              <span class="radio-label">ðŸš€ MCP Server (Enhanced)</span>
              <span class="radio-description">Local Model Context Protocol server with strategic design analysis</span>
            </label>
          </div>
          
          <div class="radio-group">
            <input type="radio" id="modeOpenAI" name="generationMode" value="openai">
            <label for="modeOpenAI">
              <span class="radio-label">ðŸ¤– OpenAI API</span>
              <span class="radio-description">Cloud-based AI generation (requires API key)</span>
            </label>
          </div>
        </div>
      </div>

      <!-- OpenAI Configuration (hidden by default) -->
      <div class="config-section" id="openaiConfig" style="display: none;">
        <div class="config-title">OpenAI Configuration</div>
        
        <div class="form-group">
          <label for="apiKey">OpenAI API Key</label>
          <input type="password" id="apiKey" placeholder="sk-..." />
        </div>
        
        <div class="form-group">
          <label for="model">Model</label>
          <select id="model">
            <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
            <option value="gpt-4o">GPT-4o</option>
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
          </select>
        </div>
      </div>

      <!-- MCP Configuration (visible by default) -->
      <div class="config-section" id="mcpConfig">
        <div class="config-title">MCP Configuration</div>
        <div class="mcp-status">
          <span class="status-indicator" id="mcpStatus">ðŸ”„ Checking...</span>
          <span class="status-text" id="mcpStatusText">Connecting to MCP server...</span>
        </div>
      </div>

      <div class="config-section">
        <div class="config-title">Ticket Template</div>
        
        <div class="form-group template-select">
          <label for="template">Template Type</label>
          <select id="template">
            <option value="component">UI Component</option>
            <option value="feature">Feature Implementation</option>
            <option value="bug">Bug Fix</option>
            <option value="page">Page/Screen</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="customPrompt">Additional Instructions (Optional)</label>
          <textarea id="customPrompt" rows="3" placeholder="e.g., Include accessibility requirements, use specific design tokens..."></textarea>
        </div>
      </div>

      <!-- Design System Integration for Tickets -->
      <div id="designSystemSection" class="config-section hidden">
        <div class="config-title">ðŸŽ¨ Design System Integration</div>
        
        <div id="designSystemInfo">
          <div class="design-system-detected">
            <div class="ds-header">
              <span class="ds-name" id="dsName">Design System Detected</span>
              <span class="ds-confidence" id="dsConfidence">85%</span>
            </div>
            <div class="ds-stats">
              <span class="ds-stat" id="dsColors">12 colors</span>
              <span class="ds-stat" id="dsTypography">8 text styles</span>
              <span class="ds-stat" id="dsComponents">24 components</span>
            </div>
          </div>
        </div>

        <div id="complianceInfo" class="compliance-info hidden">
          <div class="compliance-header">
            <span class="compliance-title">Compliance Analysis</span>
            <span class="compliance-score" id="complianceScore">92%</span>
          </div>
          <div class="compliance-breakdown">
            <div class="compliance-item">
              <span class="item-label">Colors:</span>
              <span class="item-score" id="colorScore">95%</span>
            </div>
            <div class="compliance-item">
              <span class="item-label">Typography:</span>
              <span class="item-score" id="typographyScore">88%</span>
            </div>
            <div class="compliance-item">
              <span class="item-label">Components:</span>
              <span class="item-score" id="componentScore">94%</span>
            </div>
          </div>
          
          <div id="recommendations" class="recommendations hidden">
            <div class="rec-title">Recommendations:</div>
            <div id="recList" class="rec-list"></div>
          </div>
        </div>
      </div>

      <div id="frameInfo" class="hidden"></div>
      <div id="status" class="hidden"></div>

      <button id="generate" class="button">
        ðŸ“‹ Generate Ticket from Selection
      </button>

      <div class="output-section">
        <label for="output">Generated Ticket</label>
        <textarea id="output" placeholder="Select frames in Figma and click 'Generate Ticket' to create a Jira ticket draft..."></textarea>
        
        <button id="copy" class="button button-secondary" disabled>
          ðŸ“‹ Copy to Clipboard
        </button>
      </div>
        </div>
      </div>
    </div>
    <!-- End Generator Tab -->
  </div>
  <!-- End Tab Container -->

  <script>
    // UI Elements
    const generateBtn = document.getElementById('generate');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy');
    const apiKeyInput = document.getElementById('apiKey');
    const modelSelect = document.getElementById('model');
    const templateSelect = document.getElementById('template');
    const customPromptInput = document.getElementById('customPrompt');
    const statusDiv = document.getElementById('status');
    const frameInfoDiv = document.getElementById('frameInfo');
    
    // Mode Selection Elements
    const modeMCP = document.getElementById('modeMCP');
    const modeOpenAI = document.getElementById('modeOpenAI');
    const openaiConfig = document.getElementById('openaiConfig');
    const mcpConfig = document.getElementById('mcpConfig');
    const mcpStatus = document.getElementById('mcpStatus');
    const mcpStatusText = document.getElementById('mcpStatusText');

    // Tab Management
    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Remove active class from all tabs and buttons
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          btn.classList.add('active');
          const targetContent = document.getElementById(`${targetTab}-tab`);
          if (targetContent) {
            targetContent.classList.add('active');
          }
        });
      });
    }

    // State
    let frameDataList = [];
    let isGenerating = false;
    let currentFileKey = '';
    let currentFileName = '';
    
    // MCP Server Communication
    async function callMCPServer(method, params) {
      try {
        console.log('ðŸ” Calling MCP server:', method, params);
        
        const response = await fetch('http://localhost:3000', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            method: method,
            params: params
          }),
        });
        
        console.log('ðŸ“¡ MCP response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`MCP Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ðŸ“¦ MCP response data:', data);
        return data.result || data;
      } catch (error) {
        console.warn('MCP Server not available:', error);
        return null;
      }
    }
    
    // Mode Switching Functions
    function initializeModeSelection() {
      // Set up radio button event listeners
      modeMCP.addEventListener('change', handleModeChange);
      modeOpenAI.addEventListener('change', handleModeChange);
      
      // Initialize with MCP mode
      handleModeChange();
      checkMCPServerStatus();
    }
    
    function handleModeChange() {
      const selectedMode = document.querySelector('input[name="generationMode"]:checked').value;
      
      if (selectedMode === 'mcp') {
        openaiConfig.style.display = 'none';
        mcpConfig.style.display = 'block';
        generateBtn.textContent = 'ðŸš€ Generate Ticket with MCP';
      } else {
        openaiConfig.style.display = 'block';
        mcpConfig.style.display = 'none';
        generateBtn.textContent = 'ðŸ¤– Generate Ticket with OpenAI';
      }
    }
    
    async function checkMCPServerStatus() {
      try {
        mcpStatus.textContent = 'ðŸ”„';
        mcpStatusText.textContent = 'Checking MCP server...';
        
        const response = await fetch('http://localhost:3000', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ method: 'ping' })
        });
        
        if (response.ok) {
          mcpStatus.textContent = 'âœ…';
          mcpStatusText.textContent = 'MCP server connected (localhost:3000)';
        } else {
          throw new Error('Server responded with error');
        }
      } catch (error) {
        mcpStatus.textContent = 'âŒ';
        mcpStatusText.textContent = 'MCP server unavailable';
        console.warn('MCP server check failed:', error);
      }
    }

    // Load saved settings
    loadSettings();

    // Initialize tabs and mode selection
    initializeTabs();
    initializeModeSelection();

    // Event listeners
    generateBtn.onclick = generateTicket;
    copyBtn.onclick = copyToClipboard;
    apiKeyInput.onchange = saveSettings;
    modelSelect.onchange = saveSettings;
    templateSelect.onchange = saveSettings;

    // Auto-trigger compliance analysis on user interaction
    document.addEventListener('click', () => {
      setTimeout(() => {
        parent.postMessage({ 
          pluginMessage: { type: 'calculate-compliance' } 
        }, '*');
      }, 500);
    });

    // Global variables for file context
    let globalFileKey = '';
    let globalFileName = '';

    // Message handling from Figma plugin
    onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'file-context') {
        currentFileKey = msg.fileKey || '';
        currentFileName = msg.fileName || '';
        console.log('ðŸ“ File context received:', { fileKey: currentFileKey, fileName: currentFileName });
      }
      
      if (msg.type === 'frame-data') {
        frameDataList = msg.data;
        displayFrameInfo(frameDataList);
        displayComplianceInfo(frameDataList);
        await generateAITicket();
      }

      if (msg.type === 'error') {
        showStatus(msg.message, 'error');
        setGenerating(false);
      }

      if (msg.type === 'design-system-detected') {
        displayDesignSystemInfo(msg.designSystem);
        // Auto-calculate compliance when design system is detected
        triggerComplianceCalculation();
      }

      if (msg.type === 'no-design-system') {
        hideDesignSystemSection();
        updateHealthMetrics(null);
      }

      if (msg.type === 'compliance-results') {
        displayComplianceResults(msg.compliance, msg.selectionCount);
      }

      if (msg.type === 'compliance-error') {
        showComplianceError(msg.message);
      }
    };

    function generateTicket() {
      if (isGenerating) return;
      
      setGenerating(true);
      showStatus('Reading selected frames...', 'loading');
      
      // Request frame data from Figma
      parent.postMessage({ 
        pluginMessage: { type: 'generate-ticket' } 
      }, '*');
    }

    async function generateAITicket() {
      if (!frameDataList.length) {
        showStatus('No frame data received', 'error');
        setGenerating(false);
        return;
      }

      const selectedMode = document.querySelector('input[name="generationMode"]:checked').value;
      console.log('ðŸš€ Starting ticket generation in mode:', selectedMode);

      if (selectedMode === 'mcp') {
        await generateWithMCP();
      } else {
        await generateWithOpenAI();
      }
    }
    
    async function generateWithMCP() {
      try {
        showStatus('ðŸ” Analyzing project with MCP...', 'loading');
        
        // Enhanced payload with Figma context
        const mcpTickets = await callMCPServer('generate_tickets', {
          frameData: frameDataList,
          template: templateSelect.value,
          projectName: currentFileName || 'Figma Design',
          figmaContext: {
            fileKey: currentFileKey,
            fileName: currentFileName,
            figmaUrl: currentFileKey ? `https://www.figma.com/file/${currentFileKey}` : null,
            frameUrls: frameDataList.map(frame => 
              currentFileKey ? `https://www.figma.com/file/${currentFileKey}?node-id=${encodeURIComponent(frame.id)}` : null
            ).filter(Boolean)
          },
          instructions: customPromptInput.value || 'Generate comprehensive development tickets with design system compliance.'
        });
        
        showStatus('ðŸŽ« Processing MCP results...', 'loading');
        console.log('ðŸ“¦ MCP response received:', mcpTickets);
        
        if (mcpTickets && mcpTickets.content && mcpTickets.content.length > 0) {
          const ticketText = mcpTickets.content[0].text;
          
          output.value = ticketText;
          copyBtn.disabled = false;
          showStatus('âœ… Enhanced tickets generated with MCP!', 'success');
          return;
        }
        
        throw new Error('MCP server returned no content');
        
      } catch (error) {
        console.error('âŒ MCP generation failed:', error);
        
        // Fallback for MCP mode
        const fallbackTicket = generateFallbackTicket();
        output.value = fallbackTicket;
        copyBtn.disabled = false;
        showStatus('âš ï¸ Fallback ticket generated (MCP server unavailable)', 'error');
      } finally {
        setGenerating(false);
      }
    }
    
    async function generateWithOpenAI() {
      try {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
          showStatus('Please enter your OpenAI API key', 'error');
          setGenerating(false);
          return;
        }
        
        showStatus('ðŸ¤– Generating ticket with OpenAI...', 'loading');
        
        const prompt = createPrompt(frameDataList);
        const model = modelSelect.value;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: model,
            messages: [
              { 
                role: 'system', 
                content: 'You are a UX/UI ticket assistant. Generate clean, structured Jira tickets from Figma design context. Focus on implementation details, acceptance criteria, and technical requirements.' 
              },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 1000
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || `API request failed: ${response.status}`);
        }

        const data = await response.json();
        const ticket = data.choices[0].message.content.trim();
        
        output.value = ticket;
        copyBtn.disabled = false;
        showStatus('âœ… Ticket generated successfully with OpenAI!', 'success');
        
      } catch (error) {
        console.error('âŒ OpenAI generation failed:', error);
        showStatus(`Error: ${error.message}`, 'error');
      } finally {
        setGenerating(false);
      }
    }
    
    function generateFallbackTicket() {
      return `# Generated Ticket (Fallback)

## ${frameDataList[0]?.name || 'Component'} Implementation

### Description
Implement the ${frameDataList[0]?.name || 'selected component'} based on Figma design specifications.

### Acceptance Criteria
- [ ] Component matches design specifications
- [ ] Component is responsive across all devices  
- [ ] Component passes accessibility testing
- [ ] Unit tests provide adequate coverage

### Technical Notes
- Based on ${frameDataList.length} selected frame(s)
- Generated with local fallback (MCP server unavailable)
- Node count: ${frameDataList[0]?.nodeCount || 'Unknown'}
- Dimensions: ${frameDataList[0]?.dimensions?.width || 0}x${frameDataList[0]?.dimensions?.height || 0}px

### Priority
Medium

### Story Points
${Math.max(3, Math.min(8, Math.ceil((frameDataList[0]?.nodeCount || 0) / 5)))}

---
*Generated at ${new Date().toISOString()}*`;
    }
    
    // Original generateAITicket function content for reference - now split into mode-specific functions
    async function originalGenerateAITicket() {

      try {
        showStatus('ðŸ” Analyzing project with MCP...', 'loading');
        
        // Use MCP to generate tickets directly with frame data (no file key needed)
        const mcpTickets = await callMCPServer('generate_tickets', {
          frameData: frameDataList,
          template: templateSelect.value,
          projectName: currentFileName || 'Figma Design'
        });
        
        showStatus('ðŸŽ« Processing MCP results...', 'loading');
        console.log('ðŸ“¦ MCP response received:', mcpTickets);
        
        // If MCP server is available, use the enhanced tickets
        if (mcpTickets && mcpTickets.content && mcpTickets.content.length > 0) {
          // MCP returns content array, extract the text
          const ticketText = mcpTickets.content[0].text;
          
          output.value = ticketText;
          copyBtn.disabled = false;
          showStatus('âœ… Enhanced tickets generated with MCP!', 'success');
          setGenerating(false);
          return;
        }
        
        // If MCP failed, generate a simple fallback ticket (NO API KEY REQUIRED)
        console.log('ðŸ”„ MCP failed, generating fallback ticket without API');
        
        const fallbackTicket = `# Generated Ticket (Fallback)

## ${frameDataList[0]?.name || 'Component'} Implementation

### Description
Implement the ${frameDataList[0]?.name || 'selected component'} based on Figma design specifications.

### Acceptance Criteria
- [ ] Component matches design specifications
- [ ] Component is responsive across all devices
- [ ] Component passes accessibility testing
- [ ] Unit tests provide adequate coverage

### Technical Notes
- Based on ${frameDataList.length} selected frame(s)
- Generated with local fallback (MCP server unavailable)
- Node count: ${frameDataList[0]?.nodeCount || 'Unknown'}
- Dimensions: ${frameDataList[0]?.dimensions?.width || 0}x${frameDataList[0]?.dimensions?.height || 0}px

### Priority
Medium

### Story Points
${Math.max(3, Math.min(8, (frameDataList[0]?.nodeCount || 0) / 5))}

---
*Generated at ${new Date().toISOString()}*`;
        
        output.value = fallbackTicket;
        copyBtn.disabled = false;
        showStatus('âš ï¸ Fallback ticket generated (MCP server unavailable)', 'error');
        
      } catch (error) {
        console.error('âŒ Error in ticket generation:', error);
        
        // Final fallback - always works
        const simpleTicket = `# Simple Ticket

## Component Implementation

### Description
Implement the selected component based on Figma design.

### Acceptance Criteria
- [ ] Match design specifications
- [ ] Ensure responsiveness
- [ ] Pass accessibility tests

---
*Generated at ${new Date().toISOString()}*`;
        
        output.value = simpleTicket;
        copyBtn.disabled = false;
        showStatus('âš ï¸ Simple ticket generated (errors occurred)', 'error');
      } finally {
        setGenerating(false);
      }
    }

    function createPrompt(frameDataList) {
      const template = templateSelect.value;
      const customInstructions = customPromptInput.value.trim();
      
      let basePrompt = '';
      
      switch (template) {
        case 'component':
          basePrompt = 'Generate a Jira ticket for implementing a UI component based on the following Figma design:';
          break;
        case 'feature':
          basePrompt = 'Generate a Jira ticket for implementing a new feature based on the following Figma design:';
          break;
        case 'bug':
          basePrompt = 'Generate a Jira ticket for fixing a UI/UX issue based on the following Figma design:';
          break;
        case 'page':
          basePrompt = 'Generate a Jira ticket for implementing a page/screen based on the following Figma design:';
          break;
        default:
          basePrompt = 'Generate a Jira ticket based on the following Figma design:';
      }

      let prompt = basePrompt + '\\n\\n';

      frameDataList.forEach((frame, index) => {
        prompt += `**Frame ${index + 1}: ${frame.name}**\\n`;
        prompt += `- Page: ${frame.pageName}\\n`;
        prompt += `- Type: ${frame.type}\\n`;
        prompt += `- Dimensions: ${frame.dimensions.width}x${frame.dimensions.height}px\\n`;
        prompt += `- Child elements: ${frame.nodeCount}\\n`;
        
        if (frame.textContent.length > 0) {
          prompt += `- Text content: ${frame.textContent.map(t => `"${t.content}"`).join(', ')}\\n`;
        }
        
        if (frame.components.length > 0) {
          prompt += `- Components used: ${frame.components.map(c => c.masterComponent).join(', ')}\\n`;
        }
        
        if (frame.colors.length > 0) {
          prompt += `- Colors: ${frame.colors.join(', ')}\\n`;
        }
        
        if (frame.hasPrototype) {
          prompt += `- Has interactive prototype\\n`;
        }

        // Add design system context if available
        if (frame.designSystemContext) {
          const context = frame.designSystemContext;
          
          if (context.designSystem) {
            prompt += `\\n**Design System Information:**\\n`;
            prompt += `- Design System: ${context.designSystem.name}\\n`;
            prompt += `- Detection Confidence: ${Math.round(context.designSystem.detectionConfidence * 100)}%\\n`;
          }

          if (context.complianceReport) {
            const report = context.complianceReport;
            prompt += `\\n**Design System Compliance:**\\n`;
            prompt += `- Overall Score: ${report.overallScore}%\\n`;
            prompt += `- Color Compliance: ${report.colorCompliance.score}% (${report.colorCompliance.tokenizedColors}/${report.colorCompliance.totalColors} using tokens)\\n`;
            prompt += `- Typography Compliance: ${report.typographyCompliance.score}% (${report.typographyCompliance.tokenizedText}/${report.typographyCompliance.totalTextElements} using styles)\\n`;
            prompt += `- Component Compliance: ${report.componentCompliance.score}% (${report.componentCompliance.standardComponents}/${report.componentCompliance.totalComponents} standard components)\\n`;
          }

          if (context.usedTokens && context.usedTokens.length > 0) {
            prompt += `\\n**Design Tokens Used:**\\n`;
            context.usedTokens.forEach(token => {
              prompt += `- ${token.name} (${token.type})\\n`;
            });
          }

          if (context.violations && context.violations.length > 0) {
            prompt += `\\n**Design System Violations:**\\n`;
            context.violations.forEach(violation => {
              prompt += `- ${violation.description}\\n`;
              prompt += `  Suggested Fix: ${violation.suggestedFix}\\n`;
            });
          }

          if (context.recommendations && context.recommendations.length > 0) {
            prompt += `\\n**Design System Recommendations:**\\n`;
            context.recommendations.slice(0, 3).forEach(rec => { // Limit to top 3
              prompt += `- [${rec.severity.toUpperCase()}] ${rec.message}\\n`;
              prompt += `  Suggestion: ${rec.suggestion}\\n`;
            });
          }
        }
        
        // Create proper Figma deep link
        const fileKey = frame.fileKey || globalFileKey || '';
        const nodeId = frame.id.replace(':', '-'); // Convert colon to hyphen format
        const fileName = globalFileName ? `/${encodeURIComponent(globalFileName)}` : '';
        const figmaLink = `https://www.figma.com/design/${fileKey}${fileName}?node-id=${nodeId}&t=${Date.now()}`;
        prompt += `\\n- Figma link: ${figmaLink}\\n`;
        prompt += `- Frame ID: ${frame.id} (for developer reference)\\n\\n`;
      });

      if (customInstructions) {
        prompt += `**Additional Requirements:**\\n${customInstructions}\\n\\n`;
      }

      prompt += `Please format the response as:\\n\\n`;
      prompt += `**Title:** [Concise ticket title]\\n\\n`;
      prompt += `**Description:**\\n[Detailed description with context and requirements]\\n\\n`;
      prompt += `**Figma Reference:**\\n[Include the Figma link and frame details for easy access]\\n\\n`;
      prompt += `**Acceptance Criteria:**\\n1. [Specific, testable criteria]\\n2. [Another criteria]\\n3. [etc.]\\n\\n`;
      prompt += `**Technical Notes:**\\n[Any implementation details, dependencies, or considerations]\\n\\n`;
      prompt += `**Design Specs:**\\n[Key measurements, colors, fonts, and visual requirements from the Figma frame]\\n\\n`;
      
      // Add design system specific instructions if we have design system data
      const hasDesignSystemData = frameDataList.some(frame => frame.designSystemContext);
      if (hasDesignSystemData) {
        prompt += `**Design System Compliance:**\\n[Address any violations mentioned above and ensure implementation follows the design system standards. Reference specific tokens and components where applicable.]\\n\\n`;
        prompt += `**Design System Notes:**\\n[Include specific design token names, component variants, and compliance recommendations to maintain consistency with the established design system.]`;
      }

      return prompt;
    }

    function displayFrameInfo(frameDataList) {
      if (!frameDataList.length) {
        frameInfoDiv.classList.add('hidden');
        return;
      }

      let html = '';
      frameDataList.forEach((frame, index) => {
        html += `
          <div class="frame-info">
            <div class="frame-name">${frame.name}</div>
            <div class="frame-details">
              ${frame.type} â€¢ ${frame.dimensions.width}x${frame.dimensions.height}px â€¢ ${frame.nodeCount} elements
            </div>
          </div>
        `;
      });

      frameInfoDiv.innerHTML = html;
      frameInfoDiv.classList.remove('hidden');
    }

    function displayDesignSystemInfo(designSystem) {
      const section = document.getElementById('designSystemSection');
      const dsName = document.getElementById('dsName');
      const dsConfidence = document.getElementById('dsConfidence');
      const dsColors = document.getElementById('dsColors');
      const dsTypography = document.getElementById('dsTypography');
      const dsComponents = document.getElementById('dsComponents');

      dsName.textContent = designSystem.name;
      dsConfidence.textContent = `${Math.round(designSystem.detectionConfidence * 100)}%`;
      dsColors.textContent = `${designSystem.colors.length} colors`;
      dsTypography.textContent = `${designSystem.typography.length} text styles`;
      dsComponents.textContent = `${designSystem.components.components.length} components`;

      section.classList.remove('hidden');
    }

    async function displayComplianceInfo(frameDataList) {
      const complianceInfo = document.getElementById('complianceInfo');
      const complianceScore = document.getElementById('complianceScore');
      const colorScore = document.getElementById('colorScore');
      const typographyScore = document.getElementById('typographyScore');
      const componentScore = document.getElementById('componentScore');
      const recommendations = document.getElementById('recommendations');
      const recList = document.getElementById('recList');

      // Try MCP compliance check first
      if (currentFileKey && frameDataList.length > 0) {
        try {
          const figmaUrl = `https://figma.com/file/${currentFileKey}/${encodeURIComponent(currentFileName || 'Design')}`;
          const mcpCompliance = await callMCPServer('check_compliance', {
            figmaUrl: figmaUrl,
            frameData: frameDataList
          });
          
          if (mcpCompliance && mcpCompliance.overallScore !== undefined) {
            // Update UI with MCP compliance results
            complianceScore.textContent = Math.round(mcpCompliance.overallScore) + '%';
            complianceScore.className = 'compliance-score ' + getScoreClass(mcpCompliance.overallScore);
            
            if (mcpCompliance.colorCompliance) {
              colorScore.textContent = Math.round(mcpCompliance.colorCompliance.score) + '%';
            }
            if (mcpCompliance.typographyCompliance) {
              typographyScore.textContent = Math.round(mcpCompliance.typographyCompliance.score) + '%';
            }
            if (mcpCompliance.componentCompliance) {
              componentScore.textContent = Math.round(mcpCompliance.componentCompliance.score) + '%';
            }
            
            // Show recommendations if available
            if (mcpCompliance.recommendations && mcpCompliance.recommendations.length > 0) {
              recList.innerHTML = mcpCompliance.recommendations
                .map(rec => `<li>${rec}</li>`)
                .join('');
              recommendations.classList.remove('hidden');
            }
            
            complianceInfo.classList.remove('hidden');
            
            // Update health metrics with MCP data
            updateHealthMetricsFromMCP(mcpCompliance);
            return;
          }
        } catch (error) {
          console.warn('MCP compliance check failed, falling back to local analysis:', error);
        }
      }

      // Fallback to original local compliance analysis
      // Find frames with design system context
      const framesWithContext = frameDataList.filter(frame => 
        frame.designSystemContext && frame.designSystemContext.complianceReport
      );

      if (framesWithContext.length === 0) {
        complianceInfo.classList.add('hidden');
        return;
      }

      // Calculate average scores
      let totalOverall = 0;
      let totalColor = 0;
      let totalTypography = 0;
      let totalComponent = 0;
      let allRecommendations = [];

      framesWithContext.forEach(frame => {
        const report = frame.designSystemContext.complianceReport;
        totalOverall += report.overallScore;
        totalColor += report.colorCompliance.score;
        totalTypography += report.typographyCompliance.score;
        totalComponent += report.componentCompliance.score;
        allRecommendations = allRecommendations.concat(report.recommendations);
      });

      const count = framesWithContext.length;
      const avgOverall = Math.round(totalOverall / count);
      const avgColor = Math.round(totalColor / count);
      const avgTypography = Math.round(totalTypography / count);
      const avgComponent = Math.round(totalComponent / count);

      complianceScore.textContent = `${avgOverall}%`;
      colorScore.textContent = `${avgColor}%`;
      typographyScore.textContent = `${avgTypography}%`;
      componentScore.textContent = `${avgComponent}%`;

      // Color code the scores
      complianceScore.style.background = getScoreColor(avgOverall);
      colorScore.style.background = getScoreColor(avgColor);
      typographyScore.style.background = getScoreColor(avgTypography);
      componentScore.style.background = getScoreColor(avgComponent);

      // Display recommendations
      if (allRecommendations.length > 0) {
        let recHtml = '';
        allRecommendations.slice(0, 3).forEach(rec => { // Show max 3 recommendations
          recHtml += `
            <div class="rec-item ${rec.severity}">
              <div class="rec-message">${rec.message}</div>
              <div class="rec-suggestion">${rec.suggestion}</div>
            </div>
          `;
        });
        recList.innerHTML = recHtml;
        recommendations.classList.remove('hidden');
      } else {
        recommendations.classList.add('hidden');
      }

      complianceInfo.classList.remove('hidden');
    }

    function getScoreColor(score) {
      if (score >= 90) return 'var(--figma-color-bg-success)';
      if (score >= 70) return 'var(--figma-color-bg-warning)';
      return 'var(--figma-color-bg-danger)';
    }

    function hideDesignSystemSection() {
      const section = document.getElementById('designSystemSection');
      section.classList.add('hidden');
    }

    // Compliance Scoring Functions
    let lastComplianceCheck = 0;
    
    function triggerComplianceCalculation() {
      // Throttle compliance checks to avoid spam
      const now = Date.now();
      if (now - lastComplianceCheck < 2000) return; // Max once per 2 seconds
      
      lastComplianceCheck = now;
      
      // Request compliance analysis
      parent.postMessage({ 
        pluginMessage: { type: 'calculate-compliance' } 
      }, '*');
    }

    function displayComplianceResults(compliance, selectionCount) {
      console.log('ðŸ“Š Displaying compliance results:', compliance);
      
      // Update overall score
      updateHealthMetrics(compliance);
      
      // Show detailed analysis if there's selection
      if (selectionCount > 0) {
        updateComponentAnalysis(compliance, selectionCount);
        updateRecommendations(compliance.recommendations);
      }
      
      // Update last updated timestamp
      const lastUpdated = document.getElementById('lastUpdated');
      if (lastUpdated) {
        lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      }
    }

    function updateHealthMetrics(compliance) {
      const overallScore = document.getElementById('overallScore');
      const componentUsage = document.getElementById('componentUsage');
      const tokenAdoption = document.getElementById('tokenAdoption');
      const consistency = document.getElementById('consistency');
      
      if (compliance) {
        // Update metric values with animation
        if (overallScore) {
          overallScore.textContent = `${compliance.overall}%`;
          overallScore.className = `metric-value ${getScoreClass(compliance.overall)}`;
        }
        
        if (componentUsage) {
          componentUsage.textContent = `${compliance.breakdown.components.score}%`;
          componentUsage.className = `metric-value ${getScoreClass(compliance.breakdown.components.score)}`;
        }
        
        if (tokenAdoption) {
          tokenAdoption.textContent = `${Math.round((compliance.breakdown.colors.score + compliance.breakdown.typography.score) / 2)}%`;
          tokenAdoption.className = `metric-value ${getScoreClass(Math.round((compliance.breakdown.colors.score + compliance.breakdown.typography.score) / 2))}`;
        }
        
        if (consistency) {
          consistency.textContent = `${compliance.breakdown.spacing.score}%`;
          consistency.className = `metric-value ${getScoreClass(compliance.breakdown.spacing.score)}`;
        }
      } else {
        // Reset to placeholder state
        [overallScore, componentUsage, tokenAdoption, consistency].forEach(el => {
          if (el) {
            el.textContent = '--';
            el.className = 'metric-value';
          }
        });
      }
    }

    function getScoreClass(score) {
      if (score >= 90) return 'excellent';
      if (score >= 80) return 'good';
      if (score >= 70) return 'medium';
      if (score >= 60) return 'needs-attention';
      return 'poor';
    }

    function updateComponentAnalysis(compliance, selectionCount) {
      const componentAnalysis = document.getElementById('componentAnalysis');
      if (!componentAnalysis) return;
      
      const breakdown = compliance.breakdown;
      const html = `
        <div class="analysis-summary">
          <div class="summary-stat">
            <span class="stat-label">Elements analyzed:</span>
            <span class="stat-value">${selectionCount}</span>
          </div>
        </div>
        
        <div class="breakdown-grid">
          <div class="breakdown-item">
            <div class="breakdown-label">Colors</div>
            <div class="breakdown-score ${getScoreClass(breakdown.colors.score)}">${breakdown.colors.score}%</div>
            <div class="breakdown-details">${breakdown.colors.compliantCount}/${breakdown.colors.totalCount} compliant</div>
          </div>
          
          <div class="breakdown-item">
            <div class="breakdown-label">Typography</div>
            <div class="breakdown-score ${getScoreClass(breakdown.typography.score)}">${breakdown.typography.score}%</div>
            <div class="breakdown-details">${breakdown.typography.compliantCount}/${breakdown.typography.totalCount} compliant</div>
          </div>
          
          <div class="breakdown-item">
            <div class="breakdown-label">Components</div>
            <div class="breakdown-score ${getScoreClass(breakdown.components.score)}">${breakdown.components.score}%</div>
            <div class="breakdown-details">${breakdown.components.compliantCount}/${breakdown.components.totalCount} compliant</div>
          </div>
          
          <div class="breakdown-item">
            <div class="breakdown-label">Spacing</div>
            <div class="breakdown-score ${getScoreClass(breakdown.spacing.score)}">${breakdown.spacing.score}%</div>
            <div class="breakdown-details">${breakdown.spacing.compliantCount}/${breakdown.spacing.totalCount} compliant</div>
          </div>
        </div>
      `;
      
      componentAnalysis.innerHTML = html;
    }

    function updateRecommendations(recommendations) {
      const healthRecommendations = document.getElementById('healthRecommendations');
      if (!healthRecommendations) return;
      
      if (recommendations && recommendations.length > 0) {
        const html = recommendations.slice(0, 3).map(rec => `
          <div class="recommendation-item ${rec.priority}">
            <div class="rec-priority">${rec.priority.toUpperCase()}</div>
            <div class="rec-category">${rec.category}</div>
            <div class="rec-description">${rec.description}</div>
            <div class="rec-action">${rec.action}</div>
          </div>
        `).join('');
        
        healthRecommendations.innerHTML = html;
      } else {
        healthRecommendations.innerHTML = `
          <div class="metric-row">
            <span class="metric-name">No recommendations at this time</span>
          </div>
        `;
      }
    }

    function showComplianceError(message) {
      const componentAnalysis = document.getElementById('componentAnalysis');
      if (componentAnalysis) {
        componentAnalysis.innerHTML = `
          <div class="placeholder-text error">
            <span>âš ï¸ ${message}</span>
          </div>
        `;
      }
      
      const healthRecommendations = document.getElementById('healthRecommendations');
      if (healthRecommendations) {
        healthRecommendations.innerHTML = `
          <div class="placeholder-text">
            Select frames or components to get recommendations
          </div>
        `;
      }
    }

    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }

    function setGenerating(generating) {
      isGenerating = generating;
      generateBtn.disabled = generating;
      generateBtn.textContent = generating ? 'â³ Generating...' : 'ðŸ“‹ Generate Ticket from Selection';
    }

    function copyToClipboard() {
      if (output.value.trim()) {
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(output.value).then(() => {
            showStatus('Copied to clipboard!', 'success');
          }).catch(() => {
            // Fallback to legacy method
            fallbackCopyToClipboard();
          });
        } else {
          // Use fallback method
          fallbackCopyToClipboard();
        }
      }
    }

    function fallbackCopyToClipboard() {
      try {
        // Create a temporary textarea element
        const textArea = document.createElement('textarea');
        textArea.value = output.value;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        
        // Select and copy the text
        textArea.focus();
        textArea.select();
        
        // Try the legacy execCommand
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
          showStatus('Copied to clipboard!', 'success');
        } else {
          // If all else fails, select the text for manual copying
          output.select();
          output.setSelectionRange(0, 99999); // For mobile devices
          showStatus('Text selected - press Ctrl+C (or Cmd+C) to copy', 'error');
        }
      } catch (error) {
        // Final fallback - just select the text
        output.select();
        output.setSelectionRange(0, 99999);
        showStatus('Text selected - press Ctrl+C (or Cmd+C) to copy', 'error');
      }
    }

    // Check if localStorage is available
    function isLocalStorageAvailable() {
      try {
        const test = '__localStorage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch(e) {
        return false;
      }
    }

    function saveSettings() {
      const settings = {
        apiKey: apiKeyInput.value,
        model: modelSelect.value,
        template: templateSelect.value
      };
      
      if (isLocalStorageAvailable()) {
        try {
          localStorage.setItem('aiTicketGenerator', JSON.stringify(settings));
        } catch (error) {
          // Fallback to session storage
          window.tempSettings = settings;
        }
      } else {
        // Store in memory for session
        window.tempSettings = settings;
      }
    }

    function loadSettings() {
      if (isLocalStorageAvailable()) {
        try {
          const settings = JSON.parse(localStorage.getItem('aiTicketGenerator') || '{}');
          if (settings.apiKey) apiKeyInput.value = settings.apiKey;
          if (settings.model) modelSelect.value = settings.model;
          if (settings.template) templateSelect.value = settings.template;
          return; // Exit early if localStorage worked
        } catch (error) {
          // Continue to fallback
        }
      }
      
      // Fallback: try session storage
      if (window.tempSettings) {
        const settings = window.tempSettings;
        if (settings.apiKey) apiKeyInput.value = settings.apiKey;
        if (settings.model) modelSelect.value = settings.model;
        if (settings.template) templateSelect.value = settings.template;
      }
    }
    
    // MCP Helper Functions
    function getScoreClass(score) {
      if (score >= 90) return 'excellent';
      if (score >= 75) return 'good';
      return 'needs-attention';
    }
    
    function updateHealthMetricsFromMCP(mcpCompliance) {
      // Update compliance rate
      const complianceRate = document.getElementById('complianceRate');
      if (complianceRate && mcpCompliance.overallScore !== undefined) {
        complianceRate.textContent = Math.round(mcpCompliance.overallScore) + '%';
        complianceRate.className = 'metric-value ' + getScoreClass(mcpCompliance.overallScore);
      }
      
      // Update other metrics if available
      const tokenUsage = document.getElementById('tokenUsage');
      if (tokenUsage && mcpCompliance.tokenUsage !== undefined) {
        tokenUsage.textContent = mcpCompliance.tokenUsage + '%';
        tokenUsage.className = 'metric-value ' + getScoreClass(mcpCompliance.tokenUsage);
      }
      
      const consistencyScore = document.getElementById('consistencyScore');
      if (consistencyScore && mcpCompliance.consistencyScore !== undefined) {
        consistencyScore.textContent = Math.round(mcpCompliance.consistencyScore) + '%';
        consistencyScore.className = 'metric-value ' + getScoreClass(mcpCompliance.consistencyScore);
      }
    }
  </script>
</body>
</html>