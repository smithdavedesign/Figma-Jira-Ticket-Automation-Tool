<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Ticket Generator - Standalone Test</title>
  <style>
    /* Figma CSS Variables Fallbacks for Standalone Testing */
    :root {
      --figma-color-bg: #ffffff;
      --figma-color-bg-secondary: #f8f9fa;
      --figma-color-bg-tertiary: #f1f3f4;
      --figma-color-bg-brand: #0066cc;
      --figma-color-bg-brand-secondary: #e3f2fd;
      --figma-color-bg-brand-tertiary: #bbdefb;
      --figma-color-bg-success: #4caf50;
      --figma-color-bg-success-tertiary: #e8f5e8;
      --figma-color-bg-warning: #ff9800;
      --figma-color-bg-warning-tertiary: #fff3e0;
      --figma-color-bg-danger: #f44336;
      --figma-color-bg-danger-tertiary: #ffebee;
      --figma-color-bg-disabled: #e0e0e0;
      --figma-color-bg-hover: #f5f5f5;
      --figma-color-bg-brand-hover: #0056b3;
      --figma-color-text: #212121;
      --figma-color-text-secondary: #757575;
      --figma-color-text-tertiary: #9e9e9e;
      --figma-color-text-disabled: #bdbdbd;
      --figma-color-text-success: #388e3c;
      --figma-color-text-warning: #f57c00;
      --figma-color-text-danger: #d32f2f;
      --figma-color-text-onbrand: #ffffff;
      --figma-color-border: #e0e0e0;
      --figma-color-border-subtle: #f0f0f0;
      --figma-color-border-selected: #0066cc;
      --figma-color-border-brand: #0066cc;
      --figma-color-border-success: #4caf50;
      --figma-color-border-warning: #ff9800;
      --figma-color-border-danger: #f44336;
    }

    * {
      box-sizing: border-box;
    }
    
    /* Main Layout - 50/50 Split */
    .main-container {
      display: flex;
      gap: 20px;
      min-height: calc(100vh - 40px);
    }
    
    .panel {
      flex: 1;
      min-width: 0; /* Prevents flex items from overflowing */
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--figma-color-border);
    }
    
    .panel-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--figma-color-text);
      margin: 0;
    }
    
    .panel-subtitle {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin: 4px 0 0 0;
    }
    
    /* Health Metrics Panel Styles */
    .health-panel {
      background: var(--figma-color-bg);
      border-right: 1px solid var(--figma-color-border);
      padding-right: 20px;
    }
    
    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .metric-value.excellent { color: #0d9f3c; }
    .metric-value.good { color: #f4a113; }
    .metric-value.needs-attention { color: #e34f47; }
    
    .metric-label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .detailed-metrics {
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--figma-color-text);
    }
    
    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--figma-color-border-subtle);
    }
    
    .metric-row:last-child {
      border-bottom: none;
    }
    
    .metric-name {
      font-size: 11px;
      color: var(--figma-color-text);
    }
    
    .metric-score {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .metric-score.high {
      background: var(--figma-color-bg-success-tertiary);
      color: var(--figma-color-text-success);
    }
    
    .metric-score.medium {
      background: var(--figma-color-bg-warning-tertiary);
      color: var(--figma-color-text-warning);
    }
    
    .metric-score.low {
      background: var(--figma-color-bg-danger-tertiary);
      color: var(--figma-color-text-danger);
    }
    
    /* Ticket Panel Styles */
    .ticket-panel {
      background: var(--figma-color-bg);
      padding-left: 20px;
    }

    /* Enhanced Tech Stack Styles */
    .suggestion-pill {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      color: var(--figma-color-text);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 2px;
      display: inline-block;
    }
    
    .suggestion-pill:hover {
      background: var(--figma-color-bg-brand-secondary);
      border-color: var(--figma-color-border-brand);
      transform: translateY(-1px);
    }

    /* Progress Indicator Styles */
    .progress-container {
      margin: 16px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--figma-color-bg-brand) 0%, var(--figma-color-bg-success) 100%);
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    
    .progress-text {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-top: 4px;
      text-align: center;
    }

    /* Document Type Radio Styles */
    input[type="radio"] {
      accent-color: var(--figma-color-bg-brand);
      width: 12px;
      height: 12px;
    }
    
    input[type="checkbox"] {
      accent-color: var(--figma-color-bg-brand);
      width: 12px;
      height: 12px;
    }
    
    /* Enhanced Labels */
    label:has(input[type="radio"]):hover {
      background: var(--figma-color-bg-hover);
    }
    
    label:has(input[type="radio"]:checked) {
      background: var(--figma-color-bg-brand-secondary);
      border-color: var(--figma-color-border-brand);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      line-height: 1.4;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    h1 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--figma-color-text);
    }
    
    .subtitle {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      margin-bottom: 16px;
    }
    
    .config-section {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .config-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 12px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--figma-color-border-selected);
      box-shadow: 0 0 0 1px var(--figma-color-border-selected);
    }
    
    .button {
      background: var(--figma-color-bg-brand);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .button:hover {
      background: var(--figma-color-bg-brand-hover);
    }
    
    .button:disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
      cursor: not-allowed;
    }
    
    .button-secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }
    
    .button-secondary:hover {
      background: var(--figma-color-bg-hover);
    }

    .hidden {
      display: none;
    }

    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 11px;
    }
    
    .status.error {
      background: var(--figma-color-bg-danger);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-danger);
    }
    
    .status.success {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
      border: 1px solid var(--figma-color-border-success);
    }
    
    .status.loading {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
      border: 1px solid var(--figma-color-border);
    }

    /* Radio Button Styles */
    .mode-selection {
      margin-bottom: 16px;
    }
    
    .radio-group {
      margin-bottom: 12px;
    }
    
    .radio-group input[type="radio"] {
      display: none;
    }
    
    .radio-group label {
      display: flex;
      flex-direction: column;
      padding: 12px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--figma-color-bg);
    }
    
    .radio-group input[type="radio"]:checked + label {
      border-color: var(--figma-color-border-brand);
      background: var(--figma-color-bg-brand-secondary);
    }
    
    .radio-group label:hover {
      border-color: var(--figma-color-border-brand);
    }
    
    .radio-label {
      font-weight: 600;
      font-size: 12px;
      color: var(--figma-color-text);
      margin-bottom: 4px;
    }
    
    .radio-description {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Health Metrics Panel (Left Side) -->
    <div class="panel health-panel">
      <div class="panel-header">
        <h2 class="panel-title">📊 Design System Health</h2>
      </div>
      <p class="panel-subtitle">Real-time compliance and usage metrics</p>
      
      <!-- Overall Health Score -->
      <div class="metric-grid">
        <div class="metric-card">
          <div class="metric-value excellent" id="overallScore">92%</div>
          <div class="metric-label">Overall Score</div>
        </div>
        <div class="metric-card">
          <div class="metric-value good" id="complianceRate">88%</div>
          <div class="metric-label">Compliance Rate</div>
        </div>
        <div class="metric-card">
          <div class="metric-value good" id="componentUsage">94%</div>
          <div class="metric-label">Component Usage</div>
        </div>
        <div class="metric-card">
          <div class="metric-value needs-attention" id="tokenAdoption">76%</div>
          <div class="metric-label">Token Adoption</div>
        </div>
      </div>
      
      <!-- Detailed Metrics -->
      <div class="detailed-metrics">
        <div class="section-title">Component Analysis</div>
        <div class="metric-row">
          <span class="metric-name">Standard Components</span>
          <span class="metric-score high" id="standardComponents">18/20</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Custom Components</span>
          <span class="metric-score medium" id="customComponents">3/20</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Most Used Component</span>
          <span class="metric-score high" id="topComponent">Button</span>
        </div>
      </div>
      
      <div class="detailed-metrics">
        <div class="section-title">Token Adoption</div>
        <div class="metric-row">
          <span class="metric-name">Color Tokens</span>
          <span class="metric-score high" id="colorTokens">94%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Typography Tokens</span>
          <span class="metric-score medium" id="typographyTokens">82%</span>
        </div>
        <div class="metric-row">
          <span class="metric-name">Spacing Tokens</span>
          <span class="metric-score low" id="spacingTokens">67%</span>
        </div>
      </div>
    </div>
    
    <!-- Ticket Generation Panel (Right Side) -->
    <div class="panel ticket-panel">
      <div class="panel-header">
        <h2 class="panel-title">🎫 AI Ticket Generator</h2>
      </div>
      <p class="panel-subtitle">Generate enhanced tickets from selected Figma frames</p>

      <!-- Tech Stack Detection Section -->
      <div class="config-section">
        <div class="config-title">🛠️ Tech Stack Context</div>
        <p style="font-size: 11px; color: var(--figma-color-text-secondary); margin-bottom: 12px;">Describe your project's technology stack for better ticket generation:</p>
        
        <div class="form-group">
          <label for="techStackDescription">Describe your tech stack in plain English:</label>
          <textarea 
            id="techStackDescription" 
            rows="3" 
            placeholder="e.g., React app with TypeScript, Material-UI for styling, Jest for testing..."
            style="font-size: 11px;"
          ></textarea>
        </div>
        
        <!-- Quick Suggestions -->
        <div style="margin-bottom: 16px;">
          <p style="font-size: 11px; color: var(--figma-color-text-secondary); margin-bottom: 8px;">Popular combinations:</p>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            <button class="suggestion-pill" data-stack="React with TypeScript, Tailwind CSS, and Jest testing">React + TypeScript</button>
            <button class="suggestion-pill" data-stack="Vue 3 with Composition API, SCSS, and Vitest">Vue 3 + Vitest</button>
            <button class="suggestion-pill" data-stack="Next.js with TypeScript, Chakra UI">Next.js + Chakra</button>
            <button class="suggestion-pill" data-stack="Angular with Material Design, NgRx">Angular + Material</button>
            <button class="suggestion-pill" data-stack="React Native mobile app with Expo">React Native</button>
          </div>
        </div>
        
        <!-- Parse Button -->
        <button id="parseTechStack" class="button button-secondary" style="margin-bottom: 12px;">
          🤖 Parse Tech Stack
        </button>
        
        <!-- Parsed Results Display -->
        <div id="parsedResults" class="hidden" style="background: var(--figma-color-bg-success-tertiary); border: 1px solid var(--figma-color-border-success); border-radius: 6px; padding: 12px; margin-top: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; font-size: 11px;">✨ Parsed Configuration</span>
            <span style="font-size: 10px; color: var(--figma-color-text-secondary);">
              Confidence: <span id="confidencePercent" style="font-weight: 600; color: var(--figma-color-text-success);">0%</span>
            </span>
          </div>
          
          <!-- Confidence Bar -->
          <div style="width: 100%; background: var(--figma-color-bg-secondary); border-radius: 4px; height: 4px; margin-bottom: 12px;">
            <div id="confidenceBar" style="background: linear-gradient(to right, #ef4444 0%, #eab308 50%, #22c55e 100%); height: 4px; border-radius: 4px; width: 0%; transition: width 0.5s ease-in-out;"></div>
          </div>
          
          <!-- Tech Stack Details -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 10px;">
            <div>
              <span style="color: var(--figma-color-text-secondary);">Framework:</span>
              <div id="frontendFramework" style="font-weight: 600; color: var(--figma-color-text);"></div>
            </div>
            <div>
              <span style="color: var(--figma-color-text-secondary);">Language:</span>
              <div id="language" style="font-weight: 600; color: var(--figma-color-text);"></div>
            </div>
            <div>
              <span style="color: var(--figma-color-text-secondary);">Styling:</span>
              <div id="styling" style="font-weight: 600; color: var(--figma-color-text);"></div>
            </div>
            <div>
              <span style="color: var(--figma-color-text-secondary);">Testing:</span>
              <div id="testing" style="font-weight: 600; color: var(--figma-color-text);"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="config-section">
        <div class="config-title">Generation Mode</div>
        
        <div class="mode-selection">
          <div class="radio-group">
            <input type="radio" id="modeMCP" name="generationMode" value="mcp" checked>
            <label for="modeMCP">
              <span class="radio-label">🚀 MCP Server (Enhanced)</span>
              <span class="radio-description">Local Model Context Protocol server with strategic design analysis</span>
            </label>
          </div>
          
          <div class="radio-group">
            <input type="radio" id="modeOpenAI" name="generationMode" value="openai">
            <label for="modeOpenAI">
              <span class="radio-label">🤖 OpenAI API</span>
              <span class="radio-description">Cloud-based AI generation (requires API key)</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Document Type Selection -->
      <div class="config-section">
        <div class="config-title">📄 Output Document Type</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 16px;">
          <label style="display: flex; flex-direction: column; padding: 8px; border: 1px solid var(--figma-color-border); border-radius: 6px; cursor: pointer; text-align: center; font-size: 10px;">
            <input type="radio" name="documentType" value="jira" checked style="margin-bottom: 4px;">
            <span style="font-weight: 600; margin-bottom: 2px;">🎫 Jira Ticket</span>
            <span style="color: var(--figma-color-text-secondary);">Full format with story points</span>
          </label>
          <label style="display: flex; flex-direction: column; padding: 8px; border: 1px solid var(--figma-color-border); border-radius: 6px; cursor: pointer; text-align: center; font-size: 10px;">
            <input type="radio" name="documentType" value="confluence" style="margin-bottom: 4px;">
            <span style="font-weight: 600; margin-bottom: 2px;">📖 Confluence</span>
            <span style="color: var(--figma-color-text-secondary);">Detailed specification</span>
          </label>
          <label style="display: flex; flex-direction: column; padding: 8px; border: 1px solid var(--figma-color-border); border-radius: 6px; cursor: pointer; text-align: center; font-size: 10px;">
            <input type="radio" name="documentType" value="agent" style="margin-bottom: 4px;">
            <span style="font-weight: 600; margin-bottom: 2px;">🤖 Agent Task</span>
            <span style="color: var(--figma-color-text-secondary);">Structured for AI agents</span>
          </label>
        </div>
      </div>

      <div class="config-section">
        <div class="config-title">Ticket Template</div>
        
        <div class="form-group template-select">
          <label for="template">Template Type</label>
          <select id="template">
            <option value="component">UI Component</option>
            <option value="feature">Feature Implementation</option>
            <option value="bug">Bug Fix</option>
            <option value="page">Page/Screen</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        
        <!-- Enhanced Options -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; font-size: 11px;">
          <label style="display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" id="includeBoilerplate" style="margin: 0;">
            <span>Include boilerplate code</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" id="includeDesignTokens" style="margin: 0;">
            <span>Include design tokens</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" id="includeA11y" checked style="margin: 0;">
            <span>Accessibility requirements</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px;">
            <input type="checkbox" id="includeTests" checked style="margin: 0;">
            <span>Testing requirements</span>
          </label>
        </div>
        
        <div class="form-group" style="margin-top: 12px;">
          <label for="customPrompt">Additional Instructions (Optional)</label>
          <textarea id="customPrompt" rows="3" placeholder="e.g., Include accessibility requirements, use specific design tokens..."></textarea>
        </div>
      </div>

      <div id="status" class="hidden"></div>

      <button id="generate" class="button">
        📋 Generate Enhanced Ticket
      </button>

      <div class="output-section" style="margin-top: 16px;">
        <label for="output">Generated Ticket</label>
        <textarea id="output" rows="15" placeholder="Select frames in Figma and click 'Generate Ticket' to create enhanced documentation..." style="margin-top: 4px;"></textarea>
        
        <button id="copy" class="button button-secondary" disabled style="margin-top: 8px;">
          📋 Copy to Clipboard
        </button>
      </div>
    </div>
  </div>

  <script>
    // UI Elements
    const generateBtn = document.getElementById('generate');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy');
    const templateSelect = document.getElementById('template');
    const customPromptInput = document.getElementById('customPrompt');
    const statusDiv = document.getElementById('status');
    
    // Mode Selection Elements
    const modeMCP = document.getElementById('modeMCP');
    const modeOpenAI = document.getElementById('modeOpenAI');

    // State
    let frameDataList = [{
      name: "Sample Button Component",
      type: "COMPONENT",
      dimensions: { width: 120, height: 40 },
      nodeCount: 3,
      textContent: [{ content: "Click Me", fontSize: 14 }]
    }];
    let isGenerating = false;
    let parsedTechStack = null;

    // Tech Stack Parsing Functions
    function initializeTechStackParsing() {
      // Quick suggestion click handlers
      document.querySelectorAll('.suggestion-pill').forEach(pill => {
        pill.addEventListener('click', function() {
          const stack = this.getAttribute('data-stack');
          document.getElementById('techStackDescription').value = stack;
          parseTechStackDescription();
        });
      });

      // Parse tech stack button
      document.getElementById('parseTechStack').addEventListener('click', parseTechStackDescription);

      // Auto-parse when typing stops
      let parseTimeout;
      document.getElementById('techStackDescription').addEventListener('input', function() {
        clearTimeout(parseTimeout);
        parseTimeout = setTimeout(() => {
          const text = this.value.trim();
          if (text.length > 10) {
            parseTechStackDescription();
          }
        }, 2000);
      });
    }

    function parseTechStackDescription() {
      const description = document.getElementById('techStackDescription').value.trim();
      if (!description) return;

      // Show progress
      showProgress('🤖 Parsing tech stack...', 20);

      // Simulate parsing with realistic results
      setTimeout(() => {
        const mockParsing = simulateNaturalLanguageParsing(description);
        displayParsedResults(mockParsing);
        parsedTechStack = mockParsing;
        
        showProgress('✅ Tech stack parsed successfully!', 100);
        setTimeout(() => hideProgress(), 1000);
      }, 1500);
    }

    function simulateNaturalLanguageParsing(description) {
      const lowerDesc = description.toLowerCase();
      
      // Enhanced Framework Detection with scoring
      const frameworks = [
        { name: 'React Native', keywords: ['react native', 'expo', 'rn'], score: 0 },
        { name: 'Next.js', keywords: ['next.js', 'nextjs', 'next'], score: 0 },
        { name: 'Vue.js', keywords: ['vue', 'vuejs', 'vue 3', 'composition api'], score: 0 },
        { name: 'Angular', keywords: ['angular', 'ng', 'ngrx'], score: 0 },
        { name: 'React', keywords: ['react', 'jsx', 'create-react-app'], score: 0 }
      ];

      const languages = [
        { name: 'TypeScript', keywords: ['typescript', 'ts', '.tsx', '.ts'], score: 0 },
        { name: 'JavaScript', keywords: ['javascript', 'js', '.jsx', '.js'], score: 0 }
      ];

      const stylings = [
        { name: 'Tailwind CSS', keywords: ['tailwind', 'tailwindcss', 'utility-first'], score: 0 },
        { name: 'Material-UI', keywords: ['material-ui', 'mui', 'material design', '@mui'], score: 0 },
        { name: 'Chakra UI', keywords: ['chakra ui', 'chakra', '@chakra-ui'], score: 0 },
        { name: 'SCSS/Sass', keywords: ['scss', 'sass', '.scss', '.sass'], score: 0 },
        { name: 'CSS', keywords: ['css', 'vanilla css'], score: 0 }
      ];

      const testings = [
        { name: 'Jest', keywords: ['jest', 'jest testing'], score: 0 },
        { name: 'Vitest', keywords: ['vitest', 'vite testing'], score: 0 },
        { name: 'Testing Library', keywords: ['testing library', '@testing-library'], score: 0 }
      ];

      // Score each category
      function scoreCategory(items) {
        items.forEach(item => {
          item.keywords.forEach(keyword => {
            if (lowerDesc.includes(keyword)) {
              item.score += keyword.length;
            }
          });
        });
        return items.sort((a, b) => b.score - a.score)[0] || items[items.length - 1];
      }

      const framework = scoreCategory([...frameworks]).name;
      const language = scoreCategory([...languages]).name;
      const styling = scoreCategory([...stylings]).name;
      const testing = scoreCategory([...testings]).name;

      // Calculate confidence
      const totalMatches = frameworks.concat(languages, stylings, testings)
        .filter(item => item.score > 0).length;
      
      let confidence = Math.min(75 + (totalMatches * 3), 98);
      confidence = Math.max(65, Math.min(98, confidence));
      
      return {
        framework,
        language,
        styling,
        testing,
        confidence: Math.round(confidence),
        description
      };
    }

    function displayParsedResults(parsing) {
      document.getElementById('frontendFramework').textContent = parsing.framework;
      document.getElementById('language').textContent = parsing.language;
      document.getElementById('styling').textContent = parsing.styling;
      document.getElementById('testing').textContent = parsing.testing;
      
      const confidencePercent = document.getElementById('confidencePercent');
      const confidenceBar = document.getElementById('confidenceBar');
      
      confidencePercent.textContent = parsing.confidence + '%';
      confidenceBar.style.width = parsing.confidence + '%';
      
      document.getElementById('parsedResults').classList.remove('hidden');
    }

    function showProgress(message, percent) {
      showStatus(message, 'loading');
    }

    function hideProgress() {
      statusDiv.classList.add('hidden');
    }

    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }

    // Mock MCP Integration
    async function generateTicket() {
      if (isGenerating) return;
      
      setGenerating(true);
      showStatus('🔍 Generating enhanced ticket...', 'loading');
      
      // Simulate generation
      setTimeout(() => {
        const documentType = document.querySelector('input[name="documentType"]:checked')?.value || 'jira';
        const includeBoilerplate = document.getElementById('includeBoilerplate')?.checked || false;
        const includeTests = document.getElementById('includeTests')?.checked || false;
        
        let ticket = generateMockTicket(documentType, parsedTechStack, includeBoilerplate, includeTests);
        
        output.value = ticket;
        copyBtn.disabled = false;
        showStatus(`✅ Enhanced ${documentType.toUpperCase()} document generated!`, 'success');
        setGenerating(false);
      }, 2000);
    }

    function generateMockTicket(documentType, techStack, includeBoilerplate, includeTests) {
      const frameName = frameDataList[0]?.name || 'Component';
      
      if (documentType === 'confluence') {
        return `# ${frameName} Implementation Specification

## Technical Stack
${techStack ? `
- **Framework**: ${techStack.framework}
- **Language**: ${techStack.language}
- **Styling**: ${techStack.styling}
- **Testing**: ${techStack.testing}
- **Detection Confidence**: ${techStack.confidence}%
` : 'No tech stack specified'}

## Implementation Guidelines
Detailed implementation specification for ${frameName} component.

---
*Generated by Enhanced Figma Plugin*`;
      }
      
      if (documentType === 'agent') {
        return `## Agent-Digestible Task Structure

\`\`\`json
{
  "taskType": "component_implementation",
  "component": "${frameName}",
  "techStack": ${techStack ? JSON.stringify({
    framework: techStack.framework,
    language: techStack.language,
    styling: techStack.styling,
    testing: techStack.testing
  }, null, 2) : 'null'},
  "requirements": {
    "boilerplate": ${includeBoilerplate},
    "testing": ${includeTests}
  }
}
\`\`\`

*Structured for AI agent consumption*`;
      }
      
      // Default Jira format
      return `# ${frameName} Implementation

## 🚀 Tech Stack Context
${techStack ? `**Framework:** ${techStack.framework}
**Language:** ${techStack.language}
**Styling:** ${techStack.styling}
**Testing:** ${techStack.testing}
**Detection Confidence:** ${techStack.confidence}%` : 'No tech stack specified'}

## ✅ Acceptance Criteria
${includeBoilerplate ? '- [ ] Generate and review boilerplate code structure\n' : ''}${includeTests ? '- [ ] Achieve >80% test coverage\n' : ''}- [ ] Implement responsive design for all breakpoints
- [ ] Follow ${techStack?.framework || 'framework'} best practices
- [ ] Ensure cross-browser compatibility

## 📊 Estimation
**Story Points:** 5
**Priority:** High

---
*Auto-generated with enhanced Figma Plugin*`;
    }

    function setGenerating(generating) {
      isGenerating = generating;
      generateBtn.disabled = generating;
      generateBtn.textContent = generating ? '⏳ Generating...' : '📋 Generate Enhanced Ticket';
    }

    function copyToClipboard() {
      if (output.value.trim()) {
        navigator.clipboard.writeText(output.value).then(() => {
          showStatus('Copied to clipboard!', 'success');
        }).catch(() => {
          output.select();
          showStatus('Text selected - press Ctrl+C to copy', 'error');
        });
      }
    }

    // Initialize
    initializeTechStackParsing();
    generateBtn.onclick = generateTicket;
    copyBtn.onclick = copyToClipboard;
  </script>
</body>
</html>